<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>GlucoTrack View</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#080D1A;--bg2:#0C1220;--card:#101828;--card2:#141F30;
  --border:#1C2A40;--border2:#243550;
  --text:#E8EFFE;--t2:#7A8FAD;--t3:#3D526B;
  --acc:#3B82F6;--acc2:#60A5FA;
  --ok:#10B981;--ok2:#34D399;
  --low:#EF4444;--low2:#F87171;
  --hi:#F59E0B;--hi2:#FCD34D;
  --r:16px;--rs:10px;
}
html,body{height:100%;overflow:hidden;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);}
body{max-width:430px;margin:0 auto;}

/* TOAST */
.tw{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;width:calc(100% - 32px);max-width:390px;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.t{background:#1E293B;color:#fff;padding:12px 16px;border-radius:10px;font-size:13px;font-weight:500;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,.5);animation:tIn .3s ease;border:1px solid var(--border2);}
.t.err{background:#7F1D1D;border-color:#991B1B;}
.t.suc{background:#064E3B;border-color:#065F46;}
@keyframes tIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ CONNECT SCREEN â”€â”€ */
#con{position:fixed;inset:0;z-index:100;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 24px;transition:opacity .4s,transform .4s;}
#con.gone{opacity:0;pointer-events:none;transform:scale(.97);}

.clogo{text-align:center;margin-bottom:36px;}
.clogo-icon{width:76px;height:76px;border-radius:22px;background:linear-gradient(135deg,#1B2D54,#0E1A30);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;margin:0 auto 14px;font-size:34px;box-shadow:0 0 40px rgba(59,130,246,0.15),inset 0 1px 0 rgba(255,255,255,.05);}
.clogo-title{font-size:24px;font-weight:700;letter-spacing:-.5px;}
.clogo-title span{color:var(--acc2);}
.clogo-sub{font-size:13px;color:var(--t2);margin-top:4px;}
.clogo-badge{display:inline-block;margin-top:8px;background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.25);border-radius:20px;padding:3px 10px;font-size:11px;color:var(--acc2);font-weight:600;letter-spacing:.04em;}

.ccard{width:100%;background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:22px;box-shadow:0 8px 32px rgba(0,0,0,.4);}
.ccard-lbl{font-size:11px;font-weight:600;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:14px;}

.tkwrap{position:relative;margin-bottom:14px;}
.tk{width:100%;background:var(--bg);border:1.5px solid var(--border2);border-radius:var(--rs);padding:14px 16px;font-size:20px;font-family:'DM Mono',monospace;color:var(--text);letter-spacing:.2em;text-align:center;outline:none;transition:border-color .2s,box-shadow .2s;}
.tk:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(59,130,246,.15);}
.tk::placeholder{font-size:12px;letter-spacing:.04em;color:var(--t3);font-family:'DM Sans',sans-serif;}

.cbtn{width:100%;padding:14px;background:linear-gradient(135deg,#2563EB,#3B82F6);color:#fff;border:none;border-radius:var(--rs);font-size:15px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;transition:opacity .15s,transform .1s;position:relative;overflow:hidden;}
.cbtn:active{transform:scale(.98);}
.cbtn:disabled{opacity:.5;cursor:not-allowed;}
.cbtn::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.1),transparent);}

.cdiv{display:flex;align-items:center;gap:10px;margin:14px 0;}
.cdiv-l{flex:1;height:1px;background:var(--border);}
.cdiv span{font-size:11px;color:var(--t3);}

.dbtn{width:100%;padding:12px;background:transparent;border:1.5px solid var(--border2);border-radius:var(--rs);color:var(--t2);font-size:14px;font-weight:500;font-family:'DM Sans',sans-serif;cursor:pointer;transition:border-color .2s,color .2s;}
.dbtn:hover{border-color:var(--acc);color:var(--acc2);}

.cnote{margin-top:18px;font-size:11px;color:var(--t3);text-align:center;line-height:1.7;}
.cnote strong{color:var(--t2);}

/* spinner */
.spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes sp{to{transform:rotate(360deg)}}

/* â”€â”€ TOPBAR â”€â”€ */
.tb{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 12px;border-bottom:1px solid var(--border);background:var(--bg2);position:sticky;top:0;z-index:10;}
.tb-logo{font-size:15px;font-weight:700;letter-spacing:-.3px;}
.tb-logo span{color:var(--acc2);}
.tb-logo em{font-style:normal;font-size:10px;background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.2);border-radius:20px;padding:2px 8px;color:var(--acc2);font-weight:600;vertical-align:middle;margin-left:6px;}
.tb-r{display:flex;align-items:center;gap:8px;}
.tb-live{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--ok2);font-weight:600;}
.tb-dot{width:6px;height:6px;border-radius:50%;background:var(--ok2);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.tb-disc{padding:5px 11px;background:var(--card);border:1px solid var(--border2);border-radius:20px;font-size:11px;color:var(--t2);cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:500;transition:border-color .2s,color .2s;}
.tb-disc:hover{border-color:var(--low);color:var(--low2);}

/* â”€â”€ SCROLL â”€â”€ */
.scroll{height:calc(100dvh - 57px);overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;}
.scroll::-webkit-scrollbar{display:none;}

/* â”€â”€ PATIENT HEADER â”€â”€ */
.ph{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px 18px 14px;display:flex;align-items:center;gap:14px;}
.ph-av{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#1E3A6E,#2563EB);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.ph-name{font-size:16px;font-weight:700;}
.ph-meta{font-size:11px;color:var(--t2);margin-top:2px;}
.ph-tok{font-family:'DM Mono',monospace;font-size:11px;color:var(--t3);margin-top:4px;letter-spacing:.05em;}

/* â”€â”€ GLUCOSE CARD â”€â”€ */
.gc{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px;}
.gc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.gc-lbl{font-size:11px;font-weight:600;color:var(--t3);letter-spacing:.07em;text-transform:uppercase;}
.gc-badge{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:700;letter-spacing:.06em;padding:4px 10px;border-radius:20px;}
.b-ok{background:rgba(16,185,129,.12);color:var(--ok2);border:1px solid rgba(16,185,129,.2);}
.b-low{background:rgba(239,68,68,.12);color:var(--low2);border:1px solid rgba(239,68,68,.2);}
.b-hi{background:rgba(245,158,11,.12);color:var(--hi2);border:1px solid rgba(245,158,11,.2);}
.b-none{background:var(--card2);color:var(--t2);border:1px solid var(--border2);}
.bdot{width:6px;height:6px;border-radius:50%;background:currentColor;}
.gc-num{font-size:60px;font-weight:700;line-height:1;font-variant-numeric:tabular-nums;}
.gc-num.n-ok{color:var(--ok2);}
.gc-num.n-low{color:var(--low2);}
.gc-num.n-hi{color:var(--hi2);}
.gc-num.n-none{color:var(--t3);}
.gc-row{display:flex;align-items:flex-end;gap:10px;}
.gc-unit{font-size:14px;color:var(--t2);font-weight:500;margin-bottom:8px;}
.gc-trend{font-size:22px;margin-bottom:6px;}
.gc-meta{display:flex;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--t3);}
.gc-time{color:var(--t2);}

/* range bar */
.rbar{margin-top:14px;}
.rtrack{height:6px;background:var(--border);border-radius:3px;position:relative;overflow:visible;}
.rtrack-fill{position:absolute;top:0;bottom:0;border-radius:3px;}
.rlow{left:0;width:22%;background:linear-gradient(90deg,#EF4444,#F97316);}
.rok{left:22%;width:46%;background:linear-gradient(90deg,#10B981,#34D399);}
.rhi{left:68%;width:32%;background:linear-gradient(90deg,#F59E0B,#EF4444);}
.rneedle{position:absolute;top:-4px;width:14px;height:14px;border-radius:50%;background:#fff;border:3px solid var(--acc);transform:translateX(-50%);transition:left .5s ease;box-shadow:0 2px 8px rgba(0,0,0,.4);}
.raxis{display:flex;justify-content:space-between;margin-top:5px;font-size:10px;color:var(--t3);font-family:'DM Mono',monospace;}

/* â”€â”€ STATS ROW â”€â”€ */
.strow{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.st{background:var(--card);border:1px solid var(--border);border-radius:var(--rs);padding:14px;text-align:center;}
.stv{font-size:22px;font-weight:700;font-variant-numeric:tabular-nums;}
.stl{font-size:10px;color:var(--t3);margin-top:3px;font-weight:500;}

/* â”€â”€ ALERT CARD â”€â”€ */
.alert-card{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:var(--rs);padding:12px 14px;display:flex;align-items:center;gap:10px;font-size:13px;font-weight:500;color:var(--low2);}
.alert-card.warn{background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.2);color:var(--hi2);}
.alert-ic{font-size:18px;}

/* â”€â”€ CHART â”€â”€ */
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px;}
.chart-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.chart-title{font-size:13px;font-weight:600;}
.chart-sub{font-size:11px;color:var(--t3);}
.chart-wrap{position:relative;height:160px;}
canvas{display:block;}
.chart-empty{height:160px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--t3);}

/* â”€â”€ HISTORY LIST â”€â”€ */
.hist-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:0 18px;}
.hist-hd{font-size:11px;font-weight:600;color:var(--t3);letter-spacing:.07em;text-transform:uppercase;padding:16px 0 10px;}
.hi-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-top:1px solid var(--border);}
.hi-ic{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.hi-main{flex:1;}
.hi-ctx{font-size:13px;font-weight:600;}
.hi-time{font-size:11px;color:var(--t3);margin-top:2px;}
.hi-val{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums;}
.hi-u{font-size:10px;color:var(--t3);}
.empty{text-align:center;padding:28px;color:var(--t3);font-size:13px;}

/* â”€â”€ REFRESH BTN â”€â”€ */
.ref-btn{width:100%;padding:12px;background:var(--card);border:1px solid var(--border2);border-radius:var(--rs);color:var(--t2);font-size:13px;font-weight:500;font-family:'DM Sans',sans-serif;cursor:pointer;transition:border-color .2s,color .2s;display:flex;align-items:center;justify-content:center;gap:8px;}
.ref-btn:hover{border-color:var(--acc);color:var(--acc2);}
.ref-ic{font-size:15px;}

/* â”€â”€ API NOTICE â”€â”€ */
.api-notice{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.15);border-radius:var(--rs);padding:12px 14px;font-size:11px;color:var(--t2);line-height:1.6;}
.api-notice strong{color:var(--acc2);}
.api-notice code{font-family:'DM Mono',monospace;background:var(--card2);padding:1px 5px;border-radius:4px;color:var(--text);font-size:10px;}
</style>
</head>
<body>

<div class="tw" id="tw"></div>

<!-- â•â• CONNECT SCREEN â•â• -->
<div id="con">
  <div class="clogo">
    <div class="clogo-icon">ğŸ‘ï¸</div>
    <div class="clogo-title">GlucoTrack <span>View</span></div>
    <div class="clogo-sub">Caregiver & clinician companion</div>
    <div class="clogo-badge">READ-ONLY MONITORING</div>
  </div>

  <div class="ccard">
    <div class="ccard-lbl">Enter Patient Share Token</div>
    <div class="tkwrap">
      <input class="tk" id="tokenInput" placeholder="e.g.  GT-A3F9-K2M7" maxlength="14" autocomplete="off" spellcheck="false">
    </div>
    <button class="cbtn" id="connectBtn" onclick="doConnect()">Connect to Patient</button>

    <div class="cdiv"><div class="cdiv-l"></div><span>or</span><div class="cdiv-l"></div></div>
    <button class="dbtn" onclick="loadDemo()">ğŸ”® Load Demo Patient</button>
  </div>

  <div class="cnote">
    The patient generates a token in <strong>GlucoTrack â†’ Settings â†’ Share Access</strong>.<br>
    This app reads their data in real-time via your API.<br>
    <br>
    Currently using <strong>localStorage bridge</strong> for local testing.<br>
    Swap <code>fetchPatientData()</code> for a real API call when ready.
  </div>
</div>

<!-- â•â• MAIN VIEW â•â• -->
<div class="tb" id="topbar" style="display:none;">
  <div class="tb-logo">GlucoTrack <span>View</span> <em>LIVE</em></div>
  <div class="tb-r">
    <div class="tb-live"><div class="tb-dot"></div>Live</div>
    <button class="tb-disc" onclick="disconnect()">Disconnect</button>
  </div>
</div>

<div class="scroll" id="mainScroll" style="display:none;">

  <!-- patient header -->
  <div class="ph" id="patientHeader">
    <div class="ph-av" id="patAv">ğŸ‘¤</div>
    <div>
      <div class="ph-name" id="patName">â€”</div>
      <div class="ph-meta" id="patMeta">â€”</div>
      <div class="ph-tok" id="patTok">â€”</div>
    </div>
  </div>

  <!-- alert (shown if out of range) -->
  <div class="alert-card" id="alertCard" style="display:none;">
    <div class="alert-ic" id="alertIc">âš ï¸</div>
    <div id="alertMsg">â€”</div>
  </div>

  <!-- glucose card -->
  <div class="gc">
    <div class="gc-top">
      <div class="gc-lbl">Current Glucose</div>
      <div class="gc-badge b-none" id="statusBadge"><div class="bdot"></div><span id="statusTxt">â€”</span></div>
    </div>
    <div class="gc-row">
      <div class="gc-num n-none" id="mainNum">â€”</div>
      <div>
        <div class="gc-unit">mmol/L</div>
        <div class="gc-trend" id="trendArrow">â€”</div>
      </div>
    </div>
    <div class="gc-meta">
      <div class="gc-time" id="lastTime">No readings</div>
      <div>Target: <span id="targetRange">3.9 â€“ 10.0</span></div>
    </div>
    <div class="rbar">
      <div class="rtrack">
        <div class="rtrack-fill rlow"></div>
        <div class="rtrack-fill rok"></div>
        <div class="rtrack-fill rhi"></div>
        <div class="rneedle" id="needle" style="left:50%"></div>
      </div>
      <div class="raxis"><span>3.0</span><span>3.9</span><span>7.8</span><span>10.0</span><span>16+</span></div>
    </div>
  </div>

  <!-- stats -->
  <div class="strow">
    <div class="st"><div class="stv" id="sAvg">â€”</div><div class="stl">Avg Today</div></div>
    <div class="st"><div class="stv" id="sTIR">â€”%</div><div class="stl">Time In Range</div></div>
    <div class="st"><div class="stv" id="sCnt">0</div><div class="stl">Readings</div></div>
  </div>

  <!-- chart -->
  <div class="chart-card">
    <div class="chart-hd">
      <div>
        <div class="chart-title">Glucose History</div>
        <div class="chart-sub" id="chartSub">Last 6 hours</div>
      </div>
    </div>
    <div class="chart-wrap" id="chartWrap">
      <div class="chart-empty" id="chartEmpty">No data yet</div>
      <canvas id="mainChart" style="display:none;"></canvas>
    </div>
  </div>

  <!-- recent readings -->
  <div class="hist-card">
    <div class="hist-hd">Recent Readings</div>
    <div id="histList"><div class="empty">No readings yet</div></div>
  </div>

  <!-- refresh -->
  <button class="ref-btn" onclick="refresh()">
    <span class="ref-ic">ğŸ”„</span> <span id="refTxt">Refresh</span>
  </button>

  <!-- api notice -->
  <div class="api-notice">
    <strong>Developer note:</strong> This app currently reads from <code>localStorage</code> (same-browser bridge with the GlucoTrack patient app). To connect over the internet, replace <code>fetchPatientData(token)</code> in the JS with a call to your backend API, e.g. <code>GET /api/share/{token}</code>.
  </div>

</div><!-- /scroll -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA LAYER â€” swap this function for real API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function fetchPatientData(token) {
  // â”€â”€ OPTION A: localStorage bridge (same browser, for testing) â”€â”€
  // The main GlucoTrack app stores data under keys like gt_readings_<userId>
  // We expose a share token â†’ userId mapping here for demo.

  if (token === 'DEMO') return getDemoData();

  // Try to find matching share token in localStorage
  // (In production: do a fetch to your API instead)
  const users = JSON.parse(localStorage.getItem('gt_users') || '[]');
  const shareMap = JSON.parse(localStorage.getItem('gt_shareTokens') || '{}');
  const userId = shareMap[token];

  if (!userId) {
    // â”€â”€ OPTION B (production): uncomment and fill your API URL â”€â”€
    // const res = await fetch(`https://your-api.com/share/${token}`);
    // if (!res.ok) throw new Error('Invalid token');
    // return await res.json();
    throw new Error('Token not found. Use DEMO to test.');
  }

  const user = users.find(u => u.id === userId);
  const readings = JSON.parse(localStorage.getItem(`gt_readings_${userId}`) || '[]');
  const cfg = JSON.parse(localStorage.getItem(`gt_cfg_${userId}`) || '{"low":3.9,"high":10.0}');

  return { user, readings, cfg };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEMO DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getDemoData() {
  const now = Date.now();
  const hr = 3600000;
  const readings = [];
  // Simulate 12h of readings with realistic glucose curve
  const base = [5.2,5.0,4.8,5.1,5.3,7.8,9.2,8.5,7.1,6.3,5.8,5.5,
                 5.2,5.0,3.6,4.2,5.1,5.4,8.9,10.2,9.8,8.3,7.2,6.5];
  base.forEach((v,i) => {
    readings.push({
      ts: now - (23-i)*30*60*1000 + Math.random()*5*60*1000,
      value: v + (Math.random()-.5)*.3,
      context: ['Before Meal','After Meal','Random Check','Before Meal','After Meal'][i%5],
      isMealOnly: false
    });
  });
  readings.sort((a,b) => a.ts - b.ts);
  return {
    user: { firstName:'Sipho', lastName:'Dlamini', email:'sipho@demo.com', dob:'1988-04-12' },
    readings,
    cfg: { low:3.9, high:10.0 }
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let patient = null;
let readings = [];
let cfg = { low:3.9, high:10.0 };
let currentToken = '';
let refreshTimer = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONNECT / DISCONNECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function doConnect() {
  const raw = document.getElementById('tokenInput').value.trim().toUpperCase().replace(/\s/g,'');
  if (!raw) { toast('Enter a share token', 'err'); return; }
  const btn = document.getElementById('connectBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span>Connectingâ€¦';
  try {
    const data = await fetchPatientData(raw);
    currentToken = raw;
    applyData(data);
    showMain();
    toast('Connected to patient âœ“', 'suc');
    startAutoRefresh();
  } catch(e) {
    toast(e.message || 'Connection failed', 'err');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Connect to Patient';
  }
}

function loadDemo() {
  document.getElementById('tokenInput').value = 'DEMO';
  doConnect();
}

function disconnect() {
  clearInterval(refreshTimer);
  patient = null; readings = [];
  document.getElementById('topbar').style.display = 'none';
  document.getElementById('mainScroll').style.display = 'none';
  document.getElementById('con').classList.remove('gone');
  document.getElementById('tokenInput').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APPLY DATA â†’ UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function applyData(data) {
  patient = data.user;
  readings = (data.readings || []).filter(r => !r.isMealOnly && r.value > 0);
  cfg = data.cfg || { low:3.9, high:10.0 };
  renderAll();
}

function renderAll() {
  renderPatient();
  renderGlucose();
  renderStats();
  renderChart();
  renderHistory();
}

function renderPatient() {
  if (!patient) return;
  const age = patient.dob ? Math.floor((Date.now() - new Date(patient.dob)) / 31557600000) : 'â€”';
  document.getElementById('patName').textContent = patient.firstName + ' ' + patient.lastName;
  document.getElementById('patMeta').textContent = `${age} years Â· ${patient.email}`;
  document.getElementById('patTok').textContent = 'Token: ' + currentToken;
  document.getElementById('patAv').textContent = patient.firstName?.[0] + (patient.lastName?.[0] || '');
}

function renderGlucose() {
  const bgR = readings.slice().sort((a,b) => a.ts - b.ts);
  const alertCard = document.getElementById('alertCard');

  if (!bgR.length) {
    document.getElementById('mainNum').textContent = 'â€”';
    document.getElementById('mainNum').className = 'gc-num n-none';
    document.getElementById('statusBadge').className = 'gc-badge b-none';
    document.getElementById('statusTxt').textContent = 'â€”';
    document.getElementById('trendArrow').textContent = 'â€”';
    document.getElementById('lastTime').textContent = 'No readings';
    document.getElementById('needle').style.left = '50%';
    alertCard.style.display = 'none';
    return;
  }

  const lat = bgR[bgR.length - 1];
  const v = lat.value;
  const st = getStatus(v);

  document.getElementById('mainNum').textContent = fmt(v);
  document.getElementById('mainNum').className = 'gc-num ' + st.nc;
  document.getElementById('statusBadge').className = 'gc-badge ' + st.bc;
  document.getElementById('statusTxt').textContent = st.txt;
  document.getElementById('lastTime').textContent = tSince(lat.ts);
  document.getElementById('targetRange').textContent = fmt(cfg.low) + ' â€“ ' + fmt(cfg.high);

  // trend
  let trend = 'â†’';
  if (bgR.length >= 2) {
    const d = v - bgR[bgR.length-2].value;
    trend = d > 1.5 ? 'â†‘â†‘' : d > 0.5 ? 'â†‘' : d < -1.5 ? 'â†“â†“' : d < -0.5 ? 'â†“' : 'â†’';
  }
  document.getElementById('trendArrow').textContent = trend;

  // needle (3.0â€“16.7 range)
  const pct = Math.min(Math.max((v - 3.0) / (16.7 - 3.0), 0), 1) * 100;
  document.getElementById('needle').style.left = pct + '%';

  // alert
  if (st.cls === 'low') {
    alertCard.className = 'alert-card';
    alertCard.style.display = 'flex';
    document.getElementById('alertIc').textContent = 'ğŸ”´';
    document.getElementById('alertMsg').textContent = `Low glucose alert: ${fmt(v)} mmol/L â€” below target of ${fmt(cfg.low)}`;
  } else if (st.cls === 'vhi' || st.cls === 'hi') {
    alertCard.className = 'alert-card warn';
    alertCard.style.display = 'flex';
    document.getElementById('alertIc').textContent = 'ğŸŸ¡';
    document.getElementById('alertMsg').textContent = `High glucose: ${fmt(v)} mmol/L â€” above target of ${fmt(cfg.high)}`;
  } else {
    alertCard.style.display = 'none';
  }
}

function renderStats() {
  const today = new Date(); today.setHours(0,0,0,0);
  const todayR = readings.filter(r => r.ts >= today.getTime() && r.value > 0);

  if (!todayR.length) {
    document.getElementById('sAvg').textContent = 'â€”';
    document.getElementById('sTIR').textContent = 'â€”%';
    document.getElementById('sCnt').textContent = '0';
    return;
  }

  const avg = todayR.reduce((s,r) => s + r.value, 0) / todayR.length;
  const inR = todayR.filter(r => r.value >= cfg.low && r.value <= cfg.high).length;
  const tir = Math.round((inR / todayR.length) * 100);

  document.getElementById('sAvg').textContent = fmt(avg);
  document.getElementById('sAvg').style.color = getStatus(avg).col;
  document.getElementById('sTIR').textContent = tir + '%';
  document.getElementById('sTIR').style.color = tir >= 70 ? 'var(--ok2)' : tir >= 50 ? 'var(--hi2)' : 'var(--low2)';
  document.getElementById('sCnt').textContent = todayR.length;
}

function renderChart() {
  const cv = document.getElementById('mainChart');
  const wrap = document.getElementById('chartWrap');
  const empty = document.getElementById('chartEmpty');
  const cutoff = Date.now() - 6 * 3600000;
  const data = readings.filter(r => r.ts >= cutoff && r.value > 0).sort((a,b) => a.ts - b.ts);

  if (data.length < 2) {
    cv.style.display = 'none'; empty.style.display = 'flex'; return;
  }
  cv.style.display = 'block'; empty.style.display = 'none';

  const dpr = window.devicePixelRatio || 1;
  const W = wrap.offsetWidth, H = 160;
  cv.width = W * dpr; cv.height = H * dpr;
  cv.style.width = W + 'px'; cv.style.height = H + 'px';
  const ctx = cv.getContext('2d'); ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const vals = data.map(r => r.value);
  const mn = Math.max(2, Math.min(...vals) - 1);
  const mx = Math.max(...vals) + 1.5;
  const tx = i => (i / (data.length - 1)) * (W - 20) + 10;
  const ty = v => H - 20 - ((v - mn) / (mx - mn)) * (H - 30);

  // target zone
  const tyLow = ty(cfg.low), tyHigh = ty(cfg.high);
  ctx.fillStyle = 'rgba(16,185,129,0.07)';
  ctx.fillRect(10, tyHigh, W - 20, tyLow - tyHigh);
  ctx.strokeStyle = 'rgba(16,185,129,0.15)';
  ctx.lineWidth = 1;
  ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(10, tyLow); ctx.lineTo(W-10, tyLow); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(10, tyHigh); ctx.lineTo(W-10, tyHigh); ctx.stroke();
  ctx.setLineDash([]);

  // gradient fill
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, 'rgba(59,130,246,0.25)');
  grad.addColorStop(1, 'rgba(59,130,246,0)');
  ctx.beginPath();
  data.forEach((r,i) => i===0 ? ctx.moveTo(tx(i), ty(r.value)) : ctx.lineTo(tx(i), ty(r.value)));
  ctx.lineTo(tx(data.length-1), H); ctx.lineTo(tx(0), H); ctx.closePath();
  ctx.fillStyle = grad; ctx.fill();

  // line
  ctx.beginPath();
  data.forEach((r,i) => {
    const x = tx(i), y = ty(r.value);
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#3B82F6'; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.stroke();

  // dots
  data.forEach((r,i) => {
    const s = getStatus(r.value);
    ctx.beginPath();
    ctx.arc(tx(i), ty(r.value), i===data.length-1?5:3, 0, Math.PI*2);
    ctx.fillStyle = s.col; ctx.fill();
  });
}

function renderHistory() {
  const list = document.getElementById('histList');
  const bgR = readings.slice().sort((a,b) => b.ts - a.ts).slice(0,10);
  if (!bgR.length) { list.innerHTML = '<div class="empty">No readings yet</div>'; return; }

  const CTX_IC = {'Before Meal':'ğŸ½ï¸','After Meal':'ğŸ´','Before Exercise':'ğŸ‹ï¸','After Exercise':'ğŸ’ª','Before Bed':'ğŸ˜´','Waking Up':'â˜€ï¸','Feeling Unwell':'ğŸ¤’','Random Check':'ğŸ©º','Meal':'ğŸ½ï¸'};
  const CTX_CL = {'Before Meal':'#3B82F6','After Meal':'#8B5CF6','Random Check':'#6B7280'};

  list.innerHTML = bgR.map(r => {
    const s = getStatus(r.value);
    const ic = CTX_IC[r.context] || 'ğŸ©º';
    const cl = CTX_CL[r.context] || '#4A5D80';
    return `<div class="hi-row">
      <div class="hi-ic" style="background:${cl}22">${ic}</div>
      <div class="hi-main">
        <div class="hi-ctx">${r.context || 'Reading'}</div>
        <div class="hi-time">${fD(r.ts)} Â· ${fT(r.ts)}</div>
      </div>
      <div style="text-align:right">
        <div class="hi-val" style="color:${s.col}">${fmt(r.value)}</div>
        <div class="hi-u">mmol/L</div>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function startAutoRefresh() {
  clearInterval(refreshTimer);
  refreshTimer = setInterval(refresh, 60000); // every 60s
}

async function refresh() {
  if (!currentToken) return;
  const btn = document.getElementById('refTxt');
  btn.textContent = 'Refreshingâ€¦';
  try {
    const data = await fetchPatientData(currentToken);
    applyData(data);
    btn.textContent = 'Refreshed âœ“';
    setTimeout(() => btn.textContent = 'Refresh', 2000);
  } catch(e) {
    btn.textContent = 'Refresh failed';
    setTimeout(() => btn.textContent = 'Refresh', 2000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getStatus(v) {
  if (v < cfg.low) return { cls:'low', nc:'n-low', bc:'b-low', txt:'LOW', col:'var(--low2)' };
  if (v <= cfg.high) return { cls:'ok', nc:'n-ok', bc:'b-ok', txt:'IN RANGE', col:'var(--ok2)' };
  if (v <= 13.9) return { cls:'hi', nc:'n-hi', bc:'b-hi', txt:'HIGH', col:'var(--hi2)' };
  return { cls:'vhi', nc:'n-hi', bc:'b-low', txt:'VERY HIGH', col:'var(--low2)' };
}

function fmt(v) { return (Math.round(v*10)/10).toFixed(1); }

function tSince(ts) {
  const s = (Date.now()-ts)/1000;
  if (s<60) return 'Just now';
  if (s<3600) return Math.round(s/60)+'m ago';
  if (s<86400) return Math.round(s/3600)+'h ago';
  return Math.round(s/86400)+'d ago';
}

function fT(ts) { return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }

function fD(ts) {
  const d=new Date(ts), t=new Date(); t.setHours(0,0,0,0);
  const y=new Date(t); y.setDate(t.getDate()-1);
  if (d>=t) return 'Today'; if (d>=y) return 'Yesterday';
  return d.toLocaleDateString([],{weekday:'short',month:'short',day:'numeric'});
}

function showMain() {
  document.getElementById('con').classList.add('gone');
  document.getElementById('topbar').style.display = 'flex';
  document.getElementById('mainScroll').style.display = 'flex';
  setTimeout(() => {
    renderChart();
    window.scrollTo(0,0);
  }, 100);
}

function toast(msg, type='') {
  const wrap = document.getElementById('tw');
  const el = document.createElement('div');
  el.className = 't ' + type;
  el.textContent = msg;
  wrap.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// Token formatting
document.getElementById('tokenInput').addEventListener('input', function() {
  let v = this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
  if (v.length > 2 && !v.includes('-')) {
    v = v.slice(0,2) + '-' + v.slice(2);
  }
  if (v.length > 7) v = v.slice(0,7) + '-' + v.slice(7);
  this.value = v.slice(0,14);
});

document.getElementById('tokenInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doConnect();
});

window.addEventListener('resize', () => { if (patient) renderChart(); });
</script>
</body>
</html>
