<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>GlucoTrack View â€” Clinical Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --ink:#0A0E1A;--ink2:#3D4663;--ink3:#7C84A0;
  --paper:#F7F8FC;--white:#FFFFFF;
  --border:#E1E4EF;--border2:#C8CCDE;
  --low:#D93025;--low-bg:#FEF2F0;--low-b:#F5B8B3;
  --ok:#1A7A4A;--ok-bg:#EDF7F2;--ok-b:#86C9A7;
  --hi:#C47700;--hi-bg:#FDF6E3;--hi-b:#F0C97A;
  --vhi:#A61010;--vhi-bg:#FEF0EE;
  --acc:#1E4FD8;--acc2:#1840B0;--acc-bg:#EEF2FD;--acc-b:#9DB5F5;
  --crit:#C0001A;--warn:#C47700;--good:#1A7A4A;
  --sh:0 1px 4px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --sh2:0 4px 20px rgba(0,0,0,.09);
  --r:12px;
}
html,body{height:100%;background:var(--paper);color:var(--ink);font-family:'DM Sans',sans-serif;}

/* â”€â”€ LAYOUT â”€â”€ */
.app{display:grid;grid-template-rows:60px 1fr;grid-template-columns:260px 1fr;height:100vh;overflow:hidden;}
.topbar{grid-column:1/-1;background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:20px;z-index:100;}
.sidebar{background:var(--white);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column;}
.main{overflow-y:auto;padding:24px;}

/* â”€â”€ TOPBAR â”€â”€ */
.logo-mark{width:32px;height:32px;background:var(--acc);border-radius:8px;display:flex;align-items:center;justify-content:center;}
.logo-mark svg{width:18px;height:18px;fill:none;stroke:#fff;stroke-width:2.2;stroke-linecap:round;}
.logo-text{font-family:'DM Serif Display',serif;font-size:18px;color:var(--ink);letter-spacing:-.3px;}
.logo-text em{font-style:italic;color:var(--acc);}
.logo-badge{font-size:10px;font-weight:600;color:var(--acc);background:var(--acc-bg);padding:2px 8px;border-radius:20px;border:1px solid var(--acc-b);font-family:'DM Mono',monospace;letter-spacing:.04em;margin-left:2px;}
.tb-sep{width:1px;height:28px;background:var(--border);margin:0 4px;}
.tb-meta{font-size:12px;color:var(--ink3);font-family:'DM Mono',monospace;}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:12px;}
.tb-doc{display:flex;align-items:center;gap:8px;}
.tb-avatar{width:32px;height:32px;border-radius:50%;background:var(--acc-bg);border:2px solid var(--acc-b);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--acc);}
.tb-doc-name{font-size:13px;font-weight:600;}
.tb-doc-role{font-size:11px;color:var(--ink3);}
.live-dot{width:7px;height:7px;border-radius:50%;background:#1A7A4A;box-shadow:0 0 0 3px rgba(26,122,74,.2);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 0 3px rgba(26,122,74,.2)}50%{box-shadow:0 0 0 6px rgba(26,122,74,.05)}}

/* â”€â”€ SIDEBAR â”€â”€ */
.sb-section{padding:16px 12px 8px;font-size:10px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.1em;font-family:'DM Mono',monospace;}
.sb-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:9px;margin:1px 8px;cursor:pointer;font-size:13px;font-weight:500;color:var(--ink2);transition:all .15s;border:none;background:none;width:calc(100% - 16px);text-align:left;}
.sb-item:hover{background:var(--paper);color:var(--ink);}
.sb-item.active{background:var(--acc-bg);color:var(--acc);}
.sb-ic{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;background:var(--paper);flex-shrink:0;}
.sb-item.active .sb-ic{background:var(--white);}
.sb-badge{margin-left:auto;min-width:18px;height:18px;padding:0 5px;border-radius:9px;background:var(--crit);color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;}
.sb-footer{margin-top:auto;padding:16px;border-top:1px solid var(--border);}
.sb-footer-txt{font-size:11px;color:var(--ink3);line-height:1.6;}

/* â”€â”€ SCREEN â”€â”€ */
.screen{display:none;}
.screen.active{display:block;}

/* â”€â”€ PATIENT IMPORT / CONNECT â”€â”€ */
.connect-banner{background:linear-gradient(135deg,#1E4FD8,#1840B0);border-radius:var(--r);padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;gap:16px;color:#fff;}
.connect-banner h3{font-size:16px;font-weight:600;margin-bottom:3px;}
.connect-banner p{font-size:12px;opacity:.75;line-height:1.5;}
.connect-icon{font-size:32px;flex-shrink:0;}
.connect-input-row{display:flex;gap:8px;margin-top:12px;}
.connect-in{flex:1;padding:8px 12px;border-radius:8px;border:1.5px solid rgba(255,255,255,.3);background:rgba(255,255,255,.12);color:#fff;font-size:13px;font-family:'DM Mono',monospace;outline:none;}
.connect-in::placeholder{color:rgba(255,255,255,.5);}
.connect-in:focus{border-color:rgba(255,255,255,.7);}
.connect-btn{padding:8px 16px;border-radius:8px;background:#fff;border:none;color:var(--acc);font-size:13px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;white-space:nowrap;}
.connect-btn:hover{background:#f0f4ff;}

/* â”€â”€ PATIENT CARDS â”€â”€ */
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-title{font-family:'DM Serif Display',serif;font-size:20px;letter-spacing:-.3px;}
.section-sub{font-size:12px;color:var(--ink3);margin-top:2px;}
.sort-row{display:flex;gap:6px;}
.sort-btn{padding:5px 11px;border-radius:7px;border:1px solid var(--border);background:var(--white);font-size:11px;font-weight:600;color:var(--ink3);cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;}
.sort-btn.active{background:var(--acc);color:#fff;border-color:var(--acc);}

.patient-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;margin-bottom:20px;}

.pcard{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;cursor:pointer;transition:all .2s;box-shadow:var(--sh);position:relative;overflow:hidden;}
.pcard::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--ok);}
.pcard.status-low::before{background:var(--low);}
.pcard.status-hi::before{background:var(--hi);}
.pcard.status-vhi::before{background:var(--vhi);}
.pcard.status-ok::before{background:var(--ok);}
.pcard.status-none::before{background:var(--border);}
.pcard:hover{box-shadow:var(--sh2);transform:translateY(-1px);}
.pcard.alert{border-color:var(--low-b);background:var(--low-bg);}
.pcard.alert::before{background:var(--low);animation:alertPulse 1.5s infinite;}
@keyframes alertPulse{0%,100%{opacity:1}50%{opacity:.4}}

.pc-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.pc-name{font-size:14px;font-weight:700;letter-spacing:-.2px;}
.pc-id{font-size:10px;color:var(--ink3);font-family:'DM Mono',monospace;margin-top:2px;}
.pc-badge{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;border:1px solid;}
.pc-badge.ok{background:var(--ok-bg);color:var(--ok);border-color:var(--ok-b);}
.pc-badge.low{background:var(--low-bg);color:var(--low);border-color:var(--low-b);}
.pc-badge.hi{background:var(--hi-bg);color:var(--hi);border-color:var(--hi-b);}
.pc-badge.vhi{background:var(--vhi-bg);color:var(--vhi);border-color:var(--low-b);}
.pc-badge.none{background:var(--paper);color:var(--ink3);border-color:var(--border);}
.bdot-sm{width:5px;height:5px;border-radius:50%;background:currentColor;}

.pc-glucose-row{display:flex;align-items:baseline;gap:4px;margin-bottom:8px;}
.pc-gl-num{font-size:36px;font-weight:700;letter-spacing:-1.5px;font-family:'DM Mono',monospace;line-height:1;}
.pc-gl-num.ok{color:var(--ok);}
.pc-gl-num.low{color:var(--low);}
.pc-gl-num.hi{color:var(--hi);}
.pc-gl-num.vhi{color:var(--vhi);}
.pc-gl-num.none{color:var(--ink3);font-size:26px;}
.pc-gl-unit{font-size:11px;color:var(--ink3);font-family:'DM Mono',monospace;}
.pc-gl-trend{font-size:20px;margin-left:4px;}

.pc-spark{width:100%;height:28px;margin-bottom:8px;}
.pc-spark canvas{width:100%;height:100%;}

.pc-meta{display:flex;gap:10px;}
.pc-stat{flex:1;background:var(--paper);border-radius:7px;padding:6px 8px;}
.pc-stat-val{font-size:14px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:-.5px;}
.pc-stat-lbl{font-size:9px;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-top:1px;}

.pc-time{font-size:10px;color:var(--ink3);font-family:'DM Mono',monospace;margin-top:8px;display:flex;align-items:center;justify-content:space-between;}
.pc-alert-txt{font-size:11px;font-weight:700;color:var(--crit);margin-top:6px;display:flex;align-items:center;gap:4px;}

/* â”€â”€ PATIENT DETAIL PANEL â”€â”€ */
.detail-panel{position:fixed;top:60px;right:0;width:500px;height:calc(100vh - 60px);background:var(--white);border-left:1px solid var(--border);box-shadow:-4px 0 24px rgba(0,0,0,.1);z-index:50;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);overflow-y:auto;display:flex;flex-direction:column;}
.detail-panel.open{transform:translateX(0);}
.dp-top{padding:20px 24px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--white);z-index:10;}
.dp-close{position:absolute;top:16px;right:16px;width:30px;height:30px;border-radius:50%;background:var(--paper);border:none;cursor:pointer;font-size:14px;color:var(--ink3);display:flex;align-items:center;justify-content:center;}
.dp-close:hover{background:var(--border);}
.dp-name{font-family:'DM Serif Display',serif;font-size:22px;letter-spacing:-.4px;margin-bottom:2px;}
.dp-info{font-size:12px;color:var(--ink3);font-family:'DM Mono',monospace;}
.dp-body{padding:20px 24px;flex:1;}
.dp-hero{display:flex;align-items:baseline;gap:8px;margin-bottom:4px;}
.dp-gl-num{font-size:64px;font-weight:700;letter-spacing:-3px;line-height:1;font-family:'DM Mono',monospace;}
.dp-gl-num.ok{color:var(--ok);}
.dp-gl-num.low{color:var(--low);}
.dp-gl-num.hi{color:var(--hi);}
.dp-gl-num.vhi{color:var(--vhi);}
.dp-gl-num.none{color:var(--ink3);}
.dp-gl-side{display:flex;flex-direction:column;gap:4px;padding-bottom:10px;}
.dp-trend{font-size:22px;}
.dp-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:700;border:1px solid;font-family:'DM Mono',monospace;}
.dp-badge.ok{background:var(--ok-bg);color:var(--ok);border-color:var(--ok-b);}
.dp-badge.low{background:var(--low-bg);color:var(--low);border-color:var(--low-b);}
.dp-badge.hi{background:var(--hi-bg);color:var(--hi);border-color:var(--hi-b);}
.dp-badge.vhi{background:var(--vhi-bg);color:var(--vhi);border-color:var(--low-b);}
.dp-time{font-size:11px;color:var(--ink3);font-family:'DM Mono',monospace;margin-bottom:16px;}
.dp-range{height:5px;border-radius:3px;background:linear-gradient(90deg,#D93025 0%,#D93025 18%,#1A7A4A 23%,#1A7A4A 65%,#C47700 70%,#C47700 88%,#D93025 93%,#D93025 100%);position:relative;margin-bottom:16px;}
.dp-needle{position:absolute;top:-4px;width:2px;height:13px;background:var(--ink);border-radius:2px;transform:translateX(-50%);transition:left .5s;}
.dp-range-axis{display:flex;justify-content:space-between;margin-top:3px;margin-bottom:16px;}
.dp-range-axis span{font-size:9px;color:var(--ink3);font-family:'DM Mono',monospace;}
.dp-stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px;}
.dp-stat{background:var(--paper);border-radius:9px;padding:10px 12px;}
.dp-stat-val{font-size:20px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:-.5px;}
.dp-stat-lbl{font-size:10px;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em;margin-top:2px;}
.dp-chart-wrap{width:100%;height:160px;position:relative;margin-bottom:16px;}
.dp-chart-wrap canvas{width:100%;height:100%;}
.dp-chart-tooltip{position:absolute;background:rgba(10,14,26,.9);color:#fff;border-radius:7px;padding:7px 10px;font-size:11px;pointer-events:none;opacity:0;transition:opacity .15s;white-space:nowrap;transform:translateX(-50%);z-index:5;}
.dp-section-title{font-size:11px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;}

/* TIR */
.tir-bars{display:flex;flex-direction:column;gap:6px;margin-bottom:16px;}
.tir-row{display:flex;align-items:center;gap:8px;}
.tir-lbl{font-size:11px;font-weight:600;width:52px;}
.tir-bar{flex:1;height:6px;background:var(--paper);border-radius:3px;overflow:hidden;}
.tir-fill{height:100%;border-radius:3px;transition:width .6s ease;}
.tir-pct{font-size:11px;font-weight:700;width:32px;text-align:right;font-family:'DM Mono',monospace;}

/* READINGS LIST */
.readings-list{display:flex;flex-direction:column;gap:0;}
.rl-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
.rl-item:last-child{border-bottom:none;}
.rl-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.rl-main{flex:1;min-width:0;}
.rl-ctx{font-size:12px;font-weight:600;}
.rl-time{font-size:10px;color:var(--ink3);font-family:'DM Mono',monospace;}
.rl-r{text-align:right;}
.rl-val{font-size:17px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:-.5px;}
.rl-unit{font-size:9px;color:var(--ink3);font-family:'DM Mono',monospace;}
.rl-extras{font-size:10px;color:var(--ink3);margin-top:1px;}

/* ALERTS SCREEN */
.alert-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:10px;display:flex;gap:14px;align-items:flex-start;cursor:pointer;transition:all .15s;}
.alert-card:hover{box-shadow:var(--sh2);}
.alert-card.crit{border-left:3px solid var(--crit);background:var(--low-bg);}
.alert-card.warn{border-left:3px solid var(--warn);background:var(--hi-bg);}
.alert-card.info{border-left:3px solid var(--acc);}
.alert-icon{font-size:22px;flex-shrink:0;margin-top:2px;}
.alert-body{flex:1;}
.alert-title{font-size:14px;font-weight:700;margin-bottom:3px;}
.alert-sub{font-size:12px;color:var(--ink2);line-height:1.5;}
.alert-time{font-size:10px;color:var(--ink3);margin-top:5px;font-family:'DM Mono',monospace;}
.alert-act{display:flex;gap:6px;margin-top:8px;}
.act-btn{padding:5px 12px;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;border:none;transition:all .15s;}
.act-primary{background:var(--acc);color:#fff;}
.act-primary:hover{background:var(--acc2);}
.act-ghost{background:var(--paper);color:var(--ink2);}
.act-ghost:hover{background:var(--border);}

/* ANALYTICS SCREEN */
.analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
.an-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);}
.an-card.full{grid-column:1/-1;}
.an-title{font-size:12px;font-weight:700;color:var(--ink2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;}
.an-num{font-size:38px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:-1.5px;line-height:1;}
.an-sub{font-size:12px;color:var(--ink3);margin-top:4px;}
.an-chart{width:100%;height:120px;position:relative;}
.an-chart canvas{width:100%;height:100%;}

/* NOTES */
.note-area{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--ink);resize:vertical;outline:none;min-height:80px;}
.note-area:focus{border-color:var(--acc);}
.save-note-btn{margin-top:8px;padding:8px 16px;background:var(--acc);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;}
.saved-note{background:var(--paper);border-radius:8px;padding:10px 12px;font-size:12px;color:var(--ink2);line-height:1.6;margin-bottom:8px;border:1px solid var(--border);}
.saved-note-meta{font-size:10px;color:var(--ink3);margin-bottom:4px;font-family:'DM Mono',monospace;}

/* EMPTY */
.empty-state{text-align:center;padding:40px 20px;color:var(--ink3);}
.empty-icon{font-size:36px;margin-bottom:10px;}
.empty-title{font-size:16px;font-weight:600;color:var(--ink2);margin-bottom:5px;}
.empty-sub{font-size:13px;line-height:1.6;}

/* SEARCH */
.search-wrap{position:relative;flex:1;max-width:300px;}
.search-ic{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--ink3);}
.search-in{width:100%;padding:7px 12px 7px 30px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;color:var(--ink);background:var(--paper);outline:none;}
.search-in:focus{border-color:var(--acc);background:var(--white);}

/* MODAL for load from device */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-bg.open{opacity:1;pointer-events:all;}
.modal{background:var(--white);border-radius:16px;padding:28px;width:440px;max-width:calc(100vw - 32px);box-shadow:0 20px 60px rgba(0,0,0,.2);}
.modal-title{font-family:'DM Serif Display',serif;font-size:22px;margin-bottom:6px;}
.modal-sub{font-size:13px;color:var(--ink3);margin-bottom:20px;line-height:1.5;}
.modal-drop{border:2px dashed var(--border2);border-radius:12px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px;}
.modal-drop:hover{border-color:var(--acc);background:var(--acc-bg);}
.modal-drop-ic{font-size:32px;margin-bottom:8px;}
.modal-drop-txt{font-size:13px;font-weight:600;color:var(--ink2);}
.modal-drop-sub{font-size:12px;color:var(--ink3);margin-top:3px;}
.modal-or{text-align:center;font-size:12px;color:var(--ink3);margin:10px 0;position:relative;}
.modal-or::before,.modal-or::after{content:'';position:absolute;top:50%;width:42%;height:1px;background:var(--border);}
.modal-or::before{left:0;}.modal-or::after{right:0;}
.modal-paste-area{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Mono',monospace;font-size:12px;color:var(--ink);resize:none;outline:none;height:80px;}
.modal-paste-area:focus{border-color:var(--acc);}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}
.mbtn{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;border:none;}
.mbtn-cancel{background:var(--paper);color:var(--ink2);}
.mbtn-cancel:hover{background:var(--border);}
.mbtn-ok{background:var(--acc);color:#fff;}
.mbtn-ok:hover{background:var(--acc2);}

/* Demo patient pills */
.demo-patients{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;}
.demo-pill{padding:6px 14px;border-radius:20px;border:1px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;background:var(--white);}
.demo-pill:hover{border-color:var(--acc);color:var(--acc);background:var(--acc-bg);}

@media(max-width:900px){
  .app{grid-template-columns:0 1fr;}
  .sidebar{display:none;}
  .detail-panel{width:100%;border-left:none;}
}
</style>
</head>
<body>
<div class="app">

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo-mark">
    <svg viewBox="0 0 24 24"><polyline points="4,12 8,7 12,15 16,10 20,12"/></svg>
  </div>
  <div>
    <div class="logo-text">GlucoTrack <em>View</em></div>
  </div>
  <div class="logo-badge">CLINICAL</div>
  <div class="tb-sep"></div>
  <div class="tb-meta" id="liveTime">â€”</div>
  <div class="live-dot" title="Live monitoring active"></div>
  <div class="tb-right">
    <div class="search-wrap">
      <div class="search-ic">ğŸ”</div>
      <input class="search-in" placeholder="Search patientsâ€¦" oninput="searchPatients(this.value)" id="searchInput">
    </div>
    <div class="tb-sep"></div>
    <div class="tb-doc">
      <div class="tb-avatar">DR</div>
      <div>
        <div class="tb-doc-name">Dr. Reviewer</div>
        <div class="tb-doc-role">Endocrinologist</div>
      </div>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sb-section">Monitoring</div>
  <button class="sb-item active" id="nav-patients" onclick="goTo('patients')"><div class="sb-ic">ğŸ‘¥</div>Patients <span class="sb-badge" id="alertBadge" style="display:none">0</span></button>
  <button class="sb-item" id="nav-alerts" onclick="goTo('alerts')"><div class="sb-ic">ğŸ””</div>Alerts <span class="sb-badge" id="alertBadge2" style="display:none">0</span></button>
  <button class="sb-item" id="nav-analytics" onclick="goTo('analytics')"><div class="sb-ic">ğŸ“Š</div>Analytics</button>
  <div class="sb-section">Actions</div>
  <button class="sb-item" onclick="openImportModal()"><div class="sb-ic">ğŸ“</div>Load Patient Data</button>
  <button class="sb-item" onclick="addDemoPatients()"><div class="sb-ic">ğŸ§ª</div>Load Demo Patients</button>
  <div class="sb-footer">
    <div class="sb-footer-txt">GlucoTrack View v1.0<br>Read-only clinical monitoring.<br>Not a medical device.</div>
  </div>
</div>

<!-- MAIN -->
<div class="main" id="mainArea">

  <!-- PATIENTS SCREEN -->
  <div class="screen active" id="screen-patients">
    <div class="connect-banner">
      <div class="connect-icon">ğŸ“¡</div>
      <div style="flex:1;">
        <h3>Connect Patient GlucoTrack</h3>
        <p>Paste a patient's exported GlucoTrack JSON or CSV data, or load it from a file to begin monitoring.</p>
        <div class="connect-input-row">
          <input class="connect-in" placeholder="Patient name or IDâ€¦" id="patientNameIn">
          <button class="connect-btn" onclick="openImportModal()">+ Add Patient</button>
        </div>
      </div>
    </div>

    <div class="section-head">
      <div>
        <div class="section-title">Patient Overview</div>
        <div class="section-sub" id="patientCount">No patients loaded</div>
      </div>
      <div class="sort-row">
        <button class="sort-btn active" onclick="sortPatients('alert',this)">Alerts First</button>
        <button class="sort-btn" onclick="sortPatients('name',this)">Name</button>
        <button class="sort-btn" onclick="sortPatients('glucose',this)">Glucose</button>
      </div>
    </div>

    <div class="patient-grid" id="patientGrid">
      <div class="empty-state" style="grid-column:1/-1">
        <div class="empty-icon">ğŸ‘¥</div>
        <div class="empty-title">No patients loaded</div>
        <div class="empty-sub">Click "Load Demo Patients" in the sidebar to see a demo,<br>or import a patient's GlucoTrack data.</div>
      </div>
    </div>
  </div>

  <!-- ALERTS SCREEN -->
  <div class="screen" id="screen-alerts">
    <div class="section-head">
      <div>
        <div class="section-title">Alerts & Notifications</div>
        <div class="section-sub" id="alertCount">No active alerts</div>
      </div>
    </div>
    <div id="alertsList"></div>
  </div>

  <!-- ANALYTICS SCREEN -->
  <div class="screen" id="screen-analytics">
    <div class="section-head">
      <div>
        <div class="section-title">Practice Analytics</div>
        <div class="section-sub">Population-level overview across all monitored patients</div>
      </div>
    </div>
    <div class="analytics-grid" id="analyticsGrid">
      <div class="empty-state" style="grid-column:1/-1">
        <div class="empty-icon">ğŸ“Š</div>
        <div class="empty-title">No data yet</div>
        <div class="empty-sub">Load patient data to see analytics.</div>
      </div>
    </div>
  </div>

</div><!-- /main -->

</div><!-- /app -->

<!-- DETAIL PANEL -->
<div class="detail-panel" id="detailPanel">
  <div class="dp-top">
    <button class="dp-close" onclick="closeDetail()">âœ•</button>
    <div class="dp-name" id="dpName">â€”</div>
    <div class="dp-info" id="dpInfo">â€”</div>
  </div>
  <div class="dp-body" id="dpBody"></div>
</div>

<!-- IMPORT MODAL -->
<div class="modal-bg" id="importModal">
  <div class="modal">
    <div class="modal-title">Load Patient Data</div>
    <div class="modal-sub">Import a patient's GlucoTrack readings. Supports JSON export from localStorage or CSV export from the app.</div>
    <div class="modal-drop" onclick="document.getElementById('fileIn').click()" id="dropZone">
      <div class="modal-drop-ic">ğŸ“‚</div>
      <div class="modal-drop-txt">Drop file here or click to browse</div>
      <div class="modal-drop-sub">Accepts .json or .csv files</div>
      <input type="file" id="fileIn" accept=".json,.csv" style="display:none" onchange="handleFileImport(event)">
    </div>
    <div class="modal-or">or paste JSON data</div>
    <textarea class="modal-paste-area" id="pasteArea" placeholder='[{"ts":...,"value":5.2,"context":"Before Meal",...}]'></textarea>
    <div style="margin-top:10px;">
      <label style="font-size:12px;font-weight:600;color:var(--ink2);display:block;margin-bottom:4px;">Patient Name</label>
      <input id="importName" type="text" placeholder="e.g. Sarah M." style="width:100%;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;">
    </div>
    <div class="modal-actions">
      <button class="mbtn mbtn-cancel" onclick="closeImportModal()">Cancel</button>
      <button class="mbtn mbtn-ok" onclick="importPatientData()">Import</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let patients = [];
let curScreen = 'patients';
let selectedPatient = null;
let sortMode = 'alert';
let patientNotes = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(v){ return v != null ? (Math.round(v*10)/10).toFixed(1) : 'â€”'; }
function getSt(v,lo=3.9,hi=10.0){
  if(v==null)return{cls:'none',txt:'NO DATA',col:'var(--ink3)'};
  if(v<lo)return{cls:'low',txt:'LOW',col:'var(--low)'};
  if(v<=hi)return{cls:'ok',txt:'IN RANGE',col:'var(--ok)'};
  if(v<=13.9)return{cls:'hi',txt:'HIGH',col:'var(--hi)'};
  return{cls:'vhi',txt:'VERY HIGH',col:'var(--vhi)'};
}
function tSince(ts){
  const s=(Date.now()-ts)/1e3;
  if(s<60)return 'Just now';
  if(s<3600)return Math.round(s/60)+'m ago';
  if(s<86400)return Math.round(s/3600)+'h ago';
  return Math.round(s/86400)+'d ago';
}
function fT(ts){return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function fD(ts){return new Date(ts).toLocaleDateString([],{month:'short',day:'numeric'});}
function calcA1c(avg){return (avg*1.5927+1.628).toFixed(1);}
function nPos(v,lo=3.9,hi=10.0){return Math.min(Math.max((v-3.0)/(16.7-3.0),.02),.98)*100+'%';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE TIME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTime(){
  const n=new Date();
  document.getElementById('liveTime').textContent=n.toLocaleDateString([],{weekday:'short',month:'short',day:'numeric'})+' Â· '+n.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
setInterval(updateTime,1000);updateTime();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTo(n){
  curScreen=n;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+n).classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i=>i.classList.remove('active'));
  const ni=document.getElementById('nav-'+n);if(ni)ni.classList.add('active');
  if(n==='analytics')renderAnalytics();
  if(n==='alerts')renderAlerts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATIENT DATA MODEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPatient(name, readings, id){
  const bgReadings = readings.filter(r=>!r.isMealOnly&&r.value!=null&&r.value>0);
  const lo = 3.9, hi = 10.0;
  const lat = bgReadings.length ? bgReadings[bgReadings.length-1] : null;
  const now = Date.now();
  const today = new Date(); today.setHours(0,0,0,0);
  const todayR = bgReadings.filter(r=>r.ts>=today.getTime());
  const r7 = bgReadings.filter(r=>r.ts>=now-7*86400000);
  const vals7 = r7.map(r=>r.value);
  const avg7 = vals7.length ? vals7.reduce((a,b)=>a+b,0)/vals7.length : null;
  const tir = vals7.length ? Math.round(vals7.filter(v=>v>=lo&&v<=hi).length/vals7.length*100) : null;
  let trend=0;
  if(bgReadings.length>=2){
    const p=bgReadings[bgReadings.length-2];
    const dtMin=(lat.ts-p.ts)/60000;
    if(dtMin>0&&dtMin<180)trend=(lat.value-p.value)/dtMin;
  }
  const trendArrow=trend>0.05?'â†‘â†‘':trend>0.02?'â†‘':trend<-0.05?'â†“â†“':trend<-0.02?'â†“':'â†’';
  const status = lat ? getSt(lat.value,lo,hi) : {cls:'none',txt:'NO DATA',col:'var(--ink3)'};
  const isAlert = lat && (lat.value<lo || lat.value>13.9);
  const isStale = lat ? (now-lat.ts)>3600000*4 : true;
  return {id,name,readings,bgReadings,lat,lo,hi,tir,avg7,vals7,trend,trendArrow,status,isAlert,isStale,todayR};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPARKLINE (patient card)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSparkCard(canvas, readings, lo=3.9, hi=10.0){
  if(!canvas)return;
  const W=canvas.parentElement.offsetWidth||120,H=28,dpr=window.devicePixelRatio||1;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const data=readings.filter(r=>!r.isMealOnly&&r.value>0).slice(-30);
  if(data.length<2)return;
  const vals=data.map(r=>r.value);
  const mn=Math.max(0,Math.min(...vals,lo)-.5),mx=Math.max(...vals,hi)+.5;
  const tx=(i)=>i/(data.length-1)*W;const ty=(v)=>H-(v-mn)/(mx-mn)*H;
  // target band
  ctx.fillStyle='rgba(26,122,74,.08)';ctx.fillRect(0,ty(hi),W,ty(lo)-ty(hi));
  // line
  ctx.beginPath();data.forEach((r,i)=>i===0?ctx.moveTo(tx(i),ty(r.value)):ctx.lineTo(tx(i),ty(r.value)));
  const s=getSt(data[data.length-1].value,lo,hi);
  const lc={ok:'#1A7A4A',low:'#D93025',hi:'#C47700',vhi:'#A61010',none:'#7C84A0'};
  ctx.strokeStyle=lc[s.cls]||lc.ok;ctx.lineWidth=1.5;ctx.lineJoin='round';ctx.stroke();
  // dot
  ctx.beginPath();ctx.arc(tx(data.length-1),ty(data[data.length-1].value),3,0,Math.PI*2);
  ctx.fillStyle=lc[s.cls]||lc.ok;ctx.fill();
  ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PATIENT GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPatients(filter=''){
  const grid=document.getElementById('patientGrid');
  let pts=[...patients];
  if(filter)pts=pts.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase()));
  if(sortMode==='alert')pts.sort((a,b)=>(b.isAlert-a.isAlert)||(a.status.cls==='none'?1:-1)||(b.lat?.value-a.lat?.value||0));
  else if(sortMode==='name')pts.sort((a,b)=>a.name.localeCompare(b.name));
  else if(sortMode==='glucose')pts.sort((a,b)=>(b.lat?.value||0)-(a.lat?.value||0));

  const alerts=pts.filter(p=>p.isAlert).length;
  document.getElementById('patientCount').textContent=pts.length+' patient'+(pts.length!==1?'s':'')+' Â· '+alerts+' alert'+(alerts!==1?'s':'');
  const ab=document.getElementById('alertBadge');
  const ab2=document.getElementById('alertBadge2');
  if(alerts>0){ab.style.display='flex';ab.textContent=alerts;ab2.style.display='flex';ab2.textContent=alerts;}
  else{ab.style.display='none';ab2.style.display='none';}

  if(!pts.length){
    grid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ğŸ”</div><div class="empty-title">No patients found</div></div>';
    return;
  }

  grid.innerHTML=pts.map(p=>{
    const s=p.status;
    const staleTxt=p.isStale?'<span style="color:var(--warn);">âš  Stale</span>':'';
    const latVal=p.lat?fmt(p.lat.value):'â€”';
    const sinceStr=p.lat?tSince(p.lat.ts):'No data';
    const tirStr=p.tir!=null?p.tir+'%':'â€”';
    const avgStr=p.avg7!=null?fmt(p.avg7):'â€”';
    return `<div class="pcard status-${s.cls} ${p.isAlert?'alert':''}" onclick="openDetail('${p.id}')">
      <div class="pc-head">
        <div>
          <div class="pc-name">${p.name}</div>
          <div class="pc-id">ID: ${p.id}</div>
        </div>
        <div class="pc-badge ${s.cls}"><div class="bdot-sm"></div>${s.txt}</div>
      </div>
      <div class="pc-glucose-row">
        <div class="pc-gl-num ${s.cls}">${latVal}</div>
        <div class="pc-gl-unit">mmol/L</div>
        <div class="pc-gl-trend">${p.lat?p.trendArrow:''}</div>
      </div>
      <div class="pc-spark"><canvas id="spark-${p.id}"></canvas></div>
      <div class="pc-meta">
        <div class="pc-stat"><div class="pc-stat-val">${tirStr}</div><div class="pc-stat-lbl">TIR 7d</div></div>
        <div class="pc-stat"><div class="pc-stat-val">${avgStr}</div><div class="pc-stat-lbl">Avg 7d</div></div>
        <div class="pc-stat"><div class="pc-stat-val">${p.bgReadings.length}</div><div class="pc-stat-lbl">Readings</div></div>
      </div>
      <div class="pc-time"><span>${sinceStr} ${staleTxt}</span><span>${p.todayR.length} today</span></div>
      ${p.isAlert&&p.lat?`<div class="pc-alert-txt">âš  ${s.txt} â€” ${fmt(p.lat.value)} mmol/L â€” immediate attention needed</div>`:''}
    </div>`;
  }).join('');

  // Draw sparklines after render
  setTimeout(()=>{
    pts.forEach(p=>{
      const cv=document.getElementById('spark-'+p.id);
      if(cv)drawSparkCard(cv,p.readings,p.lo,p.hi);
    });
  },50);
}

function sortPatients(mode,btn){
  sortMode=mode;
  document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderPatients(document.getElementById('searchInput').value);
}

function searchPatients(q){
  renderPatients(q);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id){
  selectedPatient=patients.find(p=>p.id===id);
  if(!selectedPatient)return;
  const p=selectedPatient;
  document.getElementById('dpName').textContent=p.name;
  document.getElementById('dpInfo').textContent='ID: '+p.id+' Â· '+p.bgReadings.length+' readings Â· Last: '+(p.lat?fD(p.lat.ts)+' '+fT(p.lat.ts):'N/A');
  renderDetailBody(p);
  document.getElementById('detailPanel').classList.add('open');
}

function closeDetail(){
  document.getElementById('detailPanel').classList.remove('open');
  selectedPatient=null;
}

function renderDetailBody(p){
  const s=p.status;
  const latVal=p.lat?fmt(p.lat.value):'â€”';
  const lo=p.lo,hi=p.hi;
  const vals7=p.vals7;
  const avg7=p.avg7!=null?fmt(p.avg7):'â€”';
  const a1c=p.avg7?calcA1c(p.avg7):'â€”';
  const tir=p.tir!=null?p.tir+'%':'â€”';
  const min7=vals7.length?fmt(Math.min(...vals7)):'â€”';
  const max7=vals7.length?fmt(Math.max(...vals7)):'â€”';
  const lowPct=vals7.length?Math.round(vals7.filter(v=>v<lo).length/vals7.length*100):0;
  const okPct=vals7.length?Math.round(vals7.filter(v=>v>=lo&&v<=hi).length/vals7.length*100):0;
  const hiPct=vals7.length?Math.round(vals7.filter(v=>v>hi&&v<=13.9).length/vals7.length*100):0;
  const vhiPct=Math.max(0,100-lowPct-okPct-hiPct);
  const needlePos=p.lat?nPos(p.lat.value,lo,hi):'50%';

  const savedNotes=patientNotes[p.id]||[];

  const recents=p.bgReadings.slice(-12).reverse().map(r=>{
    const rs=getSt(r.value,lo,hi);
    const dc={ok:rs.col,low:rs.col,hi:rs.col,vhi:rs.col,none:'var(--ink3)'};
    const extras=[r.insulin?'ğŸ’‰ '+r.insulin+'u':'',r.carbs?'ğŸ '+r.carbs+'g':'',r.context||''].filter(Boolean).join(' Â· ');
    return`<div class="rl-item">
      <div class="rl-dot" style="background:${dc[rs.cls]||rs.col}"></div>
      <div class="rl-main"><div class="rl-ctx">${r.context||'Reading'}</div><div class="rl-time">${fD(r.ts)} ${fT(r.ts)}</div>${r.notes?`<div class="rl-time" style="color:var(--ink2)">${r.notes}</div>`:''}</div>
      <div class="rl-r"><div class="rl-val" style="color:${rs.col}">${fmt(r.value)}</div><div class="rl-unit">mmol/L</div></div>
    </div>`;
  }).join('');

  document.getElementById('dpBody').innerHTML=`
    <div class="dp-hero">
      <div class="dp-gl-num ${s.cls}">${latVal}</div>
      <div class="dp-gl-side">
        <div class="dp-trend">${p.lat?p.trendArrow:''}</div>
        <div class="dp-badge ${s.cls}">${s.txt}</div>
      </div>
    </div>
    <div class="dp-time">${p.lat?tSince(p.lat.ts)+' Â· '+fD(p.lat.ts)+' '+fT(p.lat.ts):'No data'}</div>
    <div class="dp-range"><div class="dp-needle" id="dpNeedle" style="left:${needlePos}"></div></div>
    <div class="dp-range-axis"><span>3.0</span><span>3.9</span><span>7.8</span><span>10.0</span><span>16.7+</span></div>
    <div class="dp-stats-row">
      <div class="dp-stat"><div class="dp-stat-val">${avg7}</div><div class="dp-stat-lbl">7d Avg</div></div>
      <div class="dp-stat"><div class="dp-stat-val">${tir}</div><div class="dp-stat-lbl">TIR 7d</div></div>
      <div class="dp-stat"><div class="dp-stat-val" style="color:var(--hi)">${a1c}${a1c!=='â€”'?'%':''}</div><div class="dp-stat-lbl">Est. A1c</div></div>
    </div>
    <!-- 7d CHART -->
    <div class="dp-section-title">7-Day Glucose Chart</div>
    <div class="dp-chart-wrap"><canvas id="dpChart"></canvas><div class="dp-chart-tooltip" id="dpTooltip"></div></div>
    <!-- TIR -->
    <div class="dp-section-title">Time In Range (7 days)</div>
    <div class="tir-bars">
      <div class="tir-row"><div class="tir-lbl" style="color:var(--low)">Low</div><div class="tir-bar"><div class="tir-fill" style="background:var(--low);width:${lowPct}%"></div></div><div class="tir-pct" style="color:var(--low)">${lowPct}%</div></div>
      <div class="tir-row"><div class="tir-lbl" style="color:var(--ok)">Target</div><div class="tir-bar"><div class="tir-fill" style="background:var(--ok);width:${okPct}%"></div></div><div class="tir-pct" style="color:var(--ok)">${okPct}%</div></div>
      <div class="tir-row"><div class="tir-lbl" style="color:var(--hi)">High</div><div class="tir-bar"><div class="tir-fill" style="background:var(--hi);width:${hiPct}%"></div></div><div class="tir-pct" style="color:var(--hi)">${hiPct}%</div></div>
      <div class="tir-row"><div class="tir-lbl" style="color:var(--vhi)">V.High</div><div class="tir-bar"><div class="tir-fill" style="background:var(--vhi);width:${vhiPct}%"></div></div><div class="tir-pct" style="color:var(--vhi)">${vhiPct}%</div></div>
    </div>
    <!-- RANGE STATS -->
    <div class="dp-stats-row" style="margin-bottom:16px;">
      <div class="dp-stat"><div class="dp-stat-val" style="color:var(--low)">${min7}</div><div class="dp-stat-lbl">Lowest 7d</div></div>
      <div class="dp-stat"><div class="dp-stat-val" style="color:var(--hi)">${max7}</div><div class="dp-stat-lbl">Highest 7d</div></div>
      <div class="dp-stat"><div class="dp-stat-val">${p.bgReadings.length}</div><div class="dp-stat-lbl">Total Rdgs</div></div>
    </div>
    <!-- CLINICAL NOTES -->
    <div class="dp-section-title">Clinical Notes</div>
    <div id="savedNotesList">${savedNotes.map(n=>`<div class="saved-note"><div class="saved-note-meta">${n.time}</div>${n.text}</div>`).join('')}</div>
    <textarea class="note-area" id="noteInput" placeholder="Add clinical observation or noteâ€¦"></textarea>
    <button class="save-note-btn" onclick="saveNote('${p.id}')">Save Note</button>
    <!-- READINGS -->
    <div class="dp-section-title" style="margin-top:16px;">Recent Readings</div>
    <div class="readings-list">${recents||'<div class="empty-state" style="padding:16px 0;"><div class="empty-icon" style="font-size:20px">ğŸ“Š</div>No BG readings</div>'}</div>
  `;

  setTimeout(()=>drawDetailChart(p),60);
}

function drawDetailChart(p){
  const cv=document.getElementById('dpChart');if(!cv)return;
  const par=cv.parentElement;
  const W=par.offsetWidth,H=160,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const since=Date.now()-7*86400000,to=Date.now();
  const data=p.bgReadings.filter(r=>r.ts>=since&&r.ts<=to);
  const lo=p.lo,hi=p.hi;
  const pL=36,pR=8,pT=8,pB=18,cW=W-pL-pR,cH=H-pT-pB;
  const allV=data.map(r=>r.value);
  const minV=Math.max(0,Math.min(...allV,lo)-1);
  const maxV=Math.max(...allV,hi)+1.5;
  const rng=maxV-minV;
  const tx=(ts)=>pL+(ts-since)/(to-since)*cW;
  const ty=(v)=>pT+(1-(v-minV)/rng)*cH;

  ctx.fillStyle='rgba(26,122,74,.07)';ctx.fillRect(pL,ty(hi),cW,ty(lo)-ty(hi));
  ctx.setLineDash([3,4]);ctx.lineWidth=.8;
  ctx.strokeStyle='rgba(26,122,74,.35)';ctx.beginPath();ctx.moveTo(pL,ty(hi));ctx.lineTo(pL+cW,ty(hi));ctx.stroke();
  ctx.strokeStyle='rgba(217,48,37,.25)';ctx.beginPath();ctx.moveTo(pL,ty(lo));ctx.lineTo(pL+cW,ty(lo));ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='#7C84A0';ctx.font='8px DM Mono';ctx.textAlign='right';
  const step=rng>10?4:2;const gs=Math.ceil(minV/step)*step;
  for(let v=gs;v<=maxV;v+=step){ctx.fillText(v.toFixed(0),pL-3,ty(v)+3);}
  if(data.length>=2){
    const gr=ctx.createLinearGradient(0,pT,0,H);gr.addColorStop(0,'rgba(30,79,216,.1)');gr.addColorStop(1,'rgba(30,79,216,0)');
    ctx.beginPath();ctx.moveTo(tx(data[0].ts),cH+pT);
    data.forEach(r=>ctx.lineTo(tx(r.ts),ty(r.value)));
    ctx.lineTo(tx(data[data.length-1].ts),cH+pT);ctx.closePath();ctx.fillStyle=gr;ctx.fill();
    ctx.beginPath();const pts=data.map(r=>({x:tx(r.ts),y:ty(r.value)}));
    ctx.moveTo(pts[0].x,pts[0].y);
    for(let i=0;i<pts.length-1;i++){
      const p0=pts[Math.max(0,i-1)],p1=pts[i],p2=pts[i+1],p3=pts[Math.min(pts.length-1,i+2)];
      const t=0.35;
      ctx.bezierCurveTo(p1.x+(p2.x-p0.x)*t/3,p1.y+(p2.y-p0.y)*t/3,p2.x-(p3.x-p1.x)*t/3,p2.y-(p3.y-p1.y)*t/3,p2.x,p2.y);
    }
    ctx.strokeStyle='#1E4FD8';ctx.lineWidth=2;ctx.lineJoin='round';ctx.stroke();
  }
  const dc={ok:'#1A7A4A',low:'#D93025',hi:'#C47700',vhi:'#A61010',none:'#7C84A0'};
  const dr=data.length>60?2:data.length>20?3:4;
  data.forEach(r=>{
    const rs=getSt(r.value,lo,hi);
    ctx.beginPath();ctx.arc(tx(r.ts),ty(r.value),dr,0,Math.PI*2);
    ctx.fillStyle=dc[rs.cls];ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=1.2;ctx.stroke();
  });
  // x-axis days
  ctx.fillStyle='#7C84A0';ctx.font='8px DM Mono';ctx.textAlign='center';
  for(let i=7;i>=0;i--){
    const d=Date.now()-i*86400000;const x=tx(d);if(x<pL||x>pL+cW)continue;
    const lbl=i===0?'Today':new Date(d).toLocaleDateString([],{month:'short',day:'numeric'});
    ctx.fillText(lbl,x,H-2);
  }
  // hover
  cv.onmousemove=function(e){
    if(!data.length)return;
    const rect=cv.getBoundingClientRect();const cx=e.clientX-rect.left;
    const tsAt=since+(cx-pL)/cW*(to-since);
    let closest=data[0],minD=Infinity;
    data.forEach(r=>{const d=Math.abs(r.ts-tsAt);if(d<minD){minD=d;closest=r;}});
    const tt=document.getElementById('dpTooltip');
    const rs=getSt(closest.value,lo,hi);
    tt.innerHTML=`<strong style="color:${rs.col}">${fmt(closest.value)} mmol/L</strong><br><span style="opacity:.7;font-size:10px;">${fD(closest.ts)} ${fT(closest.ts)}</span>`;
    tt.style.left=Math.min(Math.max(tx(closest.ts),50),cW+pL-50)+'px';
    tt.style.top='0px';tt.style.opacity='1';
  };
  cv.onmouseleave=function(){document.getElementById('dpTooltip').style.opacity='0';};
}

function saveNote(patientId){
  const txt=document.getElementById('noteInput').value.trim();
  if(!txt)return;
  if(!patientNotes[patientId])patientNotes[patientId]=[];
  patientNotes[patientId].unshift({
    time:new Date().toLocaleString([],{dateStyle:'medium',timeStyle:'short'}),
    text:txt
  });
  document.getElementById('noteInput').value='';
  const list=document.getElementById('savedNotesList');
  list.innerHTML=patientNotes[patientId].map(n=>`<div class="saved-note"><div class="saved-note-meta">${n.time}</div>${n.text}</div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAlerts(){
  const alerts=[];
  patients.forEach(p=>{
    if(!p.lat)return;
    const v=p.lat.value,s=p.status;
    const staleMins=(Date.now()-p.lat.ts)/60000;
    if(v<p.lo)alerts.push({type:'crit',icon:'ğŸš¨',title:`${p.name} â€” LOW GLUCOSE`,sub:`Current: ${fmt(v)} mmol/L Â· Target: >${fmt(p.lo)} mmol/L`,time:tSince(p.lat.ts),pid:p.id,msg:'Immediate carbohydrate intake may be required. Contact patient.'});
    else if(v>13.9)alerts.push({type:'crit',icon:'ğŸ”´',title:`${p.name} â€” VERY HIGH GLUCOSE`,sub:`Current: ${fmt(v)} mmol/L Â· Significantly above range`,time:tSince(p.lat.ts),pid:p.id,msg:'Review insulin regimen. Possible correction needed.'});
    else if(v>p.hi)alerts.push({type:'warn',icon:'âš ï¸',title:`${p.name} â€” High Glucose`,sub:`Current: ${fmt(v)} mmol/L Â· Target: <${fmt(p.hi)} mmol/L`,time:tSince(p.lat.ts),pid:p.id,msg:'Monitor closely. May require correction bolus.'});
    if(staleMins>240)alerts.push({type:'info',icon:'â°',title:`${p.name} â€” No Recent Reading`,sub:`Last reading: ${tSince(p.lat.ts)}`,time:tSince(p.lat.ts),pid:p.id,msg:'Patient has not logged in over 4 hours.'});
  });
  const el=document.getElementById('alertsList');
  document.getElementById('alertCount').textContent=alerts.length+' alert'+(alerts.length!==1?'s':'');
  if(!alerts.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-title">No active alerts</div><div class="empty-sub">All monitored patients are within normal parameters.</div></div>`;return;}
  el.innerHTML=alerts.map(a=>`
    <div class="alert-card ${a.type}" onclick="openDetail('${a.pid}')">
      <div class="alert-icon">${a.icon}</div>
      <div class="alert-body">
        <div class="alert-title">${a.title}</div>
        <div class="alert-sub">${a.sub}<br><em>${a.msg}</em></div>
        <div class="alert-time">${a.time}</div>
        <div class="alert-act">
          <button class="act-btn act-primary" onclick="event.stopPropagation();openDetail('${a.pid}')">View Patient</button>
          <button class="act-btn act-ghost" onclick="event.stopPropagation()">Dismiss</button>
        </div>
      </div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnalytics(){
  const el=document.getElementById('analyticsGrid');
  if(!patients.length){el.innerHTML='<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ğŸ“Š</div><div class="empty-title">No data yet</div><div class="empty-sub">Load patient data to see analytics.</div></div>';return;}
  const allVals7=[...patients.flatMap(p=>p.vals7)];
  const avgAll=allVals7.length?allVals7.reduce((a,b)=>a+b,0)/allVals7.length:null;
  const avgTir=patients.filter(p=>p.tir!=null).length?Math.round(patients.filter(p=>p.tir!=null).reduce((a,p)=>a+p.tir,0)/patients.filter(p=>p.tir!=null).length):null;
  const alertPts=patients.filter(p=>p.isAlert).length;
  const stalePts=patients.filter(p=>p.isStale).length;
  const a1cAvg=avgAll?calcA1c(avgAll):null;
  el.innerHTML=`
    <div class="an-card"><div class="an-title">Patients Monitored</div><div class="an-num">${patients.length}</div><div class="an-sub">${alertPts} with active alerts Â· ${stalePts} stale</div></div>
    <div class="an-card"><div class="an-title">Average TIR (7d)</div><div class="an-num" style="color:var(--ok)">${avgTir!=null?avgTir+'%':'â€”'}</div><div class="an-sub">Target: >70%</div></div>
    <div class="an-card"><div class="an-title">Population Avg Glucose</div><div class="an-num">${avgAll?fmt(avgAll):'â€”'}</div><div class="an-sub">mmol/L across all patients (7d)</div></div>
    <div class="an-card"><div class="an-title">Est. Population A1c</div><div class="an-num" style="color:var(--hi)">${a1cAvg?a1cAvg+'%':'â€”'}</div><div class="an-sub">Based on average BG readings</div></div>
    <div class="an-card full">
      <div class="an-title">Patient Status Distribution</div>
      ${renderStatusBreakdown()}
    </div>
  `;
}

function renderStatusBreakdown(){
  const cats={low:0,ok:0,hi:0,vhi:0,none:0};
  patients.forEach(p=>cats[p.status.cls]=(cats[p.status.cls]||0)+1);
  const total=patients.length||1;
  const labels={low:'Low',ok:'In Range',hi:'High',vhi:'Very High',none:'No Data'};
  const colors={low:'var(--low)',ok:'var(--ok)',hi:'var(--hi)',vhi:'var(--vhi)',none:'var(--ink3)'};
  return Object.entries(cats).filter(([,v])=>v>0).map(([k,v])=>`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
      <div style="font-size:12px;font-weight:600;color:${colors[k]};width:80px">${labels[k]}</div>
      <div style="flex:1;height:10px;background:var(--paper);border-radius:5px;overflow:hidden;"><div style="height:100%;background:${colors[k]};width:${Math.round(v/total*100)}%;border-radius:5px;transition:width .6s"></div></div>
      <div style="font-size:12px;font-weight:700;font-family:'DM Mono',monospace;color:${colors[k]};width:40px">${v} (${Math.round(v/total*100)}%)</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openImportModal(){document.getElementById('importModal').classList.add('open');}
function closeImportModal(){document.getElementById('importModal').classList.remove('open');}

function handleFileImport(e){
  const file=e.target.files[0];if(!file)return;
  const name=document.getElementById('importName').value||file.name.replace(/\.[^.]+$/,'');
  document.getElementById('importName').value=name;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      let data;
      if(file.name.endsWith('.csv')){data=parseCSV(ev.target.result);}
      else{data=JSON.parse(ev.target.result);}
      document.getElementById('pasteArea').value=JSON.stringify(data).slice(0,200)+'...';
      doImport(name||'Patient',data);
    }catch(err){alert('Could not parse file: '+err.message);}
  };
  reader.readAsText(file);
  e.target.value='';
}

function parseCSV(csv){
  const lines=csv.split('\n').filter(Boolean);
  const header=lines[0].split(',').map(h=>h.trim().replace(/^"|"$/g,'').toLowerCase());
  return lines.slice(1).filter(Boolean).map(line=>{
    const cols=line.split(',').map(c=>c.trim().replace(/^"|"$/g,''));
    const row={};header.forEach((h,i)=>row[h]=cols[i]);
    const ts=row.timestamp?parseInt(row.timestamp):new Date(row.date+' '+row.time).getTime();
    const val=parseFloat(row['glucose (mmol/l)']||row.glucose||row.value)||null;
    return{ts,value:val,context:row.context||'Reading',insulin:parseFloat(row['insulin (units)'])||null,carbs:parseFloat(row['carbs (g)'])||null,notes:row.notes||''};
  }).filter(r=>r.ts&&r.value);
}

function importPatientData(){
  const name=document.getElementById('importName').value.trim()||'Patient '+Date.now();
  const paste=document.getElementById('pasteArea').value.trim();
  if(!paste){alert('Please paste JSON data or load a file.');return;}
  let data;
  try{data=JSON.parse(paste);}catch{alert('Invalid JSON. Please check the data.');return;}
  doImport(name,data);
}

function doImport(name,readings){
  const id='pt_'+Date.now();
  const patient=buildPatient(name,readings,id);
  patients.push(patient);
  closeImportModal();
  document.getElementById('pasteArea').value='';
  document.getElementById('importName').value='';
  renderPatients();
  if(curScreen==='analytics')renderAnalytics();
  renderAlerts();
  // Show immediate feedback
  if(patient.isAlert){
    setTimeout(()=>openDetail(id),300);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO PATIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addDemoPatients(){
  const now=Date.now();
  function mkReadings(baseVal,variance,count,hoursBack,lo,hi,includeAlerts){
    const arr=[];
    const interval=(hoursBack*3600000)/count;
    for(let i=0;i<count;i++){
      const ts=now-hoursBack*3600000+i*interval+Math.random()*interval*.5;
      let v=baseVal+(Math.random()-.5)*variance*2;
      // Add meal spikes for realism
      const hour=new Date(ts).getHours();
      if(hour>=7&&hour<=8)v+=1.5+Math.random();
      if(hour>=12&&hour<=14)v+=2+Math.random()*1.5;
      if(hour>=18&&hour<=20)v+=1.8+Math.random();
      if(hour>=23||hour<=4)v-=.5;
      v=Math.max(2.0,Math.min(20,Math.round(v*10)/10));
      const contexts=['Before Meal','After Meal','Waking Up','Before Bed','Random Check'];
      const ins=Math.random()>.7?Math.round(Math.random()*8+2)*0.5:null;
      const carbs=ins?Math.round(ins*(lo+hi)/2*10):null;
      arr.push({ts,value:v,context:contexts[Math.floor(Math.random()*contexts.length)],insulin:ins,carbs,notes:''});
    }
    if(includeAlerts){
      // Add a low reading 20 mins ago
      arr.push({ts:now-20*60000,value:3.1,context:'Random Check',insulin:null,carbs:null,notes:'Felt dizzy'});
    }
    return arr.sort((a,b)=>a.ts-b.ts);
  }

  const demoData=[
    {name:'Sarah Mitchell',base:5.8,var:1.2,alert:false,count:60},
    {name:'James Okonkwo',base:9.2,var:2.5,alert:false,count:45},
    {name:'Priya Nair',base:3.8,var:.8,alert:true,count:55},// low alert
    {name:'David van der Berg',base:12.1,var:3,alert:false,count:30},// very high
    {name:'Lucia Ferreira',base:6.4,var:1.5,alert:false,count:72},
    {name:'Thomas MÃ¼ller',base:7.8,var:2,alert:false,count:20},
  ];

  demoData.forEach(d=>{
    const existing=patients.find(p=>p.name===d.name);
    if(existing)return;
    const readings=mkReadings(d.base,d.var,d.count,7*24,3.9,10.0,d.alert);
    const id='demo_'+d.name.replace(/\s/g,'_');
    patients.push(buildPatient(d.name,readings,id));
  });

  renderPatients();
  renderAlerts();
  if(curScreen==='analytics')renderAnalytics();
}

// Init
renderPatients();
</script>
</body>
</html>
