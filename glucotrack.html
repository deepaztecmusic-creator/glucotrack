<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlucoTrack Elite | Clinical Grade</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2D3748;
            --accent: #4A90E2;
            --low: #E53E3E;
            --target: #38A169;
            --high: #D69E2E;
            --bg: #F7FAFC;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            color: var(--primary);
        }

        /* Medical Dashboard Layout */
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }

        .gmi-value { font-size: 2.5rem; font-weight: bold; color: var(--accent); }
        
        /* Calculator & Input */
        .input-group {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #CBD5E0;
            border-radius: 8px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        /* Emergency Overlay */
        #emergency-alert {
            position: fixed;
            inset: 0;
            background: var(--low);
            z-index: 9999;
            color: white;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        @media print {
            .no-print { display: none; }
            .card { border: 1px solid #eee; box-shadow: none; }
        }
    </style>
</head>
<body>

<div id="emergency-alert">
    <h1 id="alert-val" style="font-size: 4rem; margin: 0;">--</h1>
    <h2>HYPOGLYCEMIA DETECTED</h2>
    <div style="background:white; color:black; padding:20px; border-radius:15px; margin:20px 0; max-width:400px;">
        <h3>Rule of 15 Protocol</h3>
        <p>1. Consume 15g fast-acting carbs.<br>2. Wait 15 minutes.<br>3. Re-test blood sugar.</p>
    </div>
    <button onclick="dismissAlert()" style="background:white; color:var(--low);">TREATED & DISMISSED</button>
</div>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0;">GlucoTrack Elite</h1>
            <small>v4.0.1 Clinical Core</small>
        </div>
        <div class="no-print">
            <input type="file" id="csv-upload" style="display:none" onchange="handleFileUpload(event)">
            <button onclick="document.getElementById('csv-upload').click()" style="width:auto; padding: 8px 15px;">Import mySugr</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="card">
            <h3>Predicted GMI (A1c)</h3>
            <div id="gmi-display" class="gmi-value">--</div>
            <small>Based on imported data</small>
        </div>
        <div class="card">
            <h3>Last Reading</h3>
            <div id="last-reading" class="gmi-value">--</div>
            <small id="last-time">Never</small>
        </div>
    </div>

    <div class="input-group">
        <h3>Bolus Calculator</h3>
        <input type="number" id="current-bg" placeholder="Current Glucose (mmol/L)" step="0.1">
        <input type="number" id="carb-count" placeholder="Meal Carbs (grams)">
        <div id="insulin-result" style="margin: 15px 0; font-weight: bold; font-size: 1.2rem; color: var(--accent);">
            Suggested Dose: 0.0 Units
        </div>
        <button onclick="calculateBolus()">Calculate & Log</button>
    </div>

    <div class="card" style="margin-top:20px;">
        <h3>Glucose History</h3>
        <canvas id="glucoseChart"></canvas>
    </div>
</div>

<script>
/**
 * GLUCOTRACK ELITE UNIFIED ENGINE
 */
let appHistory = [];
const CLINICAL_CONFIG = {
    LIMITS: { MIN: 1.1, HYPO: 3.9, MAX: 33.3 },
    RATIOS: { ICR: 10, ISF: 2.0, TARGET: 6.0 },
    CONV: 18.018
};

// 1. mySugr Import Logic 
function handleFileUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split(/\r?\n/).filter(line => line.includes(','));
        
        const imported = rows.slice(1).map(row => {
            const cols = row.split('","').map(c => c.replace(/"/g, ''));
            if (cols.length < 4) return null;
            
            // Fix comma decimals (e.g. "7,7" -> 7.7) 
            const val = parseFloat(cols[3].replace(',', '.'));
            const ts = new Date(`${cols[0]} ${cols[1]}`).getTime();
            return (!isNaN(val)) ? { val, ts } : null;
        }).filter(Boolean);

        appHistory = imported.sort((a,b) => b.ts - a.ts);
        updateDashboard();
    };
    reader.readAsText(file);
}

// 2. Clinical Math (GMI)
function calculateGMI() {
    if (!appHistory.length) return "--";
    const avg = appHistory.reduce((s, c) => s + c.val, 0) / appHistory.length;
    const mgdl = avg * CLINICAL_CONFIG.CONV;
    return (3.31 + (0.02392 * mgdl)).toFixed(1);
}

// 3. Bolus Intelligence & Safety Lock
function calculateBolus() {
    const bg = parseFloat(document.getElementById('current-bg').value);
    const carbs = parseFloat(document.getElementById('carb-count').value) || 0;

    if (isNaN(bg) || bg < CLINICAL_CONFIG.LIMITS.MIN || bg > CLINICAL_CONFIG.LIMITS.MAX) {
        alert("Invalid Glucose Reading");
        return;
    }

    if (bg < CLINICAL_CONFIG.LIMITS.HYPO) {
        triggerHypo(bg);
        document.getElementById('insulin-result').innerText = "Suggested Dose: 0.0 Units (LOW)";
        return;
    }

    const mealDose = carbs / CLINICAL_CONFIG.RATIOS.ICR;
    const correction = (bg > CLINICAL_CONFIG.RATIOS.TARGET) ? (bg - CLINICAL_CONFIG.RATIOS.TARGET) / CLINICAL_CONFIG.RATIOS.ISF : 0;
    const total = (mealDose + correction).toFixed(1);

    document.getElementById('insulin-result').innerText = `Suggested Dose: ${total} Units`;
    
    // Log reading
    appHistory.unshift({ val: bg, ts: Date.now() });
    updateDashboard();
}

// 4. Emergency Protocols
function triggerHypo(val) {
    document.getElementById('alert-val').innerText = val;
    document.getElementById('emergency-alert').style.display = 'flex';
    if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
}

function dismissAlert() {
    document.getElementById('emergency-alert').style.display = 'none';
}

// 5. UI Synchronization
function updateDashboard() {
    document.getElementById('gmi-display').innerText = calculateGMI() + "%";
    
    if (appHistory.length > 0) {
        document.getElementById('last-reading').innerText = appHistory[0].val;
        document.getElementById('last-time').innerText = new Date(appHistory[0].ts).toLocaleTimeString();
    }
    renderChart();
}

let chart;
function renderChart() {
    const ctx = document.getElementById('glucoseChart').getContext('2d');
    if (chart) chart.destroy();
    
    const displayData = [...appHistory].reverse().slice(-20);
    
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: displayData.map(d => new Date(d.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})),
            datasets: [{
                label: 'Glucose (mmol/L)',
                data: displayData.map(d => d.val),
                borderColor: '#4A90E2',
                tension: 0.3,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: { y: { min: 2, max: 20 } }
        }
    });
}
</script>

</body>
</html>
