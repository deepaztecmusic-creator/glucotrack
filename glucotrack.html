<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0D1321">
    <title>GlucoTrack 24h mmol/L</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:#F4F6F9; --white:#fff; --border:#E2E6ED; --text:#0D1321;
            --t2:#5A6478; --t3:#9AA3B5; --acc:#1A56DB; --acc-bg:#EBF5FF;
            --ok:#38A169; --low:#E53E3E; --hi:#D97706; --sh:0 4px 12px rgba(0,0,0,0.05);
            --r:16px;
        }
        body.dark {
            --bg:#0D1321; --white:#1a2236; --border:#243049; --text:#e8edf5;
            --t2:#8899bb; --t3:#4a5a7a; --acc-bg:#0d1e3d;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'Plus Jakarta Sans',sans-serif; background:var(--bg); color:var(--text); max-width:430px; margin:0 auto; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
        
        .topbar { background:var(--white); padding:12px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); z-index:10; }
        .logo { font-weight:800; font-size:18px; color:var(--acc); }
        .logo span { color:var(--text); }
        
        .hero { background:#0D1321; padding:20px 16px; color:white; flex-shrink:0; }
        .hero-label { font-size:11px; opacity:0.6; font-weight:700; letter-spacing:1px; }
        .hero-val { font-size:48px; font-weight:700; font-family:'JetBrains Mono'; color:#34d399; }
        .hero-unit { font-size:14px; opacity:0.8; margin-left:4px; }

        .scroll { flex:1; overflow-y:auto; padding:12px; padding-bottom:100px; }
        .card { background:var(--white); border-radius:var(--r); padding:16px; border:1px solid var(--border); box-shadow:var(--sh); margin-bottom:12px; }
        .card-title { font-size:12px; font-weight:800; color:var(--t3); margin-bottom:12px; text-transform:uppercase; }
        
        .chart-container { height:220px; width:100%; position:relative; }
        
        /* History Items */
        .ei { display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--border); }
        .ei:last-child { border-bottom:none; }
        .ei-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
        .ei-main { flex:1; }
        .ei-ctx { font-size:14px; font-weight:600; }
        .ei-sub { font-size:11px; color:var(--t3); font-family:'JetBrains Mono'; }
        .ei-r { text-align:right; display:flex; align-items:center; gap:12px; }
        .ei-val { font-size:18px; font-weight:700; font-family:'JetBrains Mono'; }
        .btn-del { background:none; border:none; color:var(--low); font-size:18px; cursor:pointer; padding:4px; opacity:0.6; }

        /* Modal & FAB */
        .fab { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:var(--acc); color:white; padding:14px 28px; border-radius:50px; font-weight:700; border:none; box-shadow:0 8px 24px rgba(26,86,219,0.4); z-index:100; cursor:pointer;}
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:flex-end; z-index:1000; }
        .modal.open { display:flex; }
        .sheet { width:100%; background:var(--white); border-radius:24px 24px 0 0; padding:24px; animation:up 0.3s ease; }
        @keyframes up { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .input-val { width:100%; border:none; background:none; text-align:center; font-size:64px; font-family:'JetBrains Mono'; font-weight:700; color:var(--text); outline:none; }
        .ctx-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin:20px 0; }
        .ctx-btn { padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--bg); color:var(--t2); font-size:12px; font-weight:600; cursor:pointer; }
        .ctx-btn.active { border-color:var(--acc); background:var(--acc-bg); color:var(--acc); }
        .btn-save { width:100%; background:var(--acc); color:white; padding:16px; border-radius:12px; border:none; font-weight:700; font-size:16px; cursor:pointer;}
    </style>
</head>
<body>

    <nav class="topbar">
        <div class="logo">Gluco<span>Track</span></div>
        <button onclick="toggleTheme()" style="background:none;border:none;cursor:pointer;font-size:18px;">ðŸŒ“</button>
    </nav>

    <div class="hero">
        <div class="hero-label">LATEST READING</div>
        <div class="hero-val" id="displayVal">--.-<span class="hero-unit">mmol/L</span></div>
    </div>

    <main class="scroll">
        <div class="card">
            <div class="card-title">24-Hour Trend (Today)</div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Reading History</div>
            <div id="historyList"></div>
        </div>
    </main>

    <button class="fab" onclick="openModal()">+ LOG GLUCOSE</button>

    <div class="modal" id="logModal" onclick="closeModal()">
        <div class="sheet" onclick="event.stopPropagation()">
            <div class="card-title" style="text-align:center">Reading (mmol/L)</div>
            <input type="number" id="glucoInput" class="input-val" step="0.1" placeholder="5.5" autofocus>
            
            <div class="ctx-grid">
                <button class="ctx-btn active" onclick="setCtx(this, 'General', 'ðŸ“')">General</button>
                <button class="ctx-btn" onclick="setCtx(this, 'Meal', 'ðŸŽ')">Meal</button>
                <button class="ctx-btn" onclick="setCtx(this, 'Insulin', 'ðŸ’‰')">Insulin</button>
            </div>

            <button class="btn-save" onclick="saveEntry()">SAVE READING</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const TARGET_LOW = 3.9;
        const TARGET_HIGH = 7.8;
        let historyData = JSON.parse(localStorage.getItem('gluco_history')) || [];
        let selectedCtx = { name: 'General', icon: 'ðŸ“' };
        let chart;

        const hours24 = ["00:00", "04:00", "08:00", "12:00", "16:00", "20:00", "23:59"];

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('gluco_dark', document.body.classList.contains('dark'));
            updateChart();
        }

        function setCtx(btn, name, icon) {
            document.querySelectorAll('.ctx-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedCtx = { name, icon };
        }

        function openModal() { document.getElementById('logModal').classList.add('open'); }
        function closeModal() { document.getElementById('logModal').classList.remove('open'); }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (historyData.length > 0) {
                document.getElementById('displayVal').innerHTML = `${historyData[0].val.toFixed(1)}<span class="hero-unit">mmol/L</span>`;
            }
            list.innerHTML = historyData.map((entry, index) => {
                const color = entry.val < TARGET_LOW ? 'var(--low)' : entry.val > TARGET_HIGH ? 'var(--hi)' : 'var(--ok)';
                return `
                    <div class="ei">
                        <div class="ei-dot" style="background:${color}"></div>
                        <div class="ei-main">
                            <div class="ei-ctx">${entry.icon} ${entry.ctx}</div>
                            <div class="ei-sub">${entry.date} â€¢ ${entry.time}</div>
                        </div>
                        <div class="ei-r">
                            <div class="ei-val">${entry.val.toFixed(1)}</div>
                            <button class="btn-del" onclick="deleteEntry(${index})">Ã—</button>
                        </div>
                    </div>`;
            }).join('') || '<div style="text-align:center;color:var(--t3);padding:20px;">No history</div>';
        }

        function saveEntry() {
            const val = parseFloat(document.getElementById('glucoInput').value);
            if (!val) return;

            const now = new Date();
            const newEntry = {
                val: val,
                time: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: false}),
                date: now.toLocaleDateString([], {month:'short', day:'numeric'}),
                ctx: selectedCtx.name,
                icon: selectedCtx.icon,
                timestamp: now.getTime()
            };

            historyData.unshift(newEntry);
            localStorage.setItem('gluco_history', JSON.stringify(historyData));
            
            renderHistory();
            updateChart();
            closeModal();
            document.getElementById('glucoInput').value = '';
        }

        function deleteEntry(index) {
            historyData.splice(index, 1);
            localStorage.setItem('gluco_history', JSON.stringify(historyData));
            renderHistory();
            updateChart();
        }

        function updateChart() {
            if (chart) chart.destroy();
            const ctx = document.getElementById('mainChart').getContext('2d');
            const isDark = document.body.classList.contains('dark');
            
            const todayStr = new Date().toLocaleDateString([], {month:'short', day:'numeric'});
            const todayData = historyData.filter(d => d.date === todayStr).sort((a,b) => a.timestamp - b.timestamp);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        data: todayData.map(p => ({ x: p.time, y: p.val, icon: p.icon })),
                        borderColor: '#1A56DB',
                        backgroundColor: isDark ? 'rgba(26, 86, 219, 0.2)' : 'rgba(26, 86, 219, 0.05)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#1A56DB',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (item) => ` ${item.raw.icon} ${item.raw.y} mmol/L`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            min: 2, max: 18,
                            ticks: { stepSize: 2, color: isDark ? '#8899bb' : '#9AA3B5' },
                            grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            type: 'category',
                            labels: hours24,
                            ticks: { color: isDark ? '#8899bb' : '#9AA3B5' },
                            grid: { display: false }
                        }
                    }
                },
                plugins: [{
                    id: 'targetBox',
                    beforeDraw: (chart) => {
                        const { ctx, chartArea: { left, right, width }, scales: { y } } = chart;
                        const top = y.getPixelForValue(TARGET_HIGH);
                        const bottom = y.getPixelForValue(TARGET_LOW);
                        ctx.save();
                        ctx.fillStyle = isDark ? 'rgba(56, 161, 105, 0.05)' : 'rgba(56, 161, 105, 0.1)';
                        ctx.fillRect(left, top, width, bottom - top);
                        ctx.restore();
                    }
                }]
            });
        }

        window.onload = () => {
            if(localStorage.getItem('gluco_dark') === 'true') document.body.classList.add('dark');
            renderHistory();
            updateChart();
        };
    </script>
</body>
</html>
