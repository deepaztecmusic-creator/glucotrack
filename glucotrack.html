<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlucoTrack Elite | Lead Dev Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #2d3748; --acc: #4a90e2; --err: #e53e3e; --safe: #38a169; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f7fafc; color: var(--p); margin: 0; line-height: 1.5; }
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .big-num { font-size: 2.5rem; font-weight: 800; color: var(--acc); display: block; }
        input, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: 1px solid #cbd5e0; font-size: 1rem; }
        button { background: var(--acc); color: white; border: none; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .import-btn { background: #edf2f7; color: var(--p); border: 1px solid #cbd5e0; width: auto; padding: 10px 20px; }
        #emergency { position: fixed; inset: 0; background: var(--err); color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; text-align: center; }
        .protocol-box { background: white; color: black; padding: 25px; border-radius: 15px; margin: 20px; max-width: 400px; }
    </style>
</head>
<body>

<div id="emergency">
    <h1 id="alert-val" style="font-size: 5rem; margin: 0;">--</h1>
    <h2>CRITICAL HYPO ALERT</h2>
    <div class="protocol-box">
        <h3 style="margin-top:0">Rule of 15</h3>
        <p>Eat 15g fast carbs (juice/tabs). Wait 15 mins. Re-test.</p>
    </div>
    <button onclick="dismissEmergency()" style="width:auto; background:white; color:var(--err)">I AM STABLE</button>
</div>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div><h1>GlucoTrack <span style="color:var(--acc)">Elite</span></h1></div>
        <input type="file" id="fileInput" hidden onchange="processFile(this)">
        <button class="import-btn" onclick="document.getElementById('fileInput').click()">Import mySugr CSV</button>
    </header>

    <div class="grid">
        <div class="card">
            <span>Clinical GMI (A1c)</span>
            <span id="gmi" class="big-num">--%</span>
        </div>
        <div class="card">
            <span>Last Reading</span>
            <span id="last" class="big-num">--</span>
            <small id="time">No data</small>
        </div>
    </div>

    <div class="card">
        <h3>Elite Bolus Calculator</h3>
        <div class="grid">
            <input type="number" id="calc-bg" placeholder="Glucose (mmol/L)" step="0.1">
            <input type="number" id="calc-carbs" placeholder="Carbs (g)">
        </div>
        <div id="result" style="margin: 15px 0; font-weight: 700; color: var(--acc);">Dose Suggestion: 0.0 U</div>
        <button onclick="runCalculator()">Calculate Dose</button>
    </div>

    <div class="card">
        <canvas id="mainChart" height="150"></canvas>
    </div>
</div>

<script>
    let logs = [];
    const config = { hypo: 3.9, target: 6.0, icr: 10, isf: 2.0, conv: 18.018 };

    function processFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/);
            const parsed = [];
            
            // Start at index 1 to skip headers
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                // Robust Regex: Handles commas inside quotes like "7,7"
                const parts = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                if (!parts || parts.length < 4) continue;

                const rawDate = parts[0].replace(/"/g, '');
                const rawTime = parts[1].replace(/"/g, '');
                const rawVal = parts[3].replace(/"/g, '').replace(',', '.'); // Fix decimal
                
                const val = parseFloat(rawVal);
                const ts = new Date(`${rawDate} ${rawTime}`).getTime();

                if (!isNaN(val) && !isNaN(ts)) {
                    parsed.push({ val, ts });
                }
            }
            logs = parsed.sort((a, b) => b.ts - a.ts);
            refreshUI();
        };
        reader.readAsText(file);
    }

    function runCalculator() {
        const bg = parseFloat(document.getElementById('calc-bg').value);
        const carbs = parseFloat(document.getElementById('calc-carbs').value) || 0;

        if (isNaN(bg)) return alert("Enter valid glucose");
        if (bg < config.hypo) {
            triggerEmergency(bg);
            return;
        }

        const mealDose = carbs / config.icr;
        const correction = (bg > config.target) ? (bg - config.target) / config.isf : 0;
        const total = (mealDose + correction).toFixed(1);

        document.getElementById('result').innerText = `Dose Suggestion: ${total} Units`;
        logs.unshift({ val: bg, ts: Date.now() });
        refreshUI();
    }

    function triggerEmergency(val) {
        document.getElementById('alert-val').innerText = val;
        document.getElementById('emergency').style.display = 'flex';
        if (navigator.vibrate) navigator.vibrate([500, 100, 500]);
    }

    function dismissEmergency() { document.getElementById('emergency').style.display = 'none'; }

    function refreshUI() {
        if (!logs.length) return;
        
        // Update Stats
        document.getElementById('last').innerText = logs[0].val;
        document.getElementById('time').innerText = new Date(logs[0].ts).toLocaleTimeString();
        
        // GMI Formula: 3.31 + (0.02392 * mean_mgdL)
        const avgMmol = logs.reduce((a, b) => a + b.val, 0) / logs.length;
        const gmi = (3.31 + (0.02392 * (avgMmol * config.conv))).toFixed(1);
        document.getElementById('gmi').innerText = gmi + "%";

        updateChart();
    }

    let chart;
    function updateChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chart) chart.destroy();
        const data = [...logs].reverse().slice(-14); // Last 14 readings
        
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => new Date(d.ts).toLocaleDateString()),
                datasets: [{
                    label: 'Glucose (mmol/L)',
                    data: data.map(d => d.val),
                    borderColor: '#4a90e2',
                    backgroundColor: 'rgba(74, 144, 226, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });
    }
</script>
</body>
</html>
