<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GlucoTrack">
<meta name="theme-color" content="#0D1321">
<title>GlucoTrack - South Africa</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700;800&display=swap" rel="stylesheet">
<style>
    /* ─── YOUR DESIGN SYSTEM ─── */
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    :root{
        --bg:#F4F6F9;--white:#fff;--border:#E2E6ED;--text:#0D1321;--t2:#5A6478;--t3:#9AA3B5;
        --low:#E53E3E;--ok:#38A169;--hi:#D97706;--acc:#1A56DB;--acc-bg:#EBF5FF;
        --r:14px;--sh:0 1px 3px rgba(0,0,0,.06);
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
    
    /* Topbar */
    .topbar{background:var(--white);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0;}
    .logo{font-size:16px;font-weight:800;color:var(--acc);letter-spacing:-.3px;}
    .logo span{color:var(--text);}
    #sync-status{font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;}

    /* Widget Bar */
    .wbar{background:#0D1321;padding:10px 16px;flex-shrink:0;}
    .wbar-inner{display:flex;align-items:center;gap:10px;}
    .wnum{font-size:26px;font-weight:700;color:#34d399;font-family:'JetBrains Mono',monospace;}
    .wunit{font-size:10px;color:#64748b;font-family:'JetBrains Mono',monospace;}

    /* Scroll Area */
    .scroll{flex:1;overflow-y:auto;padding-bottom:100px;}
    .card{margin:12px 14px;background:#fff;border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);}
    
    /* Glucose Hero */
    .gc-num{font-size:60px;font-weight:800;line-height:1;letter-spacing:-2.5px;color:var(--ok);font-family:'JetBrains Mono',monospace;transition:color .3s;}
    .gc-num.low{color:var(--low);}.gc-num.hi{color:var(--hi);}
    .gc-unit{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;}
    .gc-trend{font-size:22px;margin-left:4px;}
    .gc-time{font-size:11px;color:var(--t3);margin-top:10px;font-family:'JetBrains Mono',monospace;}

    /* Insulin Calculator Box */
    .carb-ins-box{background:var(--acc-bg);border-radius:12px;padding:16px;margin:12px 14px;}
    .cib-row{display:flex;align-items:center;gap:12px;}
    .cib-field{flex:1;display:flex;flex-direction:column;gap:5px;}
    .cib-label{font-size:10px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.05em;}
    .cib-input{background:#fff;border:1.5px solid #acc-b;border-radius:8px;padding:10px;font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:var(--text);outline:none;width:100%;border:1px solid var(--border);}
    .cib-arrow{font-size:20px;color:var(--acc);margin-top:15px;}
    .cib-result{flex:1;}
    .cib-result-val{font-size:32px;font-weight:800;color:var(--acc);font-family:'JetBrains Mono',monospace;}
    .cib-unit{font-size:12px;color:var(--acc);font-weight:600;margin-left:4px;}

    .fab{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--acc);color:#fff;border:none;border-radius:50px;padding:13px 28px;font-weight:700;box-shadow:0 4px 16px rgba(26,86,219,.35);}
</style>
</head>
<body>

    <div class="topbar">
        <div class="logo">GLUCO<span>TRACK</span></div>
        <div id="sync-status" style="color:var(--t3);">CONNECTING...</div>
    </div>

    <div class="wbar">
        <div class="wbar-inner">
            <span class="wnum" id="widget-num">--</span>
            <span class="wunit">mg/dL</span>
        </div>
    </div>

    <div class="scroll">
        <div class="card">
            <div style="font-size:11px; font-weight:700; color:var(--t3); text-transform:uppercase; margin-bottom:5px;">Live Glucose</div>
            <div style="display:flex; align-items:flex-end; gap:6px;">
                <div class="gc-num" id="main-num">--</div>
                <div style="padding-bottom:8px; display:flex; align-items:center;">
                    <span class="gc-unit">mg/dL</span>
                    <span class="gc-trend" id="main-trend"></span>
                </div>
            </div>
            <div class="gc-time" id="last-update">Waiting for data...</div>
        </div>

        <div class="carb-ins-box">
            <div class="cib-row">
                <div class="cib-field">
                    <label class="cib-label">Meal Carbs (g)</label>
                    <input type="number" inputmode="decimal" class="cib-input" placeholder="0" id="carb-in">
                </div>
                <div class="cib-arrow">→</div>
                <div class="cib-result">
                    <label class="cib-label">Suggested Dose</label>
                    <div>
                        <span class="cib-result-val" id="ins-out">0.0</span>
                        <span class="cib-unit">Units</span>
                    </div>
                </div>
            </div>
            <div style="font-size:10px; color:var(--acc); opacity:0.7; margin-top:10px; font-style:italic;">
                *Calculation based on 1 unit per 10g carbs.
            </div>
        </div>
    </div>

    <button class="fab">＋ Log Entry</button>

    <script>
        // ─── CONFIGURATION ───
        const WORKER_URL = 'https://cool-block-e0b8.deepaztecmusic.workers.dev/';
        const INSULIN_RATIO = 10; // Change this to your specific ICR (e.g., 12 or 15)

        const arrowMap = { 1: '↓', 2: '↘', 3: '→', 4: '↗', 5: '↑' };

        // ─── 1. GLUCOSE SYNC ENGINE ───
        async function syncGlucose() {
            const statusEl = document.getElementById('sync-status');
            try {
                const response = await fetch(WORKER_URL);
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                // Update UI Numbers
                const val = data.value;
                document.getElementById('main-num').innerText = val;
                document.getElementById('widget-num').innerText = val;

                // Update Color State
                const mainNum = document.getElementById('main-num');
                mainNum.classList.remove('low', 'hi');
                if (val < 70) mainNum.classList.add('low');
                else if (val > 180) mainNum.classList.add('hi');

                // Update Arrow
                document.getElementById('main-trend').innerText = arrowMap[data.trend] || '→';

                // Update Time
                const now = new Date();
                document.getElementById('last-update').innerText = `Last updated: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                
                statusEl.innerText = "LIVE (SA)";
                statusEl.style.color = "#38A169";

            } catch (err) {
                console.error("Sync Error:", err);
                statusEl.innerText = "OFFLINE";
                statusEl.style.color = "#E53E3E";
            }
        }

        // ─── 2. INSULIN CALCULATOR ENGINE ───
        const carbIn = document.getElementById('carb-in');
        const insOut = document.getElementById('ins-out');

        carbIn.addEventListener('input', (e) => {
            const carbs = parseFloat(e.target.value) || 0;
            const dose = (carbs / INSULIN_RATIO).toFixed(1);
            insOut.innerText = dose;
        });

        // ─── INITIALIZE ───
        syncGlucose();
        setInterval(syncGlucose, 300000); // Auto-update every 5 minutes
    </script>
</body>
</html>
