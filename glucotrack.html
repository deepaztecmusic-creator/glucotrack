<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GlucoTrack">
<meta name="theme-color" content="#0D1321">
<title>GlucoTrack | Clinical Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
<style>
/* ─── SYSTEM ARCHITECTURE STYLES ─── */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#F4F6F9;--white:#fff;--border:#E2E6ED;--text:#0D1321;--t3:#9AA3B5;
  --low:#E53E3E;--ok:#38A169;--hi:#D97706;--acc:#1A56DB;
  --r:14px;--rs:8px;--sh:0 1px 3px rgba(0,0,0,.06);
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* ─── HEADER & WIDGET ─── */
.topbar{background:var(--white);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);z-index:10;}
.logo{font-size:16px;font-weight:800;color:var(--acc);}
.logo span{color:var(--text);}
.topbar-date{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;}

.wbar{background:#0D1321;padding:12px 16px;color:#fff;}
.wbar-inner{display:flex;align-items:center;justify-content:space-between;}
.wnum{font-size:28px;font-weight:700;color:#34d399;font-family:'JetBrains Mono',monospace;}
.wunit{font-size:12px;color:#64748b;margin-left:4px;}
.wtime{font-size:10px;color:#64748b;font-family:'JetBrains Mono',monospace;text-transform:uppercase;}

/* ─── CORE UI ─── */
.scroll{flex:1;overflow-y:auto;padding-bottom:100px;}
.card{margin:12px;background:#fff;border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);}
.gc-lbl{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;margin-bottom:4px;}
.gc-row{display:flex;align-items:baseline;gap:6px;}
.gc-num{font-size:56px;font-weight:800;color:var(--ok);font-family:'JetBrains Mono',monospace;line-height:1;transition: color 0.3s;}
.gc-u{font-size:16px;color:var(--t3);font-weight:700;}
.gc-time{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;margin-top:8px;}

/* ─── CLINICAL ALERTS ─── */
#alert-banner{display:none;margin:12px 12px 0;padding:12px;border-radius:var(--rs);font-weight:800;font-size:12px;text-align:center;animation:pulse 2s infinite;}
.alert-hypo{display:block !important;background:var(--low);color:#fff;}
.alert-hyper{display:block !important;background:var(--hi);color:#fff;}
@keyframes pulse{0%{opacity:1}50%{opacity:0.8}100%{opacity:1}}

/* ─── ANALYTICS ─── */
.stats-grid{display:flex;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.stat-val{font-size:18px;font-weight:800;color:var(--text);}
.stat-label{font-size:10px;color:var(--t3);font-weight:700;}

.chart-wrap{width:100%;height:140px;margin-top:15px;position:relative;}
canvas#glucoseChart{width:100%;height:100%;}

/* ─── INTERACTION ─── */
.fab{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--acc);color:#fff;padding:14px 24px;border-radius:50px;font-weight:700;border:none;box-shadow:0 4px 15px rgba(26,86,219,0.4);cursor:pointer;z-index:100;transition: all 0.2s;}
.fab:disabled{background:var(--t3);opacity:0.6;transform:translateX(-50%) scale(0.98);}

.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#0D1321;color:#fff;padding:8px 16px;border-radius:8px;font-size:12px;opacity:0;transition:0.3s;z-index:1000;}
.toast.show{opacity:1;}
</style>
</head>
<body>

<div id="toast" class="toast">New Reading Sequenced</div>
<div id="alert-banner"></div>

<div class="topbar">
    <div class="logo">GLUCO<span>TRACK</span></div>
    <div class="topbar-date">--- -- --:--</div>
</div>

<div class="wbar">
    <div class="wbar-inner">
        <div>
            <span class="wnum" id="widget-val">5.8</span><span class="wunit">mmol/L</span>
            <div class="wtime" id="widget-time">Updating...</div>
        </div>
        <div style="text-align:right">
            <div style="font-size:10px; opacity:0.6">TREND</div>
            <div id="trend-arrow" style="font-size:18px;">→</div>
        </div>
    </div>
</div>

<div class="scroll">
    <div class="card">
        <div class="gc-lbl">Current Glucose</div>
        <div class="gc-row">
            <div class="gc-num" id="hero-val">5.8</div>
            <div class="gc-u">mmol/L</div>
        </div>
        <div class="gc-time" id="hero-time">Last Reading: Initializing...</div>
        
        <div class="chart-wrap">
            <canvas id="glucoseChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="gc-lbl">Daily Performance</div>
        <div class="stats-grid">
            <div>
                <div class="stat-val" id="stat-tir">100%</div>
                <div class="stat-label">IN RANGE</div>
            </div>
            <div>
                <div class="stat-val" id="stat-avg">5.8</div>
                <div class="stat-label">AVG GLUCOSE</div>
            </div>
            <div>
                <div class="stat-val" id="stat-a1c">5.4</div>
                <div class="stat-label">EST. A1C</div>
            </div>
        </div>
    </div>
</div>

<button class="fab" id="log-btn" onclick="initiateReading()">+ Log Reading</button>

<script>
/**
 * APP ENGINE STATE
 */
const AppState = {
    history: [5.4, 5.8, 6.1, 5.9, 5.7, 6.2, 5.8], 
    lastReadingTimestamp: Date.now() - 600000, // 10 mins ago baseline
    isProcessing: false,
    intervals: {
        clock: null,
        timers: null
    }
};

// 1. System Clock
function updateClock() {
    const now = new Date();
    const datePart = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }).toUpperCase();
    const timePart = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
    document.querySelector('.topbar-date').textContent = `${datePart} ${timePart}`;
}

// 2. Relative Timer Controller
function updateRelativeTimers() {
    // Prevent logic execution if state is locked for reading
    if (AppState.isProcessing) return;

    const diffMins = Math.floor((Date.now() - AppState.lastReadingTimestamp) / 60000);
    const ts = diffMins < 1 ? "Just now" : `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
    
    document.getElementById('widget-time').textContent = ts;
    document.getElementById('hero-time').textContent = `Last Reading: ${ts}`;
}

// 3. Analytic Calculators (TIR, AVG, A1c)
function updateClinicalStats() {
    const data = AppState.history;
    if (data.length === 0) return;

    const inRangeCount = data.filter(v => v >= 3.9 && v <= 10.0).length;
    const tir = Math.round((inRangeCount / data.length) * 100);
    const sum = data.reduce((a, b) => a + b, 0);
    const avg = (sum / data.length).toFixed(1);
    const a1c = ((parseFloat(avg) + 2.59) / 1.59).toFixed(1);

    document.getElementById('stat-tir').textContent = `${tir}%`;
    document.getElementById('stat-avg').textContent = avg;
    document.getElementById('stat-a1c').textContent = a1c;
}

// 4. Data Visualization
function drawChart() {
    const canvas = document.getElementById('glucoseChart');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    const data = AppState.history;
    const width = rect.width;
    const height = rect.height;
    ctx.clearRect(0, 0, width, height);

    const max = 15.0; 
    const min = 2.0;
    const getX = (i) => (i / (data.length - 1)) * width;
    const getY = (v) => height - ((v - min) / (max - min)) * height;

    // Clinical Range Shading (Green Zone)
    ctx.fillStyle = 'rgba(56, 161, 105, 0.08)';
    ctx.fillRect(0, getY(10.0), width, getY(3.9) - getY(10.0));

    ctx.beginPath();
    ctx.strokeStyle = '#1A56DB';
    ctx.lineWidth = 3;
    ctx.lineJoin = 'round';
    data.forEach((val, i) => {
        i === 0 ? ctx.moveTo(getX(i), getY(val)) : ctx.lineTo(getX(i), getY(val));
    });
    ctx.stroke();

    ctx.lineTo(width, height);
    ctx.lineTo(0, height);
    const grad = ctx.createLinearGradient(0, 0, 0, height);
    grad.addColorStop(0, 'rgba(26, 86, 219, 0.15)');
    grad.addColorStop(1, 'rgba(26, 86, 219, 0)');
    ctx.fillStyle = grad;
    ctx.fill();
}

/**
 * 5. READING LIFECYCLE (Timer Stopping Logic)
 */
function initiateReading() {
    // STOP the background interval logic immediately
    AppState.isProcessing = true;
    
    // UI Locking
    const btn = document.getElementById('log-btn');
    btn.disabled = true;
    btn.textContent = "Processing...";
    
    // Visual indicator that timer is suspended for calculation
    document.getElementById('widget-time').textContent = "CALIBRATING...";
    document.getElementById('hero-time').textContent = "Establishing baseline...";

    // Simulated medical-grade sequencing delay
    setTimeout(() => {
        finalizeReading();
    }, 1200);
}

function finalizeReading() {
    // Generate new mmol/L reading (3.5 to 12.5 range)
    const newVal = parseFloat((Math.random() * (12.5 - 3.5) + 3.5).toFixed(1));
    const oldVal = AppState.history[AppState.history.length - 1];
    
    // Commit to History
    AppState.history.push(newVal);
    if(AppState.history.length > 25) AppState.history.shift();
    
    // RESET TIMESTAMPS & RESUME TIMER STATE
    AppState.lastReadingTimestamp = Date.now();
    AppState.isProcessing = false;

    // Global UI Sync
    document.getElementById('widget-val').textContent = newVal.toFixed(1);
    document.getElementById('hero-val').textContent = newVal.toFixed(1);
    
    const btn = document.getElementById('log-btn');
    btn.disabled = false;
    btn.textContent = "+ Log Reading";

    // Trend Analysis
    const arrow = document.getElementById('trend-arrow');
    const diff = newVal - oldVal;
    arrow.textContent = diff > 0.4 ? "↑" : (diff < -0.4 ? "↓" : (diff > 0.1 ? "↗" : (diff < -0.1 ? "↘" : "→")));
    
    // Threshold Alerts
    const banner = document.getElementById('alert-banner');
    banner.className = ''; 
    if (newVal < 3.9) {
        banner.textContent = "⚠ HYPOGLYCEMIA ALERT";
        banner.className = 'alert-hypo';
        document.getElementById('hero-val').style.color = 'var(--low)';
    } else if (newVal > 10.0) {
        banner.textContent = "⚠ HYPERGLYCEMIA ALERT";
        banner.className = 'alert-hyper';
        document.getElementById('hero-val').style.color = 'var(--hi)';
    } else {
        banner.style.display = 'none';
        document.getElementById('hero-val').style.color = 'var(--ok)';
    }

    // Refresh All Modules
    drawChart();
    updateRelativeTimers(); // Now resumes and correctly shows "Just now"
    updateClinicalStats();
    
    // Notification
    const toast = document.getElementById('toast');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

// 6. Global Controller
function boot() {
    updateClock();
    updateRelativeTimers();
    updateClinicalStats();
    drawChart();
    
    // Clean intervals
    if(AppState.intervals.clock) clearInterval(AppState.intervals.clock);
    if(AppState.intervals.timers) clearInterval(AppState.intervals.timers);
    
    AppState.intervals.clock = setInterval(updateClock, 1000);
    AppState.intervals.timers = setInterval(updateRelativeTimers, 10000);
}

window.onload = boot;
window.onresize = drawChart;

// Background handling for mobile persistence
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') boot();
});
</script>
</body>
</html>
