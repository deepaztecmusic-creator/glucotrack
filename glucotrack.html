<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GlucoTrack">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0D1321">
<title>GlucoTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* --- YOUR ORIGINAL STYLES REMAIN UNTOUCHED --- */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#F4F6F9;--white:#fff;--border:#E2E6ED;--border2:#C8CDD8;
  --text:#0D1321;--t2:#5A6478;--t3:#9AA3B5;
  --low:#E53E3E;--low-bg:#FFF5F5;--low-b:#FEB2B2;
  --ok:#38A169;--ok-bg:#F0FFF4;--ok-b:#9AE6B4;
  --hi:#D97706;--hi-bg:#FFFBEB;--hi-b:#FCD34D;
  --vhi:#E53E3E;--acc:#1A56DB;--acc-bg:#EBF5FF;--acc-b:#93C5FD;
  --pur:#7C3AED;--pur-bg:#F5F3FF;
  --sh:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --sh2:0 4px 16px rgba(0,0,0,.09);
  --r:14px;--rs:8px;
}
body.dark{
  --bg:#0D1321;--white:#1a2236;--border:#243049;--border2:#2d3d57;
  --text:#e8edf5;--t2:#8899bb;--t3:#4a5a7a;
}
html{height:100%;background:var(--bg);}
body{height:100%;overflow:hidden;font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;display:flex;flex-direction:column;}
.topbar{background:var(--white);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0;position:relative;z-index:210;}
.logo{font-size:16px;font-weight:800;color:var(--acc);letter-spacing:-.3px;}.logo span{color:var(--text);}
.wbar{background:#0D1321;padding:10px 16px;flex-shrink:0;position:relative;overflow:hidden;color:#fff;}
.wnum{font-size:26px;font-weight:700;color:#34d399;font-family:'JetBrains Mono',monospace;}
.wnum.low{color:#f87171;}.wnum.hi{color:#fbbf24;}.wnum.none{color:#475569;}
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}
.card{margin:12px 14px 0;background:#fff;border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);padding:16px;}
.gc-num{font-size:60px;font-weight:800;line-height:1;letter-spacing:-2.5px;color:var(--ok);font-family:'JetBrains Mono',monospace;}
.gc-num.none{color:var(--t3);font-size:42px;}
.rtrack{height:4px;border-radius:2px;background:linear-gradient(90deg,#E53E3E 0%,#38A169 30%,#38A169 70%,#D97706 85%,#E53E3E 100%);position:relative;}
.rneedle{position:absolute;top:-5px;width:2px;height:14px;background:var(--text);border-radius:2px;transform:translateX(-50%);transition:left .5s ease;}
.fab{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:100;background:var(--acc);color:#fff;border:none;border-radius:50px;padding:13px 24px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;box-shadow:var(--sh2);}
.mbd{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:400;display:none;align-items:flex-end;justify-content:center;}
.mbd.open{display:flex;}
.msheet{width:100%;max-width:430px;background:#fff;border-radius:20px 20px 0 0;padding:20px 20px 40px;transform:translateY(0);transition:transform 0.3s;}
.bi{font-size:60px;font-weight:800;width:100%;text-align:center;background:none;border:none;outline:none;color:var(--text);font-family:'JetBrains Mono',monospace;}
.cc{display:inline-flex;align-items:center;padding:9px 11px;background:var(--bg);border:1.5px solid transparent;border-radius:var(--rs);cursor:pointer;font-size:12px;font-weight:600;margin:4px;}
.cc.selected{background:var(--acc-bg);border-color:var(--acc);color:var(--acc);}
.svbtn{width:100%;margin-top:20px;padding:13px;background:var(--acc);border:none;border-radius:var(--rs);color:#fff;font-weight:700;cursor:pointer;}
canvas.main-chart{display:block;width:100%;height:180px;}
</style>
</head>
<body>

<div class="topbar">
    <div class="logo">GLUCO<span>TRACK</span></div>
    <div class="topbar-right"><div class="topbar-date" id="liveClock">00:00</div></div>
</div>

<div class="wbar">
    <div class="wbar-inner">
        <div class="wnum none" id="widgetVal">--.-</div>
        <div style="font-size:10px; opacity:0.6; font-family:'JetBrains Mono'">mmol/L</div>
    </div>
</div>

<div class="scroll">
    <div class="card">
        <div style="font-size:11px; font-weight:700; color:var(--t3); text-transform:uppercase;">Latest Reading</div>
        <div class="gc-num none" id="heroVal">--.-</div>
        <div class="rtrack" style="margin-top:15px;"><div class="rneedle" id="needle"></div></div>
    </div>

    <div class="card">
        <div style="font-size:13px; font-weight:700; margin-bottom:10px;">24h Glucose Trend (mmol/L)</div>
        <div style="height:180px; position:relative;">
            <canvas class="main-chart" id="glucoseChart"></canvas>
        </div>
    </div>

    <div id="historyList"></div>
</div>

<button class="fab" onclick="openModal()">+ Log Reading</button>

<div class="mbd" id="logModal">
    <div class="msheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <span style="font-weight:800; font-size:18px;">Log Reading</span>
            <button onclick="closeModal()" style="background:none; border:none; font-size:20px; color:var(--t3);">âœ•</button>
        </div>
        <input type="number" class="bi" id="glucoseInput" placeholder="0.0" step="0.1">
        <div style="text-align:center; color:var(--t3); margin-top:-10px; font-size:12px;">mmol/L</div>
        
        <div style="margin-top:20px;">
            <div style="font-size:10px; font-weight:700; color:var(--t3); text-transform:uppercase; margin-bottom:8px;">Context</div>
            <div class="ctx-grid">
                <div class="cc" onclick="selectCtx(this)">Fasting</div>
                <div class="cc" onclick="selectCtx(this)">Pre-Meal</div>
                <div class="cc" onclick="selectCtx(this)">Post-Meal</div>
                <div class="cc selected" onclick="selectCtx(this)">General</div>
            </div>
        </div>

        <button class="svbtn" onclick="saveData()">Save Reading</button>
    </div>
</div>

<script>
/* --- CORE LOGIC --- */
let glucoseReadings = JSON.parse(localStorage.getItem('gt_data')) || [];

function openModal() { document.getElementById('logModal').classList.add('open'); document.getElementById('glucoseInput').focus(); }
function closeModal() { document.getElementById('logModal').classList.remove('open'); }
function selectCtx(el) { document.querySelectorAll('.cc').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); }

function saveData() {
    const val = parseFloat(document.getElementById('glucoseInput').value);
    const ctx = document.querySelector('.cc.selected').innerText;
    
    if(!val || val <= 0) { alert("Please enter a valid value"); return; }

    const entry = {
        id: Date.now(),
        value: val,
        context: ctx,
        timestamp: new Date().getTime(),
        timeStr: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };

    glucoseReadings.unshift(entry);
    localStorage.setItem('gt_data', JSON.stringify(glucoseReadings));
    
    document.getElementById('glucoseInput').value = '';
    closeModal();
    updateUI();
}

function updateUI() {
    const latest = glucoseReadings[0];
    const widget = document.getElementById('widgetVal');
    const hero = document.getElementById('heroVal');
    const needle = document.getElementById('needle');

    if(latest) {
        const displayVal = latest.value.toFixed(1);
        widget.innerText = displayVal;
        hero.innerText = displayVal;
        
        widget.className = "wnum";
        hero.className = "gc-num";

        // mmol/L Color Coding
        let color = 'var(--ok)';
        if(latest.value < 3.9) color = 'var(--low)';
        else if(latest.value > 10.0) color = 'var(--hi)';

        widget.style.color = color;
        hero.style.color = color;

        // Needle Position (2.0 to 18.0 mmol/L scale)
        let percent = ((latest.value - 2) / (18 - 2)) * 100;
        needle.style.left = Math.max(5, Math.min(95, percent)) + '%';
    }

    // History
    const list = document.getElementById('historyList');
    list.innerHTML = glucoseReadings.slice(0, 5).map(r => `
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:12px;">
            <div>
                <div style="font-weight:700;">${r.value.toFixed(1)} <small style="font-weight:400; color:var(--t3)">mmol/L</small></div>
                <div style="font-size:11px; color:var(--t3)">${r.context}</div>
            </div>
            <div style="font-size:11px; color:var(--t3)">${r.timeStr}</div>
        </div>
    `).join('');

    renderChart();
}

function renderChart() {
    const canvas = document.getElementById('glucoseChart');
    const ctx = canvas.getContext('2d');
    const w = canvas.offsetWidth;
    const h = canvas.offsetHeight;
    canvas.width = w; canvas.height = h;

    if(glucoseReadings.length < 2) return;

    // Draw Abbott-style Target Zone (3.9 to 10.0)
    ctx.fillStyle = 'rgba(56, 161, 105, 0.08)';
    const yTargetHigh = h - (10 / 18 * h);
    const yTargetLow = h - (3.9 / 18 * h);
    ctx.fillRect(0, yTargetHigh, w, yTargetLow - yTargetHigh);

    // Draw Line
    ctx.beginPath();
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#1A56DB';
    ctx.lineJoin = 'round';

    const plotData = [...glucoseReadings].slice(0, 12).reverse();
    plotData.forEach((d, i) => {
        const x = (i / (plotData.length - 1)) * w;
        const y = h - (d.value / 18 * h);
        if(i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.stroke();
}

// Live Clock
setInterval(() => {
    document.getElementById('liveClock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}, 1000);

// Init
updateUI();
window.addEventListener('resize', renderChart);
</script>

</body>
</html>
