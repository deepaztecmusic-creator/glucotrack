<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>GlucoTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<style>
/* ─── YOUR ORIGINAL CSS ─── */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#F4F6F9;--white:#fff;--border:#E2E6ED;--border2:#C8CDD8;
  --text:#0D1321;--t2:#5A6478;--t3:#677088;
  --low:#E53E3E;--low-bg:#FFF5F5;--low-b:#FEB2B2;
  --ok:#38A169;--ok-bg:#F0FFF4;--ok-b:#9AE6B4;
  --hi:#D97706;--hi-bg:#FFFBEB;--hi-b:#FCD34D;
  --vhi:#E53E3E;--acc:#1A56DB;--acc-bg:#EBF5FF;--acc-b:#93C5FD;
  --pur:#7C3AED;--pur-bg:#F5F3FF;
  --sh:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --sh2:0 4px 16px rgba(0,0,0,.09);
  --r:14px;--rs:8px;
}
body.dark{
  --bg:#0D1321;--white:#1a2236;--border:#243049;--border2:#2d3d57;
  --text:#e8edf5;--t2:#a0b0cc;--t3:#7a8db5;--acc:#5b8dee;
  --low-bg:#2d1515;--low-b:#7f2020;--ok-bg:#0d2a1a;--ok-b:#1a5c30;
  --hi-bg:#2a1f08;--hi-b:#7a4f0a;--acc-bg:#0d1e3d;--acc-b:#1a3a6b;
}
html{height:100%;background:var(--bg);}
body{height:100%;overflow:hidden;font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;display:flex;flex-direction:column;}

.topbar{background:var(--white);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0;z-index:210;}
.logo{font-size:16px;font-weight:800;color:var(--acc);letter-spacing:-.3px;}
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}
.card{margin:12px 14px 0;background:#fff;border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);padding:16px;}
.gc-num{font-size:60px;font-weight:800;line-height:1;letter-spacing:-2.5px;color:var(--ok);font-family:'JetBrains Mono',monospace;}
.gc-num.low{color:var(--low);}.gc-num.hi{color:var(--hi);}.gc-num.none{color:var(--t3);font-size:42px;}
.fab{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:100;background:var(--acc);color:#fff;border:none;border-radius:50px;padding:13px 24px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(26,86,219,.35);}

/* Modal Overlay Styles */
.mbd{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:400;display:none;align-items:flex-end;justify-content:center;}
.msheet{width:100%;max-width:430px;background:var(--white);border-radius:20px 20px 0 0;padding:20px 20px 40px;transform:translateY(100%);transition:transform 0.3s ease;}
.mbd.open{display:flex;} .mbd.open .msheet{transform:translateY(0);}
input{width:100%;padding:12px;margin:10px 0;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:16px;}
</style>
</head>
<body class="dark"> <div class="topbar">
        <div class="logo">GLUCO<span>TRACK</span></div>
        <div style="font-size:11px; color:var(--t3);" id="clock">00:00</div>
    </div>

    <div class="scroll">
        <div class="card">
            <div style="font-size:11px; font-weight:700; color:var(--t3); margin-bottom:5px;">LATEST READING</div>
            <div style="display:flex; align-items:baseline; gap:10px;">
                <div class="gc-num none" id="main-glucose">--</div>
                <div style="font-size:12px; color:var(--t3); font-family:'JetBrains Mono';">mg/dL</div>
            </div>
            <div id="main-time" style="font-size:11px; color:var(--t3); margin-top:5px;">No data synced</div>
        </div>

        <div class="card">
            <div style="font-size:13px; font-weight:700; margin-bottom:12px;">GLUCOSE TREND</div>
            <div style="height:180px;"><canvas id="glucoChart"></canvas></div>
        </div>

        <div class="card">
            <div style="font-size:13px; font-weight:700; margin-bottom:10px;">MYSUGR IMPORT</div>
            <input type="file" id="csv-file" accept=".csv" style="display:none">
            <button onclick="document.getElementById('csv-file').click()" style="width:100%; padding:12px; border:1px solid var(--acc); background:var(--acc-bg); color:var(--acc); font-weight:700; border-radius:10px; cursor:pointer;">
                UPLOAD MYSUGR CSV
            </button>
        </div>

        <div class="card" style="margin-bottom:100px;">
            <div style="font-size:13px; font-weight:700; margin-bottom:12px;">HISTORY</div>
            <div id="history-container">
                <div style="text-align:center; padding:20px; color:var(--t3);">Import data to see history</div>
            </div>
        </div>
    </div>

    <button class="fab" onclick="toggleModal(true)">+ Add Reading</button>

    <div class="mbd" id="log-modal" onclick="if(event.target===this) toggleModal(false)">
        <div class="msheet">
            <h3 style="margin-bottom:15px;">Manual Entry</h3>
            <input type="number" id="manual-val" placeholder="Glucose (mg/dL)" inputmode="numeric">
            <input type="text" id="manual-note" placeholder="Note (e.g. Lunch)">
            <button onclick="saveManual()" style="width:100%; padding:14px; background:var(--acc); color:#fff; border:none; border-radius:10px; font-weight:700; margin-top:10px;">SAVE READING</button>
        </div>
    </div>

<script>
// --- APP BRAINS ---
let data = JSON.parse(localStorage.getItem('gluco_data')) || [];
let chart = null;

document.addEventListener('DOMContentLoaded', () => {
    initChart();
    renderUI();
    setupClock();
    
    // File Import Listener
    document.getElementById('csv-file').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                const imported = results.data.map(row => {
                    // Specific mapping for mySugr headers
                    const val = row['Blood Glucose'] || row['Value'] || row['Blutzucker'];
                    const date = row['Date'] || row['Datum'];
                    const time = row['Time'] || row['Zeit'];
                    if(!val || !date) return null;
                    
                    return {
                        v: parseInt(val),
                        ts: new Date(`${date} ${time || '00:00'}`).getTime(),
                        n: row['Carbs'] ? `${row['Carbs']}g Carbs` : 'mySugr Import'
                    };
                }).filter(x => x && !isNaN(x.v));

                data = [...imported, ...data].sort((a,b) => b.ts - a.ts);
                save();
                alert(`Imported ${imported.length} readings`);
            }
        });
    };
});

function renderUI() {
    const mainG = document.getElementById('main-glucose');
    const mainT = document.getElementById('main-time');
    const hist = document.getElementById('history-container');

    if (data.length > 0) {
        const latest = data[0];
        mainG.innerText = latest.v;
        mainG.className = 'gc-num ' + (latest.v < 70 ? 'low' : latest.v > 180 ? 'hi' : 'ok');
        mainT.innerText = `Checked at ${new Date(latest.ts).toLocaleTimeString()}`;

        hist.innerHTML = data.slice(0, 10).map(item => `
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border)">
                <div>
                    <div style="font-weight:700; color:var(--text)">${item.v} mg/dL</div>
                    <div style="font-size:11px; color:var(--t3)">${item.n}</div>
                </div>
                <div style="font-size:11px; color:var(--t3); text-align:right">
                    ${new Date(item.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                </div>
            </div>
        `).join('');
    }
    updateChart();
}

function initChart() {
    const ctx = document.getElementById('glucoChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ 
            data: [], borderColor: '#1A56DB', backgroundColor: 'rgba(26,86,219,0.1)', 
            fill: true, tension: 0.4, pointRadius: 2 
        }]},
        options: { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { min: 40, max: 250 } }
        }
    });
}

function updateChart() {
    if(!chart) return;
    const subset = [...data].reverse().slice(-15);
    chart.data.labels = subset.map(d => '');
    chart.data.datasets[0].data = subset.map(d => d.v);
    chart.update();
}

function toggleModal(open) { document.getElementById('log-modal').classList.toggle('open', open); }

function saveManual() {
    const v = document.getElementById('manual-val').value;
    const n = document.getElementById('manual-note').value;
    if(!v) return;
    data.unshift({ v: parseInt(v), ts: Date.now(), n: n || 'Manual Entry' });
    save();
    toggleModal(false);
}

function save() {
    localStorage.setItem('gluco_data', JSON.stringify(data));
    renderUI();
}

function setupClock() {
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }, 1000);
}
</script>
</body>
</html>
