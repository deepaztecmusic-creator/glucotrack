<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0D1321">
    <title>GlucoTrack mmol/L</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:#F4F6F9; --white:#fff; --border:#E2E6ED; --text:#0D1321;
            --t2:#5A6478; --t3:#9AA3B5; --acc:#1A56DB; --acc-bg:#EBF5FF;
            --ok:#38A169; --low:#E53E3E; --hi:#D97706; --sh:0 4px 12px rgba(0,0,0,0.05);
            --r:16px;
        }
        body.dark {
            --bg:#0D1321; --white:#1a2236; --border:#243049; --text:#e8edf5;
            --t2:#8899bb; --t3:#4a5a7a; --acc-bg:#0d1e3d;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'Plus Jakarta Sans',sans-serif; background:var(--bg); color:var(--text); max-width:430px; margin:0 auto; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
        
        .topbar { background:var(--white); padding:12px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); z-index:10; }
        .logo { font-weight:800; font-size:18px; color:var(--acc); }
        .logo span { color:var(--text); }
        
        .hero { background:#0D1321; padding:20px 16px; color:white; flex-shrink:0; }
        .hero-label { font-size:11px; opacity:0.6; font-weight:700; letter-spacing:1px; }
        .hero-val { font-size:48px; font-weight:700; font-family:'JetBrains Mono'; color:#34d399; }
        .hero-unit { font-size:14px; opacity:0.8; margin-left:4px; }

        .scroll { flex:1; overflow-y:auto; padding:12px; padding-bottom:100px; }
        .card { background:var(--white); border-radius:var(--r); padding:16px; border:1px solid var(--border); box-shadow:var(--sh); margin-bottom:12px; }
        .card-title { font-size:12px; font-weight:800; color:var(--t3); margin-bottom:12px; text-transform:uppercase; letter-spacing:0.05em; }
        
        /* Abbott Chart */
        .chart-container { height:200px; width:100%; position:relative; }
        
        /* History Items */
        .ei { display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--border); }
        .ei:last-child { border-bottom:none; }
        .ei-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
        .ei-main { flex:1; }
        .ei-ctx { font-size:14px; font-weight:600; }
        .ei-sub { font-size:11px; color:var(--t3); font-family:'JetBrains Mono'; }
        .ei-r { text-align:right; display:flex; align-items:center; gap:12px; }
        .ei-val { font-size:18px; font-weight:700; font-family:'JetBrains Mono'; }
        .btn-del { background:none; border:none; color:var(--low); font-size:18px; cursor:pointer; padding:4px; opacity:0.6; }

        /* Modal */
        .fab { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:var(--acc); color:white; padding:14px 28px; border-radius:50px; font-weight:700; border:none; box-shadow:0 8px 24px rgba(26,86,219,0.4); cursor:pointer; z-index:100; }
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:flex-end; z-index:1000; }
        .modal.open { display:flex; }
        .sheet { width:100%; background:var(--white); border-radius:24px 24px 0 0; padding:24px; animation:up 0.3s ease; }
        @keyframes up { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .input-val { width:100%; border:none; background:none; text-align:center; font-size:64px; font-family:'JetBrains Mono'; font-weight:700; color:var(--text); outline:none; }
        .btn-save { width:100%; background:var(--acc); color:white; padding:16px; border-radius:12px; border:none; font-weight:700; margin-top:20px; font-size:16px; }
        
        .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--text); color:white; padding:10px 20px; border-radius:8px; font-size:13px; font-weight:600; display:none; z-index:2000; }
    </style>
</head>
<body>

    <div id="toast" class="toast">Entry Recorded</div>

    <nav class="topbar">
        <div class="logo">Gluco<span>Track</span></div>
        <button onclick="toggleTheme()" style="background:none;border:none;font-size:18px;cursor:pointer">ðŸŒ“</button>
    </nav>

    <div class="hero">
        <div class="hero-label">LAST READING</div>
        <div class="hero-val" id="displayVal">--.-<span class="hero-unit">mmol/L</span></div>
    </div>

    <main class="scroll">
        <div class="card">
            <div class="card-title">Abbott Trend (mmol/L)</div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Reading History</div>
            <div id="historyList">
                </div>
        </div>
    </main>

    <button class="fab" onclick="openModal()">+ LOG GLUCOSE</button>

    <div class="modal" id="logModal" onclick="closeModal()">
        <div class="sheet" onclick="event.stopPropagation()">
            <div class="card-title" style="text-align:center">Enter mmol/L</div>
            <input type="number" id="glucoInput" class="input-val" step="0.1" placeholder="5.5" autofocus>
            <button class="btn-save" onclick="saveEntry()">SAVE READING</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const TARGET_LOW = 3.9;
        const TARGET_HIGH = 7.8;
        let chart;
        let historyData = JSON.parse(localStorage.getItem('gluco_history')) || [];

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('gluco_dark', document.body.classList.contains('dark'));
            initChart();
        }

        function openModal() { document.getElementById('logModal').classList.add('open'); document.getElementById('glucoInput').focus(); }
        function closeModal() { document.getElementById('logModal').classList.remove('open'); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (historyData.length > 0) {
                document.getElementById('displayVal').innerHTML = `${historyData[0].val.toFixed(1)}<span class="hero-unit">mmol/L</span>`;
            }
            
            list.innerHTML = historyData.map((entry, index) => {
                const color = entry.val < TARGET_LOW ? 'var(--low)' : entry.val > TARGET_HIGH ? 'var(--hi)' : 'var(--ok)';
                return `
                    <div class="ei">
                        <div class="ei-dot" style="background:${color}"></div>
                        <div class="ei-main">
                            <div class="ei-ctx">Glucose Reading</div>
                            <div class="ei-sub">${entry.date} â€¢ ${entry.time}</div>
                        </div>
                        <div class="ei-r">
                            <div class="ei-val">${entry.val.toFixed(1)}</div>
                            <button class="btn-del" onclick="deleteEntry(${index})">Ã—</button>
                        </div>
                    </div>
                `;
            }).join('') || '<div style="text-align:center; color:var(--t3); padding:20px;">No readings yet</div>';
        }

        function saveEntry() {
            const val = parseFloat(document.getElementById('glucoInput').value);
            if (!val) return;

            const newEntry = {
                val: val,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                date: new Date().toLocaleDateString([], {month:'short', day:'numeric'})
            };

            historyData.unshift(newEntry);
            localStorage.setItem('gluco_history', JSON.stringify(historyData));
            
            renderHistory();
            initChart();
            showToast("Reading Saved");
            closeModal();
            document.getElementById('glucoInput').value = '';
        }

        function deleteEntry(index) {
            historyData.splice(index, 1);
            localStorage.setItem('gluco_history', JSON.stringify(historyData));
            renderHistory();
            initChart();
            showToast("Deleted");
        }

        function initChart() {
            if (chart) chart.destroy();
            const ctx = document.getElementById('mainChart').getContext('2d');
            const isDark = document.body.classList.contains('dark');
            
            // Get last 7 entries for chart, reverse to show chronological
            const chartPoints = [...historyData].slice(0, 7).reverse();
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartPoints.map(p => p.time),
                    datasets: [{
                        data: chartPoints.map(p => p.val),
                        borderColor: '#1A56DB',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(26, 86, 219, 0.05)',
                        pointBackgroundColor: (c) => {
                            const v = c.raw;
                            return v < TARGET_LOW ? '#E53E3E' : v > TARGET_HIGH ? '#D97706' : '#1A56DB';
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 2, max: 16, ticks: { stepSize: 2, color: isDark ? '#4a5a7a' : '#9AA3B5' }, grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' } },
                        x: { ticks: { color: isDark ? '#4a5a7a' : '#9AA3B5' }, grid: { display: false } }
                    }
                },
                plugins: [{
                    id: 'targetZone',
                    beforeDraw: (chart) => {
                        const {ctx, chartArea: {left, right}, scales: {y}} = chart;
                        const top = y.getPixelForValue(TARGET_HIGH);
                        const bottom = y.getPixelForValue(TARGET_LOW);
                        ctx.fillStyle = isDark ? 'rgba(56, 161, 105, 0.05)' : 'rgba(56, 161, 105, 0.08)';
                        ctx.fillRect(left, top, right - left, bottom - top);
                    }
                }]
            });
        }

        // Boot
        window.onload = () => {
            if(localStorage.getItem('gluco_dark') === 'true') document.body.classList.add('dark');
            renderHistory();
            initChart();
        };
    </script>
</body>
</html>
