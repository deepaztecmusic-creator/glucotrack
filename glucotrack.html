<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GlucoTrack">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0D1321">
<meta name="application-name" content="GlucoTrack">
<meta name="description" content="Personal glucose tracker with AI meal analysis">
<link id="pwa-icon-57" rel="apple-touch-icon" sizes="57x57">
<link id="pwa-icon-60" rel="apple-touch-icon" sizes="60x60">
<link id="pwa-icon-72" rel="apple-touch-icon" sizes="72x72">
<link id="pwa-icon-76" rel="apple-touch-icon" sizes="76x76">
<link id="pwa-icon-114" rel="apple-touch-icon" sizes="114x114">
<link id="pwa-icon-120" rel="apple-touch-icon" sizes="120x120">
<link id="pwa-icon-144" rel="apple-touch-icon" sizes="144x144">
<link id="pwa-icon-152" rel="apple-touch-icon" sizes="152x152">
<link id="pwa-icon-180" rel="apple-touch-icon" sizes="180x180">
<link id="pwa-manifest" rel="manifest">
<link id="pwa-splash-2048" rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
<link id="pwa-splash-1668" rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
<link id="pwa-splash-1536" rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">
<link id="pwa-splash-1125" rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
<link id="pwa-splash-1242" rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
<link id="pwa-splash-750" rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
<link id="pwa-splash-640" rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
<title>GlucoTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#F4F6F9;--white:#fff;--border:#E2E6ED;--border2:#C8CDD8;
  --text:#0D1321;--t2:#5A6478;--t3:#677088;
  --low:#E53E3E;--low-bg:#FFF5F5;--low-b:#FEB2B2;
  --ok:#38A169;--ok-bg:#F0FFF4;--ok-b:#9AE6B4;
  --hi:#D97706;--hi-bg:#FFFBEB;--hi-b:#FCD34D;
  --vhi:#E53E3E;--acc:#1A56DB;--acc-bg:#EBF5FF;--acc-b:#93C5FD;
  --pur:#7C3AED;--pur-bg:#F5F3FF;
  --sh:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --sh2:0 4px 16px rgba(0,0,0,.09);
  --r:14px;--rs:8px;
}
body.dark{
  --bg:#0D1321;--white:#1a2236;--border:#243049;--border2:#2d3d57;
  --text:#e8edf5;--t2:#a0b0cc;--t3:#7a8db5;--acc:#5b8dee;
  --low-bg:#2d1515;--low-b:#7f2020;
  --ok-bg:#0d2a1a;--ok-b:#1a5c30;
  --hi-bg:#2a1f08;--hi-b:#7a4f0a;
  --acc-bg:#0d1e3d;--acc-b:#1a3a6b;
  --pur-bg:#1a0d35;
  --sh:0 1px 3px rgba(0,0,0,.3),0 1px 2px rgba(0,0,0,.2);
  --sh2:0 4px 16px rgba(0,0,0,.4);
}
body.dark .card{background:var(--white);}
body.dark .topbar{background:#111827;border-color:var(--border);}
body.dark .drawer{background:#111827;}
body.dark .msheet{background:#111827;}
body.dark .sgcard{background:var(--white);}
body.dark input,body.dark textarea{background:#0d1321;color:var(--text);border-color:var(--border2);}
body.dark .cc{background:#0d1321;}
body.dark .iif{background:#0d1321;}
body.dark .nf{background:#0d1321;color:var(--text);}
body.dark .tp.active{background:var(--white);}
body.dark .cdr-btn.active{background:var(--white);}
html{height:100%;background:var(--bg);}body{height:100%;overflow:hidden;font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;display:flex;flex-direction:column;}

/* ─── TOAST ─── */
.toast-wrap{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;width:calc(100% - 32px);max-width:390px;}
.toast{background:var(--text);color:#fff;padding:12px 16px;border-radius:10px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,0.25);animation:toastIn .3s cubic-bezier(.34,1.56,.64,1) forwards;pointer-events:all;}
.toast.error{background:#C53030;}.toast.success{background:#276749;}.toast.warn{background:#B7791F;}
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;display:flex;align-items:flex-end;justify-content:center;padding:0 0 32px;animation:toastIn .2s ease;}
.confirm-box{background:#fff;border-radius:16px;padding:20px;width:calc(100% - 32px);max-width:390px;box-shadow:0 8px 32px rgba(0,0,0,.25);}
body.dark .confirm-box{background:#1a2236;}

/* ── Extended dark mode: card-like components ── */
body.dark .rem-card,
body.dark .alarm-card{background:var(--white);border-color:var(--border);}

body.dark .help-q{background:var(--white);border-color:var(--border);}
body.dark .help-q-body{background:var(--bg);color:var(--t2);}
body.dark .help-q-hd{color:var(--text);}

body.dark .about-row{color:var(--t2);}
body.dark .about-row span:last-child{color:var(--text);}
body.dark .about-divider{background:var(--border);}

body.dark .ex-table th{background:#0d1e3d;color:var(--t2);}
body.dark .ex-table td{border-color:var(--border);color:var(--text);}
body.dark .ex-table tr:nth-child(even) td{background:#111d30;}
body.dark .ex-profile-btn{background:var(--white);border-color:var(--border);color:var(--t2);}
body.dark .ex-profile-btn.active{background:#0d1e3d;color:#5b8dee;border-color:#1a3a6b;}
body.dark .ex-timer-bar{background:var(--white);border-color:var(--border);}
body.dark .ex-elapsed{color:var(--text);}

body.dark .first-bite-btn{background:var(--white);border-color:var(--border);color:var(--t2);}
body.dark .first-bite-btn.active{background:#0d1e3d;border-color:#1a3a6b;color:#5b8dee;}

body.dark .meal-item-name,
body.dark .meal-item-carbs{background:var(--bg);border-color:var(--border);color:var(--text);}
body.dark .meal-total-box{background:#0d1e3d;border-color:#1a3a6b;}
body.dark .meal-total-lbl,
body.dark .meal-total-val,
body.dark .meal-insulin-rec{color:#5b8dee;}
body.dark .carb-ins-box{background:#0d1e3d;border-color:#1a3a6b;}
body.dark .cib-label,
body.dark .cib-result-label,
body.dark .cib-result-val,
body.dark .cib-result-unit,
body.dark .cib-note{color:#5b8dee;}
body.dark .cib-input{background:var(--white);border-color:#1a3a6b;color:var(--text);}
body.dark .cib-arrow{color:#5b8dee;}

body.dark .cam-area{border-color:var(--border2);background:var(--white);}
body.dark .cam-area:hover{border-color:#5b8dee;background:#0d1e3d;}
body.dark .cam-area-txt{color:var(--t2);}
body.dark .cam-result-box{background:var(--white);}
body.dark .crb-stat{background:var(--bg);border-color:var(--border);color:var(--t2);}
body.dark .crb-stat span{color:#5b8dee;}
body.dark .crb-name{color:var(--text);}
body.dark .crb-items{color:var(--t2);}

body.dark .st{background:var(--white);border-color:var(--border);}
body.dark .stl{color:var(--t3);}

body.dark .app-card{background:var(--white);border-color:var(--border);}
body.dark .app-name{color:var(--text);}
body.dark .app-desc{color:var(--t2);}

body.dark .report-card{background:var(--white);border-color:var(--border);}

body.dark .di{color:var(--t2);}
body.dark .di:hover{background:var(--border);color:var(--text);}
body.dark .di.active{color:#5b8dee;background:#0d1e3d;}
body.dark .di-ic{background:var(--bg);}
body.dark .di.active .di-ic{background:#0d1e3d;}
body.dark .dfooter{color:var(--t3);}
body.dark .dh-user{color:var(--text);}
body.dark .dh-email{color:var(--t3);}

body.dark .msec-lbl{color:var(--t3);}
body.dark .mtitle{color:var(--text);}
body.dark .bi{color:var(--text);}
body.dark .biu{color:var(--t3);}

body.dark .tabs{background:var(--bg);}
body.dark .meal-tab{color:var(--t3);}
body.dark .meal-tab.active{background:var(--white);color:#5b8dee;}

body.dark .sglbl{color:var(--t3);}
body.dark .sgi-t{color:var(--text);}
body.dark .sgi-s{color:var(--t3);}
body.dark .ri-f label{color:var(--t3);}
body.dark .ri-f input{background:var(--bg);border-color:var(--border);color:var(--text);}

body.dark .gc-lbl{color:var(--t3);}
body.dark .gc-unit{color:var(--t3);}
body.dark .gc-time{color:var(--t3);}
body.dark .gc-rh{color:var(--t3);}
body.dark .gc-trend{color:var(--t2);}

body.dark .raxis span{color:var(--t3);}

body.dark .ei-ctx{color:var(--text);}
body.dark .ei-sub{color:var(--t3);}
body.dark .ei-u{color:var(--t3);}
body.dark .empty{color:var(--t3);}

body.dark .sc-title{color:var(--text);}
body.dark .sc-hd{border-color:var(--border);}

body.dark .chart-tooltip{background:rgba(26,34,54,.95);}

body.dark .a1c-note{color:var(--t3);}
body.dark .glabels span{color:var(--t3);}
body.dark .tir-nm{color:inherit;}

body.dark .fc-note{color:rgba(255,255,255,.6);}
body.dark .fc-meta{color:rgba(255,255,255,.7);}

body.dark .alarm-title{color:var(--text);}
body.dark .alarm-sub{color:var(--t3);}
body.dark .alarm-row{border-color:var(--border);}
body.dark .rem-title{color:var(--text);}
body.dark .rem-time input{background:var(--bg);border-color:var(--border);color:var(--text);}
body.dark .rem-row{border-color:var(--border);}

body.dark .ptitle{color:var(--text);}
body.dark .psub{color:var(--t3);}

body.dark .topbar-date{color:var(--t3);}
body.dark .logo span{color:var(--text);}
.confirm-msg{font-size:15px;font-weight:600;color:var(--text);margin-bottom:16px;line-height:1.4;text-align:center;}
.confirm-btns{display:flex;gap:10px;}
.confirm-btn{flex:1;padding:12px;border:none;border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;}
.confirm-btn.cancel{background:var(--bg);color:var(--t2);}
.confirm-btn.danger{background:#E53E3E;color:#fff;}
.confirm-btn.primary{background:var(--acc);color:#fff;}
.toast-icon{font-size:16px;flex-shrink:0;}
@keyframes toastIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
@keyframes toastOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-12px)}}

/* ─── AUTH SCREEN ─── */

/* ─── TOPBAR ─── */
.topbar{background:var(--white);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0;position:relative;z-index:210;}
.logo{font-size:16px;font-weight:800;color:var(--acc);letter-spacing:-.3px;}
.logo span{color:var(--text);}
.topbar-right{display:flex;align-items:center;gap:8px;}
.topbar-date{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;}
.burger{width:40px;height:40px;border:none;background:none;cursor:pointer;position:relative;border-radius:8px;transition:background .15s;flex-shrink:0;}
.burger:hover{background:var(--bg);}
.bl{position:absolute;left:50%;width:20px;height:2px;background:var(--text);border-radius:2px;transform:translateX(-50%);transition:transform .3s ease,opacity .3s ease;}.bl:nth-child(1){top:11px;}.bl:nth-child(2){top:19px;}.bl:nth-child(3){top:27px;}
.burger.open .bl:nth-child(1){transform:translateX(-50%) translateY(8px) rotate(45deg);}
.burger.open .bl:nth-child(2){opacity:0;}
.burger.open .bl:nth-child(3){transform:translateX(-50%) translateY(-8px) rotate(-45deg);}

/* ─── WIDGET BAR ─── */
.wbar{background:#0D1321;padding:10px 16px;flex-shrink:0;position:relative;overflow:hidden;}
.wbar::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,#1e293b,#0f172a);pointer-events:none;}
.wbar-inner{display:flex;align-items:center;gap:10px;position:relative;z-index:1;}
.wbar-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0;overflow:hidden;}
.wval-grp{display:flex;align-items:baseline;gap:4px;flex-shrink:0;}
.wnum{font-size:26px;font-weight:700;color:#34d399;font-family:'JetBrains Mono',monospace;transition:color .4s;letter-spacing:-1px;}
.wnum.low{color:#f87171;}.wnum.hi{color:#fbbf24;}.wnum.vhi{color:#f87171;}.wnum.none{color:#475569;font-size:20px;}
.wunit{font-size:10px;color:#64748b;font-family:'JetBrains Mono',monospace;}
.wtrend{font-size:13px;color:#94a3b8;margin-left:1px;}
.wtime{font-size:10px;color:#475569;font-family:'JetBrains Mono',monospace;}
.wspark{flex:1;min-width:40px;max-width:110px;height:30px;}
.wspark canvas{width:100%;height:100%;}
.wcam{flex-shrink:0;flex-grow:0;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,.15);border-radius:9px;padding:7px 12px;display:flex;align-items:center;gap:6px;cursor:pointer;color:#fff;font-size:12px;font-weight:600;font-family:'Plus Jakarta Sans',sans-serif;transition:background .15s;white-space:nowrap;}
.wcam:hover{background:rgba(255,255,255,.18);}

/* ─── SCROLL AREA ─── */
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}
.scroll::-webkit-scrollbar{display:none;}

/* ─── DRAWER ─── */
.dov{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.45);z-index:190;opacity:0;pointer-events:none;transition:opacity .25s;}
.dov.open{opacity:1;pointer-events:all;}
.drawer{position:fixed;top:0;left:-300px;width:280px;height:100%;min-height:100vh;background:#fff;z-index:200;transition:left .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;box-shadow:4px 0 24px rgba(0,0,0,.18);}
.drawer.open{left:0;}
.dh{padding:48px 20px 18px;border-bottom:1px solid var(--border);}
.dh-user{font-size:15px;font-weight:700;color:var(--text);margin-bottom:2px;}
.dh-email{font-size:12px;color:var(--t3);}
.dnav{flex:1;padding:8px 0;overflow-y:auto;}
.di{display:flex;align-items:center;gap:11px;padding:12px 20px;cursor:pointer;font-size:14px;font-weight:500;color:var(--t2);transition:all .15s;border:none;background:none;width:100%;text-align:left;}
.di:hover{background:var(--bg);color:var(--text);}
.di.active{color:var(--acc);background:var(--acc-bg);}
.di-ic{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;background:var(--bg);flex-shrink:0;}
.di.active .di-ic{background:var(--acc-bg);}
.ddiv{height:1px;background:var(--border);margin:5px 20px;}
.dfooter{padding:14px 20px;border-top:1px solid var(--border);font-size:11px;color:var(--t3);}

/* ─── FAB ─── */
.fab{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:100;background:var(--acc);color:#fff;border:none;border-radius:50px;padding:13px 24px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(26,86,219,.35);transition:all .2s;white-space:nowrap;}
.fab:hover{transform:translateX(-50%) translateY(-2px);}
.fab-plus{width:18px;height:18px;background:rgba(255,255,255,.25);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;}

/* ─── SCREENS ─── */
.screen{display:none;padding-bottom:80px;}
.screen.active{display:block;}

/* ─── CARDS ─── */
.card{margin:12px 14px 0;background:#fff;border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);padding:16px;}
.card-last{margin-bottom:12px;}
.sc-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.sc-title{font-size:13px;font-weight:700;color:var(--text);}
.tabs{display:flex;gap:3px;background:var(--bg);border-radius:7px;padding:3px;}
.tp{padding:4px 9px;border-radius:5px;font-size:11px;font-weight:600;color:var(--t3);cursor:pointer;border:none;background:transparent;transition:all .15s;}
.tp.active{background:#fff;color:var(--acc);box-shadow:var(--sh);}

/* GLUCOSE HERO */
.gc-lbl{font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px;}
.gc-top{display:flex;align-items:flex-start;justify-content:space-between;}
.gc-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;border:1px solid;}
.bok{background:var(--ok-bg);color:var(--ok);border-color:var(--ok-b);}
.blow{background:var(--low-bg);color:var(--low);border-color:var(--low-b);}
.bhi{background:var(--hi-bg);color:var(--hi);border-color:var(--hi-b);}
.bvhi{background:var(--low-bg);color:var(--vhi);border-color:var(--low-b);}
.bdot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.gc-row{display:flex;align-items:flex-end;gap:7px;margin-top:2px;}
.gc-num{font-size:60px;font-weight:800;line-height:1;letter-spacing:-2.5px;color:var(--ok);transition:color .4s;font-family:'JetBrains Mono',monospace;}
.gc-num.low{color:var(--low);}.gc-num.hi{color:var(--hi);}.gc-num.vhi{color:var(--vhi);}.gc-num.none{color:var(--t3);font-size:42px;letter-spacing:-1px;}
.gc-ucol{display:flex;flex-direction:column;padding-bottom:9px;gap:2px;}
.gc-unit{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;}
.gc-trend{font-size:20px;font-weight:700;transition:color .4s,transform .3s;}
.gc-trend.rising2{color:#E53E3E;transform:rotate(-45deg);}
.gc-trend.rising1{color:#D97706;}
.gc-trend.stable{color:#38A169;}
.gc-trend.falling1{color:#D97706;}
.gc-trend.falling2{color:#E53E3E;transform:rotate(45deg);}
@keyframes trendPop{0%{transform:scale(1)}40%{transform:scale(1.5)}100%{transform:scale(1)}}
.gc-trend.pop{animation:trendPop .35s ease;}
.gc-meta{display:flex;align-items:center;justify-content:space-between;margin-top:5px;}
.gc-time{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;}
.gc-rh{font-size:11px;color:var(--t3);}

/* RANGE STRIP */
.rstrip{margin-top:14px;}
.rtrack{height:4px;border-radius:2px;background:linear-gradient(90deg,#E53E3E 0%,#E53E3E 18%,#38A169 23%,#38A169 65%,#D97706 70%,#D97706 88%,#E53E3E 93%,#E53E3E 100%);position:relative;}
.rneedle{position:absolute;top:-5px;width:2px;height:14px;background:var(--text);border-radius:2px;transform:translateX(-50%);transition:left .5s cubic-bezier(.4,0,.2,1);}
.raxis{display:flex;justify-content:space-between;margin-top:4px;}
.raxis span{font-size:9px;color:var(--t3);font-family:'JetBrains Mono',monospace;}

/* STAT TILES */
.strow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:10px 14px 0;}
.st{background:#fff;border:1px solid var(--border);border-radius:var(--rs);padding:11px 10px;box-shadow:var(--sh);}
.stv{font-size:18px;font-weight:800;letter-spacing:-.5px;font-family:'JetBrains Mono',monospace;}
.stl{font-size:10px;color:var(--t3);margin-top:2px;text-transform:uppercase;letter-spacing:.04em;}

/* ══════ ABBOTT-QUALITY CHART ══════ */
.chart-container{position:relative;width:100%;user-select:none;}
.chart-canvas-wrap{position:relative;width:100%;height:180px;}
canvas.main-chart{display:block;width:100%;height:100%;cursor:crosshair;}
.chart-tooltip{position:absolute;background:rgba(13,19,33,.92);color:#fff;border-radius:8px;padding:8px 12px;font-size:12px;pointer-events:none;opacity:0;transition:opacity .15s;white-space:nowrap;z-index:20;transform:translateX(-50%);}
.chart-tooltip strong{font-family:'JetBrains Mono',monospace;font-size:14px;}
.chart-date-range{display:flex;align-items:center;gap:8px;margin-top:10px;}
.cdr-btn{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;color:var(--t3);cursor:pointer;border:none;background:var(--bg);transition:all .15s;}
.cdr-btn.active{background:#fff;color:var(--acc);box-shadow:var(--sh);}
.cdr-custom{display:flex;align-items:center;gap:6px;margin-left:auto;}
.cdr-date-in{padding:4px 8px;border:1px solid var(--border2);border-radius:6px;font-size:11px;color:var(--text);font-family:'JetBrains Mono',monospace;outline:none;}
.cdr-date-in:focus{border-color:var(--acc);}

/* ENTRIES */
.ei{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.ei:last-child{border-bottom:none;padding-bottom:0;}
.ei-ic{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.ei-main{flex:1;min-width:0;}
.ei-ctx{font-size:13px;font-weight:600;}
.ei-sub{font-size:11px;color:var(--t3);margin-top:1px;font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ei-r{text-align:right;flex-shrink:0;}
.ei-val{font-size:18px;font-weight:800;letter-spacing:-.5px;font-family:'JetBrains Mono',monospace;}
.ei-u{font-size:10px;color:var(--t3);font-family:'JetBrains Mono',monospace;}
.empty{text-align:center;padding:24px 16px;color:var(--t3);font-size:13px;}
.empty-ic{font-size:28px;margin-bottom:8px;}

/* ─── FORECAST ─── */
.ptitle{font-size:20px;font-weight:800;padding:14px 14px 2px;letter-spacing:-.5px;}
.psub{font-size:13px;color:var(--t3);padding:0 14px 12px;}
.fc-hero{background:linear-gradient(135deg,#1e1b4b,#1D4ED8);border:none;}
.fc-hd-txt{font-size:11px;opacity:.5;color:#fff;text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;}
.fc-row{display:flex;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap;}
.fc-item{text-align:center;}
.fc-lbl{font-size:10px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px;}
.fc-num{font-size:30px;font-weight:800;letter-spacing:-1.5px;color:#fff;font-family:'JetBrains Mono',monospace;}
.fc-arr{font-size:18px;color:rgba(255,255,255,.4);}
.fc-meta{font-size:12px;color:rgba(255,255,255,.55);margin-bottom:10px;}
.fc-pills{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.fpill{padding:3px 9px;background:rgba(255,255,255,.12);border-radius:20px;font-size:11px;font-weight:600;color:rgba(255,255,255,.9);}
.fc-note{font-size:11px;color:rgba(255,255,255,.45);margin-top:10px;line-height:1.5;}
.fc-chart-wrap{height:90px;position:relative;}

/* ─── A1C ─── */
.a1c-big{font-size:68px;font-weight:800;letter-spacing:-4px;line-height:1;font-family:'JetBrains Mono',monospace;}
.a1c-pct{font-size:18px;letter-spacing:0;}
.a1c-zone{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid;}
.gtrack{height:5px;border-radius:3px;background:linear-gradient(90deg,var(--ok) 0%,#84CC16 30%,var(--hi) 60%,var(--low) 100%);position:relative;margin-top:16px;}
.gneedle{position:absolute;top:-5px;width:3px;height:15px;background:var(--text);border-radius:2px;transform:translateX(-50%);transition:left .6s cubic-bezier(.4,0,.2,1);}
.glabels{display:flex;justify-content:space-between;margin-top:4px;}
.glabels span{font-size:9px;color:var(--t3);font-family:'JetBrains Mono',monospace;}
.a1c-note{font-size:11px;color:var(--t3);margin-top:10px;line-height:1.5;}
.tir-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.tir-row:last-child{margin-bottom:0;}
.tir-nm{font-size:11px;font-weight:600;width:54px;flex-shrink:0;}
.tir-bw{flex:1;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;}
.tir-bf{height:100%;border-radius:3px;transition:width .6s ease;}
.tir-pc{font-size:11px;font-weight:700;width:32px;text-align:right;font-family:'JetBrains Mono',monospace;}

/* ─── HISTORY ─── */
.hist-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 0;}
.dglabel{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;padding:12px 14px 5px;}

/* ─── SETTINGS ─── */
.sg{margin:0 14px;}
.sglbl{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;padding:14px 0 7px;}
.sgcard{background:#fff;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh);}
.sgi{display:flex;align-items:center;justify-content:space-between;padding:13px 15px;border-bottom:1px solid var(--border);}
.sgi:last-child{border-bottom:none;}
.sgi-l{display:flex;align-items:center;gap:10px;}
.sgi-ic{font-size:16px;width:26px;text-align:center;}
.sgi-t{font-size:13px;font-weight:500;}
.sgi-s{font-size:11px;color:var(--t3);margin-top:1px;}
.tsw{width:40px;height:24px;background:var(--border2);border-radius:12px;position:relative;cursor:pointer;transition:background .2s;border:none;flex-shrink:0;}
.tsw.on{background:var(--acc);}
.tsw::after{content:'';position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:3px;left:3px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
.tsw.on::after{left:19px;}
.ri-wrap{display:flex;gap:9px;padding:13px 15px;}
.ri-f{flex:1;display:flex;flex-direction:column;gap:4px;}
.ri-f label{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;}
.ri-f input{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:var(--text);background:var(--bg);border:1.5px solid var(--border);border-radius:7px;padding:7px 9px;outline:none;width:100%;-moz-appearance:textfield;}
.ri-f input:focus{border-color:var(--acc);}
.ri-f input::-webkit-inner-spin-button{-webkit-appearance:none;}
.dbtn{width:100%;padding:13px 15px;background:none;border:none;color:var(--low);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;text-align:left;transition:background .15s;border-bottom:1px solid var(--border);}
.dbtn:hover{background:var(--low-bg);}
.dbtn:last-child{border-bottom:none;}

/* ─── LOG MODAL ─── */
.mbd{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:400;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .22s;}
.mbd.open{opacity:1;pointer-events:all;}
.msheet{width:100%;max-width:430px;background:#fff;border-radius:20px 20px 0 0;padding:0 0 32px;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);max-height:88vh;overflow-y:auto;overflow-x:visible;}
.mbd.open .msheet{transform:translateY(0);}
.mhandle{width:30px;height:3px;background:var(--border2);border-radius:2px;margin:11px auto 0;}
.mtop{padding:14px 20px 0;display:flex;align-items:center;justify-content:space-between;}
.mtitle{font-size:18px;font-weight:800;}
.mclose{width:28px;height:28px;border-radius:50%;background:var(--bg);border:none;cursor:pointer;font-size:15px;color:var(--t2);display:flex;align-items:center;justify-content:center;}
.biw{text-align:center;padding:12px 20px 2px;}
.bi{font-size:60px;font-weight:800;width:200px;text-align:center;background:none;border:none;outline:none;color:var(--text);letter-spacing:-2.5px;font-family:'JetBrains Mono',monospace;-moz-appearance:textfield;}
.bi::-webkit-inner-spin-button{-webkit-appearance:none;}
.biu{font-size:12px;color:var(--t3);font-family:'JetBrains Mono',monospace;}
.rfb{min-height:18px;font-size:12px;font-weight:600;text-align:center;padding:2px 20px 4px;}
.msec{padding:10px 20px 0;}
.msec-lbl{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px;}
.ctxg{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.cc{display:flex;align-items:center;gap:8px;padding:9px 11px;background:var(--bg);border:1.5px solid transparent;border-radius:var(--rs);cursor:pointer;font-size:12px;font-weight:600;color:var(--t2);transition:all .15s;user-select:none;}
.cc.selected{background:var(--acc-bg);border-color:var(--acc);color:var(--acc);}
.cc-ic{font-size:15px;}

/* CARB/INSULIN SECTION */
.carb-ins-box{background:var(--acc-bg);border:1.5px solid var(--acc-b);border-radius:10px;padding:12px 14px;margin:0 20px;}
.cib-row{display:flex;align-items:center;gap:10px;}
.cib-field{flex:1;display:flex;flex-direction:column;gap:3px;}
.cib-label{font-size:10px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.05em;}
.cib-input{background:#fff;border:1.5px solid var(--acc-b);border-radius:7px;padding:9px 10px;font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;color:var(--text);outline:none;width:100%;-moz-appearance:textfield;transition:border-color .15s;}
.cib-input:focus{border-color:var(--acc);}
.cib-input::-webkit-inner-spin-button{-webkit-appearance:none;}
.cib-arrow{font-size:18px;color:var(--acc);flex-shrink:0;margin-top:14px;}
.cib-result{flex:1;display:flex;flex-direction:column;gap:3px;}
.cib-result-label{font-size:10px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.05em;}
.cib-result-val{font-size:30px;font-weight:800;color:var(--acc);font-family:'JetBrains Mono',monospace;letter-spacing:-1px;}
.cib-result-unit{font-size:12px;color:var(--acc);opacity:.7;}
.cib-note{font-size:11px;color:var(--acc);opacity:.7;margin-top:8px;line-height:1.5;}

.iif{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--rs);padding:9px 11px;display:flex;flex-direction:column;gap:3px;transition:border-color .15s;}
.iif:focus-within{border-color:var(--acc);}
.iif label{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;}
.iif input{background:none;border:none;outline:none;font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--text);width:100%;-moz-appearance:textfield;}
.iif input::-webkit-inner-spin-button{-webkit-appearance:none;}
.nf{width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--rs);padding:9px 11px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);resize:none;outline:none;transition:border-color .15s;}
.nf:focus{border-color:var(--acc);}
.nf::placeholder{color:var(--t3);}
.svbtn{width:calc(100% - 40px);margin:14px 20px 0;padding:13px;background:var(--acc);border:none;border-radius:var(--rs);color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s;}
.svbtn:hover{background:#1e40af;}
.iins{display:flex;gap:8px;}


/* ─── FOOD AUTOCOMPLETE ─── */
.food-wrap{position:relative;flex:1;overflow:visible;}
.food-suggestions{position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid var(--acc);border-radius:var(--rs);box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:500;margin-top:3px;overflow:hidden;display:none;max-height:220px;overflow-y:auto;}
.food-suggestions.open{display:block;}
.food-sugg-item{padding:9px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;transition:background .1s;}
.food-sugg-item:last-child{border-bottom:none;}
.food-sugg-item:hover{background:var(--acc-bg);}
.food-sugg-name{font-size:13px;font-weight:600;color:var(--text);}
.food-sugg-carbs{font-size:12px;font-weight:700;color:var(--acc);font-family:'JetBrains Mono',monospace;}
.food-sugg-loading{padding:10px 12px;font-size:12px;color:var(--t3);text-align:center;}
.food-sugg-per{font-size:10px;color:var(--t3);margin-left:4px;}

/* ─── MEAL LOG MODAL ─── */
.meal-tabs{display:flex;gap:3px;background:var(--bg);border-radius:8px;padding:3px;margin:12px 20px 0;}
.meal-tab{flex:1;padding:8px;text-align:center;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer;color:var(--t3);border:none;background:none;transition:all .15s;}
.meal-tab.active{background:#fff;color:var(--acc);box-shadow:var(--sh);}
.meal-content{padding:0 20px;}
.meal-content.hidden{display:none;}

/* MANUAL MEAL */
.meal-item-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;overflow:visible;position:relative;}
.meal-item-name{flex:1;padding:9px 11px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--rs);font-size:13px;color:var(--text);outline:none;font-family:'Plus Jakarta Sans',sans-serif;}
.meal-item-name:focus{border-color:var(--acc);}
.meal-item-name::placeholder{color:var(--t3);}
.meal-item-carbs{width:72px;padding:9px 9px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--rs);font-size:13px;color:var(--text);outline:none;font-family:'JetBrains Mono',monospace;text-align:center;-moz-appearance:textfield;}
.meal-item-carbs:focus{border-color:var(--acc);}
.meal-item-carbs::-webkit-inner-spin-button{-webkit-appearance:none;}
.meal-del{width:30px;height:30px;border:none;background:var(--low-bg);border-radius:7px;color:var(--low);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.add-item-btn{width:100%;padding:9px;border:1.5px dashed var(--border2);border-radius:var(--rs);background:none;font-size:13px;font-weight:600;color:var(--t2);cursor:pointer;transition:all .15s;}
.add-item-btn:hover{border-color:var(--acc);color:var(--acc);}
.meal-total-box{background:var(--acc-bg);border-radius:10px;padding:12px 14px;margin:10px 0;}
.meal-total-row{display:flex;align-items:center;justify-content:space-between;}
.meal-total-lbl{font-size:12px;color:var(--acc);font-weight:600;}
.meal-total-val{font-size:22px;font-weight:800;color:var(--acc);font-family:'JetBrains Mono',monospace;letter-spacing:-.5px;}
.meal-insulin-rec{font-size:12px;color:var(--acc);opacity:.75;margin-top:4px;}

/* CAMERA MEAL */
.cam-area{border:2px dashed var(--border2);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;margin:10px 0;}
.cam-area:hover{border-color:var(--acc);background:var(--acc-bg);}
.cam-area img{width:100%;border-radius:8px;max-height:200px;object-fit:cover;display:none;}
.cam-area-placeholder{pointer-events:none;}
.cam-area-ic{font-size:36px;margin-bottom:8px;}
.cam-area-txt{font-size:13px;color:var(--t2);font-weight:600;}
.cam-area-sub{font-size:12px;color:var(--t3);margin-top:3px;}
.cam-result-box{background:var(--bg);border-radius:10px;padding:12px;margin:8px 0;display:none;}
.crb-name{font-size:15px;font-weight:700;margin-bottom:4px;}
.crb-stats{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;}
.crb-stat{padding:4px 10px;background:#fff;border-radius:6px;border:1px solid var(--border);font-size:12px;}
.crb-stat span{font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--acc);}
.crb-items{font-size:12px;color:var(--t2);line-height:1.6;}
.analyze-btn{width:100%;padding:11px;background:var(--acc);border:none;border-radius:var(--rs);color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;margin:6px 0;}
.analyze-btn:disabled{opacity:.6;cursor:not-allowed;}


/* ─── ENTRY ACTION BUTTONS ─── */
.ei-actions{display:flex;gap:4px;flex-shrink:0;margin-left:6px;}
.ei-act{width:28px;height:28px;border-radius:7px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;flex-shrink:0;}
.ei-act.edit{background:var(--acc-bg);color:var(--acc);}
.ei-act.edit:hover{background:var(--acc);color:#fff;}
.ei-act.del{background:var(--low-bg);color:var(--low);}
.ei-act.del:hover{background:var(--low);color:#fff;}


/* ─── DRAWER SUBMENUS ─── */
.di-group{width:100%;}
.di-parent{display:flex;align-items:center;gap:11px;padding:12px 20px;cursor:pointer;font-size:14px;font-weight:500;color:var(--t2);transition:all .15s;border:none;background:none;width:100%;text-align:left;justify-content:space-between;}
.di-parent:hover{background:var(--bg);color:var(--text);}
.di-parent.active{color:var(--acc);background:var(--acc-bg);}
.di-parent-left{display:flex;align-items:center;gap:11px;}
.di-arrow{font-size:10px;color:var(--t3);transition:transform .22s;flex-shrink:0;}
.di-sub{max-height:0;overflow:hidden;transition:max-height .28s cubic-bezier(.4,0,.2,1);}
.di-sub.open{max-height:400px;}
.di-sub .di{padding:9px 20px 9px 51px;font-size:13px;}
/* ─── SECTION SCREENS ─── */
.rpt-sub-tabs{display:flex;gap:4px;overflow-x:auto;padding:0 14px 10px;scrollbar-width:none;}
.rpt-sub-tabs::-webkit-scrollbar{display:none;}
.rpt-tab{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;color:var(--t3);background:var(--bg);border:none;cursor:pointer;white-space:nowrap;transition:all .15s;}
.rpt-tab.active{background:var(--acc);color:#fff;}
.rpt-panel{display:none;padding-bottom:80px;}
.rpt-panel.active{display:block;}
/* ─── ALARM CARDS ─── */
.alarm-card{background:#fff;border:1px solid var(--border);border-radius:var(--r);margin:10px 14px 0;padding:14px 16px;box-shadow:var(--sh);}
.alarm-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;}
.alarm-row:last-child{margin-bottom:0;}
.alarm-info{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
.alarm-ic{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.alarm-title{font-size:13px;font-weight:700;color:var(--text);}
.alarm-sub{font-size:11px;color:var(--t3);margin-top:1px;}
.alarm-val{display:flex;align-items:center;gap:6px;}
.alarm-input{width:64px;padding:5px 7px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--text);outline:none;-moz-appearance:textfield;text-align:center;}
.alarm-input:focus{border-color:var(--acc);}
.alarm-input::-webkit-inner-spin-button{-webkit-appearance:none;}
/* ─── CONNECTED APPS ─── */
.app-card{background:#fff;border:1px solid var(--border);border-radius:var(--r);margin:10px 14px 0;overflow:hidden;box-shadow:var(--sh);}
.app-item{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid var(--border);}
.app-item:last-child{border-bottom:none;}
.app-logo{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;background:var(--bg);}
.app-info{flex:1;min-width:0;}
.app-name{font-size:13px;font-weight:700;}
.app-desc{font-size:11px;color:var(--t3);margin-top:1px;}
.app-connect{padding:6px 14px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;flex-shrink:0;}
.app-connect.connected{background:var(--ok-bg);color:var(--ok);border:1px solid var(--ok-b);}
.app-connect.disconnected{background:var(--acc);color:#fff;}
/* ─── REMINDERS ─── */
.rem-card{background:#fff;border:1px solid var(--border);border-radius:var(--r);margin:10px 14px 0;padding:14px 16px;box-shadow:var(--sh);}
.rem-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);}
.rem-row:last-child{border-bottom:none;}
.rem-left{display:flex;align-items:center;gap:10px;}
.rem-ic{font-size:20px;width:32px;text-align:center;}
.rem-title{font-size:13px;font-weight:600;}
.rem-time{font-size:11px;color:var(--t3);margin-top:1px;}
.rem-time input{background:none;border:none;outline:none;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--acc);cursor:pointer;padding:0;width:70px;}
/* ─── HELP & ABOUT ─── */
.help-section{margin:10px 14px 0;}
.help-q{background:#fff;border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;margin-bottom:8px;}
.help-q-hd{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;cursor:pointer;font-size:13px;font-weight:600;}
.help-q-body{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .25s ease,padding .25s ease;font-size:12px;color:var(--t2);line-height:1.7;}
.help-q-body.open{max-height:300px;padding:0 16px 12px;}
.about-card{background:linear-gradient(135deg,#0D1321,#1e293b);border-radius:var(--r);margin:10px 14px;padding:20px;color:#fff;text-align:center;}
.about-logo{font-size:36px;margin-bottom:8px;}
.about-name{font-size:20px;font-weight:800;letter-spacing:-.5px;margin-bottom:4px;}
.about-ver{font-size:12px;opacity:.5;font-family:'JetBrains Mono',monospace;}
.about-divider{height:1px;background:rgba(255,255,255,.1);margin:16px 0;}
.about-row{display:flex;justify-content:space-between;font-size:12px;padding:4px 0;opacity:.7;}
.about-disclaimer{font-size:11px;opacity:.4;margin-top:12px;line-height:1.6;}


/* ─── LIBRELINK CONNECT MODAL ─── */
.libre-modal-bd{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:300;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .22s;}
.libre-modal-bd.open{opacity:1;pointer-events:all;}
.libre-modal{background:#fff;border-radius:16px;width:100%;max-width:380px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25);}
.libre-modal-head{background:linear-gradient(135deg,#0077C8,#00A3E0);padding:20px;display:flex;align-items:center;gap:12px;}
.libre-modal-logo{width:44px;height:44px;background:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.libre-modal-htxt{color:#fff;}
.libre-modal-htxt h3{font-size:16px;font-weight:800;margin-bottom:2px;}
.libre-modal-htxt p{font-size:11px;opacity:.75;}
.libre-modal-body{padding:20px;}
.libre-modal-field{margin-bottom:14px;}
.libre-modal-field label{display:block;font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;}
.libre-modal-field input,.libre-modal-field select{width:100%;padding:10px 12px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;font-size:14px;color:var(--text);outline:none;font-family:'Plus Jakarta Sans',sans-serif;transition:border-color .15s;}
.libre-modal-field input:focus,.libre-modal-field select:focus{border-color:#0077C8;}
.libre-modal-connect-btn{width:100%;padding:13px;background:#0077C8;border:none;border-radius:9px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;margin-top:6px;}
.libre-modal-connect-btn:hover{background:#005fa3;}
.libre-modal-connect-btn:disabled{opacity:.6;cursor:not-allowed;}
.libre-modal-cancel{width:100%;padding:10px;background:none;border:none;color:var(--t3);font-size:13px;font-weight:600;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;margin-top:6px;}
.libre-modal-note{font-size:11px;color:var(--t3);line-height:1.6;margin-top:10px;padding:10px;background:var(--bg);border-radius:8px;}
.libre-live-card{background:linear-gradient(135deg,#0077C8,#00A3E0);border-radius:12px;padding:16px;margin:10px 14px 0;color:#fff;}
.libre-live-label{font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px;}
.libre-live-val{font-size:48px;font-weight:800;letter-spacing:-2px;font-family:'JetBrains Mono',monospace;line-height:1;}
.libre-live-unit{font-size:12px;opacity:.6;margin-top:2px;}
.libre-live-trend{font-size:20px;margin-left:8px;vertical-align:middle;}
.libre-live-meta{font-size:11px;opacity:.55;margin-top:6px;}
.libre-live-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.15);border-radius:20px;padding:3px 10px;font-size:10px;font-weight:700;margin-top:8px;}
.libre-sync-row{display:flex;align-items:center;justify-content:space-between;margin-top:10px;}
.libre-sync-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);border-radius:8px;padding:7px 14px;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
.libre-sync-btn:hover{background:rgba(255,255,255,.3);}
.app-connect.libre-connected{background:#0077C8;color:#fff;border:none;}
.app-status-dot{width:7px;height:7px;border-radius:50%;background:var(--ok);display:inline-block;margin-right:4px;animation:blink 2s infinite;}

/* ─── CAMERA FULL SCREEN ─── */
.camfs{position:fixed;inset:0;z-index:500;background:#000;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:opacity .2s;}
.camfs.open{opacity:1;pointer-events:all;}
.camfs-top{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;position:absolute;top:0;left:0;right:0;z-index:10;background:linear-gradient(to bottom,rgba(0,0,0,.6),transparent);}
.camfs-title{font-size:15px;font-weight:700;color:#fff;}
.camfs-close{width:30px;height:30px;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:50%;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;}
.camfs-vw{flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
#camfsVideo{width:100%;height:100%;object-fit:cover;}
#camfsPreview{width:100%;height:100%;object-fit:cover;display:none;}
.camfs-frame{position:absolute;width:72%;aspect-ratio:4/3;border:2px solid rgba(255,255,255,.6);border-radius:14px;box-shadow:0 0 0 9999px rgba(0,0,0,.35);pointer-events:none;}
.camfs-analyzing{position:absolute;inset:0;background:rgba(0,0,0,.7);display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:#fff;font-size:14px;font-weight:600;}
.camfs-analyzing.show{display:flex;}
.spin{width:34px;height:34px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:sp .7s linear infinite;}
@keyframes sp{to{transform:rotate(360deg)}}
.camfs-bottom{padding:16px 16px 28px;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);position:absolute;bottom:0;left:0;right:0;display:flex;align-items:center;justify-content:center;gap:16px;}
.camfs-hint{text-align:center;color:rgba(255,255,255,.5);font-size:12px;position:absolute;bottom:100px;width:100%;left:0;}
.camfs-cap{width:60px;height:60px;border-radius:50%;background:#fff;border:4px solid rgba(255,255,255,.4);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:22px;transition:transform .15s;}
.camfs-cap:active{transform:scale(.9);}
.camfs-upload{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:9px 14px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
#fsFileInput{display:none;}

/* ─── WELLBEING TAGS ─── */
.tag-pill{padding:6px 11px;border-radius:20px;border:1.5px solid var(--border);background:var(--bg);font-size:12px;font-weight:600;color:var(--t2);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;}
.tag-pill.active{background:#F5F3FF;border-color:#7C3AED;color:#7C3AED;}
body.dark .tag-pill{background:var(--white);border-color:var(--border);color:var(--t2);}
body.dark .tag-pill.active{background:#1a0d35;border-color:#5b21b6;color:#a78bfa;}

/* ─── FIRST BITE PILLS ─── */
.first-bite-btn{padding:7px 12px;border-radius:20px;border:1.5px solid var(--border);background:var(--bg);font-size:12px;font-weight:600;color:var(--t2);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;}
.first-bite-btn.active{background:var(--acc-bg);border-color:var(--acc);color:var(--acc);}

/* ─── EXERCISE SCREEN ─── */
.ex-hero{background:linear-gradient(135deg,#064e3b,#065f46);border:none;color:#fff;}
.ex-status{font-size:42px;font-weight:800;letter-spacing:-2px;font-family:'JetBrains Mono',monospace;line-height:1;}
.ex-status-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.07em;opacity:.6;margin-bottom:4px;}
.ex-status-sub{font-size:13px;opacity:.75;margin-top:6px;line-height:1.5;}
.ex-action{margin-top:12px;padding:10px 14px;border-radius:10px;font-size:13px;font-weight:700;line-height:1.5;}
.ex-action.go{background:rgba(52,211,153,.2);border:1px solid rgba(52,211,153,.4);color:#34d399;}
.ex-action.warn{background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.35);color:#fbbf24;}
.ex-action.stop{background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.35);color:#f87171;}
.ex-pills{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.ex-pill{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(255,255,255,.12);color:rgba(255,255,255,.85);}
.ex-profile-row{display:flex;gap:8px;margin:10px 14px 0;}
.ex-profile-btn{flex:1;padding:10px 6px;background:#fff;border:2px solid var(--border);border-radius:10px;text-align:center;cursor:pointer;font-size:11px;font-weight:700;color:var(--t2);transition:all .15s;}
.ex-profile-btn.active{border-color:var(--acc);color:var(--acc);background:var(--acc-bg);}
.ex-profile-btn .epb-ic{font-size:20px;margin-bottom:3px;}
.ex-profile-btn .epb-lbl{font-size:10px;font-weight:700;}
.ex-profile-btn .epb-sub{font-size:9px;color:var(--t3);margin-top:1px;font-weight:400;}
.ex-table{width:100%;border-collapse:collapse;font-size:11px;}
.ex-table th{background:var(--bg);padding:6px 8px;text-align:left;font-weight:700;font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border);}
.ex-table td{padding:7px 8px;border-bottom:1px solid var(--border);vertical-align:top;line-height:1.4;}
.ex-table tr:last-child td{border-bottom:none;}
.ex-table .go-td{color:var(--ok);font-weight:600;}
.ex-table .warn-td{color:var(--hi);font-weight:600;}
.ex-table .stop-td{color:var(--low);font-weight:600;}
.ex-timer-bar{background:#fff;border:1px solid var(--border);border-radius:var(--r);margin:10px 14px 0;padding:14px;display:flex;align-items:center;gap:12px;}
.ex-timer-ic{font-size:28px;}
.ex-timer-txt{flex:1;}
.ex-timer-btn{padding:8px 14px;border-radius:8px;border:none;font-size:13px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
.ex-start-btn{background:var(--ok);color:#fff;}
.ex-stop-btn{background:var(--low-bg);color:var(--low);}
.ex-elapsed{font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;letter-spacing:-1px;color:var(--acc);}
</style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div class="toast-wrap" id="toastWrap"></div>
<div id="confirmOverlay" style="display:none;"></div>

<!-- ══ AUTH SCREEN ══ -->


<!-- ══ MAIN APP ══ -->
<div class="topbar">
  <button class="burger" id="burgerBtn" onclick="toggleDrawer()">
    <div class="bl"></div><div class="bl"></div><div class="bl"></div>
  </button>
  <div class="logo">Gluco<span>Track</span></div>
  <div class="topbar-right">
    <div class="topbar-date" id="topDate"></div>
    <button onclick="toggleDark()" id="darkBtn" style="width:34px;height:34px;border:none;background:none;cursor:pointer;font-size:17px;border-radius:8px;transition:background .15s;display:flex;align-items:center;justify-content:center;" title="Toggle dark mode">🌙</button>
  </div>
</div>

<!-- WIDGET BAR -->
<div class="wbar">
  <div class="wbar-inner">
    <div class="wbar-left">
      <div>
        <div class="wval-grp">
          <div class="wnum none" id="wNum">—</div>
          <div class="wunit">mmol/L</div>
          <div class="wtrend" id="wTrend"></div>
        </div>
        <div class="wtime" id="wTime">No reading</div>
      </div>
      <div class="wspark"><canvas id="sparkCv"></canvas></div>
    </div>
    <button class="wcam" onclick="openCamFull()">📷 Scan Meal</button>
  </div>
</div>

<!-- DRAWER -->
<div class="dov" id="dov" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="dh">
    <div class="dh-user" id="drawerUser">—</div>
    <div class="dh-email" id="drawerEmail">—</div>
  </div>
  <nav class="dnav">
    <!-- HOME -->
    <button class="di active" id="nav-home" onclick="goTo('home')"><div class="di-ic">🏠</div>Home</button>
    <!-- LOGBOOK group -->
    <div class="di-group">
      <button class="di-parent" id="nav-logbook" onclick="toggleSubMenu('sub-logbook',this)">
        <div class="di-parent-left"><div class="di-ic">📓</div>Logbook</div>
        <span class="di-arrow" id="arr-logbook">▶</span>
      </button>
      <div class="di-sub" id="sub-logbook">
        <button class="di" id="nav-logmeal" onclick="openMealModal();closeDrawer()"><div class="di-ic">🍽️</div>Log Meal</button>
        <button class="di" id="nav-forecast" onclick="goTo('forecast')"><div class="di-ic">🔮</div>Glucose Forecast</button>
        <button class="di" id="nav-history" onclick="goTo('history')"><div class="di-ic">📋</div>Reading History</button>
      </div>
    </div>
    <!-- REPORTS group -->
    <div class="di-group">
      <button class="di-parent" id="nav-reports" onclick="toggleSubMenu('sub-reports',this)">
        <div class="di-parent-left"><div class="di-ic">📊</div>Reports</div>
        <span class="di-arrow" id="arr-reports">▶</span>
      </button>
      <div class="di-sub" id="sub-reports">
        <button class="di" id="nav-report-patterns" onclick="goTo('reports');setReportTab('patterns')"><div class="di-ic">📈</div>Daily Patterns</button>
        <button class="di" id="nav-report-tir" onclick="goTo('reports');setReportTab('tir')"><div class="di-ic">🎯</div>Time In Range</button>
        <button class="di" id="nav-report-low" onclick="goTo('reports');setReportTab('low')"><div class="di-ic">🚨</div>Low Glucose Events</button>
        <button class="di" id="nav-report-avg" onclick="goTo('reports');setReportTab('avg')"><div class="di-ic">📉</div>Average Glucose</button>
        <button class="di" id="nav-report-meal" onclick="goTo('reports');setReportTab('meal')"><div class="di-ic">🍽️</div>Meal Impact</button>
        <button class="di" id="nav-report-daily" onclick="goTo('reports');setReportTab('daily')"><div class="di-ic">📆</div>Daily Graph</button>
        <button class="di" id="nav-a1c" onclick="goTo('a1c')"><div class="di-ic">🔬</div>Estimated A1c</button>
      </div>
    </div>
    <!-- ALARMS -->
    <button class="di" id="nav-alarms" onclick="goTo('alarms')"><div class="di-ic">🔔</div>Alarms</button>
    <!-- REMINDERS -->
    <button class="di" id="nav-reminders" onclick="goTo('reminders')"><div class="di-ic">⏰</div>Reminders</button>
    <!-- EXERCISE -->
    <button class="di" id="nav-exercise" onclick="goTo('exercise')"><div class="di-ic">🏃</div>Exercise Guide</button>
    <!-- CONNECTED APPS -->
    <button class="di" id="nav-apps" onclick="goTo('apps')"><div class="di-ic">🔗</div>Connected Apps</button>
    <div class="ddiv"></div>
    <!-- SETTINGS -->
    <button class="di" id="nav-settings" onclick="goTo('settings')"><div class="di-ic">⚙️</div>Settings</button>
    <!-- HELP -->
    <div class="di-group">
      <button class="di-parent" id="nav-helpgrp" onclick="toggleSubMenu('sub-help',this)">
        <div class="di-parent-left"><div class="di-ic">❓</div>Help &amp; About</div>
        <span class="di-arrow" id="arr-help">▶</span>
      </button>
      <div class="di-sub" id="sub-help">
        <button class="di" id="nav-help" onclick="goTo('help')"><div class="di-ic">💬</div>Help</button>
        <button class="di" id="nav-about" onclick="goTo('about')"><div class="di-ic">ℹ️</div>About</button>
      </div>
    </div>
    <div class="ddiv"></div>
    <button class="di" onclick="logOut()"><div class="di-ic">🚪</div>Sign Out</button>
    <div class="ddiv"></div>
    <button class="di" onclick="shareApp();closeDrawer()"><div class="di-ic">📤</div>Share GlucoTrack</button>
  </nav>
  <div class="dfooter">GlucoTrack v4.0 · mmol/L</div>
</div>

<!-- FAB -->
<button class="fab" id="fab" onclick="openLogModal()">
  <div class="fab-plus">+</div> Log Reading
</button>

<!-- SCROLL AREA -->
<div class="scroll" id="scrollArea">

<!-- ── HOME ── -->
<div class="screen active" id="screen-home">
  <div class="card">
    <div class="gc-top">
      <div><div class="gc-lbl">Current Glucose</div></div>
      <div class="gc-badge bok" id="statusBadge"><div class="bdot"></div><span id="statusText">—</span></div>
    </div>
    <div class="gc-row">
      <div class="gc-num none" id="mainNum">—</div>
      <div class="gc-ucol">
        <div class="gc-unit">mmol/L</div>
        <div class="gc-trend" id="trendArrow">—</div>
      </div>
    </div>
    <div class="gc-meta">
      <div class="gc-time" id="lastCheck">No readings yet</div>
      <div class="gc-rh">Target: <span id="rHint">3.9–10.0</span></div>
    </div>
    <div class="rstrip">
      <div class="rtrack"><div class="rneedle" id="rneedle" style="left:50%"></div></div>
      <div class="raxis"><span>3.0</span><span>3.9</span><span>7.8</span><span>10.0</span><span>16.7+</span></div>
    </div>
  </div>
  <div class="strow">
    <div class="st"><div class="stv" id="sAvg">—</div><div class="stl">Avg Today</div></div>
    <div class="st"><div class="stv" id="sTIR">—%</div><div class="stl">In Range</div></div>
    <div class="st"><div class="stv" id="sCount">0</div><div class="stl">Readings</div></div>
  </div>
  <!-- Week-over-week mini banner -->
  <div id="wowBanner" style="display:none;margin:8px 14px 0;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:space-between;">
    <div style="font-size:11px;color:var(--t3);">vs last week</div>
    <div style="font-size:13px;font-weight:800;font-family:'JetBrains Mono',monospace;" id="homeDelta">—</div>
    <div style="font-size:11px;color:var(--t3);" id="homeDeltaNote">—</div>
  </div>

  <!-- CHART CARD -->
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd" style="margin-bottom:8px;">
      <div class="sc-title">Glucose Levels (mmol/L)</div>
    </div>
    <div class="chart-container">
      <div class="chart-canvas-wrap">
        <canvas id="mainChart" class="main-chart"></canvas>
        <div class="chart-tooltip" id="chartTooltip"></div>
      </div>
      <div class="chart-date-range" style="margin-top:8px;">
        <button class="cdr-btn active" onclick="setChartRange('3h',this)">3h</button>
        <button class="cdr-btn" onclick="setChartRange('6h',this)">6h</button>
        <button class="cdr-btn" onclick="setChartRange('today',this)">Today</button>
        <button class="cdr-btn" onclick="setChartRange('3d',this)">3d</button>
        <button class="cdr-btn" onclick="setChartRange('7d',this)">7d</button>
        <button class="cdr-btn" onclick="setChartRange('14d',this)">14d</button>
        <button class="cdr-btn" onclick="setChartRange('custom',this)" id="cdrCustomBtn">Custom</button>
      </div>
      <div id="customDateRow" style="display:none;margin-top:6px;padding:0 2px;align-items:center;gap:6px;flex-wrap:wrap;">
        <span style="font-size:11px;color:var(--t3);">From</span>
        <input type="date" class="cdr-date-in" id="cdrFrom">
        <span style="font-size:11px;color:var(--t3);">To</span>
        <input type="date" class="cdr-date-in" id="cdrTo">
        <button onclick="applyCustomRange()" style="padding:4px 10px;border-radius:6px;background:var(--acc);color:#fff;border:none;font-size:11px;font-weight:700;cursor:pointer;">Apply</button>
      </div>
    </div>
  </div>

  <!-- RECENT -->
  <div class="card card-last" style="margin-top:10px;">
    <div class="sc-hd"><div class="sc-title">Recent Readings</div></div>
    <div id="recentList"><div class="empty"><div class="empty-ic">💉</div>No readings yet.</div></div>
  </div>
</div>

<!-- ── FORECAST ── -->
<div class="screen" id="screen-forecast">
  <div class="ptitle">Glucose Forecast</div>
  <div class="psub">Predictive model · meals, insulin &amp; trend</div>
  <div class="card fc-hero">
    <div class="fc-hd-txt">Next 3 Hours Prediction</div>
    <div class="fc-row">
      <div class="fc-item"><div class="fc-lbl">Now</div><div class="fc-num" id="fcNow">—</div></div>
      <div class="fc-arr">→</div>
      <div class="fc-item"><div class="fc-lbl">1 hour</div><div class="fc-num" id="fc1h">—</div></div>
      <div class="fc-arr">→</div>
      <div class="fc-item"><div class="fc-lbl">2 hours</div><div class="fc-num" id="fc2h">—</div></div>
      <div class="fc-arr">→</div>
      <div class="fc-item"><div class="fc-lbl">3 hours</div><div class="fc-num" id="fc3h">—</div></div>
    </div>
    <div class="fc-meta" id="fcMeta">Log a reading to see your forecast</div>
    <div class="fc-pills" id="fcPills"></div>
    <div class="fc-chart-wrap"><canvas id="fcChart" class="ch" style="width:100%;height:100%;"></canvas></div>
    <div class="fc-note" id="fcNote">Forecast is based on logged readings, meals, and insulin. Log regularly for accuracy.</div>
  </div>
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd"><div class="sc-title">Active Factors</div></div>
    <div id="fcFactors"><div class="empty" style="padding:12px;"><div class="empty-ic" style="font-size:20px;">⚡</div>No active meals or insulin</div></div>
  </div>
  <div class="card card-last" style="margin-top:10px;">
    <div class="sc-hd"><div class="sc-title">Recommendations</div></div>
    <div id="fcRecs"><div class="empty" style="padding:12px;"><div class="empty-ic" style="font-size:20px;">💡</div>Log readings for personalised recommendations</div></div>
  </div>

  <!-- BASAL FEATURE 1: Adequacy -->
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd">
      <div class="sc-title">🌙 Basal Adequacy</div>
      <div style="font-size:10px;color:var(--t3);">Based on fasting readings</div>
    </div>
    <div id="basalAdequacy"><div class="empty" style="padding:10px;font-size:12px;">Log fasting readings (Before Bed &amp; Waking Up) for analysis</div></div>
  </div>

  <!-- BASAL FEATURE 2: Overnight drift -->
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd">
      <div class="sc-title">🌜 Overnight Trend</div>
      <div style="font-size:10px;color:var(--t3);">Bedtime → morning (7 days)</div>
    </div>
    <div id="overnightTrend"><div class="empty" style="padding:10px;font-size:12px;">Need both Before Bed and Waking Up readings</div></div>
  </div>

  <!-- BASAL FEATURE 3: Logging streak -->
  <div class="card card-last" style="margin-top:10px;margin-bottom:12px;">
    <div class="sc-hd">
      <div class="sc-title">💉 Basal Injection Streak</div>
      <div style="font-size:10px;color:var(--t3);">Daily logging record</div>
    </div>
    <div id="basalStreak"><div class="empty" style="padding:10px;font-size:12px;">No basal injections logged yet</div></div>
  </div>
</div>

<!-- ── A1C ── -->
<div class="screen" id="screen-a1c">
  <div class="ptitle">A1c &amp; Trends</div>
  <div class="psub">Estimated from your logged readings</div>
  <div class="card" style="text-align:center;">
    <div style="font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;">Estimated HbA1c</div>
    <div class="a1c-big" id="a1cBig" style="color:var(--ok)">—<span class="a1c-pct">%</span></div>
    <div style="font-size:13px;color:var(--t3);margin-bottom:12px;" id="a1cSub">Log more readings to calculate</div>
    <div class="a1c-zone" id="a1cZone" style="background:var(--ok-bg);color:var(--ok);border-color:var(--ok-b)">—</div>
    <div class="gtrack"><div class="gneedle" id="gneedle" style="left:0%"></div></div>
    <div class="glabels"><span>4%</span><span>5%</span><span>6%</span><span>7%</span><span>8%</span><span>10%</span><span>14%</span></div>
    <div class="a1c-note">Estimated: A1c ≈ (avg mmol/L × 1.5927 + 1.628) · Not a replacement for a lab HbA1c test.</div>
  </div>
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd"><div class="sc-title">A1c Trend (weekly)</div></div>
    <div style="width:100%;height:150px;position:relative;"><canvas id="a1cChart" style="width:100%;height:100%;"></canvas></div>
  </div>
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd"><div class="sc-title">Time In Range (7 days)</div></div>
    <div>
      <div class="tir-row"><div class="tir-nm" style="color:var(--low)">Low</div><div class="tir-bw"><div class="tir-bf" id="tirLow" style="background:var(--low);width:0%"></div></div><div class="tir-pc" id="tirLowP" style="color:var(--low)">0%</div></div>
      <div class="tir-row"><div class="tir-nm" style="color:var(--ok)">Target</div><div class="tir-bw"><div class="tir-bf" id="tirOk" style="background:var(--ok);width:0%"></div></div><div class="tir-pc" id="tirOkP" style="color:var(--ok)">0%</div></div>
      <div class="tir-row"><div class="tir-nm" style="color:var(--hi)">High</div><div class="tir-bw"><div class="tir-bf" id="tirHigh" style="background:var(--hi);width:0%"></div></div><div class="tir-pc" id="tirHighP" style="color:var(--hi)">0%</div></div>
      <div class="tir-row"><div class="tir-nm" style="color:var(--vhi)">V.High</div><div class="tir-bw"><div class="tir-bf" id="tirVH" style="background:var(--vhi);width:0%"></div></div><div class="tir-pc" id="tirVHP" style="color:var(--vhi)">0%</div></div>
    </div>
  </div>
  <div class="strow" style="margin-top:10px;">
    <div class="st"><div class="stv" id="a7avg">—</div><div class="stl">7d Avg</div></div>
    <div class="st"><div class="stv" id="a7min" style="color:var(--low)">—</div><div class="stl">Lowest</div></div>
    <div class="st"><div class="stv" id="a7max" style="color:var(--hi)">—</div><div class="stl">Highest</div></div>
  </div>

  <!-- GMI / CV% / eAG card -->
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd" style="margin-bottom:4px;">
      <div class="sc-title">Glucose Management Indicators</div>
      <div style="font-size:10px;color:var(--t3);">14-day window</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">
      <div style="text-align:center;padding:12px 6px;background:var(--bg);border-radius:10px;">
        <div style="font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">GMI</div>
        <div style="font-size:26px;font-weight:800;letter-spacing:-1px;font-family:'JetBrains Mono',monospace;" id="gmiVal">—</div>
        <div style="font-size:10px;color:var(--t3);margin-top:2px;">%</div>
      </div>
      <div style="text-align:center;padding:12px 6px;background:var(--bg);border-radius:10px;">
        <div style="font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">CV%</div>
        <div style="font-size:26px;font-weight:800;letter-spacing:-1px;font-family:'JetBrains Mono',monospace;" id="cvVal">—</div>
        <div style="font-size:10px;color:var(--t3);margin-top:2px;">%</div>
      </div>
      <div style="text-align:center;padding:12px 6px;background:var(--bg);border-radius:10px;">
        <div style="font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">eAG</div>
        <div style="font-size:26px;font-weight:800;letter-spacing:-1px;font-family:'JetBrains Mono',monospace;" id="eagVal">—</div>
        <div style="font-size:10px;color:var(--t3);margin-top:2px;">mmol/L</div>
      </div>
    </div>
    <!-- CV% status bar -->
    <div id="cvStatusBox" style="display:none;padding:10px 12px;border-radius:9px;border:1px solid;margin-bottom:10px;">
      <div style="font-size:12px;font-weight:700;" id="cvStatusTitle">—</div>
      <div style="font-size:11px;margin-top:3px;opacity:.85;" id="cvStatusSub">—</div>
    </div>
    <!-- GMI vs lab A1c note -->
    <div id="gmiDiffBox" style="display:none;padding:10px 12px;background:var(--bg);border-radius:9px;margin-bottom:8px;">
      <div style="font-size:11px;color:var(--t2);line-height:1.6;" id="gmiDiffTxt">—</div>
    </div>
    <div style="font-size:10px;color:var(--t3);line-height:1.7;border-top:1px solid var(--border);padding-top:8px;">
      <strong>GMI</strong> (Glucose Management Indicator) estimates HbA1c from 14-day CGM/SMBG data · Bergenstal et al., <em>Diabetes Care</em> 2018<br>
      <strong>CV%</strong> (Coefficient of Variation) measures glucose variability · Target &lt;36% · Rodbard, <em>Diabetes Tech Ther</em> 2009<br>
      <strong>eAG</strong> (Estimated Average Glucose) derived from A1c · Nathan et al., ADA 2008<br>
      ⚠️ These are estimates only. Always use lab HbA1c results for clinical decisions.
    </div>
  </div>

  <!-- Week-over-week comparison -->
  <div class="card card-last" style="margin-top:10px;margin-bottom:12px;" id="wowCard">
    <div class="sc-hd"><div class="sc-title">Week-over-Week</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;" id="wowGrid">
      <div style="text-align:center;">
        <div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px;">This Week</div>
        <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;" id="wowThis">—</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px;">Last Week</div>
        <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;" id="wowLast">—</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px;">Change</div>
        <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;" id="wowDelta">—</div>
      </div>
    </div>
    <div style="font-size:11px;color:var(--t3);margin-top:8px;" id="wowNote">Log at least 3 readings this week and last week to compare.</div>
  </div>
</div>

<!-- ── HISTORY ── -->
<div class="screen" id="screen-history">
  <div class="hist-hd">
    <div class="ptitle" style="padding:0;">History</div>
    <div style="font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;" id="histCnt">0 readings</div>
  </div>
  <div id="histList"><div class="empty" style="margin:28px 0;"><div class="empty-ic">📋</div>No readings logged yet.</div></div>
</div>

<!-- ── SETTINGS ── -->
<div class="screen" id="screen-settings">
  <div class="ptitle">Settings</div>
  <div class="sg">
    <div class="sglbl">Target Range (mmol/L)</div>
    <div class="sgcard">
      <div class="ri-wrap">
        <div class="ri-f"><label>Low Below</label><input type="number" id="sLow" value="3.9" step="0.1" onchange="saveSettings()"></div>
        <div class="ri-f"><label>High Above</label><input type="number" id="sHigh" value="10.0" step="0.1" onchange="saveSettings()"></div>
      </div>
    </div>
    <div class="sglbl">HbA1c Target</div>
    <div class="sgcard">
      <div class="ri-wrap">
        <div class="ri-f"><label>My HbA1c Goal (%)</label><input type="number" id="sA1cGoal" value="7.0" step="0.1" min="5.0" max="10.0" onchange="saveSettings()"></div>
      </div>
      <div style="padding:0 15px 12px;font-size:11px;color:var(--t3);line-height:1.6;">ADA standard is &lt;7%. Your endocrinologist may set a different personal target.</div>
    </div>
    <div class="sglbl">Bolus (Short-Acting) Insulin</div>
    <div class="sgcard">
      <div class="ri-wrap">
        <div class="ri-f"><label>Carb Ratio (g/unit)</label><input type="number" id="sCarbRatio" value="10" step="1" onchange="saveSettings()"></div>
        <div class="ri-f"><label>Correction (mmol/u)</label><input type="number" id="sCorrFactor" value="2.2" step="0.1" onchange="saveSettings()"></div>
      </div>
      <div style="padding:0 15px 12px;font-size:11px;color:var(--t3);line-height:1.6;">
        Uses the <strong>Walsh Bolus Calculator</strong> (medical standard):<br>
        <strong>Meal dose</strong> = Carbs ÷ <strong id="carbRatioDisplay">10</strong>g/u &nbsp;·&nbsp;
        <strong>Correction</strong> = (BG − target) ÷ <strong id="corrDisplay">2.2</strong> mmol/u<br>
        Total = Meal + Correction − IOB &nbsp;·&nbsp; Always confirm with your diabetes care team.
      </div>
    </div>
    <div class="sglbl">Basal (Long-Acting) Insulin</div>
    <div class="sgcard">
      <div class="ri-wrap">
        <div class="ri-f"><label>Insulin Name</label><input type="text" id="sBasalName" placeholder="e.g. Lantus, Toujeo, Tresiba" onchange="saveSettings()" style="font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:600;"></div>
        <div class="ri-f"><label>Daily Dose (units)</label><input type="number" id="sBasalDose" value="0" step="1" min="0" max="200" onchange="saveSettings()" style="font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:var(--text);background:var(--bg);border:1.5px solid var(--border);border-radius:7px;padding:7px 9px;outline:none;width:100%;-moz-appearance:textfield;"></div>
      </div>
      <div style="padding:0 15px 8px;">
        <div style="font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">Injection Time</div>
        <input type="time" id="sBasalTime" value="18:00" onchange="saveSettings()" style="font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 14px;outline:none;width:100%;color:var(--text);letter-spacing:1px;">
      </div>
      <div id="basalReminderStatus" style="margin:4px 15px 12px;padding:10px 12px;background:var(--ok-bg);border:1px solid var(--ok-b);border-radius:8px;font-size:12px;color:var(--ok);line-height:1.6;display:none;">
        🔔 Reminders set — <strong id="basalPreRemindTime">—</strong> <span style="opacity:.7;">(15 min warning)</span> and <strong id="basalRemindTime">—</strong> <span style="opacity:.7;">(injection time)</span>
      </div>
      <div id="basalNoReminder" style="margin:4px 15px 12px;padding:10px 12px;background:var(--hi-bg);border:1px solid var(--hi-b);border-radius:8px;font-size:12px;color:var(--hi);line-height:1.6;display:none;">
        ⚠️ Set your daily dose above to activate reminders.
      </div>
    </div>
    <div class="sglbl">Alerts</div>
    <div class="sgcard">
      <div class="sgi" style="flex-direction:column;align-items:flex-start;gap:8px;padding:14px 15px;">
        <div style="display:flex;align-items:center;gap:10px;width:100%;">
          <div class="sgi-ic">🔔</div>
          <div style="flex:1"><div class="sgi-t">Browser Notifications</div><div class="sgi-s" id="notifStatus">Tap to enable</div></div>
          <button onclick="requestNotificationPermission(true)" style="padding:6px 12px;background:var(--acc);border:none;border-radius:7px;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:Plus Jakarta Sans,sans-serif;">Enable</button>
        </div>
        <div style="font-size:11px;color:var(--t3);line-height:1.5;padding-left:36px;">Required for alarms and the pre-meal timer to fire when your screen is locked.</div>
      </div>
      <div class="sgi"><div class="sgi-l"><div class="sgi-ic">🔴</div><div><div class="sgi-t">Low Glucose Alert</div><div class="sgi-s">Warn when below target</div></div></div><button class="tsw on" onclick="this.classList.toggle('on')"></button></div>
      <div class="sgi"><div class="sgi-l"><div class="sgi-ic">🟡</div><div><div class="sgi-t">High Glucose Alert</div><div class="sgi-s">Warn when above target</div></div></div><button class="tsw on" onclick="this.classList.toggle('on')"></button></div>
    </div>
    <div class="sglbl">Appearance</div>
    <div class="sgcard">
      <div class="sgi">
        <div class="sgi-l"><div class="sgi-ic">🌙</div><div><div class="sgi-t">Dark Mode</div><div class="sgi-s">Easier on the eyes at night</div></div></div>
        <button class="tsw" id="darkToggle" onclick="toggleDark()"></button>
      </div>
    </div>
    <div class="sglbl">Data &amp; Backup</div>
    <div class="sgcard">
      <button class="dbtn" onclick="backupData()" style="color:var(--ok);">💾 Backup All Data (JSON)</button>
      <button class="dbtn" onclick="document.getElementById('restoreInput').click()" style="color:var(--acc);">📥 Restore from Backup</button>
      <input type="file" id="restoreInput" accept=".json" onchange="restoreData(event)" style="display:none;">
      <button class="dbtn" onclick="exportCSV()">📤 Export Readings (CSV)</button>
      <!-- FreeStyle Libre import — temporarily disabled
      <button class="dbtn" onclick="document.getElementById('libreImportInput').click()" style="color:#0077C8;">📲 Import from FreeStyle Libre (CSV)</button>
      <input type="file" id="libreImportInput" accept=".csv" onchange="importLibreCSV(event)" style="display:none;">
      -->
      <button class="dbtn" onclick="document.getElementById('mysugrsImportInput').click()" style="color:#E84D1C;">📲 Import from mySugr / Accu-Chek (CSV)</button>
      <input type="file" id="mysugrsImportInput" accept=".csv" onchange="importMySugrCSV(event)" style="display:none;">
      <button class="dbtn" onclick="clearAll()">🗑️ Clear All Readings</button>
    </div>
    <div class="sglbl">Share</div>
    <div class="sgcard">
      <button class="dbtn" onclick="shareApp()" style="color:var(--acc);border-bottom:none;">📲 Share GlucoTrack with others</button>
    </div>
    <div class="sglbl">Add to Home Screen</div>
    <div class="sgcard">
      <div class="sgi" style="flex-direction:column;align-items:flex-start;gap:12px;padding:16px 15px;">
        <!-- Icon preview -->
        <div style="display:flex;align-items:center;gap:14px;width:100%;">
          <canvas id="iconPreview" width="60" height="60" style="border-radius:13px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.15);"></canvas>
          <div>
            <div class="sgi-t" style="font-size:15px;font-weight:800;">GlucoTrack</div>
            <div class="sgi-s" style="font-size:12px;">Installs as a native-feeling app on your home screen with a custom icon</div>
          </div>
        </div>

        <!-- iPhone Instructions -->
        <div id="pwaInstructions" style="width:100%;background:#0D1321;border-radius:12px;padding:14px;display:none;">
          <div style="font-size:12px;font-weight:700;color:#34d399;margin-bottom:10px;text-transform:uppercase;letter-spacing:.05em;">📱 iPhone / iPad — Safari Only</div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="width:24px;height:24px;background:#1A56DB;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;flex-shrink:0;">1</div>
              <div style="font-size:13px;color:rgba(255,255,255,.8);line-height:1.5;">Open this page in <strong style="color:#fff;">Safari</strong> (not Chrome or other browsers)</div>
            </div>
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="width:24px;height:24px;background:#1A56DB;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;flex-shrink:0;">2</div>
              <div style="font-size:13px;color:rgba(255,255,255,.8);line-height:1.5;">Tap the <strong style="color:#fff;">Share button</strong> <span style="font-size:15px;">⬆️</span> at the bottom of the screen</div>
            </div>
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="width:24px;height:24px;background:#1A56DB;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;flex-shrink:0;">3</div>
              <div style="font-size:13px;color:rgba(255,255,255,.8);line-height:1.5;">Scroll down and tap <strong style="color:#fff;">"Add to Home Screen"</strong></div>
            </div>
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="width:24px;height:24px;background:#34d399;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#0D1321;flex-shrink:0;">✓</div>
              <div style="font-size:13px;color:rgba(255,255,255,.8);line-height:1.5;">Tap <strong style="color:#fff;">"Add"</strong> — GlucoTrack appears on your home screen with the icon above</div>
            </div>
          </div>
        </div>

        <!-- Android Instructions -->
        <div id="pwaAndroid" style="width:100%;background:#0D1321;border-radius:12px;padding:14px;display:none;">
          <div style="font-size:12px;font-weight:700;color:#34d399;margin-bottom:10px;text-transform:uppercase;letter-spacing:.05em;">🤖 Android — Chrome</div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="width:24px;height:24px;background:#1A56DB;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;flex-shrink:0;">1</div>
              <div style="font-size:13px;color:rgba(255,255,255,.8);line-height:1.5;">Tap the <strong style="color:#fff;">⋮ menu</strong> in the top-right corner of Chrome</div>
            </div>
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="width:24px;height:24px;background:#1A56DB;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;flex-shrink:0;">2</div>
              <div style="font-size:13px;color:rgba(255,255,255,.8);line-height:1.5;">Tap <strong style="color:#fff;">"Add to Home Screen"</strong> or <strong style="color:#fff;">"Install App"</strong></div>
            </div>
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="width:24px;height:24px;background:#34d399;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#0D1321;flex-shrink:0;">✓</div>
              <div style="font-size:13px;color:rgba(255,255,255,.8);line-height:1.5;">Tap <strong style="color:#fff;">"Add"</strong> to confirm</div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <button onclick="showPwaInstructions()" id="pwaShowBtn" style="width:100%;padding:13px;background:var(--acc);border:none;border-radius:9px;color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
          <span>📲</span> <span id="pwaShowBtnTxt">How to Add to Home Screen</span>
        </button>
        <button onclick="triggerPwaInstall()" id="pwaInstallBtn" style="width:100%;padding:12px;background:none;border:1.5px solid var(--acc);border-radius:9px;color:var(--acc);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;display:none;">
          ⬇️ Install App (tap to confirm)
        </button>
      </div>
    </div>
    <div class="sglbl">AI Features (Meal Analysis &amp; Food Search)</div>
    <div class="sgcard">
      <div style="padding:12px 15px 6px;">
        <div style="font-size:11px;color:var(--t3);line-height:1.7;margin-bottom:10px;">Enter your Anthropic API key to enable AI meal photo analysis and food carb lookup. Your key is stored only on this device.<br><a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--acc);font-weight:600;">Get a free key at console.anthropic.com →</a></div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
          <input type="password" id="sApiKey" placeholder="sk-ant-…" onchange="saveApiKey()" style="flex:1;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--text);background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:9px 11px;outline:none;min-width:0;" autocomplete="off" spellcheck="false">
          <button onclick="testApiKey()" style="padding:9px 14px;background:var(--acc);border:none;border-radius:8px;color:#fff;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;">Test</button>
        </div>
        <div id="apiKeyStatus" style="font-size:11px;line-height:1.6;display:none;padding:8px 10px;border-radius:7px;margin-bottom:6px;"></div>
      </div>
    </div>
    <div style="padding:10px 0 16px;font-size:11px;color:var(--t3);line-height:1.6;">GlucoTrack v4.0 · mmol/L · Data stored locally on device.<br>AI meal analysis powered by Claude AI. Not a medical device. Always consult your endocrinologist or diabetes care team before adjusting insulin doses.</div>
  </div>
</div>


<!-- ── REPORTS ── -->
<div class="screen" id="screen-reports">
  <div class="ptitle" style="display:flex;align-items:center;justify-content:space-between;padding-right:14px;">
    <span>Reports</span>
    <button onclick="generatePDFReport()" style="padding:8px 14px;background:var(--acc);border:none;border-radius:9px;color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;">📄 Export PDF</button>
  </div>
  <div class="psub">Analyse your glucose patterns</div>
  <div class="rpt-sub-tabs" id="rptTabs">
    <button class="rpt-tab active" onclick="setReportTab('patterns',this)">Daily Patterns</button>
    <button class="rpt-tab" onclick="setReportTab('tir',this)">Time In Range</button>
    <button class="rpt-tab" onclick="setReportTab('low',this)">Low Events</button>
    <button class="rpt-tab" onclick="setReportTab('avg',this)">Average Glucose</button>
    <button class="rpt-tab" onclick="setReportTab('daily',this)">Daily Graph</button>
    <button class="rpt-tab" onclick="setReportTab('meal',this)">🍽️ Meal Impact</button>
  </div>

  <!-- DAILY PATTERNS -->
  <div class="rpt-panel active" id="rpt-patterns">
    <div class="card"><div class="sc-hd"><div class="sc-title">Hourly Average (7 days)</div></div>
      <div style="width:100%;height:170px;position:relative;"><canvas id="patternChart"></canvas></div>
      <div style="font-size:11px;color:var(--t3);margin-top:8px;line-height:1.6;">Shows your average glucose level per hour of the day across the last 7 days. Helps identify post-meal spikes and overnight patterns.</div>
    </div>
    <div class="strow card-last" style="margin-bottom:12px;">
      <div class="st"><div class="stv" id="rptPeakHour">—</div><div class="stl">Peak Hour</div></div>
      <div class="st"><div class="stv" id="rptLowHour">—</div><div class="stl">Lowest Hour</div></div>
      <div class="st"><div class="stv" id="rptReadings7">0</div><div class="stl">7d Readings</div></div>
    </div>
  </div>

  <!-- TIME IN RANGE -->
  <div class="rpt-panel" id="rpt-tir">
    <div class="card">
      <div class="sc-hd"><div class="sc-title">Time In Range — 14 days</div></div>
      <div style="width:100%;height:170px;position:relative;"><canvas id="tirDonutChart"></canvas></div>
    </div>
    <div class="card card-last" style="margin-top:10px;">
      <div class="sc-hd"><div class="sc-title">Breakdown</div></div>
      <div class="tir-row"><div class="tir-nm" style="color:var(--low)">Low &lt;3.9</div><div class="tir-bw"><div class="tir-bf" id="rptTirLow" style="background:var(--low);width:0%"></div></div><div class="tir-pc" id="rptTirLowP" style="color:var(--low)">0%</div></div>
      <div class="tir-row"><div class="tir-nm" style="color:var(--ok)">Target</div><div class="tir-bw"><div class="tir-bf" id="rptTirOk" style="background:var(--ok);width:0%"></div></div><div class="tir-pc" id="rptTirOkP" style="color:var(--ok)">0%</div></div>
      <div class="tir-row"><div class="tir-nm" style="color:var(--hi)">High</div><div class="tir-bw"><div class="tir-bf" id="rptTirHigh" style="background:var(--hi);width:0%"></div></div><div class="tir-pc" id="rptTirHighP" style="color:var(--hi)">0%</div></div>
      <div class="tir-row"><div class="tir-nm" style="color:var(--vhi)">V.High</div><div class="tir-bw"><div class="tir-bf" id="rptTirVH" style="background:var(--vhi);width:0%"></div></div><div class="tir-pc" id="rptTirVHP" style="color:var(--vhi)">0%</div></div>
    </div>
  </div>

  <!-- LOW GLUCOSE EVENTS -->
  <div class="rpt-panel" id="rpt-low">
    <div class="card">
      <div class="sc-hd"><div class="sc-title">Low Glucose Events (30 days)</div></div>
      <div class="strow" style="margin:0 0 14px;">
        <div class="st"><div class="stv" id="rptLowCount" style="color:var(--low)">0</div><div class="stl">Total Events</div></div>
        <div class="st"><div class="stv" id="rptLowAvg" style="color:var(--low)">—</div><div class="stl">Avg Level</div></div>
        <div class="st"><div class="stv" id="rptLowSev">—</div><div class="stl">Lowest</div></div>
      </div>
      <div id="rptLowList"><div class="empty"><div class="empty-ic">✅</div>No low glucose events. Great job!</div></div>
    </div>
    <div class="card card-last" style="margin-top:10px;">
      <div class="sc-hd"><div class="sc-title">Low Events by Time of Day</div></div>
      <div style="width:100%;height:140px;position:relative;"><canvas id="lowByHourChart"></canvas></div>
    </div>
  </div>

  <!-- AVERAGE GLUCOSE -->
  <div class="rpt-panel" id="rpt-avg">
    <div class="card">
      <div class="sc-hd"><div class="sc-title">Average Glucose Trend</div></div>
      <div style="width:100%;height:170px;position:relative;"><canvas id="avgTrendChart"></canvas></div>
    </div>
    <div class="strow" style="margin:10px 14px 0;">
      <div class="st"><div class="stv" id="rptAvg7">—</div><div class="stl">7-day Avg</div></div>
      <div class="st"><div class="stv" id="rptAvg14">—</div><div class="stl">14-day Avg</div></div>
      <div class="st"><div class="stv" id="rptAvg30">—</div><div class="stl">30-day Avg</div></div>
    </div>
    <div class="card card-last" style="margin:10px 14px 0;padding:14px 16px;">
      <div style="font-size:11px;color:var(--t3);line-height:1.7;" id="rptAvgNote">Average glucose is calculated from all logged readings. Target: 3.9–10.0 mmol/L.</div>
    </div>
  </div>

  <!-- DAILY GRAPH -->
  <div class="rpt-panel" id="rpt-daily">
    <div class="card">
      <div class="sc-hd">
        <div class="sc-title">Daily Glucose Graph</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <button onclick="shiftDailyDay(-1)" style="padding:3px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-size:12px;">◀</button>
          <span id="dailyDayLabel" style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--t2);min-width:70px;text-align:center;">Today</span>
          <button onclick="shiftDailyDay(1)" style="padding:3px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-size:12px;">▶</button>
        </div>
      </div>
      <div style="width:100%;height:180px;position:relative;"><canvas id="dailyGraph"></canvas></div>
    </div>
    <div class="strow card-last" style="margin-bottom:12px;">
      <div class="st"><div class="stv" id="dgAvg">—</div><div class="stl">Day Avg</div></div>
      <div class="st"><div class="stv" id="dgMin" style="color:var(--low)">—</div><div class="stl">Min</div></div>
      <div class="st"><div class="stv" id="dgMax" style="color:var(--hi)">—</div><div class="stl">Max</div></div>
    </div>
  </div>

  <!-- MEAL IMPACT PANEL -->
  <div class="rpt-panel" id="rpt-meal">
    <div class="card" style="margin-top:10px;">
      <div class="sc-hd">
        <div class="sc-title">Postprandial Glucose Spikes</div>
        <div style="font-size:10px;color:var(--t3);">Last 14 days</div>
      </div>
      <div style="font-size:11px;color:var(--t3);margin-bottom:12px;line-height:1.6;">Shows peak BG rise within 2h of each meal. <strong>ADA target:</strong> post-meal BG &lt;10.0 mmol/L. A rise &gt;2.0 mmol/L may indicate meal size or insulin dose needs review with your care team.</div>
      <div id="mealImpactList"><div class="empty"><div class="empty-ic">🍽️</div>Log meals with carbs to see spike analysis.</div></div>
    </div>
    <div class="card" style="margin-top:10px;">
      <div class="sc-hd"><div class="sc-title">Highest-Impact Foods</div></div>
      <div style="font-size:11px;color:var(--t3);margin-bottom:8px;">Foods ranked by average glucose spike — highest first. Review with your dietitian.</div>
      <div id="worstFoodsList"><div class="empty" style="padding:8px 0;">Log at least 3 meals to see rankings.</div></div>
    </div>
    <div class="card card-last" style="margin-top:10px;margin-bottom:12px;">
      <div class="sc-hd"><div class="sc-title">Wellbeing Tag Impact</div></div>
      <div style="font-size:11px;color:var(--t3);margin-bottom:8px;">Average glucose on days with each wellbeing tag vs without. Requires 3+ tagged readings per tag.</div>
      <div id="tagImpactList"><div class="empty" style="padding:8px 0;">Log readings with wellbeing tags to see patterns.</div></div>
    </div>
  </div>

</div>

<!-- ── ALARMS ── -->
<div class="screen" id="screen-alarms">
  <div class="ptitle">Alarms</div>
  <div class="psub">Set glucose alert thresholds</div>
  <div class="alarm-card">
    <div class="sc-title" style="margin-bottom:12px;">Glucose Alarms</div>
    <div class="alarm-row">
      <div class="alarm-info">
        <div class="alarm-ic" style="background:var(--low-bg)">🚨</div>
        <div><div class="alarm-title">Low Alarm</div><div class="alarm-sub">Alert when BG drops below threshold</div></div>
      </div>
      <div class="alarm-val">
        <input type="number" class="alarm-input" id="alLow" value="3.9" step="0.1" min="2.0" max="5.0" onchange="saveAlarms()">
        <button class="tsw on" id="alLowSw" onclick="toggleAlarm(this)"></button>
      </div>
    </div>
    <div class="alarm-row">
      <div class="alarm-info">
        <div class="alarm-ic" style="background:var(--hi-bg)">⚠️</div>
        <div><div class="alarm-title">High Alarm</div><div class="alarm-sub">Alert when BG rises above threshold</div></div>
      </div>
      <div class="alarm-val">
        <input type="number" class="alarm-input" id="alHigh" value="10.0" step="0.1" min="6.0" max="20.0" onchange="saveAlarms()">
        <button class="tsw on" id="alHighSw" onclick="toggleAlarm(this)"></button>
      </div>
    </div>
    <div class="alarm-row">
      <div class="alarm-info">
        <div class="alarm-ic" style="background:var(--low-bg)">🔴</div>
        <div><div class="alarm-title">Urgent Low Alarm</div><div class="alarm-sub">Critical alert for severe hypoglycaemia</div></div>
      </div>
      <div class="alarm-val">
        <input type="number" class="alarm-input" id="alUrgLow" value="3.0" step="0.1" min="2.0" max="4.0" onchange="saveAlarms()">
        <button class="tsw on" id="alUrgLowSw" onclick="toggleAlarm(this)"></button>
      </div>
    </div>
    <div class="alarm-row">
      <div class="alarm-info">
        <div class="alarm-ic" style="background:#FFF5F5)">📈</div>
        <div><div class="alarm-title">Rising Fast</div><div class="alarm-sub">Alert when glucose rising &gt;2 mmol/h</div></div>
      </div>
      <div class="alarm-val">
        <button class="tsw" id="alRiseSw" onclick="toggleAlarm(this)"></button>
      </div>
    </div>
    <div class="alarm-row">
      <div class="alarm-info">
        <div class="alarm-ic" style="background:var(--acc-bg)">📉</div>
        <div><div class="alarm-title">Falling Fast</div><div class="alarm-sub">Alert when glucose falling &gt;2 mmol/h</div></div>
      </div>
      <div class="alarm-val">
        <button class="tsw on" id="alFallSw" onclick="toggleAlarm(this)"></button>
      </div>
    </div>
  </div>
  <div class="alarm-card card-last" style="margin-top:10px;margin-bottom:12px;">
    <div class="sc-title" style="margin-bottom:12px;">Notification Settings</div>
    <div class="alarm-row">
      <div class="alarm-info">
        <div class="alarm-ic" style="background:var(--pur-bg)">🔊</div>
        <div><div class="alarm-title">Sound Alerts</div><div class="alarm-sub">Play sound when alarm triggers</div></div>
      </div>
      <button class="tsw on" id="alSoundSw" onclick="toggleAlarm(this)"></button>
    </div>
    <div class="alarm-row">
      <div class="alarm-info">
        <div class="alarm-ic" style="background:var(--bg)">📳</div>
        <div><div class="alarm-title">Vibration</div><div class="alarm-sub">Vibrate when alarm triggers</div></div>
      </div>
      <button class="tsw on" id="alVibeSw" onclick="toggleAlarm(this)"></button>
    </div>
    <div class="alarm-row">
      <div class="alarm-info">
        <div class="alarm-ic" style="background:var(--bg)">🌙</div>
        <div><div class="alarm-title">Overnight Alarms</div><div class="alarm-sub">Allow alarms between 22:00–07:00</div></div>
      </div>
      <button class="tsw on" id="alNightSw" onclick="toggleAlarm(this)"></button>
    </div>
    <div style="margin-top:14px;padding:12px;background:var(--acc-bg);border-radius:10px;border:1px solid var(--acc-b);">
      <div style="font-size:12px;font-weight:700;color:var(--acc);margin-bottom:6px;">⚡ When alarms trigger</div>
      <div style="font-size:11px;color:var(--acc);opacity:.85;line-height:1.8;">
        • Every time you <strong>log a reading</strong> manually<br>
        • Every <strong>30 seconds</strong> while the app is open (checks latest reading)<br>
        • Urgent Low repeats every <strong>5 min</strong> until BG rises<br>
        • All others wait <strong>15 min</strong> before repeating
      </div>
    </div>
    <button onclick="testAlarm()" style="width:100%;margin-top:12px;padding:11px;background:var(--bg);border:1.5px solid var(--border2);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--t2);cursor:pointer;">🔔 Test Alarm Sound &amp; Vibration</button>
  </div>
</div>

<!-- ── REMINDERS ── -->
<div class="screen" id="screen-reminders">
  <div class="ptitle">Reminders</div>
  <div class="psub">Never miss a blood glucose check</div>
  <div class="rem-card">
    <div class="sc-title" style="margin-bottom:8px;">Daily Check Reminders</div>
    <div class="rem-row">
      <div class="rem-left"><div class="rem-ic">☀️</div><div><div class="rem-title">Morning Check</div><div class="rem-time"><input type="time" value="07:00" onchange="saveReminders()"></div></div></div>
      <button class="tsw on" onclick="this.classList.toggle('on');saveReminders()"></button>
    </div>
    <div class="rem-row">
      <div class="rem-left"><div class="rem-ic">🍽️</div><div><div class="rem-title">Before Breakfast</div><div class="rem-time"><input type="time" value="08:00" onchange="saveReminders()"></div></div></div>
      <button class="tsw on" onclick="this.classList.toggle('on');saveReminders()"></button>
    </div>
    <div class="rem-row">
      <div class="rem-left"><div class="rem-ic">🌞</div><div><div class="rem-title">Midday Check</div><div class="rem-time"><input type="time" value="12:30" onchange="saveReminders()"></div></div></div>
      <button class="tsw" onclick="this.classList.toggle('on');saveReminders()"></button>
    </div>
    <div class="rem-row">
      <div class="rem-left"><div class="rem-ic">🍴</div><div><div class="rem-title">Before Dinner</div><div class="rem-time"><input type="time" value="18:00" onchange="saveReminders()"></div></div></div>
      <button class="tsw on" onclick="this.classList.toggle('on');saveReminders()"></button>
    </div>
    <div class="rem-row">
      <div class="rem-left"><div class="rem-ic">😴</div><div><div class="rem-title">Before Bed</div><div class="rem-time"><input type="time" value="22:00" onchange="saveReminders()"></div></div></div>
      <button class="tsw on" onclick="this.classList.toggle('on');saveReminders()"></button>
    </div>
  </div>
  <div class="rem-card card-last" style="margin-top:10px;margin-bottom:12px;">
    <div class="sc-title" style="margin-bottom:8px;">Other Reminders</div>
    <div class="rem-row">
      <div class="rem-left"><div class="rem-ic">💊</div><div><div class="rem-title">Medication</div><div class="rem-time"><input type="time" value="08:00" onchange="saveReminders()"></div></div></div>
      <button class="tsw on" onclick="this.classList.toggle('on');saveReminders()"></button>
    </div>
    <div class="rem-row">
      <div class="rem-left"><div class="rem-ic">🏋️</div><div><div class="rem-title">Exercise Reminder</div><div class="rem-time"><input type="time" value="17:00" onchange="saveReminders()"></div></div></div>
      <button class="tsw" onclick="this.classList.toggle('on');saveReminders()"></button>
    </div>
    <div class="rem-row">
      <div class="rem-left"><div class="rem-ic">📱</div><div><div class="rem-title">Sensor Change</div><div class="rem-time"><input type="time" value="09:00" onchange="saveReminders()"></div></div></div>
      <button class="tsw" onclick="this.classList.toggle('on');saveReminders()"></button>
    </div>
    <div style="margin-top:12px;padding:10px;background:var(--acc-bg);border-radius:9px;font-size:11px;color:var(--acc);line-height:1.6;">
      <strong>📌 To receive push notifications:</strong> Add GlucoTrack to your home screen first, then enable notifications when prompted.
    </div>
    <button onclick="testNotification()" style="width:100%;margin-top:10px;padding:11px;background:var(--bg);border:1.5px solid var(--border2);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--t2);cursor:pointer;">🔔 Send Test Notification</button>
    <button onclick="saveReminders()" style="width:100%;margin-top:8px;padding:11px;background:var(--acc);border:none;border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:#fff;cursor:pointer;">💾 Save All Reminders</button>
  </div>
</div>

<!-- ── CONNECTED APPS ── -->
<div class="screen" id="screen-apps">
  <div class="ptitle">Connected Apps</div>
  <div class="psub">Integrate with your health ecosystem</div>

  <!-- FREESTYLE LIBRE LIVE CARD (shown when connected) -->
  <div id="libreLiveCard" style="display:none;">
    <div class="libre-live-card">
      <div class="libre-live-label">FreeStyle Libre · Live Reading</div>
      <div style="display:flex;align-items:baseline;gap:4px;">
        <div class="libre-live-val" id="libreVal">—</div>
        <div class="libre-live-trend" id="libreTrend"></div>
      </div>
      <div class="libre-live-unit">mmol/L</div>
      <div class="libre-live-meta" id="libreMeta">—</div>
      <div class="libre-live-badge"><span class="app-status-dot"></span>Live from LibreLinkUp</div>
      <div class="libre-sync-row">
        <span style="font-size:11px;opacity:.55;" id="libreLastSync">Not synced yet</span>
        <button class="libre-sync-btn" onclick="libreSync()">🔄 Sync Now</button>
      </div>
    </div>
    <div class="app-card" style="margin:10px 14px 0;">
      <div style="padding:12px 16px 8px;font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;">Sync Options</div>
      <div class="sgi"><div class="sgi-l"><div class="sgi-ic">🔄</div><div><div class="sgi-t">Auto-import readings</div><div class="sgi-s">Import CGM readings into GlucoTrack every sync</div></div></div><button class="tsw on" id="libreAutoImport" onclick="this.classList.toggle('on')"></button></div>
      <div class="sgi"><div class="sgi-l"><div class="sgi-ic">⏱️</div><div><div class="sgi-t">Background sync (5 min)</div><div class="sgi-s">Sync automatically while app is open</div></div></div><button class="tsw on" id="libreAutoSync" onclick="toggleLibreAutoSync(this)"></button></div>
    </div>
  </div>

  <!-- CGM DEVICES SECTION -->
  <div class="app-card" id="libreAppCard">
    <div style="padding:12px 16px 8px;font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;">CGM Devices</div>
    <div class="app-item">
      <div class="app-logo" style="background:#EBF5FF">💙</div>
      <div class="app-info">
        <div class="app-name">Abbott FreeStyle Libre 2 / 3</div>
        <div class="app-desc" id="libreStatusDesc">Connect via LibreLinkUp account · Real readings</div>
      </div>
      <button class="app-connect disconnected" id="libreConnectBtn" onclick="openLibreModal()">Connect</button>
    </div>
    <div class="app-item">
      <div class="app-logo" style="background:#FFF5F5">🔵</div>
      <div class="app-info"><div class="app-name">Dexcom G6 / G7</div><div class="app-desc">Requires Dexcom Developer API · Coming soon</div></div>
      <button class="app-connect disconnected" style="opacity:.5;cursor:not-allowed;" disabled>Soon</button>
    </div>
    <div class="app-item">
      <div class="app-logo" style="background:#F5F3FF">🟣</div>
      <div class="app-info"><div class="app-name">Medtronic Guardian</div><div class="app-desc">No public API available · Coming soon</div></div>
      <button class="app-connect disconnected" style="opacity:.5;cursor:not-allowed;" disabled>Soon</button>
    </div>
  </div>

  <div class="app-card" style="margin-top:10px;">
    <div style="padding:12px 16px 8px;font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;">Health Platforms</div>
    <div class="app-item">
      <div class="app-logo" style="background:#FFF5F5">❤️</div>
      <div class="app-info"><div class="app-name">Apple Health</div><div class="app-desc">Requires native iOS app · Not available in PWA</div></div>
      <button class="app-connect disconnected" style="opacity:.5;cursor:not-allowed;" disabled>iOS only</button>
    </div>
    <div class="app-item">
      <div class="app-logo" style="background:#F0FFF4">💚</div>
      <div class="app-info"><div class="app-name">Google Fit</div><div class="app-desc">Requires native Android app · Not available in PWA</div></div>
      <button class="app-connect disconnected" style="opacity:.5;cursor:not-allowed;" disabled>Android only</button>
    </div>
    <div class="app-item">
      <div class="app-logo" style="background:#EBF5FF">💙</div>
      <div class="app-info"><div class="app-name">NightScout</div><div class="app-desc">Open-source CGM server · Enter your Nightscout URL</div></div>
      <button class="app-connect disconnected" onclick="openNightscoutModal()">Connect</button>
    </div>
  </div>

  <div class="app-card card-last" style="margin-top:10px;margin-bottom:12px;">
    <div style="padding:12px 16px 8px;font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;">Insulin Pumps</div>
    <div class="app-item">
      <div class="app-logo" style="background:#FFF5F5">🩸</div>
      <div class="app-info"><div class="app-name">Omnipod 5</div><div class="app-desc">No public API · Coming soon</div></div>
      <button class="app-connect disconnected" style="opacity:.5;cursor:not-allowed;" disabled>Soon</button>
    </div>
    <div class="app-item">
      <div class="app-logo" style="background:#FFFBEB">🟠</div>
      <div class="app-info"><div class="app-name">Tandem t:slim X2</div><div class="app-desc">No public API · Coming soon</div></div>
      <button class="app-connect disconnected" style="opacity:.5;cursor:not-allowed;" disabled>Soon</button>
    </div>
  </div>
</div>

<!-- ══ FREESTYLE LIBRE CONNECT MODAL ══ -->
<div class="libre-modal-bd" id="libreModalBd" onclick="handleLibreModalBd(event)">
  <div class="libre-modal" id="libreModalBox">
    <div class="libre-modal-head">
      <div class="libre-modal-logo">💙</div>
      <div class="libre-modal-htxt">
        <h3>FreeStyle Libre</h3>
        <p>Abbott LibreLinkUp · Unofficial API · Real data</p>
      </div>
    </div>
    <div class="libre-modal-body">
      <div id="libreModalForm">
        <div class="libre-modal-field">
          <label>LibreLinkUp Email</label>
          <input type="email" id="libreEmail" placeholder="your@email.com" autocomplete="email">
        </div>
        <div class="libre-modal-field">
          <label>LibreLinkUp Password</label>
          <input type="password" id="librePassword" placeholder="••••••••" autocomplete="current-password">
        </div>
        <div class="libre-modal-field">
          <label>Region</label>
          <select id="libreRegion">
            <option value="eu">Europe (EU) — incl. South Africa</option>
            <option value="us">United States (US)</option>
            <option value="eu2">Europe 2 (EU2)</option>
            <option value="ae">Middle East (AE)</option>
            <option value="ap">Asia Pacific (AP)</option>
            <option value="au">Australia (AU)</option>
            <option value="ca">Canada (CA)</option>
            <option value="de">Germany (DE)</option>
            <option value="fr">France (FR)</option>
            <option value="jp">Japan (JP)</option>
          </select>
        </div>
        <button class="libre-modal-connect-btn" id="libreConnectSubmit" onclick="libreLogin()">Connect to LibreLinkUp</button>
        <button class="libre-modal-cancel" onclick="closeLibreModal()">Cancel</button>
        <div class="libre-modal-note">
          🔐 Your credentials are used only to fetch your CGM data from Abbott's LibreLinkUp server. They are stored locally on your device only and never sent anywhere else.<br><br>
          ⚠️ This uses an <strong>unofficial reverse-engineered API</strong>. It is not affiliated with Abbott. Use at your own risk.
          You must have the LibreLinkUp app installed and your sensor sharing set up before connecting.
        </div>
      </div>
      <div id="libreModalStatus" style="display:none;text-align:center;padding:10px 0 6px;">
        <div class="spin" style="margin:0 auto 12px;border-color:rgba(0,119,200,.2);border-top-color:#0077C8;"></div>
        <div style="font-size:13px;font-weight:600;color:var(--t2);" id="libreModalStatusTxt">Connecting…</div>
      </div>
    </div>
  </div>
</div>

<!-- ══ NIGHTSCOUT CONNECT MODAL ══ -->
<div class="libre-modal-bd" id="nsModalBd" onclick="handleNsModalBd(event)">
  <div class="libre-modal" id="nsModalBox">
    <div class="libre-modal-head" style="background:linear-gradient(135deg,#1a1a2e,#16213e);">
      <div class="libre-modal-logo">🌙</div>
      <div class="libre-modal-htxt">
        <h3>NightScout</h3>
        <p>Open-source CGM server · Real-time glucose</p>
      </div>
    </div>
    <div class="libre-modal-body">
      <div class="libre-modal-field">
        <label>NightScout URL</label>
        <input type="url" id="nsUrl" placeholder="https://yoursite.ns.10be.de" autocomplete="off">
      </div>
      <div class="libre-modal-field">
        <label>API Secret (optional)</label>
        <input type="password" id="nsSecret" placeholder="Leave blank if not set" autocomplete="off">
      </div>
      <button class="libre-modal-connect-btn" style="background:#1a1a2e;" onclick="connectNightscout()">Connect to NightScout</button>
      <button class="libre-modal-cancel" onclick="closeNsModal()">Cancel</button>
      <div class="libre-modal-note">NightScout is a self-hosted open-source CGM server. You need to have NightScout already set up and running before connecting here.</div>
    </div>
  </div>
</div>

<!-- ── HELP ── -->
<div class="screen" id="screen-help">
  <div class="ptitle">Help</div>
  <div class="psub">Answers to common questions</div>
  <div class="help-section">
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>How do I log a glucose reading?</span><span>▼</span></div><div class="help-q-body">Tap the blue <strong>Log Reading</strong> button at the bottom of the screen. Enter your glucose value from your meter in mmol/L, select the context (e.g. Before Meal), add any carbs or insulin, then tap Save.</div></div>
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>How does the Glucose Forecast work?</span><span>▼</span></div><div class="help-q-body">The forecast uses your recent readings to calculate a trend, then factors in any active carbs and insulin you've logged. It predicts your glucose 1–3 hours ahead. Log regularly for best accuracy.</div></div>
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>What is Time In Range (TIR)?</span><span>▼</span></div><div class="help-q-body">Time In Range is the percentage of your readings that fall within your target glucose range (default 3.9–10.0 mmol/L). The ADA recommends a TIR of at least 70% for most people with diabetes.</div></div>
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>How is estimated A1c calculated?</span><span>▼</span></div><div class="help-q-body">Estimated A1c is calculated using the formula: A1c ≈ (average mmol/L × 1.5927 + 1.628). This is an estimate only — always get a lab HbA1c test from your doctor for accurate results.</div></div>
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>How do I scan a meal with AI?</span><span>▼</span></div><div class="help-q-body">Tap <strong>📷 Scan Meal</strong> in the top bar. Point your camera at your meal and tap capture. The AI will identify the food and estimate carbohydrate content. You can then log it and get an insulin suggestion based on your carb ratio.</div></div>
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>How do I export my data?</span><span>▼</span></div><div class="help-q-body">Go to <strong>Settings → Data → Export All Readings (CSV)</strong>. This downloads a spreadsheet with all your logged readings, which you can share with your healthcare team.</div></div>
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>Is my data private?</span><span>▼</span></div><div class="help-q-body">Yes. All your glucose readings and meal data are stored locally on your device only. Nothing is uploaded to any server. The only external connection is the AI meal analysis feature, which sends meal photos to Claude AI for analysis.</div></div>
  </div>
  <div style="padding:14px 14px 80px;font-size:11px;color:var(--t3);line-height:1.7;">Need more help? Contact your diabetes care team or endocrinologist. GlucoTrack is not a medical device and does not replace professional medical advice.</div>
</div>

<!-- ── ABOUT ── -->
<div class="screen" id="screen-about">
  <div class="about-card">
    <div class="about-logo">💉</div>
    <div class="about-name">GlucoTrack</div>
    <div class="about-ver">Version 4.0 · mmol/L</div>
    <div class="about-divider"></div>
    <div class="about-row"><span>Platform</span><span>Progressive Web App</span></div>
    <div class="about-row"><span>Units</span><span>mmol/L</span></div>
    <div class="about-row"><span>AI Engine</span><span>Claude AI (Anthropic)</span></div>
    <div class="about-row"><span>Data Storage</span><span>Local device only</span></div>
    <div class="about-row"><span>Open Source</span><span>Not yet</span></div>
    <div class="about-disclaimer">GlucoTrack is not a medical device. It is a personal glucose logging and analysis tool. Always consult your endocrinologist or diabetes care team before making any changes to your insulin doses or treatment plan. Do not use this app as a substitute for professional medical advice, diagnosis, or treatment.</div>
  </div>
  <div class="help-section" style="padding-bottom:80px;">
    <div class="sc-title" style="padding:12px 0 8px;font-size:13px;">Acknowledgements</div>
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>Third-party services used</span><span>▼</span></div><div class="help-q-body">• Claude AI by Anthropic — meal image analysis<br>• Google Fonts — Plus Jakarta Sans &amp; JetBrains Mono<br>• Local storage API — data persistence</div></div>
    <div class="help-q"><div class="help-q-hd" onclick="toggleFaq(this)"><span>Medical disclaimer</span><span>▼</span></div><div class="help-q-body">This app is for personal tracking purposes only. Glucose readings and insulin suggestions are not a substitute for your doctor's advice. Always verify any insulin dose calculations with your healthcare provider before administering insulin.</div></div>
  </div>


<!-- ── EXERCISE ── -->
<div class="screen" id="screen-exercise">
  <div class="ptitle">Exercise Guide</div>
  <div class="psub">Based on EASD / ADA / ISPAD guidelines · Type 1 Diabetes</div>

  <!-- ── WHAT IS MY PROFILE? ── -->
  <div style="margin:0 14px 0;padding:12px 14px;background:var(--acc-bg);border:1.5px solid var(--acc-b);border-radius:12px;">
    <div style="font-size:12px;font-weight:700;color:var(--acc);margin-bottom:6px;">👆 Pick your exercise type:</div>
    <div style="font-size:12px;color:var(--acc);line-height:1.7;">
      <strong>🚶 Low intensity</strong> — walking, light yoga, stretching<br>
      <strong>🏃 Moderate</strong> — jogging, cycling, swimming, gym cardio<br>
      <strong>🏋️ High intensity</strong> — HIIT, heavy weights, sprints, competitive sport
    </div>
  </div>

  <!-- ── PROFILE SELECTOR ── -->
  <div class="ex-profile-row" style="margin-top:8px;">
    <div class="ex-profile-btn active" id="exProf0" onclick="setExProfile(0)">
      <div class="epb-ic">🚶</div>
      <div class="epb-lbl">Low</div>
      <div class="epb-sub">Walking / Yoga</div>
    </div>
    <div class="ex-profile-btn" id="exProf1" onclick="setExProfile(1)">
      <div class="epb-ic">🏃</div>
      <div class="epb-lbl">Moderate</div>
      <div class="epb-sub">Jogging / Cycling</div>
    </div>
    <div class="ex-profile-btn" id="exProf2" onclick="setExProfile(2)">
      <div class="epb-ic">🏋️</div>
      <div class="epb-lbl">High</div>
      <div class="epb-sub">HIIT / Weights</div>
    </div>
  </div>

  <!-- ── CURRENT BG STATUS CARD ── -->
  <div class="card ex-hero" style="margin-top:10px;">
    <div class="ex-status-lbl">Your Current Blood Sugar</div>
    <div style="display:flex;align-items:flex-end;gap:8px;">
      <div class="ex-status" id="exBgNum">—</div>
      <div style="padding-bottom:8px;opacity:.6;font-size:12px;">mmol/L <span id="exTrend"></span></div>
    </div>
    <div class="ex-pills" id="exPills"></div>
    <div class="ex-action warn" id="exAction">Log a blood sugar reading to get your personalised exercise recommendation</div>
  </div>

  <!-- ── EXERCISE TIMER ── -->
  <div class="ex-timer-bar" id="exTimerBar">
    <div class="ex-timer-ic">⏱️</div>
    <div class="ex-timer-txt">
      <div style="font-size:13px;font-weight:700;color:var(--text);">Exercise Timer</div>
      <div class="ex-elapsed" id="exElapsed">00:00</div>
      <div style="font-size:11px;color:var(--t3);" id="exTimerSub">Check BG every 20–30 min during exercise</div>
    </div>
    <button class="ex-timer-btn ex-start-btn" id="exTimerBtn" onclick="toggleExTimer()">Start</button>
  </div>

  <!-- ── BEFORE YOU EXERCISE ── -->
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd">
      <div class="sc-title">🟢 Before You Start</div>
      <div style="font-size:10px;color:var(--t3);" id="exProfLabel">Low intensity</div>
    </div>
    <div style="font-size:12px;color:var(--t3);margin-bottom:10px;line-height:1.5;">
      Check your blood sugar, look at the direction it's moving, then find your row below.
    </div>
    <div id="preExCards"></div>
    <div style="margin-top:10px;padding:10px;background:var(--bg);border-radius:8px;font-size:11px;color:var(--t3);line-height:1.7;">
      <strong>💡 Quick snack guide:</strong> 15g carbs ≈ 3 glucose tabs · 150ml fruit juice · 1 small banana · 4 Jelly Babies<br>
      <em>Source: EASD/ISPAD Exercise Position Statement (Moser et al. 2020)</em>
    </div>
  </div>

  <!-- ── DURING EXERCISE ── -->
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd"><div class="sc-title">🔄 During Exercise</div></div>
    <div style="font-size:12px;color:var(--t3);margin-bottom:10px;line-height:1.5;">
      Check every 20–30 min. If you feel shaky, dizzy or sweaty — stop and check immediately.
    </div>
    <div id="duringExCards"></div>
  </div>

  <!-- ── AFTER EXERCISE ── -->
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd"><div class="sc-title">🏁 After Exercise</div></div>
    <div style="font-size:12px;color:var(--t3);margin-bottom:10px;line-height:1.5;">
      Check your blood sugar within 30 min of finishing. Exercise can lower BG for up to 24 hours after.
    </div>
    <div id="postExCards"></div>
    <div style="margin-top:10px;padding:10px 12px;background:var(--hi-bg);border:1px solid var(--hi-b);border-radius:8px;font-size:12px;color:var(--hi);line-height:1.6;">
      ⚠️ <strong>Night hypo risk:</strong> After evening or intense exercise your blood sugar can drop 6–15 hours later — even while you sleep. Have a small snack before bed and consider setting a 3 AM alarm to check.
    </div>
  </div>

  <!-- ── GENERAL TIPS ── -->
  <div class="card" style="margin-top:10px;">
    <div class="sc-hd"><div class="sc-title">💡 General Tips for Exercising with T1D</div></div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div style="font-size:20px;flex-shrink:0;">🩺</div>
        <div style="font-size:12px;color:var(--t2);line-height:1.6;"><strong>Reduce your pre-exercise insulin</strong> — If you eat a meal before training, ask your diabetes team about reducing your meal bolus by 25–75% depending on exercise type and intensity.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div style="font-size:20px;flex-shrink:0;">🍬</div>
        <div style="font-size:12px;color:var(--t2);line-height:1.6;"><strong>Always carry fast-acting carbs</strong> — Glucose tabs, fruit juice, or jelly babies. Never exercise without them. Tell your gym partner or coach you have Type 1 diabetes.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div style="font-size:20px;flex-shrink:0;">📈</div>
        <div style="font-size:12px;color:var(--t2);line-height:1.6;"><strong>HIIT can raise BG first</strong> — High-intensity exercise releases adrenaline which pushes BG up temporarily. This usually corrects itself within 1–2 hours. Don't over-correct with insulin immediately.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div style="font-size:20px;flex-shrink:0;">💧</div>
        <div style="font-size:12px;color:var(--t2);line-height:1.6;"><strong>Stay hydrated</strong> — Dehydration affects blood sugar readings and insulin absorption. Drink water before, during and after exercise.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div style="font-size:20px;flex-shrink:0;">🚫</div>
        <div style="font-size:12px;color:var(--t2);line-height:1.6;"><strong>Don't inject into working muscles</strong> — Injecting insulin into your thigh before a run speeds up absorption and increases hypo risk. Use your abdomen before leg-heavy exercise.</div>
      </div>
    </div>
    <div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;font-size:10px;color:var(--t3);line-height:1.6;">
      ⚕️ This guide is for educational purposes only. It does not replace advice from your endocrinologist or diabetes care team. Not applicable to hybrid closed-loop (artificial pancreas) systems. Always discuss your exercise insulin plan with your diabetes team.
    </div>
  </div>

  <!-- ── NOCTURNAL REMINDER ── -->
  <div class="card card-last" style="margin-top:10px;margin-bottom:12px;">
    <div class="sc-hd"><div class="sc-title">🌙 Set a Night Check Reminder</div></div>
    <div style="font-size:12px;color:var(--t2);margin-bottom:12px;line-height:1.6;">
      After evening or intense exercise, set an alarm to check your blood sugar during the night. Hypos can happen up to 15 hours later.
    </div>
    <div style="display:flex;gap:8px;">
      <button onclick="setNocturnalReminder(6)" style="flex:1;padding:10px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;color:var(--t2);">In 6 hours</button>
      <button onclick="setNocturnalReminder(9)" style="flex:1;padding:10px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;color:var(--t2);">In 9 hours</button>
      <button onclick="setNocturnalReminder(12)" style="flex:1;padding:10px;background:var(--acc);border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;color:#fff;">In 12 hours</button>
    </div>
  </div>
</div>


<!-- ══ LOG READING MODAL ══ -->
<div class="mbd" id="mbd" onclick="handleBd(event)">
  <div class="msheet" id="logSheet">
    <div class="mhandle"></div>
    <div class="mtop"><div class="mtitle">Log Reading</div><button class="mclose" onclick="closeLogModal()">✕</button></div>
    <!-- Time edit row — shown only when editing -->
    <div id="editTimeRow" style="display:none;margin:8px 20px 0;background:var(--acc-bg);border:1.5px solid var(--acc-b);border-radius:10px;padding:10px 12px;">
      <div style="font-size:10px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">📅 Date &amp; Time Logged</div>
      <div style="display:flex;gap:8px;">
        <input type="date" id="editDate" style="flex:1;padding:7px 9px;background:#fff;border:1.5px solid var(--acc-b);border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--text);outline:none;">
        <input type="time" id="editTime" style="flex:1;padding:7px 9px;background:#fff;border:1.5px solid var(--acc-b);border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--text);outline:none;">
      </div>
    </div>
    <div class="biw">
      <input type="number" class="bi" id="glIn" placeholder="0.0" min="1.0" max="33.3" step="0.1" oninput="onGlIn()">
      <div class="biu">mmol / L</div>
    </div>
    <div class="rfb" id="rfb"></div>
    <div class="msec">
      <div class="msec-lbl">Context</div>
      <div class="ctxg">
        <div class="cc selected" data-ctx="Before Meal" onclick="pickCtx(this)"><span class="cc-ic">🍽️</span>Before Meal</div>
        <div class="cc" data-ctx="After Meal" onclick="pickCtx(this)"><span class="cc-ic">🍴</span>After Meal</div>
        <div class="cc" data-ctx="Before Exercise" onclick="pickCtx(this)"><span class="cc-ic">🏋️</span>Before Gym</div>
        <div class="cc" data-ctx="After Exercise" onclick="pickCtx(this)"><span class="cc-ic">💪</span>After Gym</div>
        <div class="cc" data-ctx="Before Bed" onclick="pickCtx(this)"><span class="cc-ic">😴</span>Before Bed</div>
        <div class="cc" data-ctx="Waking Up" onclick="pickCtx(this)"><span class="cc-ic">☀️</span>Waking Up</div>
        <div class="cc" data-ctx="Feeling Unwell" onclick="pickCtx(this)"><span class="cc-ic">🤒</span>Feeling Unwell</div>
        <div class="cc" data-ctx="Random Check" onclick="pickCtx(this)"><span class="cc-ic">🩺</span>Random Check</div>
      </div>
    </div>

    <!-- WELLBEING TAGS -->
    <div class="msec" style="margin-top:2px;">
      <div class="msec-lbl">Wellbeing (optional)</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;" id="tagPills">
        <button class="tag-pill" data-tag="😤 Stressed" onclick="toggleTag(this)">😤 Stressed</button>
        <button class="tag-pill" data-tag="😴 Poor sleep" onclick="toggleTag(this)">😴 Poor sleep</button>
        <button class="tag-pill" data-tag="🤒 Unwell" onclick="toggleTag(this)">🤒 Unwell</button>
        <button class="tag-pill" data-tag="💊 On steroids" onclick="toggleTag(this)">💊 On steroids</button>
        <button class="tag-pill" data-tag="🏋️ Post-exercise" onclick="toggleTag(this)">🏋️ Post-exercise</button>
        <button class="tag-pill" data-tag="🍺 Alcohol" onclick="toggleTag(this)">🍺 Alcohol</button>
        <button class="tag-pill" data-tag="🔥 Hot weather" onclick="toggleTag(this)">🔥 Hot weather</button>
        <button class="tag-pill" data-tag="✈️ Travel" onclick="toggleTag(this)">✈️ Travel</button>
      </div>
    </div>

    <!-- CARB / INSULIN BOX -->
    <div class="msec">
      <div class="msec-lbl">Carbs &amp; Insulin</div>
    </div>
    <div class="carb-ins-box">
      <div class="cib-row">
        <div class="cib-field">
          <div class="cib-label">Carbs (g)</div>
          <input type="number" class="cib-input" id="carbIn" placeholder="0" min="0" max="500" step="1" oninput="calcInsulinFromCarbs()">
        </div>
        <div class="cib-arrow">→</div>
        <div class="cib-result">
          <div class="cib-result-label">Suggested Insulin</div>
          <div><span class="cib-result-val" id="suggestedIns">0.0</span><span class="cib-result-unit"> units</span></div>
        </div>
      </div>
      <div class="cib-note" id="cibNote">Enter carbs to get insulin suggestion</div>
    </div>

    <div class="msec" style="margin-top:10px;">
      <div class="msec-lbl">Insulin</div>
      <div class="iins">
        <div class="iif">
          <label>💉 Bolus (short-acting)</label>
          <input type="number" id="mIns" placeholder="0" min="0" max="100" step="0.5">
        </div>
        <div class="iif">
          <label>🌙 Basal (<span id="mBasalName">long-acting</span>)</label>
          <input type="number" id="mBasal" placeholder="0" min="0" max="200" step="1">
          <div id="mBasalHint" style="font-size:10px;color:var(--t3);margin-top:3px;"></div>
        </div>
      </div>
      <div class="iif" style="margin-top:8px;">
        <label>Notes</label>
        <input type="text" id="mNotes" placeholder="Optional notes">
      </div>
    </div>
    <button class="svbtn" onclick="saveReading()">Save Reading</button>
  </div>
</div>

<!-- ══ MEAL LOG MODAL ══ -->
<div class="mbd" id="mealMbd" onclick="handleMealBd(event)">
  <div class="msheet" id="mealSheet">
    <div class="mhandle"></div>
    <div class="mtop"><div class="mtitle">Log Meal</div><button class="mclose" onclick="closeMealModal()">✕</button></div>
    <!-- Time edit row — shown only when editing -->
    <div id="mealEditTimeRow" style="display:none;margin:8px 20px 0;background:var(--acc-bg);border:1.5px solid var(--acc-b);border-radius:10px;padding:10px 12px;">
      <div style="font-size:10px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">📅 Date &amp; Time Logged</div>
      <div style="display:flex;gap:8px;">
        <input type="date" id="mealEditDate" style="flex:1;padding:7px 9px;background:#fff;border:1.5px solid var(--acc-b);border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--text);outline:none;">
        <input type="time" id="mealEditTime" style="flex:1;padding:7px 9px;background:#fff;border:1.5px solid var(--acc-b);border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--text);outline:none;">
      </div>
    </div>
    <div class="meal-tabs">
      <button class="meal-tab active" id="mt-manual" onclick="switchMealTab('manual')">✏️ Manual Entry</button>
      <button class="meal-tab" id="mt-camera" onclick="switchMealTab('camera')">📷 Photo Scan</button>
    </div>

    <!-- MANUAL MEAL -->
    <div class="meal-content" id="mc-manual" style="margin-top:12px;">
      <div class="msec-lbl" style="padding:0 0 6px;">Meal Items</div>
      <div id="mealItemsContainer">
        <div class="meal-item-row">
          <div class="food-wrap">
            <input type="text" class="meal-item-name" placeholder="Food item (e.g. Rice, Brown bread)" oninput="onFoodInput(this)" onblur="hideSuggestions(this,300)" autocomplete="off">
            <div class="food-suggestions"></div>
          </div>
          <input type="number" class="meal-item-carbs" placeholder="g" min="0" oninput="recalcMealTotals()">
          <button class="meal-del" onclick="removeMealItem(this)">✕</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:2px;">
        <button class="add-item-btn" onclick="addMealItem()" style="flex:1;">+ Add food item</button>
        <button class="add-item-btn" onclick="analyseFullMeal()" id="fullMealAiBtn" style="flex:1;border-color:var(--acc);color:var(--acc);">🤖 AI Carb Lookup</button>
      </div>
      <div class="meal-total-box">
        <div class="meal-total-row">
          <div class="meal-total-lbl">Total Carbs</div>
          <div class="meal-total-val"><span id="mealTotalCarbs">0</span><span style="font-size:14px;font-weight:500;"> g</span></div>
        </div>
        <div class="meal-insulin-rec" id="mealInsRec">Search foods above or tap AI Carb Lookup</div>
        <div id="mealItemBreakdown" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="iins" style="margin-top:8px;">
        <div class="iif"><label>Insulin to take (units)</label><input type="number" id="mealIns" placeholder="0" min="0" max="100" step="0.5"></div>
      </div>
      <textarea class="nf" id="mealNotes" rows="2" placeholder="Meal notes..." style="margin-top:8px;"></textarea>
    </div>

    <!-- CAMERA MEAL -->
    <div class="meal-content hidden" id="mc-camera" style="margin-top:12px;">
      <div class="cam-area" id="camDropArea" onclick="triggerCamUpload()">
        <img id="camPreviewImg" alt="Meal preview">
        <div class="cam-area-placeholder" id="camAreaPlaceholder">
          <div class="cam-area-ic">📷</div>
          <div class="cam-area-txt">Tap to take photo or upload</div>
          <div class="cam-area-sub">Photo will be analysed by AI</div>
        </div>
      </div>
      <input type="file" id="camFileInput" accept="image/*" capture="environment" onchange="handleCamUpload(event)" style="display:none;">
      <button class="analyze-btn" id="analyzeBtn" onclick="runMealAnalysis()" disabled>🔍 Analyse Meal with AI</button>
      <div id="aiKeyHint" style="display:none;font-size:11px;color:var(--hi);text-align:center;padding:4px 0;">No API key — go to Settings → AI Features to add one</div>
      <div class="cam-result-box" id="camResultBox">
        <div class="crb-name" id="crbName"></div>
        <div class="crb-stats" id="crbStats"></div>
        <div class="crb-items" id="crbItems"></div>
        <div class="meal-total-box" style="margin-top:10px;">
          <div class="meal-total-row">
            <div class="meal-total-lbl">AI Detected Carbs</div>
            <div class="meal-total-val"><span id="aiCarbs">0</span><span style="font-size:14px;font-weight:500;"> g</span></div>
          </div>
          <div class="meal-insulin-rec" id="aiInsRec"></div>
        </div>
        <div class="iins" style="margin-top:8px;">
          <div class="iif"><label>Insulin to take (units)</label><input type="number" id="aiMealIns" placeholder="0" min="0" max="100" step="0.5"></div>
        </div>
      </div>
    </div>
    <!-- FIRST BITE TIME -->
    <div class="msec" style="margin-top:10px;" id="firstBiteSection">
      <div class="msec-lbl">When did you start eating?</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="firstBitePills">
        <button class="first-bite-btn active" data-min="0" onclick="setFirstBite(0,this)">Just now</button>
        <button class="first-bite-btn" data-min="10" onclick="setFirstBite(10,this)">10 min ago</button>
        <button class="first-bite-btn" data-min="20" onclick="setFirstBite(20,this)">20 min ago</button>
        <button class="first-bite-btn" data-min="30" onclick="setFirstBite(30,this)">30 min ago</button>
        <button class="first-bite-btn" data-min="45" onclick="setFirstBite(45,this)">45 min ago</button>
      </div>
      <div style="font-size:11px;color:var(--t3);margin-top:5px;" id="firstBiteHint">BG check reminder will fire at <strong id="firstBiteFireAt">—</strong></div>
    </div>
    <button class="svbtn" onclick="saveMeal()">Log Meal</button>
  </div>
</div>

<!-- ══ FULL-SCREEN CAMERA ══ -->
<div class="camfs" id="camfs">
  <div class="camfs-top">
    <div class="camfs-title">📷 Scan Meal</div>
    <button class="camfs-close" onclick="closeCamFull()">✕</button>
  </div>
  <div class="camfs-vw">
    <video id="camfsVideo" autoplay playsinline muted></video>
    <img id="camfsPreview" alt="preview">
    <div class="camfs-frame"></div>
    <div class="camfs-analyzing" id="camfsAnalyzing">
      <div class="spin"></div>
      <div>Analysing with AI…</div>
    </div>
  </div>
  <div class="camfs-hint">Point at your meal and tap capture</div>
  <div class="camfs-bottom">
    <label class="camfs-upload" for="fsFileInput">📁 Upload</label>
    <input type="file" id="fsFileInput" accept="image/*" onchange="handleFsUpload(event)">
    <button class="camfs-cap" onclick="captureFsPhoto()">📷</button>
  </div>
</div>
<canvas id="hiddenCv" style="display:none;"></canvas>

<script>
// ══════════════ COUNTRIES THAT USE mmol/L ══════════════
const MMOL_COUNTRIES=['ZA','GB','AU','NZ','IE','CA','NG','KE','ZW','TZ','UG','ZM','GH','ET','MA','SE','NO','DE','FR','NL','SG'];

// ══════════════ STATE ══════════════
let readings=[];
let cfg={low:3.9,high:10.0,carbRatio:10,corrFactor:2.2,a1cGoal:7.0};
let currentUser=null;
let selCtx='Before Meal';
let selectedTags=[];
let chartCustomFrom=null,chartCustomTo=null;
let activeCamStream=null;
let camImageData=null;
let mealCamImageData=null;
let mealTab='manual';
let firstBiteOffsetMin=0; // minutes ago the user started eating

// ══════════════ STORAGE ══════════════
// ── CSS var helper for canvas (adapts to dark/light mode) ──
function cssVar(name,fallback){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim()||fallback;
}

function store(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
function load(k,def){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def;}catch(e){return def;}}
function getUserKey(k){return currentUser?`gt_${currentUser.id}_${k}`:null;}
function saveReadings(){if(getUserKey('r'))store(getUserKey('r'),readings);}
function loadReadings(){if(getUserKey('r'))readings=load(getUserKey('r'),[]);}
function saveCfg(){if(getUserKey('c'))store(getUserKey('c'),cfg);}
function saveExProfile(){store('gt_exProfile',exProfile);}
function loadExProfile(){exProfile=load('gt_exProfile',0);}
function loadCfg(){if(getUserKey('c'))cfg={...cfg,...load(getUserKey('c'),{})};}

// ══════════════ TOAST ══════════════
function toast(msg,type='info',icon='ℹ️'){
  const w=document.getElementById('toastWrap');
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<span class="toast-icon">${icon}</span><span>${msg}</span>`;
  w.appendChild(el);
  setTimeout(()=>{el.style.animation='toastOut .3s ease forwards';setTimeout(()=>el.remove(),300);},3500);
}
function toastError(msg){toast(msg,'error','❌');}
function toastSuccess(msg){toast(msg,'success','✅');}
function toastWarn(msg){toast(msg,'warn','⚠️');}

// ══════════════ BROWSER NOTIFICATIONS ══════════════
function requestNotificationPermission(showPrompt){
  if(!('Notification' in window)){
    if(showPrompt) toastWarn('Your browser does not support notifications.');
    return;
  }
  if(Notification.permission==='granted'){
    if(showPrompt) toastSuccess('Notifications are already enabled ✅');
    return;
  }
  if(Notification.permission==='denied'){
    if(showPrompt) toastWarn('Notifications are blocked. Go to your browser/phone Settings → Site Settings → Notifications and allow GlucoTrack.');
    return;
  }
  // 'default' — ask
  Notification.requestPermission().then(p=>{
    if(p==='granted') toastSuccess('✅ Notifications enabled! You will be alerted even when the screen is locked (Android) or app is in background.');
    else toastWarn('⚠️ Notifications blocked. To enable: browser Settings → Site Settings → Notifications → Allow for this site.');
  });
}

// Send a real browser notification + in-app toast + sound
function notify(title, body, icon='💉', soundType='test'){
  // In-app toast always
  toast(body, 'info', icon);
  // Sound + vibration
  const a=load('gt_alarms',{});
  if(a.soundOn!==false) playAlarmSound(soundType);
  if(a.vibeOn!==false) triggerVibration(soundType);
  // Use Service Worker notification — works in background on Android
  if('serviceWorker' in navigator && Notification.permission==='granted'){
    navigator.serviceWorker.ready.then(reg=>{
      reg.showNotification(title,{
        body,
        tag:'glucotrack-'+soundType,
        requireInteraction:true,
        vibrate:[200,100,200,100,200],
        icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">💉</text></svg>',
      }).catch(()=>{
        // Fallback to basic Notification API
        if(Notification.permission==='granted') try{new Notification(title,{body});}catch(e){}
      });
    }).catch(()=>{
      if(Notification.permission==='granted') try{new Notification(title,{body});}catch(e){}
    });
  } else if('Notification' in window && Notification.permission==='granted'){
    try{new Notification(title,{body,requireInteraction:true});}catch(e){}
  }
}

// Schedule a notification via the Service Worker (survives screen lock on Android)
function scheduleNotification(delayMs, title, body, tag){
  if('serviceWorker' in navigator && Notification.permission==='granted'){
    navigator.serviceWorker.ready.then(reg=>{
      // Send to SW to schedule — SW setTimeout persists longer than page timers
      reg.active && reg.active.postMessage({
        type:'SCHEDULE_NOTIFICATION', delayMs, title, body, tag
      });
    }).catch(()=>{});
  }
  // Also keep a page-side timer as backup
  return setTimeout(()=>{
    notify(title, body, '🍽️', 'test');
  }, delayMs);
}

// ── In-app confirm (replaces window.confirm which is blocked on iOS PWA) ──
function appConfirm(msg, onConfirm, danger=true){
  const ov=document.getElementById('confirmOverlay');
  ov.style.display='flex';
  ov.style.position='fixed';
  ov.style.inset='0';
  ov.style.background='rgba(0,0,0,.5)';
  ov.style.zIndex='10000';
  ov.style.alignItems='flex-end';
  ov.style.justifyContent='center';
  ov.style.padding='0 0 32px';
  ov.innerHTML=`<div class="confirm-box">
    <div class="confirm-msg">${msg}</div>
    <div class="confirm-btns">
      <button class="confirm-btn cancel" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-btn ${danger?'danger':'primary'}" id="confirmOkBtn">Confirm</button>
    </div>
  </div>`;
  document.getElementById('confirmOkBtn').onclick=()=>{closeConfirm();onConfirm();};
}
function closeConfirm(){
  const ov=document.getElementById('confirmOverlay');
  if(ov)ov.style.display='none';
}


// ══════════════ UTILS ══════════════
const CTX_IC={'Before Meal':'🍽️','After Meal':'🍴','Before Exercise':'🏋️','After Exercise':'💪','Before Bed':'😴','Waking Up':'☀️','Feeling Unwell':'🤒','Random Check':'🩺','Meal':'🍽️','Basal Insulin':'🌙'};
const CTX_CL={'Before Meal':'#3B82F6','After Meal':'#8B5CF6','Before Exercise':'#F59E0B','After Exercise':'#059669','Before Bed':'#6366F1','Waking Up':'#F97316','Feeling Unwell':'#DC2626','Random Check':'#6B7280','Meal':'#3B82F6','Basal Insulin':'#7C3AED'};
function fmt(v){return(Math.round(v*10)/10).toFixed(1);}
function getSt(v){
  const lo=cfg.low,hi=cfg.high;
  if(v<lo)return{cls:'low',bc:'blow',txt:'LOW',col:'var(--low)'};
  if(v<=hi)return{cls:'ok',bc:'bok',txt:'IN RANGE',col:'var(--ok)'};
  if(v<=13.9)return{cls:'hi',bc:'bhi',txt:'HIGH',col:'var(--hi)'};
  return{cls:'vhi',bc:'bvhi',txt:'VERY HIGH',col:'var(--vhi)'};
}
function fT(ts){return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function fD(ts){
  const d=new Date(ts),t=new Date();t.setHours(0,0,0,0);
  const y=new Date(t);y.setDate(t.getDate()-1);
  if(d>=t)return'Today';if(d>=y)return'Yesterday';
  return d.toLocaleDateString([],{weekday:'short',month:'short',day:'numeric'});
}
function tSince(ts){
  const s=(Date.now()-ts)/1e3;
  if(s<60)return'Just now';
  if(s<3600){const m=Math.round(s/60);return m+'min ago';}
  if(s<86400){const h=Math.round(s/3600);return h+'h ago';}
  return Math.round(s/86400)+'d ago';
}
function nPos(v){return Math.min(Math.max((v-3.0)/(16.7-3.0),.02),.98)*100+'%';}
function calcA1c(avgMmol){return(avgMmol*1.5927+1.628).toFixed(1);}
function updateDate(){const n=new Date();document.getElementById('topDate').textContent=n.toLocaleDateString([],{month:'short',day:'numeric'});}


// ══════════════ DRAWER SUBMENUS ══════════════
function toggleSubMenu(id, btn){
  const sub=document.getElementById(id);
  const isOpen=sub.classList.toggle('open');
  const arrId=id.replace('sub-','arr-');
  const arr=document.getElementById(arrId);
  if(arr)arr.style.transform=isOpen?'rotate(90deg)':'';
}

// ══════════════ REPORTS ══════════════
let dailyDayOffset=0;

function setReportTab(tab, btnEl){
  // Hide all panels
  document.querySelectorAll('.rpt-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.rpt-tab').forEach(b=>b.classList.remove('active'));
  const panel=document.getElementById('rpt-'+tab);
  if(panel)panel.classList.add('active');
  // Activate matching button (either passed in or find by content)
  if(btnEl){btnEl.classList.add('active');}
  else{
    document.querySelectorAll('.rpt-tab').forEach(b=>{
      if(b.getAttribute('onclick')&&b.getAttribute('onclick').includes("'"+tab+"'"))b.classList.add('active');
    });
  }
  // Draw chart for selected tab
  setTimeout(()=>{
    if(tab==='patterns')drawPatternChart();
    if(tab==='tir')drawTirDonut();
    if(tab==='low')updateLowEvents();
    if(tab==='avg')drawAvgTrend();
    if(tab==='daily')drawDailyGraph();
    if(tab==='meal')updateMealImpact();
  },60);
}

function updateReports(){
  setReportTab('patterns');
}

// Daily Patterns chart (hourly avg)
function drawPatternChart(){
  const cv=document.getElementById('patternChart');if(!cv)return;
  const par=cv.parentElement;
  let W=par.offsetWidth||300;W=Math.max(W,200);
  const H=170,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const cutoff=Date.now()-7*86400000;
  const d7=readings.filter(r=>r.ts>=cutoff&&!r.isMealOnly&&r.value>0);
  // Build hourly buckets
  const hourly=Array.from({length:24},()=>[]);
  d7.forEach(r=>{const h=new Date(r.ts).getHours();hourly[h].push(r.value);});
  const avgs=hourly.map(b=>b.length?b.reduce((a,v)=>a+v,0)/b.length:null);
  const valid=avgs.filter(v=>v!==null);
  if(!valid.length){
    ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='12px Plus Jakarta Sans';ctx.textAlign='center';
    ctx.fillText('No data for last 7 days',W/2,H/2);
    // Update stats
    document.getElementById('rptPeakHour').textContent='—';
    document.getElementById('rptLowHour').textContent='—';
    document.getElementById('rptReadings7').textContent=0;
    return;
  }
  // Stats
  let peakH=0,lowH=0,peakV=-Infinity,lowV=Infinity;
  avgs.forEach((v,h)=>{if(v===null)return;if(v>peakV){peakV=v;peakH=h;}if(v<lowV){lowV=v;lowH=h;}});
  document.getElementById('rptPeakHour').textContent=peakH+':00';
  document.getElementById('rptLowHour').textContent=lowH+':00';
  document.getElementById('rptReadings7').textContent=d7.length;
  const mn=Math.max(0,Math.min(...valid,cfg.low)-1);
  const mx=Math.max(...valid,cfg.high)+1;
  const pL=30,pR=8,pT=8,pB=18,cW=W-pL-pR,cH=H-pT-pB;
  const bw=cW/24-1;
  const ty=(v)=>pT+(1-(v-mn)/(mx-mn||1))*cH;
  // Target band
  ctx.fillStyle='rgba(56,161,105,0.07)';ctx.fillRect(pL,ty(cfg.high),cW,ty(cfg.low)-ty(cfg.high));
  // Bars
  avgs.forEach((v,h)=>{
    if(v===null)return;
    const x=pL+h*(cW/24);
    const bh=cH-(ty(v)-pT);
    const s=getSt(v);
    const cols={ok:'#38A169',low:'#E53E3E',hi:'#D97706',vhi:'#E53E3E'};
    ctx.fillStyle=cols[s.cls]+'BB';
    ctx.fillRect(x,ty(v),bw,bh);
  });
  // Y labels
  ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='8px JetBrains Mono';ctx.textAlign='right';
  [mn,cfg.low,cfg.high,mx].forEach(v=>{if(v>=mn&&v<=mx)ctx.fillText(v.toFixed(1),pL-3,ty(v)+3);});
  // X labels
  ctx.textAlign='center';
  [0,6,12,18,23].forEach(h=>{ctx.fillText(h+'h',pL+h*(cW/24)+bw/2,H-3);});
}

// TIR Donut
function drawTirDonut(){
  const cv=document.getElementById('tirDonutChart');if(!cv)return;
  const par=cv.parentElement;
  let W=par.offsetWidth||300;W=Math.max(W,200);
  const H=170,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const cutoff=Date.now()-14*86400000;
  const d14=readings.filter(r=>r.ts>=cutoff&&!r.isMealOnly&&r.value>0);
  const tot=d14.length||1;
  const lo=cfg.low,hi=cfg.high;
  const lN=d14.filter(r=>r.value<lo).length;
  const oN=d14.filter(r=>r.value>=lo&&r.value<=hi).length;
  const hN=d14.filter(r=>r.value>hi&&r.value<=13.9).length;
  const vN=d14.filter(r=>r.value>13.9).length;
  const segs=[
    {pct:lN/tot,col:'#E53E3E',lbl:'Low'},
    {pct:oN/tot,col:'#38A169',lbl:'In Range'},
    {pct:hN/tot,col:'#D97706',lbl:'High'},
    {pct:vN/tot,col:'#E53E3E88',lbl:'V.High'}
  ].filter(s=>s.pct>0);
  // Update TIR bars in breakdown
  const pL2=Math.round(lN/tot*100),pO=Math.round(oN/tot*100),pH=Math.round(hN/tot*100),pV=Math.max(0,100-pL2-pO-pH);
  document.getElementById('rptTirLow').style.width=pL2+'%';document.getElementById('rptTirLowP').textContent=pL2+'%';
  document.getElementById('rptTirOk').style.width=pO+'%';document.getElementById('rptTirOkP').textContent=pO+'%';
  document.getElementById('rptTirHigh').style.width=pH+'%';document.getElementById('rptTirHighP').textContent=pH+'%';
  document.getElementById('rptTirVH').style.width=pV+'%';document.getElementById('rptTirVHP').textContent=pV+'%';
  if(!d14.length){ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='12px Plus Jakarta Sans';ctx.textAlign='center';ctx.fillText('No data',W/2,H/2);return;}
  const cx=W/2,cy=H/2,r=Math.min(W,H)/2-16,ri=r*0.55;
  let angle=-Math.PI/2;
  segs.forEach(s=>{
    const sweep=s.pct*Math.PI*2;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,angle,angle+sweep);ctx.closePath();
    ctx.fillStyle=s.col;ctx.fill();
    // Label if big enough
    if(s.pct>0.08){
      const mid=angle+sweep/2;
      const lx=cx+Math.cos(mid)*(r+ri)/2,ly=cy+Math.sin(mid)*(r+ri)/2;
      ctx.fillStyle='#fff';ctx.font='bold 10px Plus Jakarta Sans';ctx.textAlign='center';
      ctx.fillText(Math.round(s.pct*100)+'%',lx,ly+3.5);
    }
    angle+=sweep;
  });
  // Donut hole
  ctx.beginPath();ctx.arc(cx,cy,ri,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
  // Centre label
  ctx.fillStyle='#0D1321';ctx.font='bold 16px JetBrains Mono';ctx.textAlign='center';
  ctx.fillText(Math.round(oN/tot*100)+'%',cx,cy+2);
  ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='9px Plus Jakarta Sans';ctx.fillText('In Range',cx,cy+14);
}

// Low Glucose Events
function updateLowEvents(){
  const cutoff=Date.now()-30*86400000;
  const lows=readings.filter(r=>r.ts>=cutoff&&!r.isMealOnly&&r.value>0&&r.value<cfg.low)
    .map((r,i)=>({...r,_idx:i})).reverse();
  document.getElementById('rptLowCount').textContent=lows.length;
  if(lows.length){
    const avg=lows.reduce((s,r)=>s+r.value,0)/lows.length;
    document.getElementById('rptLowAvg').textContent=fmt(avg);
    document.getElementById('rptLowSev').textContent=fmt(Math.min(...lows.map(r=>r.value)));
  } else {
    document.getElementById('rptLowAvg').textContent='—';
    document.getElementById('rptLowSev').textContent='—';
  }
  const el=document.getElementById('rptLowList');
  if(!lows.length){el.innerHTML='<div class="empty"><div class="empty-ic">✅</div>No low glucose events in 30 days. Great job!</div>';return;}
  el.innerHTML=lows.slice(0,15).map(r=>{
    const s=getSt(r.value);
    return`<div class="ei"><div class="ei-ic" style="background:var(--low-bg)">🚨</div><div class="ei-main"><div class="ei-ctx">${fD(r.ts)}, ${fT(r.ts)}</div><div class="ei-sub">${r.context||'Reading'}${r.notes?' · '+r.notes:''}</div></div><div class="ei-r"><div class="ei-val" style="color:var(--low)">${fmt(r.value)}</div><div class="ei-u">mmol/L</div></div></div>`;
  }).join('');
  // Low by hour chart
  setTimeout(drawLowByHour,40);
}

function drawLowByHour(){
  const cv=document.getElementById('lowByHourChart');if(!cv)return;
  const par=cv.parentElement;
  let W=par.offsetWidth||300;W=Math.max(W,200);
  const H=140,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const cutoff=Date.now()-30*86400000;
  const lows=readings.filter(r=>r.ts>=cutoff&&!r.isMealOnly&&r.value>0&&r.value<cfg.low);
  const hourly=Array(24).fill(0);lows.forEach(r=>{hourly[new Date(r.ts).getHours()]++;});
  const maxC=Math.max(...hourly,1);
  const pL=28,pR=8,pT=8,pB=18,cW=W-pL-pR,cH=H-pT-pB;
  const bw=Math.floor(cW/24)-1;
  hourly.forEach((cnt,h)=>{
    if(!cnt)return;
    const bh=(cnt/maxC)*cH;
    const x=pL+h*(cW/24);
    ctx.fillStyle='rgba(229,62,62,0.7)';
    ctx.fillRect(x,pT+cH-bh,bw,bh);
    if(cnt>0){ctx.fillStyle='#E53E3E';ctx.font='8px JetBrains Mono';ctx.textAlign='center';ctx.fillText(cnt,x+bw/2,pT+cH-bh-2);}
  });
  ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='8px JetBrains Mono';ctx.textAlign='center';
  [0,6,12,18,23].forEach(h=>ctx.fillText(h+'h',pL+h*(cW/24)+bw/2,H-3));
}

// Average Trend
function drawAvgTrend(){
  const cv=document.getElementById('avgTrendChart');if(!cv)return;
  const par=cv.parentElement;
  let W=par.offsetWidth||300;W=Math.max(W,200);
  const H=170,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const now=Date.now();
  function avgFor(days){
    const cut=now-days*86400000;
    const v=readings.filter(r=>r.ts>=cut&&!r.isMealOnly&&r.value>0).map(r=>r.value);
    return v.length?v.reduce((a,b)=>a+b,0)/v.length:null;
  }
  const a7=avgFor(7),a14=avgFor(14),a30=avgFor(30);
  document.getElementById('rptAvg7').textContent=a7?fmt(a7):'—';
  document.getElementById('rptAvg14').textContent=a14?fmt(a14):'—';
  document.getElementById('rptAvg30').textContent=a30?fmt(a30):'—';
  // Build 30-day daily avgs
  const buckets=[];
  for(let i=29;i>=0;i--){
    const d=new Date(now-i*86400000);d.setHours(0,0,0,0);
    const de=d.getTime()+86400000;
    const v=readings.filter(r=>r.ts>=d.getTime()&&r.ts<de&&!r.isMealOnly&&r.value>0).map(r=>r.value);
    buckets.push({day:d,avg:v.length?v.reduce((a,b)=>a+b,0)/v.length:null});
  }
  const valid=buckets.filter(b=>b.avg!==null);
  if(!valid.length){ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='12px Plus Jakarta Sans';ctx.textAlign='center';ctx.fillText('No data',W/2,H/2);return;}
  const vals=valid.map(b=>b.avg);
  const mn=Math.max(0,Math.min(...vals,cfg.low)-1),mx=Math.max(...vals,cfg.high)+1;
  const pL=30,pR=8,pT=8,pB=18,cW=W-pL-pR,cH=H-pT-pB;
  const tx=(i)=>pL+i/29*cW;
  const ty=(v)=>pT+(1-(v-mn)/(mx-mn||1))*cH;
  ctx.fillStyle='rgba(56,161,105,0.07)';ctx.fillRect(pL,ty(cfg.high),cW,ty(cfg.low)-ty(cfg.high));
  // Gradient fill
  const grad=ctx.createLinearGradient(0,pT,0,H);
  grad.addColorStop(0,'rgba(26,86,219,0.12)');grad.addColorStop(1,'rgba(26,86,219,0)');
  ctx.beginPath();ctx.moveTo(tx(0),cH+pT);
  buckets.forEach((b,i)=>{if(b.avg!==null)ctx.lineTo(tx(i),ty(b.avg));});
  ctx.lineTo(tx(29),cH+pT);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  // Line
  ctx.beginPath();let first=true;
  buckets.forEach((b,i)=>{if(b.avg===null)return;if(first){ctx.moveTo(tx(i),ty(b.avg));first=false;}else ctx.lineTo(tx(i),ty(b.avg));});
  ctx.strokeStyle='#1A56DB';ctx.lineWidth=2;ctx.lineJoin='round';ctx.stroke();
  // Y labels
  ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='8px JetBrains Mono';ctx.textAlign='right';
  [mn,cfg.low,cfg.high,mx].forEach(v=>ctx.fillText(v.toFixed(1),pL-3,ty(v)+3));
  // X labels
  ctx.textAlign='center';
  [0,7,14,21,29].forEach(i=>{
    const d=new Date(now-i*86400000);
    ctx.fillText(d.toLocaleDateString([],{month:'short',day:'numeric'}),tx(29-i),H-3);
  });
}

// Daily Graph
function drawDailyGraph(){
  const cv=document.getElementById('dailyGraph');if(!cv)return;
  const par=cv.parentElement;
  let W=par.offsetWidth||300;W=Math.max(W,200);
  const H=180,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const base=new Date();base.setHours(0,0,0,0);
  const dayStart=base.getTime()+dailyDayOffset*86400000;
  const dayEnd=dayStart+86400000;
  // Update label
  const dl=document.getElementById('dailyDayLabel');
  if(dl){
    if(dailyDayOffset===0)dl.textContent='Today';
    else if(dailyDayOffset===-1)dl.textContent='Yesterday';
    else{const d=new Date(dayStart);dl.textContent=d.toLocaleDateString([],{month:'short',day:'numeric'});}
  }
  const data=readings.filter(r=>r.ts>=dayStart&&r.ts<dayEnd&&!r.isMealOnly&&r.value>0);
  // Stats
  const vals=data.map(r=>r.value);
  document.getElementById('dgAvg').textContent=vals.length?fmt(vals.reduce((a,b)=>a+b,0)/vals.length):'—';
  document.getElementById('dgMin').textContent=vals.length?fmt(Math.min(...vals)):'—';
  document.getElementById('dgMax').textContent=vals.length?fmt(Math.max(...vals)):'—';
  const lo=cfg.low,hi=cfg.high;
  const mn=Math.max(0,Math.min(...(vals.length?vals:[lo]),lo)-1.5);
  const mx=Math.max(...(vals.length?vals:[hi]),hi)+2;
  const pL=34,pR=8,pT=8,pB=24,cW=W-pL-pR,cH=H-pT-pB;
  const tx=(ts)=>pL+(ts-dayStart)/86400000*cW;
  const ty=(v)=>pT+(1-(v-mn)/(mx-mn||1))*cH;
  // Background
  ctx.fillStyle=document.body.classList.contains('dark')?'#111d30':'#FAFBFC';ctx.fillRect(pL,pT,cW,cH);
  // Target band
  ctx.fillStyle='rgba(56,161,105,0.07)';ctx.fillRect(pL,ty(hi),cW,ty(lo)-ty(hi));
  // Target lines
  ctx.setLineDash([4,4]);ctx.lineWidth=1;
  ctx.strokeStyle='rgba(56,161,105,0.4)';ctx.beginPath();ctx.moveTo(pL,ty(hi));ctx.lineTo(pL+cW,ty(hi));ctx.stroke();
  ctx.strokeStyle='rgba(229,62,62,0.3)';ctx.beginPath();ctx.moveTo(pL,ty(lo));ctx.lineTo(pL+cW,ty(lo));ctx.stroke();
  ctx.setLineDash([]);
  // Y labels
  const gs=mx-mn>10?4:2;const gst=Math.ceil(mn/gs)*gs;
  ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='8px JetBrains Mono';ctx.textAlign='right';
  for(let v=gst;v<=mx;v+=gs)ctx.fillText(v.toFixed(1),pL-3,ty(v)+3);
  // X labels (hours)
  ctx.textAlign='center';ctx.font='9px JetBrains Mono';
  [0,4,8,12,16,20,24].forEach(h=>{
    const ts=dayStart+h*3600000;if(ts>dayEnd)return;
    ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fillRect(tx(ts),pT,1,cH);
    ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.fillText(h+'h',tx(ts),pT+cH+pB-4);
  });
  if(!data.length){
    ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='12px Plus Jakarta Sans';ctx.textAlign='center';
    ctx.fillText('No readings for this day',W/2,H/2);return;
  }
  // Gradient fill
  if(data.length>=2){
    const grad=ctx.createLinearGradient(0,pT,0,H);
    grad.addColorStop(0,'rgba(26,86,219,0.12)');grad.addColorStop(1,'rgba(26,86,219,0)');
    ctx.beginPath();ctx.moveTo(tx(data[0].ts),cH+pT);
    data.forEach(r=>ctx.lineTo(tx(r.ts),ty(r.value)));
    ctx.lineTo(tx(data[data.length-1].ts),cH+pT);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
    // Line
    ctx.beginPath();ctx.moveTo(tx(data[0].ts),ty(data[0].value));
    data.forEach((r,i)=>{if(i)ctx.lineTo(tx(r.ts),ty(r.value));});
    ctx.strokeStyle='#1A56DB';ctx.lineWidth=2;ctx.lineJoin='round';ctx.stroke();
  }
  // Dots
  const DOT={ok:'#38A169',low:'#E53E3E',hi:'#D97706',vhi:'#E53E3E'};
  const dr=data.length>40?2:3;
  data.forEach(r=>{
    const s=getSt(r.value);const x=tx(r.ts),y=ty(r.value);
    ctx.beginPath();ctx.arc(x,y,dr+1.5,0,Math.PI*2);ctx.fillStyle=DOT[s.cls]+'33';ctx.fill();
    ctx.beginPath();ctx.arc(x,y,dr,0,Math.PI*2);ctx.fillStyle=DOT[s.cls];ctx.fill();
    ctx.strokeStyle='white';ctx.lineWidth=1.5;ctx.stroke();
  });
  if(data.length===1){
    const r=data[0];const s=getSt(r.value);const x=tx(r.ts),y=ty(r.value);
    ctx.beginPath();ctx.arc(x,y,6,0,Math.PI*2);ctx.fillStyle=DOT[s.cls];ctx.fill();
    ctx.strokeStyle='white';ctx.lineWidth=2;ctx.stroke();
  }
}

function shiftDailyDay(dir){
  const newOff=dailyDayOffset+dir;
  if(newOff>0)return;// can't go into future
  dailyDayOffset=newOff;
  drawDailyGraph();
}

// ══════════════ ALARMS ══════════════
let lastAlarmTs={low:0,high:0,urgLow:0,rise:0,fall:0};

function toggleAlarm(btn){
  btn.classList.toggle('on');
  saveAlarms();
}

function saveAlarms(){
  const get=id=>{const el=document.getElementById(id);return el?el.classList.contains('on'):true;};
  const getVal=(id,def)=>{const el=document.getElementById(id);return el?parseFloat(el.value)||def:def;};
  store('gt_alarms',{
    low:getVal('alLow',3.9),   high:getVal('alHigh',10.0),  urgLow:getVal('alUrgLow',3.0),
    lowOn:get('alLowSw'),      highOn:get('alHighSw'),       urgLowOn:get('alUrgLowSw'),
    riseOn:get('alRiseSw'),    fallOn:get('alFallSw'),
    soundOn:get('alSoundSw'),  vibeOn:get('alVibeSw'),       nightOn:get('alNightSw'),
  });
}

function loadAlarms(){
  const a=load('gt_alarms',{});
  const setVal=(id,v)=>{const el=document.getElementById(id);if(el)el.value=v;};
  const setOn=(id,on)=>{const el=document.getElementById(id);if(el)el.classList.toggle('on',on);};
  setVal('alLow',   a.low   !=null?a.low   :3.9);
  setVal('alHigh',  a.high  !=null?a.high  :10.0);
  setVal('alUrgLow',a.urgLow!=null?a.urgLow:3.0);
  setOn('alLowSw',   a.lowOn   !=null?a.lowOn   :true);
  setOn('alHighSw',  a.highOn  !=null?a.highOn  :true);
  setOn('alUrgLowSw',a.urgLowOn!=null?a.urgLowOn:true);
  setOn('alRiseSw',  a.riseOn  !=null?a.riseOn  :false);
  setOn('alFallSw',  a.fallOn  !=null?a.fallOn  :true);
  setOn('alSoundSw', a.soundOn !=null?a.soundOn :true);
  setOn('alVibeSw',  a.vibeOn  !=null?a.vibeOn  :true);
  setOn('alNightSw', a.nightOn !=null?a.nightOn :true);
}

// ── Web Audio sound engine (no audio files needed) ──
function playAlarmSound(type){
  try{
    const AC=window.AudioContext||window.webkitAudioContext;
    if(!AC)return;
    const ctx=new AC();
    // Each note: {f:frequency, d:duration seconds}
    const P={
      urgLow:[{f:880,d:.12},{f:0,d:.05},{f:880,d:.12},{f:0,d:.05},{f:880,d:.12},{f:0,d:.05},{f:1100,d:.3}],
      low:   [{f:660,d:.2},{f:0,d:.08},{f:660,d:.35}],
      high:  [{f:440,d:.2},{f:0,d:.08},{f:540,d:.35}],
      rise:  [{f:440,d:.12},{f:550,d:.12},{f:660,d:.25}],
      fall:  [{f:660,d:.12},{f:550,d:.12},{f:440,d:.25}],
      test:  [{f:523,d:.1},{f:659,d:.1},{f:784,d:.2}],
    };
    const notes=P[type]||P.test;
    let t=ctx.currentTime+0.05;
    notes.forEach(({f,d})=>{
      if(f>0){
        const osc=ctx.createOscillator();
        const gain=ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type=(type==='urgLow')?'sawtooth':'sine';
        osc.frequency.setValueAtTime(f,t);
        gain.gain.setValueAtTime(0.5,t);
        gain.gain.exponentialRampToValueAtTime(0.001,t+d-0.01);
        osc.start(t);
        osc.stop(t+d);
      }
      t+=d;
    });
    setTimeout(()=>{try{ctx.close();}catch(e){}},t*1000+300);
  }catch(err){console.warn('Alarm sound error:',err.message);}
}

// ── Vibration patterns ──
function triggerVibration(type){
  if(!navigator.vibrate)return;
  const P={
    urgLow:[300,100,300,100,500],
    low:   [200,100,200],
    high:  [100,50,100,50,200],
    rise:  [100,100,100],
    fall:  [200,100,100],
    test:  [100,50,100,50,100],
  };
  navigator.vibrate(P[type]||P.test);
}

// ── Fire a single alarm ──
function fireAlarm(type,msg){
  const a=load('gt_alarms',{});
  const now=Date.now();
  // Throttle: urgLow=5min cooldown, all others=15min
  const cooldown=type==='urgLow'?5*60000:15*60000;
  if(now-lastAlarmTs[type]<cooldown)return;
  lastAlarmTs[type]=now;
  // Overnight check — if nightOn is false, silence between 22:00-07:00
  if(a.nightOn===false){
    const h=new Date().getHours();
    if(h>=22||h<7)return;
  }
  const icons={urgLow:'🚨',low:'🚨',high:'⚠️',rise:'📈',fall:'📉'};
  const titles={urgLow:'🚨 URGENT LOW — Act Now',low:'🚨 Low Glucose',high:'⚠️ High Glucose',rise:'📈 Rising Fast',fall:'📉 Falling Fast'};
  notify(titles[type]||'GlucoTrack Alert', msg, icons[type]||'🔔', type);
}

// ── Check a glucose value against all enabled alarms ──
function checkAlarms(value){
  if(!value||value<=0||isNaN(value))return;
  const a=load('gt_alarms',{});
  const lo=a.low!=null?a.low:3.9;
  const hi=a.high!=null?a.high:10.0;
  const urgLo=a.urgLow!=null?a.urgLow:3.0;
  // Urgent Low — highest priority, return early so we don't stack
  if(a.urgLowOn!==false && value<urgLo){
    fireAlarm('urgLow',`URGENT LOW: ${fmt(value)} mmol/L — eat fast carbs now!`);
    return;
  }
  if(a.lowOn!==false && value<lo){
    fireAlarm('low',`Low glucose: ${fmt(value)} mmol/L (below ${fmt(lo)})`);
    return;
  }
  if(a.highOn!==false && value>hi){
    fireAlarm('high',`High glucose: ${fmt(value)} mmol/L (above ${fmt(hi)})`);
  }
  // Rise/Fall trend — needs 2 readings within 2h
  const bgR=readings.filter(r=>!r.isMealOnly&&r.value>0);
  if(bgR.length>=2){
    const prev=bgR[bgR.length-2],curr=bgR[bgR.length-1];
    const dtH=(curr.ts-prev.ts)/3600000;
    if(dtH>0&&dtH<2){
      const rate=(curr.value-prev.value)/dtH;
      if(a.riseOn && rate>2)  fireAlarm('rise',`Rising fast: +${rate.toFixed(1)} mmol/h`);
      if(a.fallOn!==false && rate<-2) fireAlarm('fall',`Falling fast: ${rate.toFixed(1)} mmol/h`);
    }
  }
}

// ── Test button ──
function testAlarm(){
  const a=load('gt_alarms',{});
  if(a.soundOn!==false) playAlarmSound('test');
  if(a.vibeOn!==false)  triggerVibration('test');
  toast('🔔 Test fired — did you hear/feel it?','info','🔔');
}

// ══════════════ REMINDERS ══════════════
// Each reminder: { id, icon, label, timeInputId, switchEl }
// We scan DOM at save time to avoid stale references.

function saveReminders(){
  // Collect reminder rows from the DOM
  const rows=document.querySelectorAll('.rem-row');
  const remData=[];
  rows.forEach((row,i)=>{
    const timeIn=row.querySelector('input[type="time"]');
    const sw=row.querySelector('.tsw');
    const lbl=row.querySelector('.rem-title');
    if(timeIn&&sw&&lbl){
      remData.push({
        id:'rem_'+i,
        label:lbl.textContent.trim(),
        time:timeIn.value,
        on:sw.classList.contains('on')
      });
    }
  });
  store('gt_reminders', remData);
  scheduleAllReminders(remData);
  toastSuccess('Reminders saved.');
}

function loadReminders(){
  const saved=load('gt_reminders',[]);
  if(!saved.length) return;
  const rows=document.querySelectorAll('.rem-row');
  rows.forEach((row,i)=>{
    if(!saved[i]) return;
    const timeIn=row.querySelector('input[type="time"]');
    const sw=row.querySelector('.tsw');
    if(timeIn) timeIn.value=saved[i].time||timeIn.value;
    if(sw){
      if(saved[i].on) sw.classList.add('on');
      else sw.classList.remove('on');
    }
  });
}

function scheduleAllReminders(remData){
  // Clear any previously scheduled reminders stored in SW
  if(navigator.serviceWorker && navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({type:'CLEAR_REMINDERS'});
  }
  const now=new Date();
  remData.forEach(rem=>{
    if(!rem.on||!rem.time) return;
    const [h,m]=rem.time.split(':').map(Number);
    const fireAt=new Date(now);
    fireAt.setHours(h,m,0,0);
    if(fireAt<=now) fireAt.setDate(fireAt.getDate()+1); // schedule for tomorrow if past
    const delayMs=fireAt.getTime()-now.getTime();
    scheduleNotification(delayMs, '⏰ '+rem.label, 'Time for your '+rem.label.toLowerCase()+'. Tap to log a reading.', rem.id);
  });
}

function testNotification(){
  notify('🔔 Test Notification','Notifications are working! You will receive reminders and timer alerts here.','💉','test');
  toastSuccess('Test notification sent.');
}

// ══════════════ CONNECTED APPS ══════════════
// ══════════════ FREESTYLE LIBRE (LibreLinkUp) REAL API ══════════════
// Uses the unofficial reverse-engineered LibreLinkUp API
// Docs: https://gist.github.com/khskekec/6c13ba01b10d3018d816706a32ae8ab2
// NOTE: As of Oct 2025 API v4.16+ requires Account-Id = SHA256(userId)
//
// CORS STRATEGY: Direct browser fetch to api.libreview.io is blocked (no CORS headers).
// Solution: user deploys their own free Cloudflare Worker (100k req/day free tier).
// Worker URL is stored in localStorage. First connect triggers the setup wizard.

let libreSession = null; // {token, userId, accountId, patientId, region}
let libreSyncInterval = null;

// ── LibreLinkUp API via user-deployed Cloudflare Worker ──
// Abbott's API blocks CORS. The only reliable fix is a personal proxy.
// The user deploys a free Cloudflare Worker (takes 2 min) and pastes the URL here.
// Worker URL is saved to localStorage and reused on every visit.

function getWorkerUrl(){ return load('gt_cf_worker', null); }
function setWorkerUrl(url){ store('gt_cf_worker', url); }

async function libreFetch(path, method, headers, body){
  const region = (libreSession?.region) || 'eu';
  const baseMap = {
    eu:'api-eu.libreview.io', eu2:'api-eu2.libreview.io',
    us:'api.libreview.io', ae:'api-ae.libreview.io', ap:'api-ap.libreview.io',
    au:'api-au.libreview.io', ca:'api-ca.libreview.io', de:'api-de.libreview.io',
    fr:'api-fr.libreview.io', jp:'api-jp.libreview.io', la:'api-la.libreview.io',
  };
  // For login we don't have a session yet — use global endpoint which auto-redirects
  const base = baseMap[region] || 'api.libreview.io';
  const target = `https://${base}${path}`;

  const workerUrl = getWorkerUrl();
  if(!workerUrl){
    throw new Error('WORKER_NOT_SET');
  }

  const cleanWorkerUrl = workerUrl.replace(/\/+$/, '');
  const proxyUrl = `${cleanWorkerUrl}?url=${encodeURIComponent(target)}`;
  const opts = { method, headers };
  if(body) opts.body = body;

  console.log('[LibreFetch] Worker URL:', cleanWorkerUrl);
  console.log('[LibreFetch] Target:', target);
  console.log('[LibreFetch] Proxy URL:', proxyUrl);
  console.log('[LibreFetch] Method:', method);
  console.log('[LibreFetch] Headers:', JSON.stringify(headers));

  let resp;
  try {
    resp = await fetch(proxyUrl, opts);
    console.log('[LibreFetch] Response status:', resp.status);
  } catch(e) {
    console.error('[LibreFetch] Fetch failed:', e);
    throw new Error('Could not reach your Cloudflare Worker. Check the URL in Connected Apps settings. (' + e.message + ')');
  }

  let data;
  try {
    data = await resp.json();
  } catch(e) {
    throw new Error('Worker returned non-JSON (HTTP ' + resp.status + '). Make sure your Worker URL is correct.');
  }
  return data;
}

function libreHeadersObj(token, accountId){
  const h = {
    'Content-Type': 'application/json',
    'product': 'llu.android',
    'version': '4.7.0',
    'Accept-Encoding': 'gzip, deflate, br',
    'Connection': 'keep-alive',
    'cache-control': 'no-cache',
    'pragma': 'no-cache',
  };
  if(token) h['Authorization'] = 'Bearer ' + token;
  if(accountId) h['Account-Id'] = accountId;
  return h;
}

async function sha256hex(str){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function openLibreModal(){
  const bd = document.getElementById('libreModalBd');
  if(libreSession){
    appConfirm('Disconnect FreeStyle Libre?',()=>{libreDisconnect();});
    return;
  }
  document.getElementById('libreModalForm').style.display='block';
  document.getElementById('libreModalStatus').style.display='none';
  bd.classList.add('open');
}
function closeLibreModal(){ document.getElementById('libreModalBd').classList.remove('open'); }
function handleLibreModalBd(e){ if(e.target===document.getElementById('libreModalBd'))closeLibreModal(); }

async function libreLogin(){
  const email = document.getElementById('libreEmail').value.trim();
  const password = document.getElementById('librePassword').value;
  let region = document.getElementById('libreRegion').value;
  if(!email||!password){ toastError('Please enter your LibreLinkUp email and password.'); return; }

  // Show spinner
  document.getElementById('libreModalForm').style.display='none';
  document.getElementById('libreModalStatus').style.display='block';
  document.getElementById('libreModalStatusTxt').textContent='Signing in to LibreLinkUp…';

  try {
    // STEP 1: Login with selected region
    document.getElementById('libreModalStatusTxt').textContent = 'Connecting to LibreLinkUp (' + region.toUpperCase() + ')…';
    const savedSession = libreSession;
    libreSession = { region: region };
    let loginData;
    try {
      loginData = await libreFetch('/llu/auth/login', 'POST', libreHeadersObj(), JSON.stringify({ email, password }));
    } finally {
      libreSession = savedSession;
    }

    // Handle region redirect — retry with correct region
    if(loginData.status === 0 && loginData.data?.redirect === true){
      const redirectRegion = loginData.data.region;
      document.getElementById('libreModalStatusTxt').textContent = 'Redirected to ' + redirectRegion.toUpperCase() + ' — retrying…';
      region = redirectRegion;
      libreSession = { region: redirectRegion };
      try {
        loginData = await libreFetch('/llu/auth/login', 'POST', libreHeadersObj(), JSON.stringify({ email, password }));
      } finally {
        libreSession = savedSession;
      }
    }

    // Handle common error statuses
    if(loginData.status === 2){
      throw new Error('Please open the LibreLinkUp app on your phone and accept the latest Terms & Conditions, then try again here.');
    }
    if(loginData.status === 4){
      throw new Error('Wrong email or password. Double-check your LibreLinkUp credentials — these are the same email/password you use to log in to the LibreLinkUp app, not LibreView.');
    }
    if(loginData.status === 920){
      throw new Error('Abbott API rejected the version header — please report this bug.');
    }
    if(loginData.status === 911 || loginData.status === 912){
      throw new Error('Session error from Abbott. Try again in a moment.');
    }
    if(!loginData.data?.authTicket?.token){
      // Log the full response to help debug
      const raw = JSON.stringify(loginData).slice(0, 200);
      throw new Error('Login failed — no token returned. Full response: ' + raw);
    }

    const token = loginData.data.authTicket.token;
    const userId = loginData.data.user?.id;
    if(!userId) throw new Error('Login succeeded but no user ID in response. Try a different region.');

    // STEP 2: Build Account-Id header = SHA256(userId) — required since API v4.16 (Oct 2025)
    const accountId = await sha256hex(userId);

    document.getElementById('libreModalStatusTxt').textContent = 'Fetching your sensor connections…';

    // STEP 3: Get connections → patientId
    const connData = await libreFetch('/llu/connections', 'GET', libreHeadersObj(token, accountId), null);
    if(!connData.data?.length){
      throw new Error('No sensor connections found in your LibreLinkUp account. Open the LibreLinkUp app, make sure a sensor is active and sharing is enabled, then try again.');
    }
    const conn = connData.data[0];
    const patientId = conn.patientId;

    // Store session (no password stored)
    libreSession = { token, userId, accountId, patientId, region,
      firstName: conn.firstName, connectedAt: Date.now() };
    store('gt_libre_session', libreSession);

    closeLibreModal();
    libreOnConnected();

    // Immediately fetch latest reading
    await libreSync();

  } catch(err){
    document.getElementById('libreModalForm').style.display='block';
    document.getElementById('libreModalStatus').style.display='none';
    if(err.message === 'WORKER_NOT_SET'){
      showWorkerSetup();
    } else {
      toastError('LibreLink error: ' + err.message);
    }
  }
}

function showWorkerSetup(){
  closeLibreModal();
  document.getElementById('workerSetupModal').classList.add('open');
}

function closeWorkerSetup(){
  document.getElementById('workerSetupModal').classList.remove('open');
}

function saveWorkerUrl(){
  const url = document.getElementById('workerUrlInput').value.trim();
  if(!url || !url.startsWith('https://')){
    toastError('Please enter a valid https:// Worker URL.');
    return;
  }
  setWorkerUrl(url);
  closeWorkerSetup();
  toastSuccess('Worker URL saved! You can now connect your FreeStyle Libre.');
  setTimeout(openLibreModal, 400);
}

function libreOnConnected(){
  const btn = document.getElementById('libreConnectBtn');
  if(btn){ btn.textContent='Disconnect'; btn.className='app-connect libre-connected'; }
  const desc = document.getElementById('libreStatusDesc');
  if(desc && libreSession) desc.textContent = 'Connected · ' + (libreSession.firstName||'Patient') + ' · ' + libreSession.region.toUpperCase();
  document.getElementById('libreLiveCard').style.display='block';
  toastSuccess('FreeStyle Libre connected! Fetching your readings…');
  // Start background sync every 5 minutes
  if(document.getElementById('libreAutoSync')?.classList.contains('on')){
    startLibreAutoSync();
  }
}

function libreDisconnect(){
  libreSession = null;
  store('gt_libre_session', null);
  stopLibreAutoSync();
  const btn = document.getElementById('libreConnectBtn');
  if(btn){ btn.textContent='Connect'; btn.className='app-connect disconnected'; }
  const desc = document.getElementById('libreStatusDesc');
  if(desc) desc.textContent = 'Connect via LibreLinkUp account · Real readings';
  document.getElementById('libreLiveCard').style.display='none';
  document.getElementById('libreVal').textContent='—';
  toastSuccess('FreeStyle Libre disconnected.');
}

async function libreSync(){
  if(!libreSession){ toastError('FreeStyle Libre not connected.'); return; }
  const { token, accountId, patientId, region } = libreSession;
  try {
    document.getElementById('libreLastSync').textContent='Syncing…';
    const data = await libreFetch(`/llu/connections/${patientId}/graph`, 'GET', libreHeadersObj(token, accountId), null);

    if(data.status === 911 || data.status === 912 || data.status === 401){
      libreDisconnect();
      toastError('FreeStyle Libre session expired. Please reconnect.');
      return;
    }

    const latest = data.data?.connection?.glucoseMeasurement;
    if(!latest){ toastWarn('No current reading from LibreLinkUp.'); return; }

    // LibreLinkUp may return mg/dL (units=0) or mmol/L (units=1)
    // uom from connection: 1 = mmol/L, 0 = mg/dL
    let val = latest.Value;
    const uom = data.data?.connection?.uom;
    if(uom === 0){ val = Math.round(val / 18.0 * 10) / 10; } // convert mg/dL → mmol/L
    else { val = Math.round(val * 10) / 10; }

    // Trend arrows: 1=↓↓ 2=↓ 3=→ 4=↑ 5=↑↑
    const TREND = {1:'↓↓', 2:'↓', 3:'→', 4:'↑', 5:'↑↑'};
    const trendArrow = TREND[latest.TrendArrow] || '→';

    // Update live card
    document.getElementById('libreVal').textContent = val.toFixed(1);
    document.getElementById('libreTrend').textContent = trendArrow;
    const ts = new Date(latest.Timestamp);
    document.getElementById('libreMeta').textContent = ts.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + ' · Sensor reading';
    document.getElementById('libreLastSync').textContent = 'Synced ' + tSince(Date.now());

    // Auto-import: add reading to GlucoTrack if enabled and newer than last reading
    if(document.getElementById('libreAutoImport')?.classList.contains('on')){
      const tsMs = ts.getTime();
      const alreadyLogged = readings.some(r=>Math.abs(r.ts-tsMs)<5*60000&&!r.isMealOnly);
      if(!alreadyLogged){
        readings.push({
          ts: tsMs,
          value: val,
          context: 'Random Check',
          notes: 'LibreLinkUp auto-import',
          insulin: null, carbs: null, isMealOnly: false
        });
        saveReadings();
        refreshAll();
        toastSuccess(`LibreLink: ${val.toFixed(1)} mmol/L imported`);
      }
    }

    // Also import historical graph data if available
    const graphData = data.data?.graphData;
    if(graphData?.length && document.getElementById('libreAutoImport')?.classList.contains('on')){
      let imported = 0;
      graphData.forEach(g=>{
        let gv = g.Value;
        if(uom===0) gv = Math.round(gv/18.0*10)/10;
        else gv = Math.round(gv*10)/10;
        const gts = new Date(g.Timestamp).getTime();
        if(!readings.some(r=>Math.abs(r.ts-gts)<4*60000&&!r.isMealOnly)){
          readings.push({ts:gts,value:gv,context:'Random Check',notes:'LibreLinkUp import',insulin:null,carbs:null,isMealOnly:false});
          imported++;
        }
      });
      if(imported>0){
        saveReadings();
        refreshAll();
        toastSuccess(`Imported ${imported} historical readings from LibreLinkUp`);
      }
    }

  } catch(err){
    document.getElementById('libreLastSync').textContent = 'Sync failed';
    toastError('LibreLink sync failed: ' + err.message);
  }
}

function startLibreAutoSync(){
  stopLibreAutoSync();
  if(libreSession) libreSyncInterval = setInterval(libreSync, 5 * 60 * 1000);
}
function stopLibreAutoSync(){
  if(libreSyncInterval){ clearInterval(libreSyncInterval); libreSyncInterval=null; }
}
function toggleLibreAutoSync(btn){
  btn.classList.toggle('on');
  if(btn.classList.contains('on')) startLibreAutoSync();
  else stopLibreAutoSync();
}

// ══════════════ NIGHTSCOUT ══════════════
let nsSession = null;

function openNightscoutModal(){ document.getElementById('nsModalBd').classList.add('open'); }
function closeNsModal(){ document.getElementById('nsModalBd').classList.remove('open'); }
function handleNsModalBd(e){ if(e.target===document.getElementById('nsModalBd'))closeNsModal(); }

async function connectNightscout(){
  let url = document.getElementById('nsUrl').value.trim().replace(/\/$/, '');
  if(!url){ toastError('Please enter your NightScout URL.'); return; }
  if(!url.startsWith('http')) url = 'https://' + url;
  const secret = document.getElementById('nsSecret').value.trim();
  try {
    const headers = {'Content-Type':'application/json'};
    if(secret) headers['api-secret'] = await sha256hex(secret);
    const resp = await fetch(url + '/api/v1/entries.json?count=1&token='+encodeURIComponent(secret||''), {headers});
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    const entry = data[0];
    if(!entry) throw new Error('No readings found. Check URL and permissions.');
    nsSession = {url, secret, connectedAt: Date.now()};
    store('gt_ns_session', nsSession);
    closeNsModal();
    toastSuccess('NightScout connected! ' + (entry.sgv ? Math.round(entry.sgv/18.0*10)/10 + ' mmol/L latest' : ''));
  } catch(err){
    toastError('NightScout error: ' + err.message);
  }
}

// Restore libre session on boot
function restoreLibreSession(){
  const s = load('gt_libre_session', null);
  if(s?.token){
    libreSession = s;
    libreOnConnected();
    libreSync();
  }
}

// ══════════════ HELP FAQ ══════════════
function toggleFaq(hd){
  const body=hd.nextElementSibling;
  const isOpen=body.classList.toggle('open');
  hd.querySelector('span:last-child').textContent=isOpen?'▲':'▼';
}


// ══════════════ DRAWER / NAV ══════════════
function toggleDrawer(){
  const o=document.getElementById('drawer').classList.toggle('open');
  document.getElementById('dov').classList.toggle('open',o);
  document.getElementById('burgerBtn').classList.toggle('open',o);
}
function closeDrawer(){
  ['drawer','dov'].forEach(id=>document.getElementById(id).classList.remove('open'));
  document.getElementById('burgerBtn').classList.remove('open');
}
let curScreen='home';
function goTo(n){
  closeDrawer();
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const scr=document.getElementById('screen-'+n);
  if(!scr){console.warn('No screen:',n);return;}
  scr.classList.add('active');
  document.querySelectorAll('.di').forEach(i=>i.classList.remove('active'));
  const ni=document.getElementById('nav-'+n);if(ni)ni.classList.add('active');
  curScreen=n;
  const noFab=['settings','alarms','reminders','apps','help','about'];
  document.getElementById('fab').style.display=noFab.includes(n)?'none':'flex';
  document.getElementById('scrollArea').scrollTop=0;
  if(n==='a1c')setTimeout(updateA1c,50);
  if(n==='history')updateHistory();
  if(n==='home')setTimeout(drawMainChart,120);
  if(n==='forecast'){setTimeout(updateForecast,60);setTimeout(updateBasalInsights,80);}
  if(n==='reports')setTimeout(updateReports,60);
  if(n==='alarms')loadAlarms();
  if(n==='reminders')loadReminders();
  if(n==='exercise'){setTimeout(()=>{renderExTables();updateExerciseScreen();},50);}
}


// ══════════════ TREND LOGIC ══════════════
// Compares the latest reading to the previous one.
// Uses rate-of-change per hour so results are meaningful
// regardless of how long ago the previous reading was taken.
// Returns: { arrow, cls, label, rate, mmolPerHour }
function getTrendInfo(bgReadings) {
  const NONE = { arrow: '→', cls: 'stable', label: 'Stable', rate: 0, mmolPerHour: 0 };
  if (!bgReadings || bgReadings.length < 2) return NONE;

  const latest = bgReadings[bgReadings.length - 1];
  const prev   = bgReadings[bgReadings.length - 2];
  const dtHours = (latest.ts - prev.ts) / 3600000;

  // Ignore gaps > 3 hours — trend is not meaningful
  if (dtHours <= 0 || dtHours > 3) return NONE;

  const mmolPerHour = (latest.value - prev.value) / dtHours;

  // Thresholds (mmol/L per hour):
  //   ↑↑ rising fast   > +2.0
  //   ↑  rising        +1.0 – +2.0
  //   →  stable        -1.0 – +1.0
  //   ↓  falling       -1.0 – -2.0
  //   ↓↓ falling fast  < -2.0
  if (mmolPerHour >  2.0) return { arrow: '↑↑', cls: 'rising2',  label: 'Rising fast',   rate: mmolPerHour };
  if (mmolPerHour >  1.0) return { arrow: '↑',  cls: 'rising1',  label: 'Rising',         rate: mmolPerHour };
  if (mmolPerHour < -2.0) return { arrow: '↓↓', cls: 'falling2', label: 'Falling fast',   rate: mmolPerHour };
  if (mmolPerHour < -1.0) return { arrow: '↓',  cls: 'falling1', label: 'Falling',        rate: mmolPerHour };
  return { arrow: '→', cls: 'stable', label: 'Stable', rate: mmolPerHour };
}

// Animate the trend arrow after a new save
function animateTrendArrow() {
  const el = document.getElementById('trendArrow');
  if (!el) return;
  el.classList.remove('pop');
  void el.offsetWidth; // force reflow
  el.classList.add('pop');
}

// ══════════════ HOME ══════════════
function updateHome(){
  const today=new Date();today.setHours(0,0,0,0);
  const tR=readings.filter(r=>r.ts>=today.getTime()&&!r.isMealOnly&&r.value>0);
  document.getElementById('rHint').textContent=fmt(cfg.low)+'–'+fmt(cfg.high);
  const bgReadings=readings.filter(r=>!r.isMealOnly&&r.value!=null&&r.value>0);
  if(!bgReadings.length){
    document.getElementById('mainNum').className='gc-num none';
    document.getElementById('mainNum').textContent='—';
    document.getElementById('statusBadge').className='gc-badge bok';
    document.getElementById('statusText').textContent='—';
    document.getElementById('trendArrow').textContent='—';
    document.getElementById('lastCheck').textContent='No readings yet';
    document.getElementById('rneedle').style.left='50%';
    ['sAvg','sTIR'].forEach(id=>document.getElementById(id).textContent='—');
    document.getElementById('sCount').textContent='0';
    updateWidget();return;
  }
  const lat=bgReadings[bgReadings.length-1];
  const s=getSt(lat.value);
  document.getElementById('mainNum').className='gc-num '+s.cls;
  document.getElementById('mainNum').textContent=fmt(lat.value);
  document.getElementById('statusBadge').className='gc-badge '+s.bc;
  document.getElementById('statusText').textContent=s.txt;
  document.getElementById('lastCheck').textContent=tSince(lat.ts);
  document.getElementById('rneedle').style.left=nPos(lat.value);
  const ti=getTrendInfo(bgReadings);
  const arrowEl=document.getElementById('trendArrow');
  arrowEl.textContent=ti.arrow;
  arrowEl.className='gc-trend '+ti.cls;
  const vals=tR.map(r=>r.value);
  document.getElementById('sAvg').textContent=vals.length?fmt(vals.reduce((a,b)=>a+b,0)/vals.length):'—';
  const inR=vals.filter(v=>v>=cfg.low&&v<=cfg.high).length;
  document.getElementById('sTIR').textContent=vals.length?Math.round(inR/vals.length*100)+'%':'—%';
  document.getElementById('sCount').textContent=tR.length;
  updateWidget();
  // Week-over-week banner on home
  (function(){
    const now=Date.now();
    const thisW=readings.filter(r=>r.ts>=now-7*86400000&&!r.isMealOnly&&r.value>0).map(r=>r.value);
    const lastW=readings.filter(r=>r.ts>=now-14*86400000&&r.ts<now-7*86400000&&!r.isMealOnly&&r.value>0).map(r=>r.value);
    const banner=document.getElementById('wowBanner');
    const deltaEl=document.getElementById('homeDelta');
    const noteEl=document.getElementById('homeDeltaNote');
    if(!banner||thisW.length<3||lastW.length<3){if(banner)banner.style.display='none';return;}
    banner.style.display='flex';
    const twA=thisW.reduce((a,b)=>a+b,0)/thisW.length;
    const lwA=lastW.reduce((a,b)=>a+b,0)/lastW.length;
    const d=twA-lwA;
    deltaEl.textContent=(d>=0?'+':'')+fmt(d)+' mmol/L';
    deltaEl.style.color=d<-0.2?'var(--ok)':d>0.2?'var(--hi)':'var(--t2)';
    noteEl.textContent=d<-0.2?'↓ Improving':d>0.2?'↑ Higher avg':'→ Stable';
    noteEl.style.color=deltaEl.style.color;
  })();
}

function updateRecent(){
  const el=document.getElementById('recentList');
  if(!readings.length){el.innerHTML='<div class="empty"><div class="empty-ic">💉</div>No readings yet.</div>';return;}
  // Keep track of original indices before reversing
  const indexed=[...readings].map((r,i)=>({...r,_idx:i})).reverse().slice(0,10);
  el.innerHTML=indexed.map(r=>{
    const s=r.basalOnly?{cls:'ok',bc:'bok',txt:'BASAL',col:'#7C3AED'}:r.value&&r.value>0?getSt(r.value):{cls:'ok',bc:'bok',txt:'MEAL',col:'var(--acc)'};
    const ic=CTX_IC[r.context]||'🩺',cl=CTX_CL[r.context]||'#6B7280';
    const sub=[fD(r.ts)+', '+fT(r.ts),r.insulin?'💉 '+r.insulin+'u bolus':'',r.basal?'🌙 '+r.basal+'u basal':'',r.carbs?'🍞 '+r.carbs+'g':''].filter(Boolean).join(' · ');
    const valDisplay=r.basalOnly?r.basal+'u':r.isMealOnly?'🍽️':r.value!=null&&r.value>0?fmt(r.value):'—';
    const unitDisplay=r.basalOnly?'basal':r.isMealOnly?'meal':'mmol/L';
    const editFn=r.isMealOnly?`editMeal(${r._idx})`:`editReading(${r._idx})`;
    return`<div class="ei"><div class="ei-ic" style="background:${cl}18">${ic}</div><div class="ei-main"><div class="ei-ctx">${r.context||'Reading'}</div><div class="ei-sub">${sub}</div>${r.notes?`<div class="ei-sub" style="color:var(--t2)">${r.notes}</div>`:''} ${tagLine?`<div class="ei-sub" style="color:var(--pur);font-size:12px">${tagLine}</div>`:''}</div><div class="ei-r"><div class="ei-val" style="color:${s.col}">${valDisplay}</div><div class="ei-u">${unitDisplay}</div></div><div class="ei-actions"><button class="ei-act edit" onclick="${editFn}" title="Edit">✏️</button><button class="ei-act del" onclick="deleteEntry(${r._idx})" title="Delete">🗑️</button></div></div>`;
  }).join('');
}

// ══════════════ WIDGET ══════════════
function updateWidget(){
  const bgR=readings.filter(r=>!r.isMealOnly&&r.value!=null&&r.value>0);
  if(!bgR.length){
    document.getElementById('wNum').className='wnum none';
    document.getElementById('wNum').textContent='—';
    document.getElementById('wTrend').textContent='';
    document.getElementById('wTime').textContent='No reading';
    drawSparkline();return;
  }
  const lat=bgR[bgR.length-1];
  const s=getSt(lat.value);
  const nc={ok:'',low:'low',hi:'hi',vhi:'vhi'};
  document.getElementById('wNum').className='wnum '+(nc[s.cls]||'');
  document.getElementById('wNum').textContent=fmt(lat.value);
  document.getElementById('wTime').textContent=tSince(lat.ts);
  const wti=getTrendInfo(bgR);
  document.getElementById('wTrend').textContent=wti.arrow;
  drawSparkline();
}

function drawSparkline(){
  const cv=document.getElementById('sparkCv');if(!cv)return;
  const pw=cv.parentElement;
  const W=Math.max(pw.offsetWidth||pw.getBoundingClientRect().width,60)||100;
  const H=30,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const data=readings.filter(r=>!r.isMealOnly&&r.value!=null&&r.value>0&&r.ts>=Date.now()-6*3600000).slice(-20);
  if(data.length<2)return;
  const vals=data.map(r=>r.value);
  const mn=Math.min(...vals)-.3,mx=Math.max(...vals)+.3;
  const tx=(i)=>(i/(data.length-1))*W;
  const ty=(v)=>H-(v-mn)/(mx-mn)*H;
  ctx.beginPath();data.forEach((r,i)=>i===0?ctx.moveTo(tx(i),ty(r.value)):ctx.lineTo(tx(i),ty(r.value)));
  ctx.strokeStyle='rgba(255,255,255,.45)';ctx.lineWidth=1.5;ctx.lineJoin='round';ctx.stroke();
  const last=data[data.length-1];const sc=getSt(last.value);
  const dc={ok:'#34d399',low:'#f87171',hi:'#fbbf24',vhi:'#f87171'};
  ctx.beginPath();ctx.arc(tx(data.length-1),ty(last.value),3,0,Math.PI*2);
  ctx.fillStyle=dc[sc.cls]||'#34d399';ctx.fill();
}

// ══════════════ ABBOTT-QUALITY LINE CHART ══════════════
let chartRangeMode='3h';

function setChartRange(r,btn){
  chartRangeMode=r;
  document.querySelectorAll('.cdr-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const cdr=document.getElementById('customDateRow');
  cdr.style.display=r==='custom'?'flex':'none';
  if(r==='custom'){cdr.style.flexWrap='wrap';cdr.style.alignItems='center';cdr.style.gap='6px';}
  if(r!=='custom')drawMainChart();
}

function applyCustomRange(){
  const f=document.getElementById('cdrFrom').value;
  const t=document.getElementById('cdrTo').value;
  if(!f||!t){toastError('Please select both From and To dates.');return;}
  if(new Date(f)>new Date(t)){toastError('From date must be before To date.');return;}
  chartCustomFrom=new Date(f).setHours(0,0,0,0);
  chartCustomTo=new Date(t).setHours(23,59,59,999);
  drawMainChart();
}

function getChartRange(){
  const now=Date.now();
  if(chartRangeMode==='custom'&&chartCustomFrom&&chartCustomTo)return{since:chartCustomFrom,to:chartCustomTo};
  if(chartRangeMode==='3h')return{since:now-3*3600000,to:now};
  if(chartRangeMode==='6h')return{since:now-6*3600000,to:now};
  if(chartRangeMode==='today'){const d=new Date();d.setHours(0,0,0,0);return{since:d.getTime(),to:now};}
  if(chartRangeMode==='3d')return{since:now-3*86400000,to:now};
  if(chartRangeMode==='7d')return{since:now-7*86400000,to:now};
  if(chartRangeMode==='14d')return{since:now-14*86400000,to:now};
  return{since:now-6*3600000,to:now};
}

function drawMainChart(){
  const cv=document.getElementById('mainChart');if(!cv)return;
  // Only draw when the canvas has a real layout (visible on screen)
  const par=cv.parentElement;
  let W=par.offsetWidth||par.getBoundingClientRect().width;
  if(!W||W<10){
    // Try card parent, then scrollArea
    const card=par.closest('.card');
    if(card)W=card.offsetWidth-32;
    if(!W||W<10){const sa=document.getElementById('scrollArea');W=sa?(sa.offsetWidth||360)-28:360;}
  }
  W=Math.max(W,200);
  const H=180,dpr=window.devicePixelRatio||1;
  cv.width=Math.round(W*dpr);cv.height=Math.round(H*dpr);
  cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);

  const {since,to}=getChartRange();
  const timeSpan=to-since;
  const data=readings.filter(r=>r.ts>=since&&r.ts<=to&&!r.isMealOnly&&r.value!=null&&r.value>0);

  // PADDING
  const pL=38,pR=12,pT=10,pB=28;
  const cW=W-pL-pR,cH=H-pT-pB;

  // VALUE RANGE — Abbott style, always show target band
  const lo=cfg.low,hi=cfg.high;
  const allVals=data.map(r=>r.value);
  const dataMin=allVals.length?Math.min(...allVals):lo-1;
  const dataMax=allVals.length?Math.max(...allVals):hi+2;
  const minV=Math.max(0,Math.min(dataMin,lo)-1.5);
  const maxV=Math.max(dataMax,hi)+2.0;
  const range=maxV-minV||1;

  // Guard against zero timespan
  const safeTx=(ts)=>timeSpan>0?pL+(ts-since)/timeSpan*cW:pL+cW/2;
  function tx(ts){return safeTx(ts);}
  function ty(v){return pT+(1-(v-minV)/range)*cH;}

  // ── BACKGROUND ──
  ctx.fillStyle=document.body.classList.contains('dark')?'#111d30':'#FAFBFC';
  ctx.fillRect(pL,pT,cW,cH);

  // ── GRID LINES (faint) ──
  ctx.setLineDash([2,4]);ctx.lineWidth=.8;
  // Horizontal grid every ~2 mmol
  const gridStep=range>10?4:2;
  const gridStart=Math.ceil(minV/gridStep)*gridStep;
  for(let v=gridStart;v<=maxV;v+=gridStep){
    const y=ty(v);
    ctx.strokeStyle=document.body.classList.contains('dark')?'rgba(255,255,255,0.05)':'rgba(0,0,0,0.06)';
    ctx.beginPath();ctx.moveTo(pL,y);ctx.lineTo(pL+cW,y);ctx.stroke();
  }
  ctx.setLineDash([]);

  // ── TARGET ZONE (green tinted band) ──
  const yHi=ty(hi),yLo=ty(lo);
  ctx.fillStyle='rgba(56,161,105,0.07)';
  ctx.fillRect(pL,yHi,cW,yLo-yHi);

  // ── TARGET ZONE BORDER LINES ──
  ctx.setLineDash([4,4]);ctx.lineWidth=1;
  ctx.strokeStyle='rgba(56,161,105,0.4)';
  ctx.beginPath();ctx.moveTo(pL,yHi);ctx.lineTo(pL+cW,yHi);ctx.stroke();
  ctx.strokeStyle='rgba(229,62,62,0.3)';
  ctx.beginPath();ctx.moveTo(pL,yLo);ctx.lineTo(pL+cW,yLo);ctx.stroke();
  ctx.setLineDash([]);

  // ── Y AXIS LABELS ──
  ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='9px JetBrains Mono';ctx.textAlign='right';
  for(let v=gridStart;v<=maxV;v+=gridStep){
    ctx.fillText(v.toFixed(1),pL-4,ty(v)+3.5);
  }
  // Target labels
  ctx.fillStyle='rgba(56,161,105,0.7)';ctx.font='8px JetBrains Mono';ctx.textAlign='left';
  ctx.fillText(hi.toFixed(1),pL+2,yHi-2);
  ctx.fillStyle='rgba(229,62,62,0.7)';
  ctx.fillText(lo.toFixed(1),pL+2,yLo+9);

  if(data.length===0){
    ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='12px Plus Jakarta Sans';ctx.textAlign='center';
    ctx.fillText('No readings in this period',W/2,H/2);
    drawXAxis(ctx,pL,pT,pB,cW,cH,W,H,since,to);return;
  }

  // Single point — draw a prominent dot and label
  if(data.length===1){
    const r=data[0];const s=getSt(r.value);
    const DOT_COLORS={ok:'#38A169',low:'#E53E3E',hi:'#D97706',vhi:'#E53E3E'};
    const x=pL+cW/2,y=ty(r.value);
    ctx.beginPath();ctx.arc(x,y,7,0,Math.PI*2);ctx.fillStyle=DOT_COLORS[s.cls]+'33';ctx.fill();
    ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);ctx.fillStyle=DOT_COLORS[s.cls];ctx.fill();
    ctx.strokeStyle='white';ctx.lineWidth=2;ctx.stroke();
    const lbl=fmt(r.value);ctx.font='bold 11px JetBrains Mono';
    const tw=ctx.measureText(lbl).width;
    ctx.fillStyle='rgba(13,19,33,0.85)';roundRect(ctx,x-tw/2-5,y-26,tw+10,17,4);ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='center';ctx.fillText(lbl,x,y-13);
    drawXAxis(ctx,pL,pT,pB,cW,cH,W,H,since,to);return;
  }

  // ── GRADIENT FILL ──
  if(data.length>=2){
    const grad=ctx.createLinearGradient(0,pT,0,H);
    grad.addColorStop(0,'rgba(26,86,219,0.12)');
    grad.addColorStop(1,'rgba(26,86,219,0.0)');
    ctx.beginPath();ctx.moveTo(tx(data[0].ts),cH+pT);
    data.forEach(r=>ctx.lineTo(tx(r.ts),ty(r.value)));
    ctx.lineTo(tx(data[data.length-1].ts),cH+pT);
    ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  }

  // ── SMOOTH LINE ── (Cardinal spline for Abbott smoothness)
  if(data.length>=2){
    ctx.beginPath();
    const pts=data.map(r=>({x:tx(r.ts),y:ty(r.value)}));
    ctx.moveTo(pts[0].x,pts[0].y);
    for(let i=0;i<pts.length-1;i++){
      const p0=pts[Math.max(0,i-1)],p1=pts[i],p2=pts[i+1],p3=pts[Math.min(pts.length-1,i+2)];
      const tension=0.4;
      const cp1x=p1.x+(p2.x-p0.x)*tension/3;
      const cp1y=p1.y+(p2.y-p0.y)*tension/3;
      const cp2x=p2.x-(p3.x-p1.x)*tension/3;
      const cp2y=p2.y-(p3.y-p1.y)*tension/3;
      ctx.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,p2.x,p2.y);
    }
    ctx.strokeStyle='#1A56DB';ctx.lineWidth=2;ctx.lineJoin='round';ctx.stroke();
  }

  // ── COLOURED DOTS ── (Abbott style: color = zone)
  const DOT_COLORS={ok:'#38A169',low:'#E53E3E',hi:'#D97706',vhi:'#E53E3E'};
  const dotR=data.length>40?2:data.length>15?3:4;
  data.forEach((r,i)=>{
    const s=getSt(r.value);
    const x=tx(r.ts),y=ty(r.value);
    // Outer ring for status
    ctx.beginPath();ctx.arc(x,y,dotR+1.5,0,Math.PI*2);
    ctx.fillStyle=(DOT_COLORS[s.cls]+'22');ctx.fill();
    ctx.beginPath();ctx.arc(x,y,dotR,0,Math.PI*2);
    ctx.fillStyle=DOT_COLORS[s.cls];ctx.fill();
    ctx.strokeStyle='white';ctx.lineWidth=1.5;ctx.stroke();
  });

  // ── LATEST VALUE LABEL ──
  if(data.length){
    const last=data[data.length-1];const s=getSt(last.value);
    const lx=tx(last.ts),ly=ty(last.value);
    const lbl=fmt(last.value);
    ctx.font='bold 10px JetBrains Mono';
    const tw=ctx.measureText(lbl).width;
    const bx=Math.min(lx-tw/2-4,W-pR-tw-10);
    const by=ly>pT+22?ly-16:ly+22;
    ctx.fillStyle='rgba(13,19,33,0.85)';
    roundRect(ctx,bx,by-12,tw+8,16,4);ctx.fill();
    ctx.fillStyle='#fff';ctx.textAlign='left';ctx.fillText(lbl,bx+4,by);
  }

  drawXAxis(ctx,pL,pT,pB,cW,cH,W,H,since,to);

  // ── TOOLTIP HOVER ──
  setupChartHover(cv,data,pL,pR,pT,pB,cW,cH,since,to,minV,maxV);
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function drawXAxis(ctx,pL,pT,pB,cW,cH,W,H,since,to){
  const dur=to-since;
  ctx.font='9px JetBrains Mono';ctx.textAlign='center';

  // ── Generate candidate ticks at the natural interval ──
  let ticks=[];
  if(dur<=4*3600000){
    const s=new Date(since);s.setMinutes(Math.ceil(s.getMinutes()/30)*30,0,0);
    for(let t=s.getTime();t<=to;t+=30*60000)ticks.push(t);
  } else if(dur<=12*3600000){
    const s=new Date(since);s.setMinutes(0,0,0);s.setHours(s.getHours()+1);
    for(let t=s.getTime();t<=to;t+=3600000)ticks.push(t);
  } else if(dur<=3*86400000){
    const s=new Date(since);s.setHours(Math.ceil(s.getHours()/6)*6,0,0,0);
    for(let t=s.getTime();t<=to;t+=6*3600000)ticks.push(t);
  } else {
    // 7–14d: generate every day then cull to fit
    const s=new Date(since);s.setHours(0,0,0,0);s.setDate(s.getDate()+1);
    for(let t=s.getTime();t<=to;t+=86400000)ticks.push(t);
  }

  const tx2=(ts)=>pL+(ts-since)/(to-since)*cW;

  // ── Build label strings ──
  const labels=ticks.map(t=>{
    const d=new Date(t);
    if(dur<=12*3600000) return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    if(dur<=3*86400000) return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    return d.toLocaleDateString([],{month:'short',day:'numeric'});
  });

  // ── Measure max label width and cull overlapping ticks ──
  const MIN_GAP=6; // px breathing room between labels
  const maxLblW=labels.reduce((mx,l)=>Math.max(mx,ctx.measureText(l).width),0);
  const minSpacing=maxLblW+MIN_GAP;

  // How many ticks can we fit?
  const maxTicks=Math.floor(cW/minSpacing);
  let step=1;
  if(ticks.length>maxTicks){
    step=Math.ceil(ticks.length/maxTicks);
    // For multi-day views prefer steps that land on round days (2,3,7)
    if(dur>3*86400000){
      if(step<=2)step=2;
      else if(step<=3)step=3;
      else if(step<=7)step=7;
    }
  }

  // ── Draw only the culled ticks ──
  let lastX=-Infinity;
  ticks.forEach((t,i)=>{
    if(i%step!==0)return;
    const x=tx2(t);
    if(x<pL||x>pL+cW)return;
    // Extra safety: skip if too close to last drawn label
    if(x-lastX<minSpacing)return;
    lastX=x;
    const lbl=labels[i];
    ctx.fillStyle='rgba(0,0,0,0.10)';ctx.fillRect(x,pT,1,cH);
    ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.fillText(lbl,x,pT+cH+pB-6);
  });
}

function setupChartHover(cv,data,pL,pR,pT,pB,cW,cH,since,to,minV,maxV){
  cv.onmousemove=cv.ontouchmove=function(e){
    e.preventDefault();
    const rect=cv.getBoundingClientRect();
    const cx=e.touches?e.touches[0].clientX-rect.left:e.clientX-rect.left;
    if(!data.length)return;
    const range=to-since;
    const tsAt=since+(cx-pL)/cW*range;
    let closest=data[0],minDist=Infinity;
    data.forEach(r=>{const d=Math.abs(r.ts-tsAt);if(d<minDist){minDist=d;closest=r;}});
    const tx=(ts)=>pL+(ts-since)/range*cW;
    const x=tx(closest.ts);
    const tt=document.getElementById('chartTooltip');
    const s=getSt(closest.value);
    const time=new Date(closest.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const date=new Date(closest.ts).toLocaleDateString([],{month:'short',day:'numeric'});
    tt.innerHTML=`<strong style="color:${s.col}">${fmt(closest.value)} mmol/L</strong><br><span style="opacity:.7;font-size:11px;">${date} ${time}${closest.context?' · '+closest.context:''}</span>`;
    const tLeft=Math.min(Math.max(x,60),cW+pL-60);
    tt.style.left=tLeft+'px';
    tt.style.top=(pT-6)+'px';
    tt.style.opacity='1';
  };
  cv.onmouseleave=cv.ontouchend=function(){
    document.getElementById('chartTooltip').style.opacity='0';
  };
}

// ══════════════ FORECAST ══════════════
function updateForecast(){
  if(!readings.filter(r=>!r.isMealOnly&&r.value>0).length){
    ['fcNow','fc1h','fc2h','fc3h'].forEach(id=>document.getElementById(id).textContent='—');
    document.getElementById('fcMeta').textContent='Log a reading to see your forecast';
    document.getElementById('fcPills').innerHTML='';
    return;
  }
  const now=Date.now(),bgR2=readings.filter(r=>!r.isMealOnly&&r.value>0),lat=bgR2[bgR2.length-1];
  let trend=0;
  if(bgR2.length>=2){
    const prev=bgR2[bgR2.length-2];
    const dtMin=(lat.ts-prev.ts)/60000;
    if(dtMin>0&&dtMin<180)trend=Math.max(-0.08,Math.min(0.08,(lat.value-prev.value)/dtMin));
  }
  const recentMeals=readings.filter(r=>r.carbs&&r.carbs>0&&(now-r.ts)<2*3600000);
  const recentIns=readings.filter(r=>r.insulin&&r.insulin>0&&!r.basalOnly&&(now-r.ts)<4*3600000);// basal excluded from IOB
  function fcast(m){
    let v=lat.value+trend*m;
    recentMeals.forEach(r=>{
      const ma=(now-r.ts)/60000;
      const pF=Math.max(0,m<45?(ma+m)/45:Math.max(0,(120-(ma+m))/75));
      const pN=ma<45?ma/45:Math.max(0,(120-ma)/75);
      v+=(r.carbs/cfg.carbRatio)*cfg.corrFactor*(pF-pN)*0.7;
    });
    recentIns.forEach(r=>{
      const ma=(now-r.ts)/60000;
      const pF=Math.max(0,(ma+m)<60?(ma+m)/60:Math.max(0,(240-(ma+m))/180));
      const pN=ma<60?ma/60:Math.max(0,(240-ma)/180);
      v-=r.insulin*cfg.corrFactor*(pF-pN)*0.45;
    });
    const tgt=(cfg.low+cfg.high)/2;
    v+=(tgt-v)*0.015*(m/60);
    return Math.max(1.5,Math.round(v*10)/10);
  }
  const f1=fcast(60),f2=fcast(120),f3=fcast(180);
  const pts=[{t:0,v:lat.value},{t:30,v:fcast(30)},{t:60,v:f1},{t:90,v:fcast(90)},{t:120,v:f2},{t:180,v:f3}];
  document.getElementById('fcNow').textContent=fmt(lat.value);
  document.getElementById('fc1h').textContent=fmt(f1);
  document.getElementById('fc2h').textContent=fmt(f2);
  document.getElementById('fc3h').textContent=fmt(f3);
  const dir=f3>lat.value+.5?'📈 Rising':f3<lat.value-.5?'📉 Falling':'➡️ Stable';
  const s3=getSt(f3);
  document.getElementById('fcMeta').textContent=`${dir} · ${s3.txt} predicted in 3h`;
  const pills=[];
  if(recentMeals.length)pills.push(`🍞 Active carbs`);
  if(recentIns.length)pills.push(`💉 Insulin on board`);
  if(Math.abs(trend)>0.02)pills.push(trend>0?`⬆ Rising ${(trend*60).toFixed(1)} mmol/h`:`⬇ Falling ${(Math.abs(trend)*60).toFixed(1)} mmol/h`);
  document.getElementById('fcPills').innerHTML=pills.map(p=>`<div class="fpill">${p}</div>`).join('');
  // Factors
  let fh='';
  recentMeals.forEach(r=>{const ma=Math.round((now-r.ts)/60000);fh+=`<div class="ei"><div class="ei-ic" style="background:#F59E0B18">🍽️</div><div class="ei-main"><div class="ei-ctx">Meal</div><div class="ei-sub">${r.carbs}g carbs · ${ma}m ago</div></div></div>`;});
  recentIns.forEach(r=>{const ma=Math.round((now-r.ts)/60000);fh+=`<div class="ei"><div class="ei-ic" style="background:#1A56DB18">💉</div><div class="ei-main"><div class="ei-ctx">Insulin</div><div class="ei-sub">${r.insulin}u · ${ma}m ago</div></div></div>`;});
  document.getElementById('fcFactors').innerHTML=fh||'<div class="empty" style="padding:10px;"><div class="empty-ic" style="font-size:20px;">⚡</div>No active factors</div>';
  // Recs
  const recs=[];
  if(f1<cfg.low){
    // Rule of 15: 15g fast-acting carbs raises BG ~2.1 mmol/L in most adults
    const bgDeficit=Math.max(0,cfg.low-f1);
    const rescueCarbs=Math.round((bgDeficit/2.1)*15);
    recs.push({ic:'🚨',c:'var(--low)',t:'Low Predicted in 1h',b:`${fmt(f1)} mmol/L predicted. Rule of 15: ~${rescueCarbs}g fast-acting carbs to raise BG to target. Recheck in 15 min.`});
  }
  if(f3>cfg.high&&f1>cfg.high){
    const targetBG=(cfg.low+cfg.high)/2;
    const cu=Math.max(0,(f1-targetBG)/cfg.corrFactor);
    const cuRounded=Math.round(cu*2)/2;
    recs.push({ic:'💉',c:'var(--acc)',t:'Correction May Be Needed',b:`Predicted ${fmt(f1)} in 1h. Walsh correction: (${fmt(f1)}−${fmt(targetBG)}) ÷ ${cfg.corrFactor} ≈ ${cuRounded.toFixed(1)}u. Subtract any IOB. Always verify before dosing.`});
  }
  if(!recs.length&&f3>=cfg.low&&f3<=cfg.high)recs.push({ic:'✅',c:'var(--ok)',t:'On Track',b:'Forecast looks good for the next 3 hours.'});
  if(!recs.length)recs.push({ic:'💡',c:'var(--t2)',t:'Keep Logging',b:'Log regularly for more accurate predictions.'});
  document.getElementById('fcRecs').innerHTML=recs.map(r=>`<div style="display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)"><div style="font-size:18px;flex-shrink:0">${r.ic}</div><div><div style="font-size:13px;font-weight:700;color:${r.c};margin-bottom:3px">${r.t}</div><div style="font-size:12px;color:var(--t2);line-height:1.5">${r.b}</div></div></div>`).join('');
  setTimeout(()=>drawFcChart(pts),50);
}

function drawFcChart(pts){
  const cv=document.getElementById('fcChart');if(!cv)return;
  const par=cv.parentElement;
  let W=par.offsetWidth||par.getBoundingClientRect().width||300;
  const H=90,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const vals=pts.map(p=>p.v);
  const mn=Math.max(1,Math.min(...vals,cfg.low)-.5),mx=Math.min(22,Math.max(...vals,cfg.high)+.5);
  const pL=4,pR=4,pT=6,pB=14,cW=W-pL-pR,cH=H-pT-pB;
  const tx=(i)=>pL+(i/(pts.length-1))*cW;const ty=(v)=>pT+(1-(v-mn)/(mx-mn))*cH;
  ctx.fillStyle='rgba(255,255,255,0.08)';ctx.fillRect(pL,ty(cfg.high),cW,ty(cfg.low)-ty(cfg.high));
  if(pts.length>=2){
    ctx.beginPath();ctx.moveTo(tx(0),ty(pts[0].v));ctx.lineTo(tx(1),ty(pts[1].v));
    ctx.strokeStyle='rgba(255,255,255,.8)';ctx.lineWidth=2;ctx.stroke();
    ctx.beginPath();ctx.moveTo(tx(1),ty(pts[1].v));
    pts.slice(2).forEach((p,i)=>ctx.lineTo(tx(i+2),ty(p.v)));
    ctx.setLineDash([5,4]);ctx.strokeStyle='rgba(255,255,255,.4)';ctx.lineWidth=1.5;ctx.stroke();ctx.setLineDash([]);
  }
  pts.forEach((p,i)=>{
    const s=getSt(p.v);const dc={ok:'#34d399',low:'#f87171',hi:'#fbbf24',vhi:'#f87171'};
    ctx.beginPath();ctx.arc(tx(i),ty(p.v),i===0?4:3,0,Math.PI*2);
    ctx.fillStyle=i===0?'#fff':dc[s.cls];ctx.fill();
  });
  ctx.fillStyle='rgba(255,255,255,.35)';ctx.font='9px JetBrains Mono';ctx.textAlign='center';
  ['Now','30m','1h','1.5h','2h','3h'].forEach((l,i)=>ctx.fillText(l,tx(i),H-1));
}

// ══════════════ BASAL ANALYSIS ══════════════

// ── 1. Basal Adequacy ──
// Looks at fasting readings (Before Bed & Waking Up) over 14 days
// If fasting BG is consistently in range → basal is adequate
// If consistently high → basal may be too low
// If consistently low → basal may be too high
function updateBasalAdequacy(){
  const el=document.getElementById('basalAdequacy');
  if(!el)return;
  const since=Date.now()-14*86400000;
  const fasting=readings.filter(r=>
    !r.isMealOnly&&r.value>0&&r.ts>=since&&
    (r.context==='Before Bed'||r.context==='Waking Up')
  );
  if(fasting.length<3){
    el.innerHTML='<div class="empty" style="padding:10px;font-size:12px;">Need at least 3 fasting readings (Before Bed / Waking Up) over 14 days</div>';
    return;
  }
  const vals=fasting.map(r=>r.value);
  const avg=vals.reduce((a,b)=>a+b,0)/vals.length;
  const inRange=vals.filter(v=>v>=cfg.low&&v<=cfg.high).length;
  const pct=Math.round(inRange/vals.length*100);
  const high=vals.filter(v=>v>cfg.high).length;
  const low=vals.filter(v=>v<cfg.low).length;
  const highPct=Math.round(high/vals.length*100);
  const lowPct=Math.round(low/vals.length*100);

  let verdict,col,bg,advice;
  if(pct>=70){
    verdict='Well Controlled';col='var(--ok)';bg='var(--ok-bg)';
    advice='Your fasting glucose is mostly in range — basal dose appears appropriate.';
  } else if(highPct>40){
    verdict='Possibly Too Low';col='var(--hi)';bg='var(--hi-bg)';
    advice=`${highPct}% of fasting readings are above target. Your basal dose may need increasing — discuss with your doctor.`;
  } else if(lowPct>20){
    verdict='Possibly Too High';col='var(--low)';bg='var(--low-bg)';
    advice=`${lowPct}% of fasting readings are below target. Your basal dose may be too high — review with your doctor urgently.`;
  } else {
    verdict='Variable';col='var(--hi)';bg='var(--hi-bg)';
    advice='Your fasting glucose is inconsistent. Check for missed doses, injection site rotation, and discuss with your doctor.';
  }

  el.innerHTML=`
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      <div style="flex:1;">
        <div style="font-size:11px;color:var(--t3);margin-bottom:3px;">Fasting BG average (14 days)</div>
        <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono',monospace;letter-spacing:-1px;color:${col}">${fmt(avg)} <span style="font-size:12px;font-weight:500">mmol/L</span></div>
      </div>
      <div style="text-align:center;">
        <div style="background:${bg};color:${col};border-radius:20px;padding:5px 12px;font-size:11px;font-weight:700;">${verdict}</div>
        <div style="font-size:10px;color:var(--t3);margin-top:4px;">${fasting.length} fasting readings</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px;">
      <div style="text-align:center;background:var(--ok-bg);border-radius:8px;padding:8px;">
        <div style="font-size:18px;font-weight:800;color:var(--ok);font-family:'JetBrains Mono',monospace;">${pct}%</div>
        <div style="font-size:10px;color:var(--t3);">In Range</div>
      </div>
      <div style="text-align:center;background:var(--hi-bg);border-radius:8px;padding:8px;">
        <div style="font-size:18px;font-weight:800;color:var(--hi);font-family:'JetBrains Mono',monospace;">${highPct}%</div>
        <div style="font-size:10px;color:var(--t3);">Above Target</div>
      </div>
      <div style="text-align:center;background:var(--low-bg);border-radius:8px;padding:8px;">
        <div style="font-size:18px;font-weight:800;color:var(--low);font-family:'JetBrains Mono',monospace;">${lowPct}%</div>
        <div style="font-size:10px;color:var(--t3);">Below Target</div>
      </div>
    </div>
    <div style="background:var(--bg);border-radius:8px;padding:10px;font-size:12px;color:var(--t2);line-height:1.6;">
      💡 ${advice}
    </div>
    <div style="font-size:10px;color:var(--t3);margin-top:8px;line-height:1.5;">⚠️ This is an observational indicator only. Never adjust your basal dose without consulting your endocrinologist or diabetes care team.</div>
  `;
}

// ── 2. Overnight Trend ──
// Pairs bedtime readings with next morning readings
// Calculates average rise/fall overnight across 7 days
function updateOvernightTrend(){
  const el=document.getElementById('overnightTrend');
  if(!el)return;
  const since=Date.now()-7*86400000;

  // Get Before Bed and Waking Up readings, sorted by time
  const bed=readings.filter(r=>r.context==='Before Bed'&&!r.isMealOnly&&r.value>0&&r.ts>=since)
    .sort((a,b)=>a.ts-b.ts);
  const wake=readings.filter(r=>r.context==='Waking Up'&&!r.isMealOnly&&r.value>0&&r.ts>=since)
    .sort((a,b)=>a.ts-b.ts);

  if(!bed.length||!wake.length){
    el.innerHTML='<div class="empty" style="padding:10px;font-size:12px;">Need both Before Bed and Waking Up readings over 7 days</div>';
    return;
  }

  // Pair each bedtime with the closest subsequent waking reading (within 12h)
  const pairs=[];
  bed.forEach(b=>{
    const nextWake=wake.find(w=>w.ts>b.ts&&(w.ts-b.ts)<12*3600000);
    if(nextWake)pairs.push({bedVal:b.value,wakeVal:nextWake.value,diff:nextWake.value-b.value,bedTs:b.ts,wakeTs:nextWake.ts});
  });

  if(!pairs.length){
    el.innerHTML='<div class="empty" style="padding:10px;font-size:12px;">No matching bedtime/morning pairs found yet</div>';
    return;
  }

  const avgDiff=pairs.reduce((a,p)=>a+p.diff,0)/pairs.length;
  const rising=pairs.filter(p=>p.diff>1.5).length;
  const falling=pairs.filter(p=>p.diff<-1.5).length;
  const stable=pairs.length-rising-falling;

  let verdict,col,bg,advice;
  if(Math.abs(avgDiff)<=1.0){
    verdict='Stable Overnight';col='var(--ok)';bg='var(--ok-bg)';
    advice='Your glucose stays relatively stable overnight — a good sign your basal dose is working well.';
  } else if(avgDiff>1.0){
    verdict='Rising Overnight';col='var(--hi)';bg='var(--hi-bg)';
    advice=`Average rise of +${fmt(Math.abs(avgDiff))} mmol/L overnight. Could indicate insufficient basal, dawn phenomenon, or evening snacking. Discuss with your doctor.`;
  } else {
    verdict='Falling Overnight';col='var(--low)';bg='var(--low-bg)';
    advice=`Average drop of ${fmt(Math.abs(avgDiff))} mmol/L overnight. This may indicate your basal dose is too high, putting you at risk of overnight hypoglycaemia. Review with your doctor urgently.`;
  }

  const rows=pairs.slice(-5).reverse().map(p=>{
    const arrow=p.diff>1.5?'↑':p.diff<-1.5?'↓':'→';
    const dc=p.diff>1.5?'var(--hi)':p.diff<-1.5?'var(--low)':'var(--ok)';
    const date=new Date(p.bedTs).toLocaleDateString([],{weekday:'short',month:'short',day:'numeric'});
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);">
      <div style="font-size:11px;color:var(--t3);">${date}</div>
      <div style="font-size:12px;font-family:'JetBrains Mono',monospace;">${fmt(p.bedVal)} <span style="color:var(--t3)">→</span> ${fmt(p.wakeVal)}</div>
      <div style="font-size:13px;font-weight:800;color:${dc};">${arrow} ${p.diff>0?'+':''}${fmt(p.diff)}</div>
    </div>`;
  }).join('');

  el.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div>
        <div style="font-size:11px;color:var(--t3);margin-bottom:3px;">Avg overnight change</div>
        <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono',monospace;letter-spacing:-1px;color:${col}">${avgDiff>0?'+':''}${fmt(avgDiff)} <span style="font-size:12px;font-weight:500">mmol/L</span></div>
      </div>
      <div style="background:${bg};color:${col};border-radius:20px;padding:5px 12px;font-size:11px;font-weight:700;">${verdict}</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px;">
      <div style="text-align:center;background:var(--hi-bg);border-radius:8px;padding:8px;">
        <div style="font-size:18px;font-weight:800;color:var(--hi);font-family:'JetBrains Mono',monospace;">${rising}</div>
        <div style="font-size:10px;color:var(--t3);">Nights rising</div>
      </div>
      <div style="text-align:center;background:var(--ok-bg);border-radius:8px;padding:8px;">
        <div style="font-size:18px;font-weight:800;color:var(--ok);font-family:'JetBrains Mono',monospace;">${stable}</div>
        <div style="font-size:10px;color:var(--t3);">Nights stable</div>
      </div>
      <div style="text-align:center;background:var(--low-bg);border-radius:8px;padding:8px;">
        <div style="font-size:18px;font-weight:800;color:var(--low);font-family:'JetBrains Mono',monospace;">${falling}</div>
        <div style="font-size:10px;color:var(--t3);">Nights falling</div>
      </div>
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--t3);margin-bottom:6px;">Last ${pairs.slice(-5).length} nights</div>
    ${rows}
    <div style="background:var(--bg);border-radius:8px;padding:10px;font-size:12px;color:var(--t2);line-height:1.6;margin-top:10px;">💡 ${advice}</div>
    <div style="font-size:10px;color:var(--t3);margin-top:8px;line-height:1.5;">⚠️ Always discuss overnight patterns with your diabetes care team before adjusting your basal dose.</div>
  `;
}

// ── 3. Basal Injection Streak ──
// Tracks consecutive days basal was logged
function updateBasalStreak(){
  const el=document.getElementById('basalStreak');
  if(!el)return;
  const basalLogs=readings.filter(r=>r.basalOnly).sort((a,b)=>a.ts-b.ts);
  if(!basalLogs.length){
    el.innerHTML='<div class="empty" style="padding:10px;font-size:12px;">No basal injections logged yet — use the Log Reading button to track your daily injection</div>';
    return;
  }

  // Build set of days that have a basal log (YYYY-MM-DD strings)
  const loggedDays=new Set(basalLogs.map(r=>{
    const d=new Date(r.ts);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }));

  // Count current streak going back from today
  let streak=0;
  const today=new Date();
  for(let i=0;i<365;i++){
    const d=new Date(today);d.setDate(today.getDate()-i);
    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    if(loggedDays.has(key))streak++;
    else if(i>0)break;// gap found — streak ends (allow today to not be logged yet)
  }

  // Count longest ever streak
  const days=[...loggedDays].sort();
  let longest=0,cur=0,prevDate=null;
  days.forEach(dayStr=>{
    const d=new Date(dayStr);
    if(prevDate){
      const diff=(d-prevDate)/86400000;
      if(diff===1){cur++;longest=Math.max(longest,cur);}
      else cur=1;
    } else cur=1;
    prevDate=d;
  });
  longest=Math.max(longest,cur,streak);

  const todayKey=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  const loggedToday=loggedDays.has(todayKey);
  const totalDays=loggedDays.size;
  const name=cfg.basalName||'Basal';

  // Streak emoji
  const emoji=streak>=30?'🏆':streak>=14?'🔥':streak>=7?'⭐':streak>=3?'✅':'💉';

  // Last 14 days grid
  const gridDays=[];
  for(let i=13;i>=0;i--){
    const d=new Date(today);d.setDate(today.getDate()-i);
    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    gridDays.push({key,logged:loggedDays.has(key),label:d.getDate()});
  }
  const grid=gridDays.map(d=>`
    <div title="${d.key}" style="width:100%;aspect-ratio:1;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace;background:${d.logged?'var(--ok)':'var(--bg)'};color:${d.logged?'#fff':'var(--t3)'};">
      ${d.label}
    </div>`).join('');

  el.innerHTML=`
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
      <div style="text-align:center;">
        <div style="font-size:48px;line-height:1;">${emoji}</div>
      </div>
      <div style="flex:1;">
        <div style="font-size:11px;color:var(--t3);margin-bottom:2px;">Current streak</div>
        <div style="font-size:36px;font-weight:800;font-family:'JetBrains Mono',monospace;letter-spacing:-2px;color:${streak>0?'var(--ok)':'var(--t3)'};">${streak} <span style="font-size:14px;font-weight:600;letter-spacing:0;">days</span></div>
        <div style="font-size:11px;color:var(--t3);">${loggedToday?'✅ Logged today':'⏳ Not yet logged today'}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:11px;color:var(--t3);margin-bottom:2px;">Longest streak</div>
        <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--acc);">${longest}d</div>
        <div style="font-size:11px;color:var(--t3);">${totalDays} total days</div>
      </div>
    </div>
    <div style="font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">Last 14 days — ${name}</div>
    <div style="display:grid;grid-template-columns:repeat(14,1fr);gap:3px;margin-bottom:12px;">
      ${grid}
    </div>
    ${!loggedToday?`<div style="background:var(--acc-bg);border:1px solid var(--acc-b);border-radius:8px;padding:10px;font-size:12px;color:var(--acc);font-weight:600;">
      ⏰ Remember to log your ${name} injection today at ${cfg.basalTime||'18:00'}
    </div>`:''}
  `;
}

// ── Call all 3 when forecast screen opens ──
function updateBasalInsights(){
  updateBasalAdequacy();
  updateOvernightTrend();
  updateBasalStreak();
}

// ══════════════ A1C ══════════════
function updateA1c(){
  const s7=Date.now()-7*86400000,d7=readings.filter(r=>r.ts>=s7&&!r.isMealOnly&&r.value>0),vals=d7.map(r=>r.value);
  const lo=cfg.low,hi=cfg.high;
  document.getElementById('a7avg').textContent=vals.length?fmt(vals.reduce((a,b)=>a+b,0)/vals.length):'—';
  document.getElementById('a7min').textContent=vals.length?fmt(Math.min(...vals)):'—';
  document.getElementById('a7max').textContent=vals.length?fmt(Math.max(...vals)):'—';
  if(vals.length>=3){
    const avg=vals.reduce((a,b)=>a+b,0)/vals.length;
    const a1c=parseFloat(calcA1c(avg));
    const a1cTarget=cfg.a1cGoal||7.0;
    document.getElementById('a1cBig').innerHTML=a1c.toFixed(1)+'<span class="a1c-pct">%</span>';
    let zn,zc,zb,zbc,sub;
    if(a1c<a1cTarget-1){zn='Excellent';zc='var(--ok)';zb='var(--ok-bg)';zbc='var(--ok-b)';sub=`Well below your target of ${a1cTarget}%`;}
    else if(a1c<a1cTarget){zn='At Target';zc='var(--ok)';zb='var(--ok-bg)';zbc='var(--ok-b)';sub=`Within your target of ${a1cTarget}%`;}
    else if(a1c<a1cTarget+1){zn='Above Target';zc='var(--hi)';zb='var(--hi-bg)';zbc='var(--hi-b)';sub=`Slightly above your target of ${a1cTarget}% — review with your team`;}
    else{zn='High Risk';zc='var(--low)';zb='var(--low-bg)';zbc='var(--low-b)';sub=`Significantly above your target — see your doctor`;}
    document.getElementById('a1cBig').style.color=zc;
    document.getElementById('a1cSub').textContent=sub;
    const z=document.getElementById('a1cZone');z.textContent=zn;z.style.background=zb;z.style.color=zc;z.style.borderColor=zbc;
    document.getElementById('gneedle').style.left=Math.min(Math.max((a1c-4)/10,0),1)*100+'%';
  } else {
    document.getElementById('a1cBig').innerHTML='—<span class="a1c-pct">%</span>';
    document.getElementById('a1cBig').style.color='var(--t3)';
    document.getElementById('a1cSub').textContent='Log at least 3 readings';
    document.getElementById('a1cZone').textContent='Insufficient data';
  }
  const tot=vals.length||1;
  const lN=vals.filter(v=>v<lo).length,oN=vals.filter(v=>v>=lo&&v<=hi).length;
  const hN=vals.filter(v=>v>hi&&v<=13.9).length;
  const pL2=Math.round(lN/tot*100),pO=Math.round(oN/tot*100),pH=Math.round(hN/tot*100),pV=Math.max(0,100-pL2-pO-pH);
  ['tirLow','tirOk','tirHigh','tirVH'].forEach((id,i)=>{
    const pcts=[pL2,pO,pH,pV];
    document.getElementById(id).style.width=pcts[i]+'%';
  });
  ['tirLowP','tirOkP','tirHighP','tirVHP'].forEach((id,i)=>{
    document.getElementById(id).textContent=[pL2,pO,pH,pV][i]+'%';
  });
  setTimeout(drawA1cChart,50);
  updateGMI();
  updateWoW();
}

// ── GMI / CV% / eAG ──────────────────────────────────────────────────
// Bergenstal RM et al. Diabetes Care 2018;41(11):2275–2280
// Formula: GMI(%) = 3.31 + 0.02392 × mean_glucose_mgdl
// Nathan DM et al. ADA 2008: eAG(mg/dL) = 28.7 × A1c% − 46.7
// Rodbard D. Diabetes Technol Ther 2009: CV% = (SD/mean)×100, target <36%
function updateGMI(){
  const d14=readings.filter(r=>r.ts>=Date.now()-14*86400000&&!r.isMealOnly&&r.value>0);
  const gmiEl=document.getElementById('gmiVal');
  const cvEl=document.getElementById('cvVal');
  const eagEl=document.getElementById('eagVal');
  const cvBox=document.getElementById('cvStatusBox');
  const gmiBox=document.getElementById('gmiDiffBox');
  if(!gmiEl||!cvEl||!eagEl)return;

  if(d14.length<5){
    gmiEl.textContent='—';cvEl.textContent='—';eagEl.textContent='—';
    gmiEl.style.color=cvEl.style.color=eagEl.style.color='var(--t3)';
    if(cvBox)cvBox.style.display='none';
    if(gmiBox)gmiBox.style.display='none';
    return;
  }

  const vals=d14.map(r=>r.value);
  const n=vals.length;
  const mean=vals.reduce((a,b)=>a+b,0)/n;
  // SD (population)
  const variance=vals.reduce((s,v)=>s+Math.pow(v-mean,2),0)/n;
  const sd=Math.sqrt(variance);
  const cv=sd/mean*100;

  // Convert mean to mg/dL for GMI formula (1 mmol/L = 18.0182 mg/dL)
  const meanMgdl=mean*18.0182;
  const gmi=3.31+0.02392*meanMgdl;

  // eAG from estimated A1c (using our existing calcA1c formula)
  const estA1c=parseFloat(calcA1c(mean));
  const eagMgdl=28.7*estA1c-46.7;
  const eagMmol=eagMgdl/18.0182;

  // Display GMI
  gmiEl.textContent=gmi.toFixed(1);
  const a1cTarget=cfg.a1cGoal||7.0;
  gmiEl.style.color=gmi<a1cTarget?'var(--ok)':gmi<a1cTarget+1?'var(--hi)':'var(--low)';

  // Display CV%
  cvEl.textContent=cv.toFixed(0);
  const cvOk=cv<36;
  cvEl.style.color=cvOk?'var(--ok)':cv<40?'var(--hi)':'var(--low)';
  if(cvBox){
    cvBox.style.display='block';
    if(cvOk){
      cvBox.style.background='var(--ok-bg)';cvBox.style.borderColor='var(--ok-b)';
      document.getElementById('cvStatusTitle').style.color='var(--ok)';
      document.getElementById('cvStatusTitle').textContent='✅ CV '+cv.toFixed(0)+'% — Good variability control';
      document.getElementById('cvStatusSub').textContent='Below the clinical target of <36%. Your glucose levels are relatively stable.';
    } else if(cv<40){
      cvBox.style.background='var(--hi-bg)';cvBox.style.borderColor='var(--hi-b)';
      document.getElementById('cvStatusTitle').style.color='var(--hi)';
      document.getElementById('cvStatusTitle').textContent='⚠️ CV '+cv.toFixed(0)+'% — Elevated variability';
      document.getElementById('cvStatusSub').textContent='Above 36% target. High variability increases hypoglycaemia risk. Discuss with your care team.';
    } else {
      cvBox.style.background='var(--low-bg)';cvBox.style.borderColor='var(--low-b)';
      document.getElementById('cvStatusTitle').style.color='var(--low)';
      document.getElementById('cvStatusTitle').textContent='🚨 CV '+cv.toFixed(0)+'% — High variability';
      document.getElementById('cvStatusSub').textContent='Significantly above 36% target. Unpredictable glucose swings. Review with your endocrinologist urgently.';
    }
  }

  // Display eAG
  eagEl.textContent=fmt(eagMmol);
  eagEl.style.color='var(--text)';

  // GMI vs estimated A1c comparison note
  const diff=Math.abs(gmi-estA1c);
  if(gmiBox){
    gmiBox.style.display='block';
    let txt=`GMI ${gmi.toFixed(1)}% vs estimated HbA1c ${estA1c}%.`;
    if(diff<=0.5) txt+=' These are closely aligned — your sensor/SMBG readings reflect your average glucose well.';
    else if(gmi<estA1c) txt+=` GMI is ${diff.toFixed(1)}% lower. This may indicate post-meal spikes not captured by average. Lab HbA1c may be higher.`;
    else txt+=` GMI is ${diff.toFixed(1)}% higher than estimated A1c. Confirm with a lab HbA1c test.`;
    txt+=' Note: GMI and HbA1c may differ by ±0.5% even in ideal conditions (Bergenstal et al., 2018).';
    document.getElementById('gmiDiffTxt').textContent=txt;
  }
}

// ── Week-over-Week comparison ──────────────────────────────────────
function updateWoW(){
  const now=Date.now();
  const thisWeek=readings.filter(r=>r.ts>=now-7*86400000&&!r.isMealOnly&&r.value>0).map(r=>r.value);
  const lastWeek=readings.filter(r=>r.ts>=now-14*86400000&&r.ts<now-7*86400000&&!r.isMealOnly&&r.value>0).map(r=>r.value);
  const twEl=document.getElementById('wowThis');
  const lwEl=document.getElementById('wowLast');
  const dlEl=document.getElementById('wowDelta');
  const noteEl=document.getElementById('wowNote');
  if(!twEl)return;
  if(thisWeek.length<3||lastWeek.length<3){
    twEl.textContent='—';lwEl.textContent='—';dlEl.textContent='—';dlEl.style.color='var(--t3)';
    if(noteEl)noteEl.textContent='Log at least 3 readings in each of the past two weeks to compare.';
    return;
  }
  const twAvg=thisWeek.reduce((a,b)=>a+b,0)/thisWeek.length;
  const lwAvg=lastWeek.reduce((a,b)=>a+b,0)/lastWeek.length;
  const delta=twAvg-lwAvg;
  twEl.textContent=fmt(twAvg);
  lwEl.textContent=fmt(lwAvg);
  dlEl.textContent=(delta>=0?'+':'')+fmt(delta);
  const improved=delta<-0.2;
  const worsened=delta>0.2;
  dlEl.style.color=improved?'var(--ok)':worsened?'var(--hi)':'var(--t2)';
  if(noteEl){
    if(improved) noteEl.textContent=`Average improved by ${fmt(Math.abs(delta))} mmol/L vs last week. Keep it up!`;
    else if(worsened) noteEl.textContent=`Average rose by ${fmt(delta)} mmol/L vs last week. Review meals, activity and insulin with your care team.`;
    else noteEl.textContent=`Consistent with last week (±0.2 mmol/L). Good stability.`;
  }
}

function drawA1cChart(){
  const cv=document.getElementById('a1cChart');if(!cv)return;
  const par=cv.parentElement;
  let W=par.offsetWidth||par.getBoundingClientRect().width||300;
  const H=150,dpr=window.devicePixelRatio||1;
  cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';
  const ctx=cv.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  if(readings.length<3){ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='12px Plus Jakarta Sans';ctx.textAlign='center';ctx.fillText('Keep logging to build A1c trend',W/2,H/2);return;}
  const now=Date.now();const buckets=[];
  for(let i=5;i>=0;i--){
    const end=now-i*7*86400000,start=end-7*86400000;
    const bv=readings.filter(r=>r.ts>=start&&r.ts<end&&!r.isMealOnly&&r.value>0).map(r=>r.value);
    if(bv.length>=1){const avg=bv.reduce((a,b)=>a+b,0)/bv.length;buckets.push({a1c:parseFloat(calcA1c(avg)),label:i===0?'Now':'-'+i+'w'});}
  }
  if(!buckets.length){ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='12px Plus Jakarta Sans';ctx.textAlign='center';ctx.fillText('Keep logging',W/2,H/2);return;}
  const pL=36,pR=10,pT=12,pB=22,cW=W-pL-pR,cH=H-pT-pB;
  const minA=4,maxA=12;
  const tx=(i)=>pL+(i/Math.max(buckets.length-1,1))*cW;
  const ty=(v)=>pT+(1-(v-minA)/(maxA-minA))*cH;
  ctx.fillStyle='rgba(56,161,105,0.07)';ctx.fillRect(pL,pT,cW,ty(7)-pT);
  ctx.setLineDash([3,4]);ctx.strokeStyle='rgba(56,161,105,0.3)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(pL,ty(7));ctx.lineTo(pL+cW,ty(7));ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle='rgba(56,161,105,.6)';ctx.font='8px JetBrains Mono';ctx.textAlign='left';ctx.fillText('<7%',pL+2,ty(7)-3);
  ctx.fillStyle=cssVar('--t3','#9AA3B5');ctx.font='9px JetBrains Mono';ctx.textAlign='right';
  [5,6,7,8,9].forEach(v=>{if(v>=minA&&v<=maxA)ctx.fillText(v+'%',pL-3,ty(v)+3);});
  if(buckets.length>=2){
    const gr=ctx.createLinearGradient(0,pT,0,H);
    gr.addColorStop(0,'rgba(217,119,6,.15)');gr.addColorStop(1,'rgba(217,119,6,0)');
    ctx.beginPath();ctx.moveTo(tx(0),cH+pT);
    buckets.forEach((b,i)=>ctx.lineTo(tx(i),ty(b.a1c)));
    ctx.lineTo(tx(buckets.length-1),cH+pT);ctx.closePath();ctx.fillStyle=gr;ctx.fill();
    ctx.beginPath();buckets.forEach((b,i)=>i===0?ctx.moveTo(tx(i),ty(b.a1c)):ctx.lineTo(tx(i),ty(b.a1c)));
    ctx.strokeStyle='#D97706';ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.stroke();
  }
  buckets.forEach((b,i)=>{
    ctx.beginPath();ctx.arc(tx(i),ty(b.a1c),5,0,Math.PI*2);
    ctx.fillStyle=b.a1c<7?'#38A169':b.a1c<8?'#D97706':'#E53E3E';ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--t2').trim()||'#6B7280';ctx.font='9px JetBrains Mono';ctx.textAlign='center';ctx.fillText(b.label,tx(i),H-3);
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#374151';ctx.font='bold 9px JetBrains Mono';ctx.fillText(b.a1c+'%',tx(i),ty(b.a1c)-8);
  });
}

// ══════════════ MEAL IMPACT ══════════════
function updateMealImpact(){
  const spikes = getPostprandialSpikes().filter(s=>s.ts>=Date.now()-14*86400000);
  const listEl = document.getElementById('mealImpactList');
  const worstEl = document.getElementById('worstFoodsList');
  const tagEl = document.getElementById('tagImpactList');

  if(!listEl) return;

  if(!spikes.length){
    listEl.innerHTML='<div class="empty"><div class="empty-ic">🍽️</div>Log meals with carbs and check BG 1–2h after to see spike analysis.</div>';
    worstEl.innerHTML='<div class="empty" style="padding:8px 0;">No meal impact data yet.</div>';
  } else {
    listEl.innerHTML = spikes.slice(0,15).map(s=>{
      const riseCol = s.rise>4?'var(--low)':s.rise>2?'var(--hi)':'var(--ok)';
      const riseLabel = s.rise>4?'High spike':s.rise>2?'Moderate spike':'Minimal impact';
      const preTxt = s.preBG!=null?fmt(s.preBG)+' → ':'';
      const minsAfter = Math.round((s.peakAt-s.ts)/60000);
      return `<div class="ei">
        <div class="ei-ic" style="background:${riseCol}18">🍽️</div>
        <div class="ei-main">
          <div class="ei-ctx">${s.mealName||'Meal'}</div>
          <div class="ei-sub">${fD(s.ts)} · ${fT(s.ts)} · ${s.carbs}g carbs${s.insulin?' · 💉'+s.insulin+'u':''}</div>
          <div class="ei-sub" style="color:${riseCol}">${riseLabel}: ${preTxt}peak ${fmt(s.peakBG)} at +${minsAfter}min</div>
        </div>
        <div class="ei-r">
          <div class="ei-val" style="color:${riseCol}">${s.rise>=0?'+':''}${fmt(s.rise)}</div>
          <div class="ei-u">mmol/L</div>
        </div>
      </div>`;
    }).join('');

    // Worst offenders — group by meal name
    const byMeal={};
    spikes.forEach(s=>{
      const key=(s.mealName||'Meal').split(',')[0].trim().substring(0,25);
      if(!byMeal[key])byMeal[key]=[];
      byMeal[key].push(s.rise);
    });
    const ranked=Object.entries(byMeal)
      .filter(([,v])=>v.length>=1)
      .map(([name,rises])=>({name,avg:rises.reduce((a,b)=>a+b,0)/rises.length,n:rises.length}))
      .sort((a,b)=>b.avg-a.avg)
      .slice(0,8);
    if(ranked.length){
      const maxRise=Math.max(...ranked.map(r=>r.avg),0.1);
      worstEl.innerHTML=ranked.map(r=>{
        const pct=Math.min(100,r.avg/maxRise*100);
        const col=r.avg>4?'var(--low)':r.avg>2?'var(--hi)':'var(--ok)';
        return `<div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
            <span style="font-size:12px;font-weight:600;">${r.name}${r.n>1?' ('+r.n+'x)':''}</span>
            <span style="font-size:12px;font-weight:800;color:${col};font-family:'JetBrains Mono',monospace;">${r.avg>=0?'+':''}${fmt(r.avg)}</span>
          </div>
          <div style="height:5px;background:var(--bg);border-radius:3px;"><div style="height:100%;width:${pct}%;background:${col};border-radius:3px;transition:width .5s;"></div></div>
        </div>`;
      }).join('');
    } else {
      worstEl.innerHTML='<div class="empty" style="padding:8px 0;">Log at least 1 meal with a post-meal BG check.</div>';
    }
  }

  // ── Wellbeing Tag Impact ──
  if(!tagEl) return;
  const tagged=readings.filter(r=>r.tags&&r.tags.length&&!r.isMealOnly&&r.value>0);
  const allBG=readings.filter(r=>!r.isMealOnly&&r.value>0);
  const globalAvg=allBG.length?allBG.reduce((s,r)=>s+r.value,0)/allBG.length:0;
  const tagMap={};
  tagged.forEach(r=>{r.tags.forEach(t=>{if(!tagMap[t])tagMap[t]=[];tagMap[t].push(r.value);});});
  const tagEntries=Object.entries(tagMap).filter(([,v])=>v.length>=3);
  if(!tagEntries.length){
    tagEl.innerHTML='<div class="empty" style="padding:8px 0;">Log at least 3 readings per wellbeing tag to see patterns.</div>';
    return;
  }
  tagEl.innerHTML=tagEntries.sort((a,b)=>b[1].reduce((s,v)=>s+v,0)/b[1].length-a[1].reduce((s,v)=>s+v,0)/a[1].length).map(([tag,vals])=>{
    const avg=vals.reduce((s,v)=>s+v,0)/vals.length;
    const diff=avg-globalAvg;
    const col=diff>1?'var(--low)':diff>0.3?'var(--hi)':diff<-0.3?'var(--ok)':'var(--t2)';
    const arrow=diff>0.3?'↑':diff<-0.3?'↓':'→';
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
      <div style="flex:1;font-size:12px;font-weight:600;">${tag}</div>
      <div style="font-size:11px;color:var(--t3);">${vals.length} readings</div>
      <div style="font-size:14px;font-weight:800;color:${col};font-family:'JetBrains Mono',monospace;">${arrow} ${fmt(avg)}</div>
    </div>`;
  }).join('');
}

// ══════════════ PDF REPORT ══════════════
// Generates a clinical-grade one-page summary PDF using canvas → data URL
// Suitable to share with endocrinologist. Includes:
// - 14-day AGP-style stats (TIR, GMI, CV%, eAG, avg, SD)
// - Low event count and severity
// - Insulin & carb totals
// - Medical disclaimer
// References: Danne T et al. Diabetes Care 2017 (AGP consensus)
//             Bergenstal RM et al. Diabetes Care 2018 (GMI)
async function generatePDFReport(){
  const now=Date.now();
  const d14=readings.filter(r=>r.ts>=now-14*86400000&&!r.isMealOnly&&r.value>0);
  if(d14.length<5){toastWarn('Log at least 5 readings in the past 14 days to generate a report.');return;}

  // ── Compute all stats ──
  const vals=d14.map(r=>r.value);
  const n=vals.length;
  const avg=vals.reduce((a,b)=>a+b,0)/n;
  const variance=vals.reduce((s,v)=>s+Math.pow(v-avg,2),0)/n;
  const sd=Math.sqrt(variance);
  const cv=sd/avg*100;
  const meanMgdl=avg*18.0182;
  const gmi=3.31+0.02392*meanMgdl;
  const estA1c=parseFloat(calcA1c(avg));
  const eagMgdl=28.7*estA1c-46.7;
  const eagMmol=eagMgdl/18.0182;
  const lo=cfg.low, hi=cfg.high;
  const lN=vals.filter(v=>v<lo).length;
  const oN=vals.filter(v=>v>=lo&&v<=hi).length;
  const hN=vals.filter(v=>v>hi&&v<=13.9).length;
  const vN=vals.filter(v=>v>13.9).length;
  const tirPct=Math.round(oN/n*100);
  const lowPct=Math.round(lN/n*100);
  const hiPct=Math.round(hN/n*100);
  const vhiPct=Math.round(vN/n*100);
  const insPct=readings.filter(r=>r.ts>=now-14*86400000&&r.insulin&&r.insulin>0);
  const totalIns=insPct.reduce((s,r)=>s+(r.insulin||0),0);
  const totalCarbs=readings.filter(r=>r.ts>=now-14*86400000&&r.carbs&&r.carbs>0).reduce((s,r)=>s+(r.carbs||0),0);
  const lows=d14.filter(r=>r.value<lo);
  const dateFrom=new Date(now-14*86400000).toLocaleDateString([],{month:'short',day:'numeric',year:'numeric'});
  const dateTo=new Date(now).toLocaleDateString([],{month:'short',day:'numeric',year:'numeric'});

  // ── Draw on canvas ──
  const W=794, H=1123; // A4 at 96dpi
  const cv2=document.createElement('canvas');
  cv2.width=W; cv2.height=H;
  const ctx=cv2.getContext('2d');

  // Background
  ctx.fillStyle='#fff';
  ctx.fillRect(0,0,W,H);

  // Header band
  ctx.fillStyle='#0D1321';
  ctx.fillRect(0,0,W,80);
  ctx.fillStyle='#1A56DB';
  ctx.fillRect(0,75,W,5);

  // App name
  ctx.fillStyle='#1A56DB';
  ctx.font='bold 26px Arial, sans-serif';
  ctx.fillText('GlucoTrack',36,48);
  ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.font='13px Arial, sans-serif';
  ctx.fillText('Personal Glucose Report',36,65);

  // Date range + generated
  ctx.fillStyle='rgba(255,255,255,0.7)';
  ctx.font='12px Arial, sans-serif';
  ctx.textAlign='right';
  ctx.fillText('Period: '+dateFrom+' – '+dateTo, W-36, 38);
  ctx.fillText('Generated: '+new Date().toLocaleString(), W-36, 56);
  ctx.fillText(n+' readings', W-36, 74);
  ctx.textAlign='left';

  // ── SECTION: Key Metrics ──
  let y=110;
  ctx.fillStyle='#0D1321';
  ctx.font='bold 16px Arial, sans-serif';
  ctx.fillText('14-Day Glucose Summary',36,y);
  ctx.fillStyle='#9AA3B5';
  ctx.fillRect(36,y+6,W-72,1);
  y+=24;

  function statBox(x,bY,label,value,unit,color){
    ctx.fillStyle='#F4F6F9';
    roundRectPDF(ctx,x,bY,160,72,8);
    ctx.fill();
    ctx.fillStyle=color||'#0D1321';
    ctx.font='bold 28px Arial, sans-serif';
    ctx.textAlign='center';
    ctx.fillText(value, x+80, bY+42);
    ctx.fillStyle='#677088';
    ctx.font='10px Arial, sans-serif';
    ctx.fillText(label.toUpperCase(), x+80, bY+16);
    ctx.fillText(unit, x+80, bY+58);
    ctx.textAlign='left';
  }

  function roundRectPDF(c,x,bY,w,h,r){
    c.beginPath();c.moveTo(x+r,bY);c.lineTo(x+w-r,bY);c.quadraticCurveTo(x+w,bY,x+w,bY+r);
    c.lineTo(x+w,bY+h-r);c.quadraticCurveTo(x+w,bY+h,x+w-r,bY+h);
    c.lineTo(x+r,bY+h);c.quadraticCurveTo(x,bY+h,x,bY+h-r);
    c.lineTo(x,bY+r);c.quadraticCurveTo(x,bY,x+r,bY);c.closePath();
  }

  const gmiCol=gmi<(cfg.a1cGoal||7)?'#38A169':gmi<(cfg.a1cGoal||7)+1?'#D97706':'#E53E3E';
  const cvCol=cv<36?'#38A169':cv<40?'#D97706':'#E53E3E';
  const tirCol=tirPct>=70?'#38A169':tirPct>=50?'#D97706':'#E53E3E';
  statBox(36,y,'GMI',gmi.toFixed(1)+'%','Est. HbA1c equiv.',gmiCol);
  statBox(208,y,'CV%',cv.toFixed(0)+'%','Target <36%',cvCol);
  statBox(380,y,'eAG',fmt(eagMmol),'mmol/L','#0D1321');
  statBox(552,y,'Avg BG',fmt(avg),'mmol/L','#0D1321');
  statBox(36,y+84,'Time In Range',tirPct+'%','Target ≥70%',tirCol);
  statBox(208,y+84,'Low Events',lN,'<'+fmt(lo)+' mmol/L','#E53E3E');
  statBox(380,y+84,'Std Dev',fmt(sd),'mmol/L','#0D1321');
  statBox(552,y+84,'Readings',n,'14 days','#0D1321');
  y+=84+84+20;

  // ── TIR Bar ──
  ctx.fillStyle='#0D1321';
  ctx.font='bold 14px Arial, sans-serif';
  ctx.fillText('Time In Range Breakdown',36,y);
  ctx.fillStyle='#9AA3B5';
  ctx.fillRect(36,y+6,W-72,1);
  y+=20;

  const barW=W-72;
  const segments=[
    {pct:lowPct/100,col:'#E53E3E',lbl:'Low <'+fmt(lo)},
    {pct:tirPct/100,col:'#38A169',lbl:'Target'},
    {pct:hiPct/100,col:'#D97706',lbl:'High'},
    {pct:vhiPct/100,col:'#E53E3E88',lbl:'V.High'},
  ];
  let bx=36;
  segments.forEach(s=>{
    const sw=s.pct*barW;
    if(sw<1)return;
    ctx.fillStyle=s.col;
    ctx.fillRect(bx,y,sw,24);
    if(sw>40){
      ctx.fillStyle='#fff';
      ctx.font='bold 10px Arial, sans-serif';
      ctx.textAlign='center';
      ctx.fillText(Math.round(s.pct*100)+'%',bx+sw/2,y+15);
      ctx.textAlign='left';
    }
    bx+=sw;
  });

  // Legend
  y+=32;
  const legItems=[
    {col:'#E53E3E',lbl:`Low: ${lowPct}%`},
    {col:'#38A169',lbl:`In Range: ${tirPct}%`},
    {col:'#D97706',lbl:`High: ${hiPct}%`},
    {col:'#FF000044',lbl:`V.High: ${vhiPct}%`},
  ];
  let lx=36;
  legItems.forEach(li=>{
    ctx.fillStyle=li.col;
    ctx.fillRect(lx,y,12,12);
    ctx.fillStyle='#677088';
    ctx.font='11px Arial, sans-serif';
    ctx.fillText(li.lbl,lx+16,y+10);
    lx+=120;
  });
  y+=28;

  // ── AGP-STYLE MINI CHART ──
  ctx.fillStyle='#0D1321';
  ctx.font='bold 14px Arial, sans-serif';
  ctx.fillText('14-Day Glucose Profile',36,y+10);
  ctx.fillStyle='#9AA3B5';
  ctx.fillRect(36,y+16,W-72,1);
  y+=30;
  const chartH=130, chartW=W-72;
  const pL=30,pR=10,pT=8,pB=24;
  const cW2=chartW-pL-pR, cH2=chartH-pT-pB;
  const minV=Math.max(0,Math.min(...vals,lo)-1), maxV=Math.max(...vals,hi)+1.5;
  const tx2=(ts)=>36+pL+(ts-d14[0].ts)/(d14[d14.length-1].ts-d14[0].ts)*cW2;
  const ty2=(v)=>y+pT+(1-(v-minV)/(maxV-minV))*cH2;

  // Background
  ctx.fillStyle='#F8F9FA';
  ctx.fillRect(36+pL,y+pT,cW2,cH2);
  // Target band
  ctx.fillStyle='rgba(56,161,105,0.1)';
  ctx.fillRect(36+pL,ty2(hi),cW2,ty2(lo)-ty2(hi));
  // Target lines
  ctx.setLineDash([4,4]);ctx.strokeStyle='rgba(56,161,105,0.5)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(36+pL,ty2(hi));ctx.lineTo(36+pL+cW2,ty2(hi));ctx.stroke();
  ctx.strokeStyle='rgba(229,62,62,0.4)';
  ctx.beginPath();ctx.moveTo(36+pL,ty2(lo));ctx.lineTo(36+pL+cW2,ty2(lo));ctx.stroke();
  ctx.setLineDash([]);
  // Line
  if(d14.length>=2){
    ctx.beginPath();
    const sorted=[...d14].sort((a,b)=>a.ts-b.ts);
    sorted.forEach((r,i)=>i===0?ctx.moveTo(tx2(r.ts),ty2(r.value)):ctx.lineTo(tx2(r.ts),ty2(r.value)));
    ctx.strokeStyle='#1A56DB';ctx.lineWidth=1.5;ctx.stroke();
    // Dots
    sorted.forEach(r=>{
      const s=getSt(r.value);
      const dc={ok:'#38A169',low:'#E53E3E',hi:'#D97706',vhi:'#E53E3E'};
      ctx.beginPath();ctx.arc(tx2(r.ts),ty2(r.value),2.5,0,Math.PI*2);
      ctx.fillStyle=dc[s.cls];ctx.fill();
    });
  }
  // Y labels
  ctx.fillStyle='#677088';ctx.font='9px Arial, sans-serif';ctx.textAlign='right';
  [Math.ceil(minV),lo,hi,Math.floor(maxV)].forEach(v=>{
    if(v>=minV&&v<=maxV)ctx.fillText(v.toFixed(1),36+pL-3,ty2(v)+3);
  });
  ctx.textAlign='left';
  y+=chartH+16;

  // ── TOTALS ──
  ctx.fillStyle='#0D1321';
  ctx.font='bold 14px Arial, sans-serif';
  ctx.fillText('Treatment Summary (14 days)',36,y);
  ctx.fillStyle='#9AA3B5';
  ctx.fillRect(36,y+6,W-72,1);
  y+=22;
  ctx.font='12px Arial, sans-serif';
  ctx.fillStyle='#5A6478';
  ctx.fillText(`Total insulin logged: ${totalIns.toFixed(1)} units (bolus)`, 36, y); y+=18;
  ctx.fillText(`Total carbohydrates logged: ${totalCarbs}g`, 36, y); y+=18;
  ctx.fillText(`Low glucose events (<${fmt(lo)} mmol/L): ${lN} in 14 days${lN>0?' — lowest: '+fmt(Math.min(...lows.map(r=>r.value)))+' mmol/L':''}`, 36, y); y+=18;
  ctx.fillText(`Target range configured: ${fmt(lo)}–${fmt(hi)} mmol/L`, 36, y); y+=18;
  ctx.fillText(`Personal HbA1c goal: ${cfg.a1cGoal||7.0}%`, 36, y); y+=28;

  // ── DISCLAIMER ──
  ctx.fillStyle='#F4F6F9';
  roundRectPDF(ctx,36,y,W-72,120,8);
  ctx.fill();
  ctx.fillStyle='#E53E3E';
  ctx.font='bold 11px Arial, sans-serif';
  ctx.fillText('⚠️  IMPORTANT MEDICAL DISCLAIMER',48,y+20);
  ctx.fillStyle='#5A6478';
  ctx.font='10px Arial, sans-serif';
  const disc=[
    'GlucoTrack is a personal glucose logging tool, NOT a registered medical device (SaMD).',
    'GMI, eAG, estimated HbA1c, and CV% are estimates derived from SMBG/CGM data — they are not equivalent to laboratory results.',
    'GMI formula: Bergenstal et al., Diabetes Care 2018;41(11):2275–2280. eAG: Nathan et al., ADA 2008.',
    'Insulin suggestions are calculated using the Walsh Bolus method and must be verified with your diabetes care team before use.',
    'Do not adjust insulin doses or treatment plan based on this report without consulting your endocrinologist.',
    'Always obtain a laboratory HbA1c measurement from your healthcare provider for clinical decision-making.',
  ];
  disc.forEach((line,i)=>{ctx.fillText(line,48,y+36+i*14);});
  y+=130;

  // ── Footer ──
  ctx.fillStyle='#9AA3B5';
  ctx.fillRect(36,H-50,W-72,1);
  ctx.font='10px Arial, sans-serif';
  ctx.fillText('GlucoTrack v4 · Data stored locally · Not a medical device · Generated '+new Date().toLocaleString(),36,H-30);

  // ── Download ──
  const dataUrl=cv2.toDataURL('image/png',1.0);
  const a=document.createElement('a');
  a.href=dataUrl;
  const fname='GlucoTrack_Report_'+new Date().toISOString().split('T')[0]+'.png';
  a.download=fname;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  toastSuccess('Report downloaded as '+fname);
}

// ══════════════ POSTPRANDIAL SPIKE ANALYSIS ══════════════
// For each meal log, find the highest BG reading within 30–120 min after
// and compute the rise (peak − pre-meal BG).
// Clinical reference: ADA recommends post-meal BG <10.0 mmol/L (1-2h post)
// Significant spike defined as rise >2.0 mmol/L (clinical consensus)
function getPostprandialSpikes(){
  const meals=readings.filter(r=>r.isMealOnly||(r.context==='Meal')||(r.context==='After Meal'));
  const bgReadings=readings.filter(r=>!r.isMealOnly&&r.value>0).sort((a,b)=>a.ts-b.ts);
  const spikes=[];

  // For each meal entry, find:
  // 1. Pre-meal BG: closest BG reading within 30 min BEFORE meal
  // 2. Peak BG: highest BG reading between 30–120 min AFTER meal
  readings.filter(r=>r.isMealOnly&&r.carbs>0).forEach(meal=>{
    const preBG=bgReadings.filter(r=>r.ts>=meal.ts-30*60000&&r.ts<=meal.ts)
      .sort((a,b)=>b.ts-a.ts)[0];
    const postReadings=bgReadings.filter(r=>r.ts>meal.ts+20*60000&&r.ts<=meal.ts+2*3600000);
    if(!postReadings.length)return;
    const peakReading=postReadings.reduce((a,b)=>b.value>a.value?b:a);
    const baseline=preBG?preBG.value:cfg.low+1; // fallback if no pre-meal BG
    const rise=peakReading.value-baseline;
    spikes.push({
      ts:meal.ts,
      mealName:meal.notes||'Meal',
      carbs:meal.carbs,
      preBG:preBG?preBG.value:null,
      peakBG:peakReading.value,
      peakAt:peakReading.ts,
      rise:rise,
      insulin:meal.insulin||0,
    });
  });
  return spikes.sort((a,b)=>b.ts-a.ts);
}

// ══════════════ HISTORY ══════════════
function updateHistory(){
  document.getElementById('histCnt').textContent=readings.length+' readings';
  const el=document.getElementById('histList');
  if(!readings.length){el.innerHTML='<div class="empty" style="margin:28px 0;"><div class="empty-ic">📋</div>No readings logged yet.</div>';return;}
  const grp={};
  [...readings].map((r,i)=>({...r,_idx:i})).reverse().forEach(r=>{const k=fD(r.ts);if(!grp[k])grp[k]=[];grp[k].push(r);});
  el.innerHTML=Object.entries(grp).map(([date,rds])=>`
    <div class="dglabel">${date}</div>
    <div class="card" style="margin-bottom:0;border-radius:10px;padding:12px 14px;">
      ${rds.map(r=>{
        const s=r.basalOnly?{cls:'ok',bc:'bok',txt:'BASAL',col:'#7C3AED'}:r.value&&r.value>0?getSt(r.value):{cls:'ok',bc:'bok',txt:'MEAL',col:'var(--acc)'};
        const ic=CTX_IC[r.context]||'🩺',cl=CTX_CL[r.context]||'#6B7280';
        const sub=[fT(r.ts),r.insulin?'💉 '+r.insulin+'u bolus':'',r.basal?'🌙 '+r.basal+'u basal':'',r.carbs?'🍞 '+r.carbs+'g':''].filter(Boolean).join(' · ');
        const tagLine=r.tags&&r.tags.length?r.tags.join(' '):''; 
        const valDisplay=r.basalOnly?r.basal+'u':r.isMealOnly?'🍽️':r.value!=null&&r.value>0?fmt(r.value):'—';
        const unitDisplay=r.basalOnly?'basal':r.isMealOnly?'meal':'mmol/L';
        const editFn=r.isMealOnly?`editMeal(${r._idx})`:`editReading(${r._idx})`;
        return`<div class="ei"><div class="ei-ic" style="background:${cl}18">${ic}</div><div class="ei-main"><div class="ei-ctx">${r.context||'Reading'}</div><div class="ei-sub">${sub}</div>${r.notes?`<div class="ei-sub" style="color:var(--t2)">${r.notes}</div>`:''} ${tagLine?`<div class="ei-sub" style="color:var(--pur);font-size:12px">${tagLine}</div>`:''}</div><div class="ei-r"><div class="ei-val" style="color:${s.col};font-size:${r.isMealOnly?'16px':'18px'}">${valDisplay}</div><div class="ei-u">${unitDisplay}</div></div><div class="ei-actions"><button class="ei-act edit" onclick="${editFn}" title="Edit">✏️</button><button class="ei-act del" onclick="deleteEntry(${r._idx})" title="Delete">🗑️</button></div></div>`;
      }).join('')}
    </div>
  `).join('');
}


// ══════════════ EDIT / DELETE ENTRIES ══════════════
let editingIdx = -1; // index in readings[] being edited

function deleteEntry(idx){
  const entry=readings[idx];
  if(!entry)return;

  // Build a descriptive confirmation message
  const timeStr=fT(entry.ts)+' '+fD(entry.ts);
  let entryDesc='';
  if(entry.basalOnly) entryDesc=`basal insulin entry (${entry.basal}u) at ${timeStr}`;
  else if(entry.isMealOnly) entryDesc=`meal entry "${entry.notes||'Meal'}" at ${timeStr}`;
  else entryDesc=`reading of ${fmt(entry.value)} mmol/L at ${timeStr}`;

  const hasPreTimer=preMealTimer && entry.insulin && entry.insulin>0 && (entry.context==='Before Meal'||entry.context==='Random Check');
  const hasPostTimer=postMealTimer && (entry.context==='After Meal'||entry.isMealOnly);

  const timerWarnings=[];
  if(hasPreTimer) timerWarnings.push('⏱️ The pre-meal timer will be cancelled.');
  if(hasPostTimer) timerWarnings.push('⏱️ The post-meal BG check timer will be cancelled.');

  const msg=`Delete ${entryDesc}?${timerWarnings.length?' '+timerWarnings.join(' '):''}`;

  appConfirm(msg,()=>{
    if(hasPreTimer) cancelPreMealTimer();
    if(hasPostTimer) cancelPostMealTimer();
    readings.splice(idx,1);
    saveReadings();
    refreshAll();
    toastSuccess('Entry deleted.');
  });
}

function editReading(idx){
  const r=readings[idx];
  if(!r)return;
  editingIdx=idx;
  // Open log modal pre-filled
  document.getElementById('mbd').classList.add('open');
  document.getElementById('glIn').value=r.value!=null?r.value:'';
  document.getElementById('mIns').value=r.insulin!=null?r.insulin:'';
  document.getElementById('mBasal').value=r.basal!=null?r.basal:'';
  document.getElementById('mNotes').value=r.notes||'';
  document.getElementById('carbIn').value=r.carbs!=null?r.carbs:'';
  // Update suggested insulin display
  calcInsulinFromCarbs();
  onGlIn();
  // Set context chip
  document.querySelectorAll('.cc').forEach(c=>c.classList.remove('selected'));
  const chip=document.querySelector(`.cc[data-ctx="${r.context}"]`);
  if(chip)chip.classList.add('selected');
  selCtx=r.context||'Before Meal';
  // Change modal title and button
  document.querySelector('#logSheet .mtitle').textContent='Edit Reading';
  document.querySelector('#logSheet .svbtn').textContent='Update Reading';
  // Show the date/time edit row and pre-fill with original timestamp
  const etr=document.getElementById('editTimeRow');
  if(etr){
    etr.style.display='block';
    const d=new Date(r.ts);
    document.getElementById('editDate').value=d.toLocaleDateString('en-CA'); // YYYY-MM-DD
    document.getElementById('editTime').value=d.toTimeString().slice(0,5);   // HH:MM
  }
}

function editMeal(idx){
  const r=readings[idx];
  if(!r)return;
  editingIdx=idx;
  openMealModal();
  // Pre-fill manual tab with meal data
  // Parse notes back to items — notes is stored as "Item1 (45g), Item2 (20g)" format
  const notesStr=r.notes||'';
  const container=document.getElementById('mealItemsContainer');
  // Clear and rebuild items from saved notes
  const parts=notesStr.split(',').map(s=>s.trim()).filter(Boolean);
  let html='';
  if(parts.length>0){
    parts.forEach(part=>{
      const m=part.match(/^(.*?)\s*\((\d+(?:\.\d+)?)g\)$/);
      const name=m?m[1].trim():part;
      const carbs=m?m[2]:'';
      html+=`<div class="meal-item-row">
        <div class="food-wrap">
          <input type="text" class="meal-item-name" placeholder="Food item" oninput="onFoodInput(this)" onblur="hideSuggestions(this,300)" autocomplete="off" value="${escH(name)}">
          <div class="food-suggestions"></div>
        </div>
        <input type="number" class="meal-item-carbs" placeholder="g" min="0" oninput="recalcMealTotals()" value="${carbs}">
        <button class="meal-del" onclick="removeMealItem(this)">✕</button>
      </div>`;
    });
  } else {
    html=`<div class="meal-item-row">
      <div class="food-wrap">
        <input type="text" class="meal-item-name" placeholder="Food item" oninput="onFoodInput(this)" onblur="hideSuggestions(this,300)" autocomplete="off">
        <div class="food-suggestions"></div>
      </div>
      <input type="number" class="meal-item-carbs" placeholder="g" min="0" oninput="recalcMealTotals()" value="${r.carbs||''}">
      <button class="meal-del" onclick="removeMealItem(this)">✕</button>
    </div>`;
  }
  container.innerHTML=html;
  document.getElementById('mealIns').value=r.insulin!=null?r.insulin:'';
  document.getElementById('mealNotes').value='';
  recalcMealTotals();
  // Update modal title and button
  document.querySelector('#mealSheet .mtitle').textContent='Edit Meal';
  document.querySelector('#mealSheet .svbtn').textContent='Update Meal';
  // Show the date/time edit row and pre-fill with original timestamp
  const metr=document.getElementById('mealEditTimeRow');
  if(metr){
    metr.style.display='block';
    const d=new Date(r.ts);
    document.getElementById('mealEditDate').value=d.toLocaleDateString('en-CA');
    document.getElementById('mealEditTime').value=d.toTimeString().slice(0,5);
  }
}

// ══════════════ LOG MODAL ══════════════
function openLogModal(){
  document.getElementById('mbd').classList.add('open');
  // Hide time edit row for new readings
  const etr=document.getElementById('editTimeRow');
  if(etr)etr.style.display='none';
  document.getElementById('glIn').value='';
  document.getElementById('mIns').value='';
  // Auto-fill basal with configured dose; update label with insulin name
  const bDose=cfg.basalDose||0;
  document.getElementById('mBasal').value=bDose>0?bDose:'';
  document.getElementById('mBasalName').textContent=cfg.basalName||'long-acting';
  // Show hint if already logged today
  const todayStart=new Date();todayStart.setHours(0,0,0,0);
  const loggedToday=readings.some(r=>r.basalOnly&&r.ts>=todayStart.getTime());
  const hint=document.getElementById('mBasalHint');
  if(hint){
    hint.textContent=loggedToday?'✅ Already logged today':'';
    hint.style.color='var(--ok)';
  }
  document.getElementById('mNotes').value='';
  document.getElementById('carbIn').value='';
  document.getElementById('suggestedIns').textContent='0.0';
  document.getElementById('cibNote').textContent='Enter carbs to get insulin suggestion';
  document.getElementById('rfb').textContent='';
  document.getElementById('rfb').style.color='';
  resetTags();
  document.querySelectorAll('.cc').forEach(c=>c.classList.remove('selected'));
  document.querySelector('.cc[data-ctx="Before Meal"]').classList.add('selected');
  selCtx='Before Meal';
  setTimeout(()=>document.getElementById('glIn').focus(),350);
}
function closeLogModal(){
  document.getElementById('mbd').classList.remove('open');
  const etr=document.getElementById('editTimeRow');if(etr)etr.style.display='none';
  if(editingIdx>=0){
    editingIdx=-1;
    document.querySelector('#logSheet .mtitle').textContent='Log Reading';
    document.querySelector('#logSheet .svbtn').textContent='Save Reading';
  }
}
function handleBd(e){if(e.target===document.getElementById('mbd'))closeLogModal();}
function toggleTag(btn){
  const tag=btn.dataset.tag;
  if(btn.classList.toggle('active')){
    if(!selectedTags.includes(tag))selectedTags.push(tag);
  } else {
    selectedTags=selectedTags.filter(t=>t!==tag);
  }
}

function resetTags(){
  selectedTags=[];
  document.querySelectorAll('.tag-pill').forEach(b=>b.classList.remove('active'));
}

function pickCtx(el){document.querySelectorAll('.cc').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');selCtx=el.dataset.ctx;}

function onGlIn(){
  const v=parseFloat(document.getElementById('glIn').value);
  const fb=document.getElementById('rfb');
  if(isNaN(v)||!v){fb.textContent='';return;}
  if(v<1.0||v>33.3){fb.textContent='⚠️ Value must be between 1.0 and 33.3 mmol/L';fb.style.color='var(--low)';return;}
  const s=getSt(v);
  const msgs={ok:'✅ In target range',low:'🚨 Low — take fast-acting carbs now',hi:'⚠️ Above target — consider correction',vhi:'🚨 Very High — consider correction bolus'};
  fb.textContent=msgs[s.cls]||'';fb.style.color=s.col;
  // Update correction suggestion if carbs already entered
  calcInsulinFromCarbs();
}

function calcInsulinFromCarbs(){
  // ── Walsh Bolus Calculator (medical standard) ──────────────────────
  // Total Bolus = Meal Dose + Correction Dose - IOB
  // Meal Dose   = Carbs ÷ ICR  (ICR = insulin-to-carb ratio, g per unit)
  // Correction  = (Current BG - Target BG) ÷ ISF  (ISF = correction factor)
  // Target BG   = midpoint of user's target range
  // IOB not tracked here, so user is reminded to account for it
  const carbs=parseFloat(document.getElementById('carbIn').value)||0;
  const curBG=parseFloat(document.getElementById('glIn').value)||0;
  let ins=0; let note='';
  const targetBG=(cfg.low+cfg.high)/2; // personalised target midpoint

  if(carbs>0 || curBG>cfg.high){
    const mealDose = carbs>0 ? carbs/cfg.carbRatio : 0;
    const corrDose = curBG>targetBG ? Math.max(0,(curBG-targetBG)/cfg.corrFactor) : 0;
    const raw = mealDose + corrDose;
    ins = Math.round(raw*2)/2; // round to nearest 0.5u (standard clinical rounding)

    const parts=[];
    if(mealDose>0) parts.push(`${carbs}g ÷ ${cfg.carbRatio}g/u = ${mealDose.toFixed(2)}u meal`);
    if(corrDose>0) parts.push(`(${fmt(curBG)}−${fmt(targetBG)}) ÷ ${cfg.corrFactor} = ${corrDose.toFixed(2)}u correction`);
    note = parts.join(' + ') + (ins!==raw?` → rounded to ${ins}u`:'');
    if(ins>0) note += ' · ⚠️ Subtract any IOB';
    document.getElementById('mIns').value=ins>0?ins:'';
  } else {
    note='Enter carbs or a high BG to get a dose suggestion';
    document.getElementById('mIns').value='';
  }
  document.getElementById('suggestedIns').textContent=ins>0?ins.toFixed(1):'0.0';
  document.getElementById('cibNote').textContent=note;
}

function validateGlucoseInput(val){
  if(isNaN(val)||val==='')return{ok:false,msg:'Please enter your blood glucose reading.'};
  if(val<1.0)return{ok:false,msg:'Reading too low. Minimum valid value is 1.0 mmol/L.'};
  if(val>33.3)return{ok:false,msg:'Reading too high. Maximum valid value is 33.3 mmol/L. Please re-check your meter.'};
  return{ok:true};
}

function saveReading(){
  const raw=document.getElementById('glIn').value;
  const v=parseFloat(raw);
  const vr=validateGlucoseInput(v);
  if(!vr.ok){
    toastError(vr.msg);
    document.getElementById('rfb').textContent='⚠️ '+vr.msg;
    document.getElementById('rfb').style.color='var(--low)';
    return;
  }
  const carbs=parseInt(document.getElementById('carbIn').value)||null;
  const ins=parseFloat(document.getElementById('mIns').value)||null;
  if(ins!==null&&(isNaN(ins)||ins<0||ins>100)){toastError('Insulin dose must be between 0 and 100 units.');return;}
  if(carbs!==null&&(carbs<0||carbs>500)){toastError('Carbs must be between 0 and 500g.');return;}
  const basalVal=parseFloat(document.getElementById('mBasal').value)||null;
  if(basalVal!==null&&(isNaN(basalVal)||basalVal<0||basalVal>200)){toastError('Basal dose must be between 0 and 200 units.');return;}
  // Use edited date/time if the time row is visible (editing mode), otherwise now
  let entryTs=Date.now();
  if(editingIdx>=0){
    const etr=document.getElementById('editTimeRow');
    const dateVal=document.getElementById('editDate').value;
    const timeVal=document.getElementById('editTime').value;
    if(etr&&etr.style.display!=='none'&&dateVal&&timeVal){
      const parsed=new Date(`${dateVal}T${timeVal}`);
      if(!isNaN(parsed.getTime()))entryTs=parsed.getTime();
      else entryTs=readings[editingIdx].ts;
    } else {
      entryTs=readings[editingIdx].ts;
    }
  }
  const entry={ts:entryTs,value:Math.round(v*10)/10,context:selCtx,insulin:ins,basal:basalVal,carbs:carbs,notes:document.getElementById('mNotes').value.trim()};
  if(editingIdx>=0){
    readings[editingIdx]=entry;
    editingIdx=-1;
    document.querySelector('#logSheet .mtitle').textContent='Log Reading';
    document.querySelector('#logSheet .svbtn').textContent='Save Reading';
    toastSuccess('Reading updated!');
  } else {
    if(selectedTags.length) entry.tags=selectedTags.slice();
  readings.push(entry);
    // Show trend summary toast
    const bgArr = readings.filter(r => !r.isMealOnly && r.value > 0);
    const ti = getTrendInfo(bgArr);
    const trendMsg = ti.rate !== 0
      ? `Reading saved · ${ti.label} (${ti.rate > 0 ? '+' : ''}${ti.rate.toFixed(1)} mmol/h)`
      : 'Reading saved';
    toastSuccess(trendMsg);
  }
  saveReadings();
  closeLogModal();
  refreshAll();
  setTimeout(animateTrendArrow, 200);
  // Trigger alarm check on every new reading (not edits)
  if(editingIdx<0) setTimeout(()=>checkAlarms(Math.round(v*10)/10), 400);
  // Timer logic — only ONE timer at a time:
  // Pre-meal (20 min wait): when bolus insulin logged BEFORE eating
  // Post-meal (2 hr BG check): when logging AFTER meal, or auto-chains from pre-meal timer
  if(editingIdx<0){
    if(ins && ins>0 && (selCtx==='Before Meal'||selCtx==='Random Check')){
      // Pre-meal timer only — post-meal will auto-chain when pre-meal completes
      startPreMealTimer(ins, /*chainPostMeal=*/true);
    } else if(selCtx==='After Meal'){
      // Post-meal only — user has already eaten
      if(preMealTimer){
        // Pre-meal was running — cancel it, the meal has started
        cancelPreMealTimer(/*silent=*/true);
      }
      startPostMealTimer(0); // No offset from Log Reading — starts from now
    }
  }
}

// ══════════════ MEAL LOG MODAL ══════════════
function setFirstBite(min, btn){
  firstBiteOffsetMin=min;
  document.querySelectorAll('.first-bite-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  // Show when BG check will fire
  const fireAt=new Date(Date.now()+(2*60-min)*60000);
  const timeStr=fireAt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const hint=document.getElementById('firstBiteFireAt');
  if(hint) hint.textContent=timeStr;
}

function openMealModal(){
  document.getElementById('mealMbd').classList.add('open');
  switchMealTab('manual');
  resetManualMeal();
  mealCamImageData=null;
  // Reset first bite picker
  firstBiteOffsetMin=0;
  document.querySelectorAll('.first-bite-btn').forEach(b=>b.classList.remove('active'));
  const firstJustNow=document.querySelector('.first-bite-btn[data-min="0"]');
  if(firstJustNow) firstJustNow.classList.add('active');
  // Set default fire time label
  const hint=document.getElementById('firstBiteFireAt');
  if(hint){const t=new Date(Date.now()+2*3600000);hint.textContent=t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
  // Reset camera tab
  const img=document.getElementById('camPreviewImg');
  img.style.display='none';img.src='';
  document.getElementById('camAreaPlaceholder').style.display='block';
  document.getElementById('camResultBox').style.display='none';
  document.getElementById('analyzeBtn').disabled=true;
  document.getElementById('analyzeBtn').textContent='🔍 Analyse Meal with AI';
  document.getElementById('aiCarbs').textContent='0';
  document.getElementById('aiInsRec').textContent='';
  document.getElementById('aiMealIns').value='';
}
function closeMealModal(){
  document.getElementById('mealMbd').classList.remove('open');
  const metr=document.getElementById('mealEditTimeRow');if(metr)metr.style.display='none';
  if(editingIdx>=0){
    editingIdx=-1;
    document.querySelector('#mealSheet .mtitle').textContent='Log Meal';
    document.querySelector('#mealSheet .svbtn').textContent='Log Meal';
  }
}
function handleMealBd(e){if(e.target===document.getElementById('mealMbd'))closeMealModal();}

function switchMealTab(t){
  mealTab=t;
  document.getElementById('mt-manual').classList.toggle('active',t==='manual');
  document.getElementById('mt-camera').classList.toggle('active',t==='camera');
  document.getElementById('mc-manual').classList.toggle('hidden',t!=='manual');
  document.getElementById('mc-camera').classList.toggle('hidden',t!=='camera');
}

function resetManualMeal(){
  const c=document.getElementById('mealItemsContainer');
  c.innerHTML=`<div class="meal-item-row">
    <div class="food-wrap">
      <input type="text" class="meal-item-name" placeholder="Food item (e.g. Rice, Brown bread)" oninput="onFoodInput(this)" onblur="hideSuggestions(this,300)" autocomplete="off">
      <div class="food-suggestions"></div>
    </div>
    <input type="number" class="meal-item-carbs" placeholder="g" min="0" oninput="recalcMealTotals()">
    <button class="meal-del" onclick="removeMealItem(this)">✕</button>
  </div>`;
  document.getElementById('mealTotalCarbs').textContent='0';
  document.getElementById('mealInsRec').textContent='Enter carbs above to see insulin suggestion';
  document.getElementById('mealIns').value='';
  document.getElementById('mealNotes').value='';
}

function addMealItem(){
  const row=document.createElement('div');row.className='meal-item-row';
  row.innerHTML=`<div class="food-wrap">
    <input type="text" class="meal-item-name" placeholder="Food item" oninput="onFoodInput(this)" onblur="hideSuggestions(this,300)" autocomplete="off">
    <div class="food-suggestions"></div>
  </div>
  <input type="number" class="meal-item-carbs" placeholder="g" min="0" oninput="recalcMealTotals()">
  <button class="meal-del" onclick="removeMealItem(this)">✕</button>`;
  document.getElementById('mealItemsContainer').appendChild(row);
}

function removeMealItem(btn){
  const rows=document.querySelectorAll('#mealItemsContainer .meal-item-row');
  if(rows.length<=1){toastWarn('At least one food item required.');return;}
  btn.closest('.meal-item-row').remove();
  recalcMealTotals();
}


// ══════════════ FOOD AUTOCOMPLETE ══════════════
const foodDebounceTimers = new WeakMap();

function onFoodInput(input) {
  const query = input.value.trim();
  const wrap = input.closest('.food-wrap');
  const dropdown = wrap.querySelector('.food-suggestions');

  // Clear previous timer
  if (foodDebounceTimers.has(input)) clearTimeout(foodDebounceTimers.get(input));

  if (query.length < 2) { dropdown.classList.remove('open'); return; }

  // Show loading
  dropdown.innerHTML = '<div class="food-sugg-loading">🔍 Looking up carbs…</div>';
  dropdown.classList.add('open');

  // Debounce 500ms
  const timer = setTimeout(() => fetchFoodSuggestions(query, input, dropdown), 500);
  foodDebounceTimers.set(input, timer);
}

// ── Built-in food database (works offline, no API key needed) ──
const FOOD_DB = [
  // Grains & Staples
  {n:'White rice, cooked',c:43,g:186,cat:'🍚'},{n:'Brown rice, cooked',c:46,g:195,cat:'🍚'},
  {n:'Basmati rice, cooked',c:38,g:180,cat:'🍚'},{n:'Pap / Maize meal, cooked',c:48,g:200,cat:'🫓'},
  {n:'Samp, cooked',c:52,g:200,cat:'🫓'},{n:'Mielie bread (1 slice)',c:22,g:40,cat:'🍞'},
  {n:'White bread (1 slice)',c:15,g:30,cat:'🍞'},{n:'Brown bread (1 slice)',c:13,g:30,cat:'🍞'},
  {n:'Whole wheat bread (1 slice)',c:12,g:30,cat:'🍞'},{n:'Rye bread (1 slice)',c:15,g:32,cat:'🍞'},
  {n:'Pasta, cooked (1 cup)',c:43,g:140,cat:'🍝'},{n:'Spaghetti, cooked (1 cup)',c:43,g:140,cat:'🍝'},
  {n:'Couscous, cooked (1 cup)',c:36,g:157,cat:'🫓'},{n:'Oats, cooked (1 cup)',c:27,g:234,cat:'🥣'},
  {n:'Cornflakes (1 cup)',c:24,g:28,cat:'🥣'},{n:'Weetbix (2 biscuits)',c:26,g:37,cat:'🥣'},
  {n:'Pronutro (3/4 cup)',c:30,g:50,cat:'🥣'},{n:'Maltabella (1 cup cooked)',c:32,g:200,cat:'🥣'},
  // Potatoes & Starchy Veg
  {n:'Potato, boiled (medium)',c:37,g:150,cat:'🥔'},{n:'Potato, baked (medium)',c:37,g:150,cat:'🥔'},
  {n:'Sweet potato, cooked (medium)',c:27,g:130,cat:'🍠'},{n:'Chips / French fries (medium)',c:48,g:150,cat:'🍟'},
  {n:'Butternut, cooked (1 cup)',c:22,g:205,cat:'🎃'},{n:'Gem squash, cooked (1)',c:8,g:200,cat:'🥦'},
  // Legumes
  {n:'Lentils, cooked (1 cup)',c:40,g:198,cat:'🫘'},{n:'Chickpeas, cooked (1 cup)',c:45,g:164,cat:'🫘'},
  {n:'Kidney beans, cooked (1 cup)',c:40,g:177,cat:'🫘'},{n:'Baked beans (1/2 cup)',c:27,g:130,cat:'🫘'},
  {n:'Butter beans, cooked (1 cup)',c:41,g:180,cat:'🫘'},{n:'Hummus (2 tbsp)',c:6,g:30,cat:'🫘'},
  // Fruits
  {n:'Apple (medium)',c:25,g:182,cat:'🍎'},{n:'Banana (medium)',c:27,g:118,cat:'🍌'},
  {n:'Orange (medium)',c:15,g:131,cat:'🍊'},{n:'Mango (1 cup)',c:25,g:165,cat:'🥭'},
  {n:'Grapes (1 cup)',c:28,g:151,cat:'🍇'},{n:'Watermelon (1 cup)',c:12,g:152,cat:'🍉'},
  {n:'Pear (medium)',c:27,g:178,cat:'🍐'},{n:'Peach (medium)',c:15,g:150,cat:'🍑'},
  {n:'Pawpaw / Papaya (1 cup)',c:16,g:145,cat:'🍈'},{n:'Pineapple (1 cup)',c:22,g:165,cat:'🍍'},
  {n:'Strawberries (1 cup)',c:11,g:152,cat:'🍓'},{n:'Melon (1 cup)',c:13,g:160,cat:'🍈'},
  // Dairy
  {n:'Full cream milk (1 cup)',c:12,g:244,cat:'🥛'},{n:'Low fat milk (1 cup)',c:12,g:244,cat:'🥛'},
  {n:'Plain yoghurt (1 cup)',c:17,g:245,cat:'🥛'},{n:'Flavoured yoghurt (1 cup)',c:31,g:245,cat:'🥛'},
  {n:'Ice cream (1 scoop)',c:17,g:66,cat:'🍦'},
  // Snacks & Sweets
  {n:'Provitas (4 crackers)',c:20,g:32,cat:'🍘'},{n:'Cream crackers (4)',c:24,g:40,cat:'🍘'},
  {n:'Marie biscuits (4)',c:28,g:40,cat:'🍪'},{n:'Tennis biscuits (4)',c:24,g:36,cat:'🍪'},
  {n:'Rusks (1 piece)',c:30,g:50,cat:'🍪'},{n:'Chocolate (1 small bar)',c:28,g:50,cat:'🍫'},
  {n:'Chips / Crisps (small bag)',c:26,g:45,cat:'🥨'},{n:'Popcorn (2 cups)',c:14,g:32,cat:'🍿'},
  // Drinks
  {n:'Orange juice (1 cup)',c:26,g:248,cat:'🥤'},{n:'Apple juice (1 cup)',c:29,g:248,cat:'🥤'},
  {n:'Coke / Cola (330ml can)',c:35,g:330,cat:'🥤'},{n:'Fanta / Soft drink (330ml)',c:36,g:330,cat:'🥤'},
  {n:'Milk (250ml)',c:12,g:250,cat:'🥛'},
  // SA-specific meals
  {n:'Bunny chow (quarter loaf)',c:80,g:350,cat:'🍛'},{n:'Boerewors roll',c:30,g:180,cat:'🌭'},
  {n:'Vetkoek (1 medium)',c:45,g:120,cat:'🫓'},{n:'Koeksister (1)',c:30,g:50,cat:'🍩'},
  {n:'Melktert (1 slice)',c:35,g:120,cat:'🥧'},{n:'Paptert (1 slice)',c:40,g:150,cat:'🥧'},
  {n:'Braai bread (1 slice)',c:22,g:50,cat:'🍞'},{n:'Samoosa (1)',c:18,g:50,cat:'🥟'},
  {n:'Roti (1 medium)',c:30,g:80,cat:'🫓'},{n:'Naan (1 piece)',c:45,g:120,cat:'🍞'},
  // Proteins (low carb — still shown for completeness)
  {n:'Egg (1 large)',c:0,g:50,cat:'🥚'},{n:'Chicken breast, grilled (100g)',c:0,g:100,cat:'🍗'},
  {n:'Beef mince, cooked (100g)',c:0,g:100,cat:'🥩'},{n:'Tuna in water (1 can)',c:0,g:140,cat:'🐟'},
  // Common combos
  {n:'Pap & vleis (1 plate)',c:60,g:400,cat:'🍽️'},{n:'Rice & chicken curry (1 plate)',c:65,g:400,cat:'🍛'},
  {n:'Spaghetti bolognaise (1 plate)',c:55,g:350,cat:'🍝'},{n:'Fish & chips (1 portion)',c:70,g:400,cat:'🐟'},
];

function fetchFoodSuggestions(query, input, dropdown) {
  const q = query.toLowerCase().trim();
  if (!q) { dropdown.classList.remove('open'); return; }

  // Score each food by how well it matches
  const results = FOOD_DB
    .map(f => {
      const name = f.n.toLowerCase();
      let score = 0;
      if (name.startsWith(q)) score = 100;
      else if (name.includes(q)) score = 50;
      else {
        // word-by-word match
        const words = q.split(' ');
        words.forEach(w => { if (w.length > 2 && name.includes(w)) score += 20; });
      }
      return { ...f, score };
    })
    .filter(f => f.score > 0)
    .sort((a, b) => b.score - a.score)
    .slice(0, 5);

  if (!results.length) {
    dropdown.innerHTML = '<div class="food-sugg-loading">No matches — try a different name or enter carbs manually</div>';
    dropdown.classList.add('open');
    return;
  }

  dropdown.innerHTML = results.map(f =>
    `<div class="food-sugg-item" onmousedown="selectFood(event,'${escQ(f.n)}',${f.c},this)">
      <div>
        <div class="food-sugg-name">${f.cat} ${escH(f.n)}</div>
        <div class="food-sugg-per">${f.g}g serving</div>
      </div>
      <div class="food-sugg-carbs">${f.c}g <span style="font-size:10px;color:var(--t3)">carbs</span></div>
    </div>`
  ).join('');
  dropdown.classList.add('open');
}

function escQ(s){ return (s||'').replace(/'/g,'&#39;').replace(/"/g,'&quot;'); }
function escH(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function selectFood(e, name, carbs, el) {
  e.preventDefault();
  const wrap = el.closest('.food-wrap');
  const row = wrap.closest('.meal-item-row');
  wrap.querySelector('.meal-item-name').value = name;
  row.querySelector('.meal-item-carbs').value = carbs;
  wrap.querySelector('.food-suggestions').classList.remove('open');
  recalcMealTotals();
}

function hideSuggestions(input, delay) {
  setTimeout(() => {
    const wrap = input.closest('.food-wrap');
    if (wrap) wrap.querySelector('.food-suggestions').classList.remove('open');
  }, delay);
}

function recalcMealTotals(){
  let total=0;
  const rows=[];
  document.querySelectorAll('#mealItemsContainer .meal-item-row').forEach(row=>{
    const nameEl=row.querySelector('.meal-item-name');
    const carbEl=row.querySelector('.meal-item-carbs');
    const v=parseFloat(carbEl?.value)||0;
    if(v<0&&carbEl)carbEl.value=0;
    const carbs=Math.max(0,v);
    total+=carbs;
    if(carbs>0&&nameEl?.value.trim())rows.push({name:nameEl.value.trim(),carbs});
  });
  document.getElementById('mealTotalCarbs').textContent=Math.round(total);
  // Item breakdown
  const bd=document.getElementById('mealItemBreakdown');
  if(bd){
    if(rows.length>1){
      bd.style.display='block';
      bd.innerHTML=rows.map(r=>`<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--acc);opacity:.8;padding:1px 0;"><span>${r.name}</span><span style="font-family:'JetBrains Mono',monospace;font-weight:700;">${r.carbs}g</span></div>`).join('');
    } else {
      bd.style.display='none';bd.innerHTML='';
    }
  }
  if(total>0){
    // Walsh meal dose — carbs only (no current BG available in meal modal)
    const mealDose=total/cfg.carbRatio;
    const ins=Math.round(mealDose*2)/2;
    document.getElementById('mealInsRec').textContent=`💉 Meal dose: ${Math.round(total)}g ÷ ${cfg.carbRatio}g/u = ${ins.toFixed(1)}u · Add correction if BG is high`;
    document.getElementById('mealIns').value=ins;
  } else {
    document.getElementById('mealInsRec').textContent='Search foods above or enter carbs manually';
    document.getElementById('mealIns').value='';
  }
}

// AI full meal carb analyser — describe meal in text, get total carbs
async function analyseFullMeal(){
  const items=[];
  document.querySelectorAll('#mealItemsContainer .meal-item-name').forEach(inp=>{
    if(inp.value.trim())items.push(inp.value.trim());
  });
  if(!items.length){toastWarn('Add at least one food item first.');return;}
  if(!getApiKey()){toastError('Add your Anthropic API key in Settings → AI Features.');return;}
  const btn=document.getElementById('fullMealAiBtn');
  btn.textContent='🔄 Analysing…';btn.disabled=true;
  try{
    const resp=await fetch(getApiEndpoint(),{
      method:'POST',
      headers:getApiHeaders(),
      body:JSON.stringify({
        model:'claude-haiku-4-5-20251001',
        max_tokens:500,
        messages:[{role:'user',content:`For each food item listed, estimate the carb content in grams for a typical serving. Return ONLY raw JSON array, no markdown:
[{"name":"food name","carbs":number,"grams":number,"note":"portion assumed"}]

Foods: ${items.join(', ')}`}]
      })
    });
    if(!resp.ok)throw new Error('API error');
    const data=await resp.json();
    if(data.error)throw new Error(data.error.message||'API error');
    const txt=(data.content||[]).map(c=>c.text||'').join('');
    let results;
    try{results=JSON.parse(txt.replace(/```json|```/g,'').trim());}
    catch{throw new Error('Could not parse response');}
    if(!Array.isArray(results)||!results.length)throw new Error('No results returned');
    // Fill in carb values for each row
    const rows=document.querySelectorAll('#mealItemsContainer .meal-item-row');
    rows.forEach((row,i)=>{
      const nameEl=row.querySelector('.meal-item-name');
      const carbEl=row.querySelector('.meal-item-carbs');
      const name=nameEl?.value.trim().toLowerCase();
      if(!name||!carbEl)return;
      // Match by position or name
      const match=results[i]||results.find(r=>r.name.toLowerCase().includes(name.split(' ')[0]));
      if(match&&carbEl){
        carbEl.value=match.carbs;
        // Show tooltip
        if(match.note)carbEl.title=match.note;
      }
    });
    recalcMealTotals();
    toastSuccess(`AI estimated carbs for ${results.length} item${results.length>1?'s':''}!`);
  }catch(e){
    toastError('AI lookup failed: '+(e.message||'Check connection'));
  }finally{
    btn.textContent='🤖 AI Carb Lookup';btn.disabled=false;
  }
}

// CAMERA MEAL
function triggerCamUpload(){document.getElementById('camFileInput').click();}
function handleCamUpload(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    mealCamImageData=ev.target.result;
    const img=document.getElementById('camPreviewImg');
    img.src=mealCamImageData;img.style.display='block';
    document.getElementById('camAreaPlaceholder').style.display='none';
    document.getElementById('analyzeBtn').disabled=false;
    const hint=document.getElementById('aiKeyHint');
    if(hint)hint.style.display=getApiKey()?'none':'block';
  };
  r.readAsDataURL(file);
  e.target.value='';
}

async function runMealAnalysis(){
  if(!mealCamImageData){toastError('Please take or upload a photo first.');return;}
  if(!getApiKey()){toastError('Add your Anthropic API key in Settings → AI Features.');return;}
  const btn=document.getElementById('analyzeBtn');
  btn.disabled=true;btn.textContent='🔄 Analysing…';
  try{
    const b64=mealCamImageData.split(',')[1];
    const mt=mealCamImageData.startsWith('data:image/png')?'image/png':'image/jpeg';
    const resp=await fetch(getApiEndpoint(),{
      method:'POST',
      headers:getApiHeaders(),
      body:JSON.stringify({
        model:'claude-sonnet-4-6',max_tokens:1000,
        messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:mt,data:b64}},
          {type:'text',text:`Analyse this meal image. Return ONLY raw JSON, no markdown:
{"foodName":"name","description":"one sentence","totalCarbs":number,"calories":number,"protein":number,"fat":number,"glycemicIndex":"low|medium|high","items":["item 1 approx portion","item 2"],"notes":"brief diabetes tip"}
If no meal visible: {"error":"Could not identify a meal in this image"}`}
        ]}]
      })
    });
    const data=await resp.json();
    if(data.error){toastError('API error: '+(data.error.message||JSON.stringify(data.error)));btn.disabled=false;btn.textContent='🔍 Analyse Meal with AI';return;}
    const txt=data.content?.map(c=>c.text||'').join('')||'';
    let result;
    try{
      const clean=txt.replace(/```json|```/g,'').trim();
      result=JSON.parse(clean);
    }catch{result={error:'Could not parse response. Please try again.'};}
    if(result.error){toastError(result.error);btn.disabled=false;btn.textContent='🔍 Analyse Meal with AI';return;}
    showCamResult(result);
  }catch(err){
    toastError('Analysis failed. Check your internet connection.');
    btn.disabled=false;btn.textContent='🔍 Analyse Meal with AI';
  }
}

function showCamResult(d){
  const ins=Math.round((d.totalCarbs/cfg.carbRatio)*2)/2;
  document.getElementById('crbName').textContent=d.foodName||'Meal';
  document.getElementById('crbStats').innerHTML=
    `<div class="crb-stat">Carbs: <span>${d.totalCarbs}g</span></div>`+
    `<div class="crb-stat">Cals: <span>${d.calories||0}kcal</span></div>`+
    `<div class="crb-stat">Protein: <span>${d.protein||0}g</span></div>`+
    `<div class="crb-stat">GI: <span>${d.glycemicIndex||'—'}</span></div>`;
  document.getElementById('crbItems').innerHTML=d.items?.map(i=>`• ${i}`).join('<br>')||'';
  document.getElementById('aiCarbs').textContent=d.totalCarbs||0;
  document.getElementById('aiInsRec').textContent=`💉 Meal dose: ${d.totalCarbs}g ÷ ${cfg.carbRatio}g/u = ${ins.toFixed(1)}u · Add correction if BG is high`;
  document.getElementById('aiMealIns').value=ins;
  document.getElementById('camResultBox').style.display='block';
  document.getElementById('analyzeBtn').textContent='🔍 Re-analyse';
  document.getElementById('analyzeBtn').disabled=false;
  toastSuccess(`Found: ${d.foodName} · ${d.totalCarbs}g carbs`);
}

function saveMeal(){
  let carbs=0,ins=0,notes='',name='';
  if(mealTab==='manual'){
    let items=[];
    document.querySelectorAll('#mealItemsContainer .meal-item-row').forEach(row=>{
      const n=row.querySelector('.meal-item-name').value.trim();
      const c=parseFloat(row.querySelector('.meal-item-carbs').value)||0;
      if(n||c>0)items.push(n+(c>0?` (${c}g)`:''));
      carbs+=Math.max(0,c);
    });
    ins=parseFloat(document.getElementById('mealIns').value)||0;
    notes=document.getElementById('mealNotes').value.trim();
    name=items.join(', ')||'Meal';
  } else {
    carbs=parseFloat(document.getElementById('aiCarbs').textContent)||0;
    ins=parseFloat(document.getElementById('aiMealIns').value)||0;
    name=document.getElementById('crbName').textContent||'Meal';
  }
  if(carbs<=0){toastError('Please enter at least one food item with carbs.');return;}
  if(ins<0||ins>100){toastError('Insulin dose must be between 0 and 100 units.');return;}
  // Use last BG value for context, or mark as meal-only with value=null stored as -1 (filtered from chart)
  const latBG=readings.filter(r=>!r.isMealOnly&&r.value>0).slice(-1)[0]?.value||0;
  // Use edited date/time if time row is visible (editing mode)
  let mealTs=Date.now();
  if(editingIdx>=0){
    const metr=document.getElementById('mealEditTimeRow');
    const dateVal=document.getElementById('mealEditDate').value;
    const timeVal=document.getElementById('mealEditTime').value;
    if(metr&&metr.style.display!=='none'&&dateVal&&timeVal){
      const parsed=new Date(`${dateVal}T${timeVal}`);
      if(!isNaN(parsed.getTime()))mealTs=parsed.getTime();
      else mealTs=readings[editingIdx].ts;
    } else mealTs=readings[editingIdx].ts;
  }
  const mealEntry={
    ts:mealTs,
    value:latBG>0?latBG:null,
    context:'Meal',
    insulin:ins>0?ins:null,
    carbs:Math.round(carbs),
    notes:name,
    isMealOnly:true
  };
  if(editingIdx>=0){
    readings[editingIdx]=mealEntry;
    editingIdx=-1;
    document.querySelector('#mealSheet .mtitle').textContent='Log Meal';
    document.querySelector('#mealSheet .svbtn').textContent='Log Meal';
    toastSuccess(`Meal updated: ${Math.round(carbs)}g carbs`);
  } else {
    readings.push(mealEntry);
    toastSuccess(`Meal logged: ${Math.round(carbs)}g carbs · ${ins>0?ins+'u insulin':''}`);
    // Only pre-meal timer when logging a meal with insulin (about to eat)
    // Post-meal timer will auto-chain once the 20-min pre-meal wait is done
    if(ins>0){
      startPreMealTimer(ins, /*chainPostMeal=*/true);
    } else {
      // No insulin — meal already being eaten, start post-meal BG check directly
      startPostMealTimer(firstBiteOffsetMin);
    }
  }
  saveReadings();
  closeMealModal();
  refreshAll();
}

// ══════════════ FULL-SCREEN CAMERA (widget) ══════════════
async function openCamFull(){
  document.getElementById('camfs').classList.add('open');
  camImageData=null;
  document.getElementById('camfsPreview').style.display='none';
  document.getElementById('camfsVideo').style.display='block';
  document.getElementById('camfsAnalyzing').classList.remove('show');
  try{
    activeCamStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    document.getElementById('camfsVideo').srcObject=activeCamStream;
  }catch(e){
    document.getElementById('camfsVideo').style.display='none';
    toastWarn('Camera not available — use Upload button.');
  }
}
function closeCamFull(){
  document.getElementById('camfs').classList.remove('open');
  if(activeCamStream){activeCamStream.getTracks().forEach(t=>t.stop());activeCamStream=null;}
  camImageData=null;
}
function captureFsPhoto(){
  const vid=document.getElementById('camfsVideo');
  if(!activeCamStream||vid.style.display==='none'){toastWarn('Use the Upload button to select a photo.');return;}
  const cv=document.getElementById('hiddenCv');
  cv.width=vid.videoWidth||640;cv.height=vid.videoHeight||480;
  cv.getContext('2d').drawImage(vid,0,0);
  camImageData=cv.toDataURL('image/jpeg',.85);
  showFsPreview(camImageData);
  analyzeFsMeal(camImageData);
}
function handleFsUpload(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{camImageData=ev.target.result;showFsPreview(camImageData);analyzeFsMeal(camImageData);};
  r.readAsDataURL(file);e.target.value='';
}
function showFsPreview(dataUrl){
  document.getElementById('camfsPreview').src=dataUrl;
  document.getElementById('camfsPreview').style.display='block';
  document.getElementById('camfsVideo').style.display='none';
}
async function analyzeFsMeal(imgData){
  if(!getApiKey()){closeCamFull();toastError('Add your Anthropic API key in Settings → AI Features.');return;}
  document.getElementById('camfsAnalyzing').classList.add('show');
  try{
    const b64=imgData.split(',')[1];
    const mt=imgData.startsWith('data:image/png')?'image/png':'image/jpeg';
    const resp=await fetch(getApiEndpoint(),{
      method:'POST',headers:getApiHeaders(),
      body:JSON.stringify({model:'claude-sonnet-4-6',max_tokens:1000,
        messages:[{role:'user',content:[
          {type:'image',source:{type:'base64',media_type:mt,data:b64}},
          {type:'text',text:`Analyse this meal image. Return ONLY raw JSON:
{"foodName":"name","totalCarbs":number,"calories":number,"glycemicIndex":"low|medium|high","items":["item 1","item 2"],"notes":"brief diabetes tip"}
If no meal: {"error":"Could not identify a meal"}`}
        ]}]})
    });
    const data=await resp.json();
    if(data.error){document.getElementById('camfsAnalyzing').classList.remove('show');closeCamFull();toastError('API error: '+(data.error.message||JSON.stringify(data.error)));return;}
    const txt=data.content?.map(c=>c.text||'').join('')||'';
    let result;
    try{const clean=txt.replace(/```json|```/g,'').trim();result=JSON.parse(clean);}
    catch{result={error:'Could not parse response'};}
    document.getElementById('camfsAnalyzing').classList.remove('show');
    closeCamFull();
    if(result.error){toastError(result.error);return;}
    const ins=Math.round((result.totalCarbs/cfg.carbRatio)*2)/2;
    toastSuccess(`${result.foodName}: ${result.totalCarbs}g carbs · ~${ins.toFixed(1)}u suggested`);
    // Open meal modal with pre-filled camera result
    openMealModal();
    setTimeout(()=>{
      switchMealTab('camera');
      // Pre-fill result
      document.getElementById('aiCarbs').textContent=result.totalCarbs||0;
      document.getElementById('crbName').textContent=result.foodName||'Meal';
      document.getElementById('crbStats').innerHTML=`<div class="crb-stat">Carbs: <span>${result.totalCarbs}g</span></div><div class="crb-stat">Cals: <span>${result.calories||0}kcal</span></div><div class="crb-stat">GI: <span>${result.glycemicIndex||'—'}</span></div>`;
      document.getElementById('crbItems').innerHTML=result.items?.map(i=>`• ${i}`).join('<br>')||'';
      document.getElementById('aiInsRec').textContent=`💉 Suggested insulin: ${ins.toFixed(1)}u`;
      document.getElementById('aiMealIns').value=ins;
      document.getElementById('camPreviewImg').src=imgData;
      document.getElementById('camPreviewImg').style.display='block';
      document.getElementById('camAreaPlaceholder').style.display='none';
      document.getElementById('camResultBox').style.display='block';
      mealCamImageData=imgData;
    },400);
  }catch(err){
    document.getElementById('camfsAnalyzing').classList.remove('show');
    closeCamFull();
    toastError('Analysis failed. Check your internet connection.');
  }
}

// ══════════════ SETTINGS ══════════════
// ══════════════ API KEY ══════════════
function getApiKey(){return localStorage.getItem('gt_apikey')||'';}

function saveApiKey(){
  const v=(document.getElementById('sApiKey')?.value||'').trim();
  if(v)localStorage.setItem('gt_apikey',v);
  else localStorage.removeItem('gt_apikey');
  const st=document.getElementById('apiKeyStatus');
  if(st){
    if(v){st.style.display='block';st.style.background='var(--ok-bg)';st.style.color='var(--ok)';st.textContent='✅ API key saved — AI features active.';}
    else{st.style.display='block';st.style.background='var(--hi-bg)';st.style.color='var(--hi)';st.textContent='⚠️ API key cleared — AI features disabled.';}
    setTimeout(()=>{st.style.display='none';},3000);
  }
}

async function testApiKey(){
  const key=getApiKey();
  if(!key){toastError('Enter your API key first.');return;}
  const st=document.getElementById('apiKeyStatus');
  if(st){st.style.display='block';st.style.background='var(--acc-bg)';st.style.color='var(--acc)';st.textContent='🔄 Testing key…';}
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:getApiHeaders(),
      body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:20,messages:[{role:'user',content:'Say OK'}]})
    });
    const d=await r.json();
    if(d.error)throw new Error(d.error.message||'API error');
    if(st){st.style.background='var(--ok-bg)';st.style.color='var(--ok)';st.textContent='✅ Key works! AI features active.';}
    toastSuccess('API key works! AI features active.');
  }catch(e){
    if(st){st.style.background='var(--low-bg)';st.style.color='var(--low)';st.textContent='❌ '+(e.message||'Invalid key — check and try again.');}
    toastError('Key test failed: '+(e.message||'Invalid key'));
  }
}

function loadApiKeyUI(){
  const el=document.getElementById('sApiKey');
  if(el){const k=getApiKey();el.value=k?'•'.repeat(Math.min(k.length,36)):'';}
  const st=document.getElementById('apiKeyStatus');
  if(st&&!getApiKey()){
    st.style.display='block';
    st.style.background='var(--hi-bg)';st.style.color='var(--hi)';
    st.textContent='⚠️ No API key set — AI features (meal scan, food search) are disabled.';
  }
}

function getApiHeaders(){
  return{
    'Content-Type':'application/json',
    'anthropic-version':'2023-06-01',
    'anthropic-dangerous-direct-browser-access':'true',
    'x-api-key':getApiKey()
  };
}

function getApiEndpoint(){
  return 'https://api.anthropic.com/v1/messages';
}

function checkApiKey(){
  if(!getApiKey()){
    toastError('No API key set — go to Settings → AI Features to add your key.');
    return false;
  }
  return true;
}

function saveSettings(){
  const lo=parseFloat(document.getElementById('sLow').value);
  const hi=parseFloat(document.getElementById('sHigh').value);
  if(isNaN(lo)||lo<2.0||lo>5.0){toastError('Low target must be between 2.0 and 5.0 mmol/L.');return;}
  if(isNaN(hi)||hi<6.0||hi>16.0){toastError('High target must be between 6.0 and 16.0 mmol/L.');return;}
  if(lo>=hi){toastError('Low target must be less than high target.');return;}
  const cr=parseFloat(document.getElementById('sCarbRatio').value);
  const cf=parseFloat(document.getElementById('sCorrFactor').value);
  if(isNaN(cr)||cr<1||cr>50){toastError('Carb ratio must be between 1 and 50 g/unit.');return;}
  if(isNaN(cf)||cf<0.5||cf>10){toastError('Correction factor must be between 0.5 and 10 mmol/u.');return;}
  const basalName=document.getElementById('sBasalName')?.value.trim()||'Basal';
  const basalDose=parseFloat(document.getElementById('sBasalDose')?.value)||0;
  const basalTime=document.getElementById('sBasalTime')?.value||'18:00';
  const ag=parseFloat(document.getElementById('sA1cGoal')?.value)||7.0;
  if(isNaN(ag)||ag<5.0||ag>10.0){toastError('HbA1c goal must be between 5.0% and 10.0%.');return;}
  cfg={low:lo,high:hi,carbRatio:cr,corrFactor:cf,basalName,basalDose,basalTime,a1cGoal:ag};
  saveCfg();
  scheduleBasalReminder();
  updateBasalReminderStatus(
    parseInt((cfg.basalTime||'18:00').split(':')[0]),
    parseInt((cfg.basalTime||'18:00').split(':')[1])
  );
  document.getElementById('carbRatioDisplay').textContent=cr;
  document.getElementById('corrDisplay').textContent=cf;
  refreshAll();
  toastSuccess('Settings saved.');
}

function loadSettingsUI(){
  loadApiKeyUI();
  // Update notification permission status
  const ns=document.getElementById('notifStatus');
  if(ns){
    if(!('Notification' in window)) ns.textContent='Not supported in this browser';
    else if(Notification.permission==='granted') ns.textContent='✅ Enabled — alerts fire even when screen is locked';
    else if(Notification.permission==='denied') ns.textContent='❌ Blocked — go to phone Settings → Apps → Browser → Notifications';
    else ns.textContent='Not yet enabled — tap Enable';
  }
  document.getElementById('sLow').value=cfg.low;
  document.getElementById('sHigh').value=cfg.high;
  document.getElementById('sCarbRatio').value=cfg.carbRatio||10;
  document.getElementById('sCorrFactor').value=cfg.corrFactor||2.2;
  const a1cGoalEl=document.getElementById('sA1cGoal');
  if(a1cGoalEl) a1cGoalEl.value=cfg.a1cGoal||7.0;
  document.getElementById('carbRatioDisplay').textContent=cfg.carbRatio||10;
  document.getElementById('corrDisplay').textContent=cfg.corrFactor||2.2;
  if(document.getElementById('sBasalName'))document.getElementById('sBasalName').value=cfg.basalName||'Lantus';
  if(document.getElementById('sBasalDose'))document.getElementById('sBasalDose').value=cfg.basalDose||0;
  if(document.getElementById('sBasalTime'))document.getElementById('sBasalTime').value=cfg.basalTime||'18:00';
  // Update reminder status display
  const bt=cfg.basalTime||'18:00';
  updateBasalReminderStatus(parseInt(bt.split(':')[0]),parseInt(bt.split(':')[1]));
}

function exportCSV(){
  if(!readings.length){toastWarn('No readings to export.');return;}
  const header='Date,Time,Glucose (mmol/L),Context,Insulin (units),Carbs (g),Notes';
  const rows=readings.map(r=>{
    const d=new Date(r.ts);
    const date=d.toLocaleDateString([],{year:'numeric',month:'2-digit',day:'2-digit'});
    const time=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const val=r.value!=null?fmt(r.value):'';
    const ctx=(r.context||'').replace(/"/g,'""');
    const notes=(r.notes||'').replace(/"/g,'""');
    return `${date},${time},${val},"${ctx}",${r.insulin||''},${r.carbs||''},"${notes}"`;
  });
  const csv=[header,...rows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='glucotrack_readings.csv';
  document.body.appendChild(a);a.click();
  document.body.removeChild(a);URL.revokeObjectURL(url);
  toastSuccess('Exported '+readings.length+' readings.');
}
// ══════════════ LIBRE CSV IMPORT ══════════════
/* FreeStyle Libre import — temporarily disabled
function importLibreCSV(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const text=ev.target.result;
      const lines=text.split(/\r?\n/).filter(l=>l.trim());

      // LibreLink CSV format:
      // Row 0: device info (e.g. "FreeStyle LibreLink - 12345,...")
      // Row 1: column headers
      // Row 2+: data rows
      // Columns vary by export version but always include:
      //   Device Timestamp, Record Type, Historic Glucose mmol/L OR Scan Glucose mmol/L

      // Find the header row (contains "Timestamp" or "Device Timestamp")
      let headerIdx=-1;
      for(let i=0;i<Math.min(5,lines.length);i++){
        if(lines[i].toLowerCase().includes('timestamp')||lines[i].toLowerCase().includes('device')){
          headerIdx=i;break;
        }
      }
      if(headerIdx===-1)headerIdx=1; // fallback: assume row 1

      const headers=parseCSVRow(lines[headerIdx]).map(h=>h.trim().toLowerCase().replace(/"/g,''));

      // Find column indices
      const tsCol=headers.findIndex(h=>h.includes('device timestamp')||h.includes('timestamp'));
      const histCol=headers.findIndex(h=>h.includes('historic glucose'));
      const scanCol=headers.findIndex(h=>h.includes('scan glucose'));
      const typeCol=headers.findIndex(h=>h.includes('record type'));
      const noteCol=headers.findIndex(h=>h.includes('notes'));

      if(tsCol===-1){
        toastError('Could not read CSV format. Export from the LibreLink app and try again.');
        return;
      }

      let imported=0,skipped=0,duplicates=0;
      const newReadings=[];

      for(let i=headerIdx+1;i<lines.length;i++){
        const row=parseCSVRow(lines[i]);
        if(row.length<2)continue;

        const tsRaw=(row[tsCol]||'').replace(/"/g,'').trim();
        if(!tsRaw)continue;

        // Parse timestamp — LibreLink uses "DD-MM-YYYY HH:MM" or "MM/DD/YYYY HH:MM"
        const ts=parseLibreTimestamp(tsRaw);
        if(!ts){skipped++;continue;}

        // Get glucose value — prefer scan (fingerprick) over historic (CGM)
        let valRaw='';
        if(scanCol>-1&&row[scanCol]&&row[scanCol].replace(/"/g,'').trim())
          valRaw=row[scanCol];
        else if(histCol>-1&&row[histCol]&&row[histCol].replace(/"/g,'').trim())
          valRaw=row[histCol];

        const val=parseFloat(valRaw.replace(/"/g,'').trim());
        if(isNaN(val)||val<=0||val>33.3){skipped++;continue;}

        // Skip duplicates (same timestamp within 1 min)
        const isDupe=readings.some(r=>Math.abs(r.ts-ts)<60000&&!r.isMealOnly);
        if(isDupe){duplicates++;continue;}

        const notes=noteCol>-1?(row[noteCol]||'').replace(/"/g,'').trim():'';

        newReadings.push({
          ts,
          value:Math.round(val*10)/10,
          context:'Random Check',
          insulin:null,
          carbs:null,
          isMealOnly:false,
          notes:notes||'LibreLink import'
        });
        imported++;
      }

      if(imported===0){
        toastError(`No readings imported. Skipped: ${skipped}, Duplicates: ${duplicates}`);
        e.target.value='';return;
      }

      // Merge and sort by timestamp
      readings=[...readings,...newReadings].sort((a,b)=>a.ts-b.ts);
      saveReadings();
      refreshAll();

      let msg=`✅ Imported ${imported} readings from LibreLink`;
      if(duplicates>0)msg+=` (${duplicates} duplicates skipped)`;
      if(skipped>0)msg+=` (${skipped} invalid rows skipped)`;
      toastSuccess(msg);

    }catch(err){
      toastError('Import failed: '+(err.message||'Unknown error'));
      console.error('Libre import error:',err);
    }
    e.target.value='';
  };
  reader.readAsText(file);
}

*/

// ══════════════ MYSUGR / ACCU-CHEK CSV IMPORT ══════════════
// ══════════════ mySugr CSV IMPORT ══════════════
// Tested against: mySugr_Export_2026-02-28 (English, South Africa, GMT+02:00)
// Known format specifics:
//   Date:     "28 Feb 2026"  (DD Mon YYYY — English month abbreviation)
//   Time:     "07:29:37"     (HH:MM:SS)
//   BG:       "7,7"          (comma as decimal separator, NOT a thousands sep)
//   Encoding: UTF-8 with BOM (\uFEFF), CRLF line endings
//   Separator: comma  (fields are double-quoted)
//   BG column: "Blood Sugar Measurement (mmol/L)"

function importMySugrCSV(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      // Strip BOM, normalise CRLF → LF
      const text = ev.target.result.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const rawLines = text.split('\n').filter(l => l.trim());
      if(rawLines.length < 2){ toastError('File appears empty.'); e.target.value=''; return; }

      // ── Detect header row (first row containing "date" and "blood") ──
      let headerIdx = -1;
      for(let i = 0; i < Math.min(10, rawLines.length); i++){
        const low = rawLines[i].toLowerCase();
        if(low.includes('date') && (low.includes('blood') || low.includes('sugar') || low.includes('glucose') || low.includes('blutzucker'))){
          headerIdx = i; break;
        }
      }
      if(headerIdx === -1){
        // fallback: row with most commas or semicolons
        let maxSep = 0;
        for(let i = 0; i < Math.min(8, rawLines.length); i++){
          const n = (rawLines[i].match(/[,;]/g)||[]).length;
          if(n > maxSep){ maxSep = n; headerIdx = i; }
        }
      }
      if(headerIdx === -1){ toastError('Cannot find header row in this CSV.'); e.target.value=''; return; }

      // ── Detect separator: semicolon (European) or comma ──
      const headerLine = rawLines[headerIdx];
      const sep = (headerLine.match(/;/g)||[]).length > (headerLine.match(/,/g)||[]).length ? ';' : ',';

      // ── Parse CSV row respecting quoted fields ──
      function parseRow(line){
        const out = []; let cur = ''; let inQ = false;
        for(let i = 0; i < line.length; i++){
          const ch = line[i];
          if(ch === '"'){ inQ = !inQ; }
          else if(ch === sep && !inQ){ out.push(cur.trim()); cur = ''; }
          else { cur += ch; }
        }
        out.push(cur.trim());
        return out.map(f => f.replace(/^"|"$/g, '').trim());
      }

      const headers = parseRow(rawLines[headerIdx]).map(h => h.toLowerCase().replace(/[\u200B-\u200D\uFEFF]/g, ''));

      // ── Column finder — returns first index matching any keyword ──
      const col = (...kws) => headers.findIndex(h => kws.some(k => h.includes(k)));

      const dateCol  = col('date', 'datum', 'fecha');
      const timeCol  = col('time', 'zeit', 'hora', 'uhrzeit');
      const bgCol    = col('blood sugar measurement', 'blood sugar', 'blood glucose',
                           'blutzucker', 'glucose (mmol', 'glucose (mg', 'sugar measurement',
                           'measurement (mmol', 'measurement (mg', 'glucosa', 'medição');
      const penCol   = col('insulin injection units (pen)', 'injection units (pen)', 'bolus amount',
                           'total bolus', 'bolus (u', 'insulindosis', 'bolus [');
      const mealInsCol = col('insulin (meal)', 'meal bolus', 'food bolus', 'mahlzeitenbolus');
      const corrInsCol = col('insulin (correction)', 'correction bolus', 'korrekturbolus');
      const basalCol = col('basal injection units', 'basal injection', 'basaldosis', 'basal units');
      const carbCol  = col('meal carbohydrates', 'carbohydrates (g', 'carbohydrates(g',
                           'kohlenhydrate', 'kh (g', 'carboidratos', 'hidratos');
      const mealDescCol = col('meal descriptions', 'meal description', 'food description');
      const notesCol = col('note', 'notes', 'comment', 'notiz', 'remark', 'kommentar');
      const tagsCol  = col('tags', 'tag', 'kategorie');

      if(dateCol === -1 || bgCol === -1){
        toastError(`Column mapping failed. Headers: ${headers.slice(0,6).join(' | ')}`);
        console.warn('mySugr headers:', headers);
        e.target.value=''; return;
      }

      // ── Detect mmol/L vs mg/dL from header text ──
      const bgHeader = headers[bgCol] || '';
      let isMgDl = bgHeader.includes('mg/dl') || bgHeader.includes('mg dl');
      if(!isMgDl && !bgHeader.includes('mmol')){
        // sniff data: mmol/L values are always < 35
        const sniff = rawLines.slice(headerIdx+1, headerIdx+10)
          .map(l => parseFloat((parseRow(l)[bgCol]||'').replace(',','.')))
          .filter(v => !isNaN(v) && v > 0);
        if(sniff.length) isMgDl = (sniff.reduce((a,b)=>a+b,0)/sniff.length) > 35;
      }

      // ── Month name lookup for "28 Feb 2026" format ──
      const MONTHS = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12,
                      mrt:3,mei:5,okt:10,dez:12,ene:1,abr:4,ago:8,dic:12, // NL/ES/DE
                      jan_:1,fev:2,mai:5,set:9,out:10,nov_:11,dez_:12};    // PT

      function parseTimestamp(dateRaw, timeRaw){
        dateRaw = (dateRaw||'').trim();
        timeRaw = (timeRaw||'00:00').trim();
        const t = timeRaw.length === 5 ? timeRaw + ':00' : timeRaw;
        let d;

        // "28 Feb 2026" — DD Mon YYYY (mySugr English/SA default)
        const m1 = dateRaw.match(/^(\d{1,2})\s+([A-Za-z]{3,9})\s+(\d{4})$/);
        if(m1){
          const mo = String(MONTHS[m1[2].substring(0,3).toLowerCase()] || 1).padStart(2,'0');
          d = new Date(`${m1[3]}-${mo}-${m1[1].padStart(2,'0')}T${t}`);
        }
        // DD.MM.YYYY
        else if(/^\d{1,2}\.\d{1,2}\.\d{4}/.test(dateRaw)){
          const [dd,mm,yyyy] = dateRaw.split('.');
          d = new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${t}`);
        }
        // YYYY-MM-DD
        else if(/^\d{4}-\d{2}-\d{2}/.test(dateRaw)){
          d = new Date(`${dateRaw}T${t}`);
        }
        // DD/MM/YYYY
        else if(/^\d{1,2}\/\d{1,2}\/\d{4}/.test(dateRaw)){
          const [dd,mm,yyyy] = dateRaw.split('/');
          d = new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T${t}`);
        }
        // Last resort
        else { d = new Date(`${dateRaw} ${timeRaw}`); }

        return (!d || isNaN(d.getTime())) ? null : d.getTime();
      }

      // ── Parse decimal value handling comma separator ("7,7" → 7.7) ──
      function parseDecimal(raw){
        if(!raw) return NaN;
        // "7,7" or "7,70" → 7.7  (but "1,234" thousands-sep → handled by replacing last comma)
        return parseFloat(raw.trim().replace(/,(\d{1,3})$/, '.$1').replace(/[^0-9.]/g, ''));
      }

      // ── Main import loop ──
      let imported = 0, skipped = 0, duplicates = 0;
      const newReadings = [];

      for(let i = headerIdx + 1; i < rawLines.length; i++){
        const row = parseRow(rawLines[i]);
        if(row.length < 2) continue;

        // Date + Time
        const dateRaw = row[dateCol] || '';
        const timeRaw = timeCol > -1 ? (row[timeCol] || '') : '00:00';
        if(!dateRaw) continue;
        const ts = parseTimestamp(dateRaw, timeRaw);
        if(!ts){ skipped++; continue; }

        // Blood glucose
        const bgRaw = row[bgCol] || '';
        let val = parseDecimal(bgRaw);
        if(isNaN(val) || val <= 0){ skipped++; continue; }
        if(isMgDl) val = Math.round((val / 18.0182) * 10) / 10;
        if(val < 1.0 || val > 33.3){ skipped++; continue; }
        val = Math.round(val * 10) / 10;

        // Insulin — bolus pen > meal bolus > correction bolus
        let insulin = null;
        for(const c of [penCol, mealInsCol, corrInsCol]){
          if(c > -1){ const v = parseDecimal(row[c]); if(!isNaN(v) && v > 0){ insulin = v; break; } }
        }

        // Basal
        let basal = null;
        if(basalCol > -1){ const v = parseDecimal(row[basalCol]); if(!isNaN(v) && v > 0) basal = v; }

        // Carbs
        let carbs = null;
        if(carbCol > -1){ const v = parseDecimal(row[carbCol]); if(!isNaN(v) && v > 0) carbs = Math.round(v); }

        // Context from tags
        let context = 'Random Check';
        if(tagsCol > -1){
          const tag = (row[tagsCol] || '').toLowerCase();
          if(tag.includes('before meal') || tag.includes('pre meal') || tag.includes('pre-meal')) context = 'Before Meal';
          else if(tag.includes('after meal') || tag.includes('post meal')) context = 'After Meal';
          else if(tag.includes('bed') || tag.includes('sleep') || tag.includes('night')) context = 'Before Bed';
          else if(tag.includes('wak') || tag.includes('morning') || tag.includes('fasting')) context = 'Waking Up';
          else if(tag.includes('exercise') || tag.includes('sport') || tag.includes('gym')) context = 'After Exercise';
        }

        // Notes (combine note + meal description)
        const noteA = notesCol > -1 ? (row[notesCol] || '') : '';
        const noteB = mealDescCol > -1 ? (row[mealDescCol] || '') : '';
        const notes = [noteA, noteB].map(s=>s.trim()).filter(Boolean).join(' · ') || 'mySugr import';

        // Skip exact duplicates (same timestamp ±1 min)
        if(readings.some(r => Math.abs(r.ts - ts) < 60000 && !r.isMealOnly)){ duplicates++; continue; }

        newReadings.push({ ts, value: val, context, insulin, basal, basalOnly: false, carbs, isMealOnly: false, notes });
        imported++;
      }

      if(imported === 0){
        toastError(`No readings imported. Skipped:${skipped} Dupes:${duplicates}. Check file format.`);
        console.warn('mySugr debug — headers:', headers, 'bgCol:', bgCol, 'dateCol:', dateCol, 'sep:', sep);
        e.target.value=''; return;
      }

      readings = [...readings, ...newReadings].sort((a,b) => a.ts - b.ts);
      saveReadings();
      refreshAll();
      goTo('history');

      let msg = `✅ Imported ${imported} readings from mySugr`;
      if(isMgDl) msg += ' (converted mg/dL → mmol/L)';
      if(duplicates > 0) msg += ` · ${duplicates} duplicates skipped`;
      if(skipped > 0) msg += ` · ${skipped} rows skipped`;
      toastSuccess(msg);

    } catch(err){
      toastError('Import failed: ' + (err.message || 'Unknown error'));
      console.error('mySugr import error:', err);
    }
    e.target.value = '';
  };
  reader.readAsText(file, 'utf-8');
}

function parseCSVRow(line){
  // Generic CSV row parser (used by Libre import)
  const result=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){inQ=!inQ;}
    else if(c===','&&!inQ){result.push(cur);cur='';}
    else cur+=c;
  }
  result.push(cur);
  return result;
}

function parseLibreTimestamp(raw){
  // Handles multiple formats LibreLink uses:
  // "DD-MM-YYYY HH:MM" (most common, South Africa)
  // "MM/DD/YYYY HH:MM"
  // "YYYY-MM-DD HH:MM"
  // "DD/MM/YYYY HH:MM"
  raw=raw.trim();
  let d;

  // Try ISO format first: YYYY-MM-DD
  if(/^\d{4}-\d{2}-\d{2}/.test(raw)){
    d=new Date(raw.replace(' ','T'));
  }
  // DD-MM-YYYY HH:MM
  else if(/^\d{2}-\d{2}-\d{4}/.test(raw)){
    const [date,time]=raw.split(' ');
    const [dd,mm,yyyy]=date.split('-');
    d=new Date(`${yyyy}-${mm}-${dd}T${time||'00:00'}:00`);
  }
  // DD/MM/YYYY HH:MM
  else if(/^\d{2}\/\d{2}\/\d{4}/.test(raw)){
    const [date,time]=raw.split(' ');
    const [dd,mm,yyyy]=date.split('/');
    d=new Date(`${yyyy}-${mm}-${dd}T${time||'00:00'}:00`);
  }
  // MM/DD/YYYY HH:MM (US format)
  else if(/^\d{1,2}\/\d{1,2}\/\d{4}/.test(raw)){
    d=new Date(raw);
  }
  else{
    d=new Date(raw);
  }

  if(isNaN(d.getTime()))return null;
  return d.getTime();
}

// ══════════════ BASAL INSULIN ══════════════
function logBasalNow(){
  const dose=cfg.basalDose||parseFloat(document.getElementById('sBasalDose')?.value)||0;
  const name=cfg.basalName||document.getElementById('sBasalName')?.value||'Basal';
  if(!dose){toastError('Set your basal dose in Settings first.');return;}
  // Check already logged today
  const today=new Date();today.setHours(0,0,0,0);
  const alreadyToday=readings.some(r=>r.basalOnly&&r.ts>=today.getTime());
  if(alreadyToday){
    appConfirm(`You already logged ${name} today. Log again?`,()=>doLogBasal(dose,name),false);
  } else {
    doLogBasal(dose,name);
  }
}

function doLogBasal(dose,name){
  readings.push({
    ts:Date.now(),
    value:null,
    context:'Basal Insulin',
    insulin:null,
    basal:dose,
    basalOnly:true,
    carbs:null,
    isMealOnly:true,
    notes:`${name} ${dose}u`
  });
  saveReadings();
  refreshAll();
  toastSuccess(`🌙 ${name} ${dose}u logged`);
}

let basalPreTimer=null;   // fires 15 min before
let basalOnTimeTimer=null; // fires at injection time

function scheduleBasalReminder(){
  // Clear any existing timers
  if(basalPreTimer){clearTimeout(basalPreTimer);clearInterval(basalPreTimer);basalPreTimer=null;}
  if(basalOnTimeTimer){clearTimeout(basalOnTimeTimer);clearInterval(basalOnTimeTimer);basalOnTimeTimer=null;}

  const timeStr=cfg.basalTime||'18:00';
  const [h,m]=timeStr.split(':').map(Number);
  if(isNaN(h)||isNaN(m))return;

  const dose=cfg.basalDose||0;
  if(!dose)return; // no reminder if dose not configured

  // Calculate next injection time
  const now=new Date();
  const nextInject=new Date();
  nextInject.setHours(h,m,0,0);
  if(nextInject<=now)nextInject.setDate(nextInject.getDate()+1);

  // 15-min pre-reminder
  const nextPre=new Date(nextInject.getTime()-15*60000);
  const msPre=nextPre-now;

  // Update the status display in settings
  updateBasalReminderStatus(h,m);

  // Schedule 15-min warning
  const schedulePre=()=>{
    fireBasalPreReminder();
    basalPreTimer=setInterval(fireBasalPreReminder,24*3600000);
  };
  if(msPre>0){
    basalPreTimer=setTimeout(schedulePre,msPre);
  } else {
    // Pre-time already passed today, schedule for tomorrow
    basalPreTimer=setTimeout(schedulePre,msPre+24*3600000);
  }

  // Schedule on-time reminder
  const msInject=nextInject-now;
  const scheduleOnTime=()=>{
    fireBasalOnTimeReminder();
    basalOnTimeTimer=setInterval(fireBasalOnTimeReminder,24*3600000);
  };
  basalOnTimeTimer=setTimeout(scheduleOnTime,msInject);
}

function updateBasalReminderStatus(h,m){
  const el=document.getElementById('basalReminderStatus');
  const noEl=document.getElementById('basalNoReminder');
  const preEl=document.getElementById('basalPreRemindTime');
  const onEl=document.getElementById('basalRemindTime');
  if(!el)return;
  const dose=cfg.basalDose||0;
  if(!dose){
    el.style.display='none';
    if(noEl)noEl.style.display='block';
    return;
  }
  if(noEl)noEl.style.display='none';
  if(!preEl||!onEl){el.style.display='none';return;}
  // Calculate 15-min pre-reminder time
  const preH=m>=15?h:(h===0?23:h-1);
  const preM=m>=15?m-15:m+45;
  const fmt2=(n)=>String(n).padStart(2,'0');
  preEl.textContent=`${fmt2(preH)}:${fmt2(preM)}`;
  onEl.textContent=`${fmt2(h)}:${fmt2(m)}`;
  el.style.display='block';
}

function fireBasalPreReminder(){
  const name=cfg.basalName||'Basal';
  const dose=cfg.basalDose||0;
  if(!dose)return;
  notify(`⏰ GlucoTrack Reminder`,`15 minutes until your ${name} injection (${dose}u) — get ready`,'🌙','test');
}

function fireBasalOnTimeReminder(){
  const name=cfg.basalName||'Basal';
  const dose=cfg.basalDose||0;
  if(!dose)return;
  notify(`💉 GlucoTrack — Injection Time`,`Time for your ${name} injection (${dose}u) — inject now and log it`,'💉','test');
}

// ══════════════ PRE-MEAL INSULIN TIMER ══════════════
let preMealTimer=null;
let preMealCountdownInterval=null;

function startPreMealTimer(insulinUnits, chainPostMeal=false){
  // Cancel any running pre-meal timer first
  if(preMealTimer){clearTimeout(preMealTimer);preMealTimer=null;}
  if(preMealCountdownInterval){clearInterval(preMealCountdownInterval);preMealCountdownInterval=null;}
  // Also cancel any running post-meal timer — only one at a time
  if(postMealTimer){clearTimeout(postMealTimer);postMealTimer=null;}
  if(postMealCountdownInterval){clearInterval(postMealCountdownInterval);postMealCountdownInterval=null;}
  hidePostMealBanner();

  const WAIT_MS=20*60*1000; // 20 minutes
  const fireAt=Date.now()+WAIT_MS;

  toastSuccess(`💉 ${insulinUnits}u logged — wait 20 min before eating. Timer started!`);
  showPreMealBanner(fireAt);

  // Notification at 20 min
  scheduleNotification(
    WAIT_MS,
    '🍽️ Time to eat!',
    '20 minutes since your insulin. You can start eating now!',
    'premeal'
  );

  // Cleanup + optional chain to post-meal timer
  preMealTimer=setTimeout(()=>{
    hidePreMealBanner();
    preMealTimer=null;
    if(chainPostMeal){
      // Now the meal starts — begin the 2-hour post-meal BG check
      startPostMealTimer();
    }
  }, WAIT_MS);
}

function showPreMealBanner(fireAt){
  // Create or update the countdown banner
  let banner=document.getElementById('preMealBanner');
  if(!banner){
    banner=document.createElement('div');
    banner.id='preMealBanner';
    banner.style.cssText='position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:300;background:#0D1321;color:#fff;border-radius:12px;padding:10px 18px;font-size:13px;font-weight:700;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,0.35);white-space:nowrap;font-family:Plus Jakarta Sans,sans-serif;';
    banner.innerHTML=`<span>🍽️</span><span id="preMealCountdown">20:00</span><span style="font-weight:500;opacity:.8">until you can eat</span><button onclick="cancelPreMealTimer()" style="margin-left:8px;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:11px;font-family:Plus Jakarta Sans,sans-serif;">✕ Cancel</button>`;
    document.body.appendChild(banner);
  }
  banner.style.display='flex';

  // Update countdown every second
  preMealCountdownInterval=setInterval(()=>{
    const remaining=Math.max(0,fireAt-Date.now());
    const mins=Math.floor(remaining/60000);
    const secs=Math.floor((remaining%60000)/1000);
    const el=document.getElementById('preMealCountdown');
    if(el) el.textContent=`${mins}:${secs.toString().padStart(2,'0')}`;
    if(remaining<=0){
      clearInterval(preMealCountdownInterval);
      preMealCountdownInterval=null;
      hidePreMealBanner();
    }
  },1000);
}

function hidePreMealBanner(){
  const banner=document.getElementById('preMealBanner');
  if(banner) banner.style.display='none';
}

function cancelPreMealTimer(silent=false){
  if(preMealTimer){clearTimeout(preMealTimer);preMealTimer=null;}
  if(preMealCountdownInterval){clearInterval(preMealCountdownInterval);preMealCountdownInterval=null;}
  hidePreMealBanner();
  if(!silent) toast('Pre-meal timer cancelled','info','✕');
}

// ══════════════ POST-MEAL BG CHECK TIMER (2 hours) ══════════════
let postMealTimer=null;
let postMealCountdownInterval=null;

function startPostMealTimer(offsetMin=0){
  // Ensure pre-meal timer is not running simultaneously
  if(preMealTimer){clearTimeout(preMealTimer);preMealTimer=null;}
  if(preMealCountdownInterval){clearInterval(preMealCountdownInterval);preMealCountdownInterval=null;}
  hidePreMealBanner();
  // Clear any existing post-meal timer
  if(postMealTimer){clearTimeout(postMealTimer);postMealTimer=null;}
  if(postMealCountdownInterval){clearInterval(postMealCountdownInterval);postMealCountdownInterval=null;}

  // 2 hours from first bite — subtract time already elapsed since eating started
  const alreadyElapsedMs=Math.min(offsetMin,110)*60*1000; // cap at 110 min so at least 10 min remain
  const WAIT_MS=Math.max(10*60*1000, 2*60*60*1000 - alreadyElapsedMs);
  const fireAt=Date.now()+WAIT_MS;
  const minsLeft=Math.round(WAIT_MS/60000);

  const msg=offsetMin>0
    ? `🍽️ Started eating ${offsetMin} min ago — BG check in ${minsLeft} min!`
    : '🍽️ Meal started — check your BG in 2 hours!';
  toastSuccess(msg);
  showPostMealBanner(fireAt);

  postMealTimer=scheduleNotification(
    WAIT_MS,
    '🩸 GlucoTrack — Time to Check BG',
    '2 hours since your meal. Time to check your blood glucose now!',
    'postmeal'
  );
  setTimeout(()=>{ hidePostMealBanner(); postMealTimer=null; }, WAIT_MS);
}

function showPostMealBanner(fireAt){
  let banner=document.getElementById('postMealBanner');
  if(!banner){
    banner=document.createElement('div');
    banner.id='postMealBanner';
    const preBanner=document.getElementById('preMealBanner');
    const bottomOffset=(preBanner&&preBanner.style.display!=='none')?'136px':'80px';
    banner.style.cssText=`position:fixed;bottom:${bottomOffset};left:50%;transform:translateX(-50%);z-index:299;background:#276749;color:#fff;border-radius:12px;padding:10px 18px;font-size:13px;font-weight:700;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,0.35);white-space:nowrap;font-family:Plus Jakarta Sans,sans-serif;`;
    banner.innerHTML=`<span>🩸</span><span id="postMealCountdown">2:00:00</span><span style="font-weight:500;opacity:.8">until BG check</span><button onclick="cancelPostMealTimer()" style="margin-left:8px;background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:6px;padding:3px 8px;cursor:pointer;font-size:11px;font-family:Plus Jakarta Sans,sans-serif;">✕ Cancel</button>`;
    document.body.appendChild(banner);
  }
  banner.style.display='flex';

  postMealCountdownInterval=setInterval(()=>{
    const remaining=Math.max(0,fireAt-Date.now());
    const hrs=Math.floor(remaining/3600000);
    const mins=Math.floor((remaining%3600000)/60000);
    const secs=Math.floor((remaining%60000)/1000);
    const el=document.getElementById('postMealCountdown');
    if(el) el.textContent=`${hrs}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    if(remaining<=0){
      clearInterval(postMealCountdownInterval);
      postMealCountdownInterval=null;
      hidePostMealBanner();
    }
  },1000);
}

function hidePostMealBanner(){
  const banner=document.getElementById('postMealBanner');
  if(banner) banner.style.display='none';
}

function cancelPostMealTimer(){
  if(postMealTimer){clearTimeout(postMealTimer);postMealTimer=null;}
  if(postMealCountdownInterval){clearInterval(postMealCountdownInterval);postMealCountdownInterval=null;}
  hidePostMealBanner();
  toast('Post-meal timer cancelled','info','✕');
}

function clearAll(){appConfirm('Delete ALL readings? This cannot be undone.',()=>{readings=[];saveReadings();refreshAll();toastSuccess('All readings cleared.');});}

// ══════════════ PWA SETUP ══════════════
let pwaInstallPrompt=null;

// ── Generate app icon using Canvas ──
function generateIcon(size){
  const cv=document.createElement('canvas');cv.width=size;cv.height=size;
  const ctx=cv.getContext('2d');
  // Background
  const bg=ctx.createLinearGradient(0,0,size,size);
  bg.addColorStop(0,'#0D1321');bg.addColorStop(1,'#1e3a5f');
  const r=size*0.22;
  ctx.beginPath();ctx.moveTo(r,0);ctx.lineTo(size-r,0);
  ctx.quadraticCurveTo(size,0,size,r);ctx.lineTo(size,size-r);
  ctx.quadraticCurveTo(size,size,size-r,size);ctx.lineTo(r,size);
  ctx.quadraticCurveTo(0,size,0,size-r);ctx.lineTo(0,r);
  ctx.quadraticCurveTo(0,0,r,0);ctx.closePath();
  ctx.fillStyle=bg;ctx.fill();
  // Glucose wave line
  const pad=size*0.18,lineY=size*0.55,amp=size*0.12;
  ctx.beginPath();ctx.moveTo(pad,lineY);
  const pts=8;for(let i=0;i<=pts;i++){
    const x=pad+(size-pad*2)*(i/pts);
    const y=lineY+Math.sin((i/pts)*Math.PI*2-Math.PI/2)*amp*(i>1&&i<pts-1?1:0.3);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  }
  ctx.strokeStyle='#34d399';ctx.lineWidth=size*0.06;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke();
  // G letter
  ctx.fillStyle='#fff';ctx.font=`bold ${size*0.28}px 'Plus Jakarta Sans',sans-serif`;
  ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('G',size*0.5,size*0.3);
  // Dot (current reading indicator)
  ctx.beginPath();ctx.arc(size*0.73,lineY-amp*0.5,size*0.06,0,Math.PI*2);
  ctx.fillStyle='#34d399';ctx.fill();
  return cv.toDataURL('image/png');
}

function setupPWA(){
  // Generate and apply icon
  const icon180=generateIcon(180);
  const sizes=[57,60,72,76,114,120,144,152,180];
  sizes.forEach(s=>{
    const el=document.getElementById('pwa-icon-'+s);
    if(el)el.href=icon180;// All sizes use same generated icon
  });

  // Render icon preview in settings
  const preview=document.getElementById('iconPreview');
  if(preview){
    const img=new Image();img.onload=()=>{
      const ctx=preview.getContext('2d');ctx.drawImage(img,0,0,60,60);
    };img.src=icon180;
  }

  // Generate splash screens
  function makeSplash(w,h){
    const cv=document.createElement('canvas');cv.width=w;cv.height=h;
    const ctx=cv.getContext('2d');
    ctx.fillStyle='#0D1321';ctx.fillRect(0,0,w,h);
    const cx=w/2,cy=h/2;
    // Icon in centre
    const iSize=Math.min(w,h)*0.28;
    const iconImg=new Image();
    iconImg.onload=()=>{ctx.drawImage(iconImg,cx-iSize/2,cy-iSize*0.7,iSize,iSize);};
    iconImg.src=generateIcon(Math.round(iSize));
    ctx.fillStyle='#fff';ctx.font=`bold ${Math.round(iSize*0.22)}px sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='top';
    ctx.fillText('GlucoTrack',cx,cy-iSize*0.7+iSize+iSize*0.1);
    ctx.fillStyle='#34d399';ctx.font=`${Math.round(iSize*0.13)}px sans-serif`;
    ctx.fillText('Your personal glucose companion',cx,cy-iSize*0.7+iSize+iSize*0.1+Math.round(iSize*0.26));
    return cv.toDataURL('image/png');
  }
  // Apply splash to all sizes
  const splashes={
    '2048':'pwa-splash-2048','1668':'pwa-splash-1668','1536':'pwa-splash-1536',
    '1125':'pwa-splash-1125','1242':'pwa-splash-1242','750':'pwa-splash-750','640':'pwa-splash-640'
  };
  // Simple single splash
  setTimeout(()=>{
    try{
      const splash=makeSplash(1170,2532);
      Object.values(splashes).forEach(id=>{const el=document.getElementById(id);if(el)el.href=splash;});
    }catch(e){}
  },200);

  // Inject Web App Manifest
  const manifest={
    name:'GlucoTrack',
    short_name:'GlucoTrack',
    description:'Personal glucose tracker with AI meal analysis',
    start_url:window.location.href,
    display:'standalone',
    background_color:'#0D1321',
    theme_color:'#0D1321',
    orientation:'portrait',
    icons:[
      {src:icon180,sizes:'180x180',type:'image/png',purpose:'any maskable'},
      {src:icon180,sizes:'192x192',type:'image/png',purpose:'any maskable'},
      {src:icon180,sizes:'512x512',type:'image/png',purpose:'any maskable'}
    ]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  const murl=URL.createObjectURL(blob);
  const mlink=document.getElementById('pwa-manifest');
  if(mlink)mlink.href=murl;

  // Register inline service worker for offline support
  if('serviceWorker' in navigator){
    const swCode=`
      const CACHE='glucotrack-v5';
      const ASSETS=[self.location.origin+self.location.pathname];

      self.addEventListener('install',e=>e.waitUntil(
        caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting())
      ));
      self.addEventListener('activate',e=>e.waitUntil(
        caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k))))
          .then(()=>self.clients.claim())
      ));
      self.addEventListener('fetch',e=>e.respondWith(
        caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          if(res.ok){const rc=res.clone();caches.open(CACHE).then(c=>c.put(e.request,rc));}
          return res;
        }).catch(()=>caches.match(e.request)))
      ));

      // Handle notification display from main thread
      self.addEventListener('message', e => {
        if(e.data && e.data.type === 'SHOW_NOTIFICATION'){
          const {title, body, tag, requireInteraction} = e.data;
          e.waitUntil(
            self.registration.showNotification(title, {
              body,
              tag: tag || 'glucotrack',
              requireInteraction: requireInteraction !== false,
              icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💉</text></svg>',
              vibrate: [200, 100, 200, 100, 200],
            })
          );
        }
        if(e.data && e.data.type === 'SCHEDULE_NOTIFICATION'){
          const {delayMs, title, body, tag} = e.data;
          // Store in IDB/memory for this SW session
          setTimeout(()=>{
            self.registration.showNotification(title, {
              body,
              tag: tag || 'glucotrack-scheduled',
              requireInteraction: true,
              icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🍽️</text></svg>',
              vibrate: [300, 100, 300],
            });
          }, delayMs);
        }
      });

      // Handle notification click — focus the app
      self.addEventListener('notificationclick', e => {
        e.notification.close();
        e.waitUntil(
          clients.matchAll({type:'window',includeUncontrolled:true}).then(cs=>{
            if(cs.length) return cs[0].focus();
            return clients.openWindow(self.location.origin+self.location.pathname);
          })
        );
      });
    `;
    const swBlob=new Blob([swCode],{type:'application/javascript'});
    const swUrl=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl,{scope:'./'})
      .then(()=>console.log('GlucoTrack SW registered'))
      .catch(e=>console.log('SW registration skipped:',e.message));
  }
}

function showPwaInstructions(){
  const ua=navigator.userAgent.toLowerCase();
  const isIOS=/iphone|ipad|ipod/.test(ua);
  const isAndroid=/android/.test(ua);
  const iBtn=document.getElementById('pwaInstructions');
  const aBtn=document.getElementById('pwaAndroid');
  const showBtn=document.getElementById('pwaShowBtn');
  if(isIOS){
    iBtn.style.display=iBtn.style.display==='none'?'block':'none';
    if(aBtn)aBtn.style.display='none';
  } else if(isAndroid){
    if(aBtn)aBtn.style.display=aBtn.style.display==='none'?'block':'none';
    if(iBtn)iBtn.style.display='none';
  } else {
    // Desktop — show both
    iBtn.style.display=iBtn.style.display==='none'?'block':'none';
    if(aBtn)aBtn.style.display=iBtn.style.display;
  }
  // Scroll to show instructions
  setTimeout(()=>showBtn.scrollIntoView({behavior:'smooth',block:'nearest'}),100);
}

function triggerPwaInstall(){
  if(pwaInstallPrompt){
    pwaInstallPrompt.prompt();
    pwaInstallPrompt.userChoice.then(r=>{
      if(r.outcome==='accepted')toastSuccess('GlucoTrack installed! Find it on your home screen.');
      pwaInstallPrompt=null;
      document.getElementById('pwaInstallBtn').style.display='none';
    });
  }
}

window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  pwaInstallPrompt=e;
  const btn=document.getElementById('pwaInstallBtn');
  if(btn)btn.style.display='block';
  const showBtn=document.getElementById('pwaShowBtnTxt');
  if(showBtn)showBtn.textContent='View Install Instructions';
});

window.addEventListener('appinstalled',()=>{
  toastSuccess('GlucoTrack added to your home screen! 🎉');
  pwaInstallPrompt=null;
});



// ══════════════ DARK MODE ══════════════
function toggleDark(){
  const isDark=document.body.classList.toggle('dark');
  store('gt_dark',isDark);
  document.getElementById('darkBtn').textContent=isDark?'☀️':'🌙';
  const tog=document.getElementById('darkToggle');
  if(tog)tog.classList.toggle('on',isDark);
}
function loadDarkMode(){
  const isDark=load('gt_dark',false);
  if(isDark){
    document.body.classList.add('dark');
    const btn=document.getElementById('darkBtn');if(btn)btn.textContent='☀️';
    const tog=document.getElementById('darkToggle');if(tog)tog.classList.add('on');
  }
}

// ══════════════ BACKUP & RESTORE ══════════════
function backupData(){
  const backup={
    version:4,
    exportedAt:new Date().toISOString(),
    readings:readings,
    cfg:cfg
  };
  const json=JSON.stringify(backup,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const date=new Date().toISOString().split('T')[0];
  a.href=url;a.download=`glucotrack_backup_${date}.json`;
  document.body.appendChild(a);a.click();
  document.body.removeChild(a);URL.revokeObjectURL(url);
  toastSuccess(`Backup saved — ${readings.length} readings`);
}

function restoreData(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.readings||!Array.isArray(data.readings))throw new Error('Invalid backup file');
      appConfirm(`Restore ${data.readings.length} readings from ${data.exportedAt?.split('T')[0]||'backup'}? This will replace your current data.`,()=>{
        readings=data.readings;
        if(data.cfg)cfg={...cfg,...data.cfg};
        saveReadings();saveCfg();loadSettingsUI();refreshAll();
        toastSuccess(`Restored ${readings.length} readings successfully`);
      });
    }catch(err){
      toastError('Invalid backup file. Please use a GlucoTrack JSON backup.');
    }
  };
  reader.readAsText(file);
  e.target.value='';
}

// ══════════════ SHARE APP ══════════════
function shareApp(){
  const url=window.location.href.split('?')[0];
  const text='Track your glucose levels with GlucoTrack — free, private, works on any phone 📱';
  if(navigator.share){
    navigator.share({title:'GlucoTrack',text:text,url:url})
      .catch(()=>{});
  } else {
    navigator.clipboard.writeText(url).then(()=>{
      toastSuccess('Link copied to clipboard!');
    }).catch(()=>{
      toast('Share this link: '+url,'info','📤');
    });
  }
}

function logOut(){
  appConfirm('Sign out?',()=>{readings=[];refreshAll();toastSuccess('Signed out.');},false);
}

// ══════════════ REFRESH ══════════════

// ══════════════ EXERCISE GUIDE (EASD/ISPAD/ADA) ══════════════
let exProfile = 0; // 0=Ex0 (minimal/high risk), 1=Ex1 (moderate), 2=Ex2 (intensive/low risk)
let exTimerStart = null;
let exTimerInterval = null;
let exRunning = false;


// ── Plain-English exercise data (EASD/ISPAD/ADA based) ──
// Profile 0 = Low intensity (walking, yoga)     — highest hypo risk
// Profile 1 = Moderate (jogging, cycling)        — moderate hypo risk
// Profile 2 = High intensity (HIIT, weights)     — lower hypo risk (adrenaline effect)

// Pre-exercise cards: each entry renders as a card row
// fields: bg (display range), trend (arrow symbol), icon, status ('go'|'warn'|'stop'),
//         headline, detail[3] (per profile 0/1/2)
const PRE_EX_DATA = [
  {
    bg: 'Below 3.9', icon: '🛑', status: 'stop',
    headline: 'Too Low — Do NOT exercise yet',
    detail: [
      'Your blood sugar is dangerously low. Stop and eat fast-acting carbs (sugary drink, glucose tabs) until you feel better. Wait until your BG is above 5.0 before starting.',
      'Your blood sugar is dangerously low. Stop and eat fast-acting carbs (sugary drink, glucose tabs) until you feel better. Wait until your BG is above 5.0 before starting.',
      'Your blood sugar is dangerously low. Stop and eat fast-acting carbs (sugary drink, glucose tabs) until you feel better. Wait until your BG is above 5.0 before starting.',
    ]
  },
  {
    bg: '3.9 – 4.9', trend: '↑↑ ↗', icon: '⚠️', status: 'warn',
    headline: 'Borderline Low — Rising',
    detail: [
      'Eat about 10g of fast carbs (2 glucose tabs, small juice). Once BG is rising and above 5.0, you can start walking or low-intensity exercise.',
      'Eat about 10g of fast carbs. Once BG is stable and above 5.0, you can start your session.',
      'Eat about 10g of fast carbs. Once stable above 5.0, you can start — but monitor closely.',
    ]
  },
  {
    bg: '3.9 – 4.9', trend: '→', icon: '🛑', status: 'stop',
    headline: 'Borderline Low — Flat',
    detail: [
      'Eat 20–30g of carbs and wait 15 min. Do not exercise until your BG climbs above 5.0.',
      'Eat 20g of carbs and wait. Do not start until BG is above 5.0.',
      'Eat 20g of carbs and wait. Do not start until BG is above 5.0.',
    ]
  },
  {
    bg: '3.9 – 4.9', trend: '↘ ↓↓', icon: '🛑', status: 'stop',
    headline: 'Borderline Low — Dropping',
    detail: [
      'Eat 30–35g of carbs immediately. Do not exercise. Wait until BG is safely above 5.0.',
      'Eat 25g of carbs and wait. Do not start until BG is above 5.0.',
      'Eat 25g of carbs and wait. Do not start until BG is above 5.0.',
    ]
  },
  {
    bg: '5.0 – 6.9 ¹', trend: '↑↑ ↗', icon: '✅', status: 'go',
    headline: 'OK to Go — Rising',
    detail: [
      'Have 15g of carbs as a safety buffer, then you can start any exercise.',
      'You are good to go — no snack needed.',
      'You are good to go — no snack needed.',
    ]
  },
  {
    bg: '5.0 – 6.9 ¹', trend: '→', icon: '⚠️', status: 'warn',
    headline: 'OK — but flat trend, take a small snack',
    detail: [
      'Eat 20g of carbs, then start any exercise. Monitor during.',
      'Eat 10g of carbs, then start any exercise.',
      'You are good to go — no snack needed.',
    ]
  },
  {
    bg: '5.0 – 6.9 ¹', trend: '↘ ↓↓', icon: '⚠️', status: 'warn',
    headline: 'OK — but dropping, take a snack first',
    detail: [
      'Eat 25–30g of carbs. Wait 10 min, then start. Consider delaying intense exercise.',
      'Eat 15–20g of carbs. Wait 10 min, then start.',
      'You are good to go — but monitor closely.',
    ]
  },
  {
    bg: '7.0 – 10.0 ²', trend: 'Any', icon: '✅', status: 'go',
    headline: 'Great Range — Ideal for Exercise',
    detail: [
      'Perfect starting point. Go ahead with any exercise.',
      'Perfect starting point. Go ahead with any exercise.',
      'Perfect starting point. Go ahead with any exercise.',
    ]
  },
  {
    bg: '10.1 – 15.0', trend: '↑↑ ↗', icon: '⚠️', status: 'warn',
    headline: 'A bit High — Rising',
    detail: [
      'Consider a small insulin correction (50% of your usual correction dose). You can start cardio/walking. Delay heavy weights or sprints.',
      'Consider a small correction. You can start cardio. Delay heavy lifting or sprints.',
      'Consider a small correction. You can start any exercise but monitor closely.',
    ]
  },
  {
    bg: '10.1 – 15.0', trend: '→ ↘ ↓↓', icon: '✅', status: 'go',
    headline: 'A bit High — Stable or Dropping',
    detail: [
      'OK to exercise. The activity will naturally help bring BG down.',
      'OK to exercise. The activity will help bring BG down.',
      'OK to exercise.',
    ]
  },
  {
    bg: 'Above 15.0', trend: 'Any', icon: '🛑', status: 'stop',
    headline: 'Too High — Insulin Correction Needed',
    detail: [
      'Your blood sugar is very high. Take an insulin correction (ask your diabetes team for the right amount) and wait until BG comes down below 15 before exercising. Check for ketones if possible.',
      'Too high to exercise safely. Take a correction dose and wait. Check for ketones.',
      'Too high. Take a correction and wait. If you have ketones above 1.5, do not exercise.',
    ]
  },
];

// During exercise cards (profile-independent — same guidance for all)
const DURING_EX_DATA = [
  {
    bg: 'Above 15.0 with ketones', icon: '🛑', status: 'stop',
    headline: 'Stop — Ketones Detected',
    detail: 'Stop all exercise immediately. Take insulin as directed by your diabetes team. Do not restart until BG is below 15 and ketones are below 0.5.'
  },
  {
    bg: 'Above 15.0 no ketones', icon: '⚠️', status: 'warn',
    headline: 'Very High — Check Trend',
    detail: 'If your BG is rising, consider a small correction (50% dose) and continue light exercise only. If it\'s dropping, you can continue all exercise types.'
  },
  {
    bg: '7.0 – 15.0', icon: '✅', status: 'go',
    headline: 'Good Range — Keep Going',
    detail: 'You\'re in a safe zone. Continue your session. Check again in 20–30 min.'
  },
  {
    bg: 'Below 7.0 ³', icon: '⚠️', status: 'warn',
    headline: 'Getting Low — Take Carbs and Continue',
    detail: 'Eat 10–15g of fast carbs (glucose tabs, juice). You can usually continue exercising after — check again in 15 min. If still dropping, eat more and slow down.'
  },
  {
    bg: 'Below 3.9', icon: '🛑', status: 'stop',
    headline: 'Low — Stop and Treat',
    detail: 'Stop exercising. Sit down. Eat 15–20g fast carbs immediately. Check BG every 15 min until you\'re back above 5.0. Only restart if you feel fully recovered.'
  },
  {
    bg: 'Below 3.0', icon: '🛑', status: 'stop',
    headline: 'Severe Low — Emergency',
    detail: 'Stop immediately. Eat the largest amount of fast carbs you have. Sit or lie down. Ask someone for help. Do not restart exercise today.'
  },
];

// Post-exercise cards
const POST_EX_DATA = [
  {
    bg: 'Above 10.0', trend: '↑↑ ↗', icon: '⚠️', status: 'warn',
    headline: 'High After Exercise',
    detail: 'This can happen after intense/HIIT sessions (adrenaline effect). Wait 1–2 hours before correcting with insulin — it often comes down on its own. If above 15, a small correction is reasonable.'
  },
  {
    bg: '5.6 – 10.0 ⁴', icon: '✅', status: 'go',
    headline: 'Great Range — Well Done!',
    detail: 'Your blood sugar is in a good place. Have a balanced meal or snack with protein and some carbs to help your muscles recover. Check again in 2 hours.'
  },
  {
    bg: 'Below 5.6 ⁴', trend: '↑↑ ↗', icon: '✅', status: 'go',
    headline: 'Slightly Low — Rising, You\'re OK',
    detail: 'Your BG is low but heading up. No extra carbs needed right now. Check again in 1 hour.'
  },
  {
    bg: 'Below 5.6 ⁴', trend: '→', icon: '⚠️', status: 'warn',
    headline: 'Slightly Low — Have a Small Snack',
    detail: 'Eat about 10g of carbs (crackers, small piece of fruit). This prevents a delayed hypo, especially if you\'re going to sleep soon.'
  },
  {
    bg: 'Below 5.6 ⁴', trend: '↘ ↓↓', icon: '🛑', status: 'stop',
    headline: 'Low After Exercise — Treat Now',
    detail: 'Eat 15g fast carbs immediately. Follow up with a snack containing protein + carbs (e.g. peanut butter toast, cheese + crackers). If exercising in the evening, set a night-time alarm to check your BG.'
  },
];

// ── Profile labels ──
const EX_PROFILE_LABELS = [
  'Low intensity (Walking / Yoga)',
  'Moderate (Jogging / Cycling)',
  'High intensity (HIIT / Weights)'
];

// ── Footnotes ──
const EX_FOOTNOTES = `<div style="margin-top:10px;font-size:10px;color:var(--t3);line-height:1.8;padding:8px 10px;background:var(--bg);border-radius:8px;">
  ¹ Low profile upper threshold: 6.9 · Moderate: 7.9 · High: 8.9 mmol/L<br>
  ² Low profile ideal zone top: 10.0 · Moderate: 11.0 · High: 12.0 mmol/L<br>
  ³ Low profile "getting low" threshold: &lt;9.0 · Moderate: &lt;8.0 · High: &lt;7.0 mmol/L<br>
  ⁴ Post-exercise low threshold varies: Low profile &lt;5.6 · Moderate &lt;5.0 · High &lt;4.4 mmol/L<br>
  <em>Based on: EASD/ISPAD Exercise Statement (Moser et al. 2020), ADA Standards of Care 2024</em>
</div>`;

function setExProfile(p){
  exProfile = p;
  [0,1,2].forEach(i => document.getElementById('exProf'+i).classList.toggle('active', i===p));
  const lbl = document.getElementById('exProfLabel');
  if(lbl) lbl.textContent = EX_PROFILE_LABELS[p];
  renderExCards();
  updateExerciseScreen();
}

function exCardHTML(icon, status, headline, detail, bg, trend){
  const colors = {go:'var(--ok)', warn:'var(--hi)', stop:'var(--low)'};
  const bgs    = {go:'var(--ok-bg)', warn:'var(--hi-bg)', stop:'var(--low-bg)'};
  const borders = {go:'var(--ok-b)', warn:'var(--hi-b)', stop:'var(--low-b)'};
  const col = colors[status]||'var(--t2)';
  const bg2 = bgs[status]||'var(--bg)';
  const bdr = borders[status]||'var(--border)';
  return `<div style="display:flex;gap:10px;padding:11px 12px;margin-bottom:8px;background:${bg2};border:1.5px solid ${bdr};border-radius:10px;align-items:flex-start;">
    <div style="font-size:22px;flex-shrink:0;line-height:1;">${icon}</div>
    <div style="flex:1;min-width:0;">
      <div style="font-size:11px;font-family:'JetBrains Mono',monospace;color:${col};font-weight:700;margin-bottom:2px;">${bg}${trend?' · '+trend:''}</div>
      <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px;line-height:1.3;">${headline}</div>
      <div style="font-size:12px;color:var(--t2);line-height:1.6;">${detail}</div>
    </div>
  </div>`;
}

function renderExCards(){
  const p = exProfile;
  const lbl = document.getElementById('exProfLabel');
  if(lbl) lbl.textContent = EX_PROFILE_LABELS[p];

  const preEl = document.getElementById('preExCards');
  if(preEl){
    preEl.innerHTML = PRE_EX_DATA.map(d =>
      exCardHTML(d.icon, d.status, d.headline, d.detail[Math.min(p, d.detail.length-1)], d.bg, d.trend||'')
    ).join('') + EX_FOOTNOTES;
  }

  const durEl = document.getElementById('duringExCards');
  if(durEl){
    durEl.innerHTML = DURING_EX_DATA.map(d =>
      exCardHTML(d.icon, d.status, d.headline, d.detail, d.bg, '')
    ).join('');
  }

  const postEl = document.getElementById('postExCards');
  if(postEl){
    postEl.innerHTML = POST_EX_DATA.map(d =>
      exCardHTML(d.icon, d.status, d.headline, d.detail, d.bg, d.trend||'')
    ).join('') + EX_FOOTNOTES;
  }
}

// Keep renderExTables as an alias so the goTo handler still works
function renderExTables(){ renderExCards(); }

function getTrendArrow(){
  const bgR = readings.filter(r => !r.isMealOnly && r.value > 0);
  if(bgR.length < 2) return null;
  const last = bgR[bgR.length-1], prev = bgR[bgR.length-2];
  const dtMin = (last.ts - prev.ts) / 60000;
  if(dtMin <= 0 || dtMin > 120) return null;
  const rate = (last.value - prev.value) / dtMin * 60;
  if(rate > 2.0)  return '↑↑';
  if(rate > 1.0)  return '↗';
  if(rate > -1.0) return '→';
  if(rate > -2.0) return '↘';
  return '↓↓';
}

function getExRecommendation(bg, trend, profile){
  const p = profile;
  if(bg < 3.9) return {cls:'stop', msg:'🛑 Blood sugar too low. Do NOT exercise. Eat fast-acting carbs now and wait until your BG is above 5.0 mmol/L.'};
  if(bg < 5.0){
    if(trend==='↑↑') return {cls:'warn', msg:'⚠️ Low but rising. Eat 10g carbs (2 glucose tabs). OK to start gentle exercise once above 5.0.'};
    if(trend==='↗')  return {cls:'warn', msg:'⚠️ Borderline low. Eat 10–15g carbs and wait. Start only when BG is above 5.0.'};
    return               {cls:'stop', msg:'🛑 Too low. Eat 20–30g carbs. Rest and wait until BG climbs above 5.0.'};
  }
  const lowCeil = [6.9, 7.9, 8.9][p];
  if(bg <= lowCeil){
    if(trend==='↑↑'||trend==='↗') return {cls:p===0?'warn':'go', msg:p===0?'⚠️ Eat 15g carbs as a buffer, then you can start.':'✅ Good to go! BG is rising — no snack needed.'};
    if(trend==='→')  return {cls:p===2?'go':'warn', msg:p===2?'✅ Good to go!':p===1?'⚠️ Have 10g carbs first, then start.':'⚠️ Have 20g carbs first, then start.'};
    return               {cls:p===2?'go':'warn', msg:p===2?'✅ OK to start — monitor closely.':p===1?'⚠️ Have 15–20g carbs. Wait 10 min, then start.':'⚠️ Have 25–30g carbs. Wait before starting.'};
  }
  const midCeil = [10.0, 11.0, 12.0][p];
  if(bg <= midCeil){
    if(trend==='↘'||trend==='↓↓') return {cls:'warn', msg:p===0?'⚠️ BG dropping — have 15g carbs then start.':'✅ OK to start. BG is coming down naturally.'};
    return {cls:'go', msg:'✅ Ideal range for exercise. Go for it!'};
  }
  if(bg <= 15.0){
    if(trend==='↑↑'||trend==='↗') return {cls:'warn', msg:'⚠️ BG is high and rising. Consider a small correction (50% of your normal dose). Stick to walking or cardio — avoid heavy weights or sprints.'};
    return {cls:'go', msg:'✅ BG is high but stable or dropping. OK to exercise — activity will help bring it down.'};
  }
  return {cls:'stop', msg:'🛑 Blood sugar very high. Take an insulin correction and wait until BG is below 15 mmol/L before exercising. Check for ketones.'};
}

function updateExerciseScreen(){
  const bgR = readings.filter(r => !r.isMealOnly && r.value > 0);
  const exBgNum  = document.getElementById('exBgNum');
  const exAction = document.getElementById('exAction');
  const exPills  = document.getElementById('exPills');
  const exTrend  = document.getElementById('exTrend');
  if(!exBgNum) return;

  if(!bgR.length){
    exBgNum.textContent = '—';
    exAction.className = 'ex-action warn';
    exAction.textContent = 'Log a blood sugar reading to get your personalised exercise recommendation.';
    exPills.innerHTML = '';
    return;
  }

  const last = bgR[bgR.length-1];
  const trend = getTrendArrow() || '→';
  const ageMin = (Date.now() - last.ts) / 60000;

  exBgNum.textContent = fmt(last.value);
  if(exTrend) exTrend.textContent = trend;

  const pills = [];
  if(ageMin > 30) pills.push(`⚠️ Reading ${Math.round(ageMin)}min old — log a fresh check`);
  pills.push(['🚶 Low intensity', '🏃 Moderate', '🏋️ High intensity'][exProfile]);
  exPills.innerHTML = pills.map(p => `<div class="ex-pill">${p}</div>`).join('');

  const rec = getExRecommendation(last.value, trend, exProfile);
  exAction.className = 'ex-action ' + rec.cls;
  exAction.textContent = rec.msg;
}


// ── Exercise Timer ──
function toggleExTimer(){
  if(!exRunning){
    exRunning=true;
    exTimerStart=Date.now();
    document.getElementById('exTimerBtn').textContent='Stop';
    document.getElementById('exTimerBtn').className='ex-timer-btn ex-stop-btn';
    document.getElementById('exTimerSub').textContent='Exercise in progress…';
    exTimerInterval=setInterval(tickExTimer,1000);
    // Remind about during-exercise BG checks
    scheduleNotification(20*60000,'⏱️ Exercise check','Check your blood glucose — 20 minutes into exercise.','ex-check-20');
    scheduleNotification(45*60000,'⏱️ Exercise check','Check your blood glucose — 45 minutes into exercise.','ex-check-45');
    toastSuccess('Exercise timer started. BG check reminders set at 20 and 45 minutes.');
  } else {
    stopExTimer();
    // Offer nocturnal reminder if it's afternoon/evening
    const hr=new Date().getHours();
    if(hr>=14){
      toast('Evening session detected. Consider setting a nocturnal hypo reminder below.','warn','🌙');
    }
  }
}

function tickExTimer(){
  if(!exTimerStart) return;
  const elapsed=Math.floor((Date.now()-exTimerStart)/1000);
  const m=Math.floor(elapsed/60).toString().padStart(2,'0');
  const s=(elapsed%60).toString().padStart(2,'0');
  const el=document.getElementById('exElapsed');
  if(el) el.textContent=m+':'+s;
}

function stopExTimer(){
  exRunning=false;
  clearInterval(exTimerInterval);
  exTimerInterval=null;
  const elapsed=exTimerStart?Math.floor((Date.now()-exTimerStart)/1000):0;
  const m=Math.floor(elapsed/60);
  document.getElementById('exTimerBtn').textContent='Start';
  document.getElementById('exTimerBtn').className='ex-timer-btn ex-start-btn';
  document.getElementById('exTimerSub').textContent=`Last session: ${m} min. Start timer when you begin exercising.`;
  exTimerStart=null;
}

// ── Nocturnal hypo reminder ──
function setNocturnalReminder(hours){
  const ms=hours*3600000;
  const fireAt=new Date(Date.now()+ms);
  scheduleNotification(ms,'🌙 Nocturnal hypo check',`Check your blood glucose now — ${hours}h after your exercise session. Hypos can occur 6–15h post-exercise.`,'nocturnal-hypo');
  toastSuccess(`Nocturnal reminder set for ${fireAt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`);
  notify('🌙 Reminder set',`Nocturnal BG check reminder in ${hours} hours at ${fireAt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}. Stay safe!`,'','info');
}

function refreshAll(){
  updateDate();updateHome();updateRecent();
  if(curScreen==='exercise')updateExerciseScreen();
  setTimeout(drawMainChart,80);
  if(curScreen==='a1c')setTimeout(updateA1c,50);
  if(curScreen==='history')updateHistory();
  if(curScreen==='forecast'){setTimeout(updateForecast,60);setTimeout(updateBasalInsights,80);}
}

// FAB opens log reading modal

// Log Meal is now in Logbook submenu in drawer

// ══════════════ INIT ══════════════
// Auth UI commented out — DOB init skipped
// Init custom date range defaults
const today=new Date();
document.getElementById('cdrTo').value=today.toISOString().split('T')[0];
const weekAgo=new Date(today);weekAgo.setDate(today.getDate()-7);
document.getElementById('cdrFrom').value=weekAgo.toISOString().split('T')[0];
// Hide customDateRow by default
document.getElementById('customDateRow').style.display='none';

window.addEventListener('resize',()=>{
  if(curScreen==='home')drawMainChart();
  if(curScreen==='a1c')drawA1cChart();
  drawSparkline();
});
// ── Live timestamp refresh every 30 seconds ──
function refreshTimestamps(){
  updateDate();
  updateWidget(); // updates wTime "X min ago" in widget bar
  // Update main dashboard "last check" time
  const bgR=readings.filter(r=>!r.isMealOnly&&r.value!=null&&r.value>0);
  if(bgR.length){
    const lat=bgR[bgR.length-1];
    const lc=document.getElementById('lastCheck');
    if(lc)lc.textContent=tSince(lat.ts);
    // Alarm check on 30s tick — only for readings logged in last 10 min
    if(Date.now()-lat.ts < 10*60000) checkAlarms(lat.value);
  }
  // Update recent list timestamps without full redraw
  if(curScreen==='home'){
    document.querySelectorAll('.ei-sub[data-ts]').forEach(el=>{
      const ts=parseInt(el.dataset.ts);
      if(ts)el.firstChild && (el.firstChild.textContent=fD(ts)+', '+fT(ts));
    });
  }
  // Update Libre last sync label if visible
  const lls=document.getElementById('libreLastSync');
  if(lls&&window._libreLastSyncTs)lls.textContent='Synced '+tSince(window._libreLastSyncTs);
}
setInterval(refreshTimestamps, 30000);
// Boot directly as guest — auth UI removed
(function(){
  const guest={id:'guest',email:'',firstName:'Guest',lastName:'',dob:'',country:'ZA',createdAt:Date.now()};
  currentUser=guest;
  loadReadings();
  loadCfg();
  loadExProfile();
  loadReminders();
  requestNotificationPermission();
  const du=document.getElementById('drawerUser'); if(du) du.textContent='Guest';
  const de=document.getElementById('drawerEmail'); if(de) de.textContent='';
  loadSettingsUI();
  updateDate();
  setTimeout(refreshAll, 50);
  setTimeout(setupPWA, 100);
  loadDarkMode();
  loadAlarms();
  scheduleBasalReminder();
  setTimeout(drawMainChart, 300);
  setTimeout(restoreLibreSession, 200);
})();
</script>

<!-- ══ CLOUDFLARE WORKER SETUP MODAL ══ -->
<div class="mbd" id="workerSetupModal" onclick="if(event.target===this)closeWorkerSetup()">
  <div class="msheet" style="max-height:92vh">
    <div class="mhandle"></div>
    <div class="mtop">
      <div class="mtitle">⚡ One-Time Setup Required</div>
      <button class="mclose" onclick="closeWorkerSetup()">✕</button>
    </div>
    <div style="padding:14px 20px 0;">
      <p style="font-size:13px;color:var(--t2);line-height:1.6;margin-bottom:14px;">
        Abbott's API blocks direct browser connections. You need to deploy a free personal proxy 
        using <strong>Cloudflare Workers</strong> (free forever, takes ~2 minutes).
      </p>

      <div style="background:var(--acc-bg);border:1.5px solid var(--acc-b);border-radius:10px;padding:14px;margin-bottom:14px;">
        <div style="font-size:11px;font-weight:700;color:var(--acc);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Step 1 — Create your Worker</div>
        <ol style="font-size:12px;color:var(--text);line-height:2;margin-left:16px;">
          <li>Go to <strong>workers.cloudflare.com</strong> → sign up free</li>
          <li>Click <strong>Create Application</strong> → <strong>Create Worker</strong></li>
          <li>Replace all the default code with the code below</li>
          <li>Click <strong>Save and Deploy</strong></li>
          <li>Copy your Worker URL (looks like <code style="font-size:11px;background:rgba(0,0,0,.06);padding:1px 5px;border-radius:4px;">https://xxx.workers.dev</code>)</li>
        </ol>
      </div>

      <div style="margin-bottom:14px;">
        <div style="font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">Worker Code — copy and paste this:</div>
        <div style="position:relative;">
          <pre id="workerCodePre" style="background:#0D1321;color:#e2e8f0;font-size:10px;font-family:'JetBrains Mono',monospace;padding:12px;border-radius:8px;overflow-x:auto;line-height:1.5;white-space:pre-wrap;word-break:break-all;margin:0;">export default {
  async fetch(request) {
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': '*',
      }});
    }
    const url = new URL(request.url);
    const target = url.searchParams.get('url');
    if (!target) return new Response('Missing ?url=', { status: 400 });
    const resp = await fetch(new Request(target, {
      method: request.method,
      headers: request.headers,
      body: request.method !== 'GET' ? request.body : undefined,
    }));
    return new Response(resp.body, { status: resp.status, headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
    }});
  }
}</pre>
          <button onclick="navigator.clipboard.writeText(document.getElementById('workerCodePre').textContent);toastSuccess('Copied!')" 
            style="position:absolute;top:8px;right:8px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);color:#fff;font-size:11px;font-weight:700;padding:4px 10px;border-radius:6px;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;">
            📋 Copy
          </button>
        </div>
      </div>

      <div style="margin-bottom:14px;">
        <div style="font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;">Step 2 — Paste your Worker URL here:</div>
        <input type="url" id="workerUrlInput" 
          placeholder="https://your-worker.your-name.workers.dev"
          style="width:100%;padding:11px 12px;background:var(--bg);border:1.5px solid var(--border2);border-radius:8px;font-size:13px;font-family:'JetBrains Mono',monospace;outline:none;color:var(--text);"
          onfocus="this.style.borderColor='var(--acc)'" onblur="this.style.borderColor='var(--border2)'">
      </div>

      <button onclick="saveWorkerUrl()" class="svbtn" style="margin:0 0 8px;">Save & Continue</button>
      <p style="font-size:11px;color:var(--t3);text-align:center;line-height:1.5;padding-bottom:4px;">
        Your Worker URL is only stored on this device. Cloudflare's free plan allows 100,000 requests/day.
      </p>
    </div>
  </div>
</div>
</body>
</html>
