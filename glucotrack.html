<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>GlucoTrack – With mySugr Import</title>
  <meta name="theme-color" content="#0d1321"/>
  <style>
    :root {
      --bg: #f4f6f9;
      --fg: #0d1321;
      --card: white;
      --border: #e2e6ed;
      --accent: #1a56db;
      --ok: #38a169;
      --low: #e53e3e;
      --hi: #d97706;
      --muted: #6b7280;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: var(--card);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }
    main { flex: 1; padding: 16px; }
    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px;
      margin-bottom: 16px;
    }
    .big-number {
      font-size: 3.8rem;
      font-weight: 800;
      line-height: 1;
      font-family: monospace;
      margin: 8px 0;
    }
    .status {
      font-size: 1.1rem;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 999px;
      display: inline-block;
    }
    .low  { background: #fee2e2; color: var(--low); }
    .ok   { background: #ecfdf5; color: var(--ok); }
    .high { background: #fef3c7; color: var(--hi); }
    input[type="number"], input[type="file"] {
      font-size: 1.4rem;
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: monospace;
    }
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin: 12px 0;
    }
    .context-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px 0;
    }
    .context-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 0.95rem;
    }
    .context-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .history {
      margin-top: 24px;
    }
    .entry {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .entry:last-child { border-bottom: none; }
    #importStatus {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      background: #ecfdf5;
      color: #065f46;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>

<header>
  <h1>GlucoTrack</h1>
  <div id="date"></div>
</header>

<main>
  <div class="card">
    <div style="font-size:0.95rem; color:var(--muted); margin-bottom:4px;">Current Glucose</div>
    <div class="big-number" id="current">—</div>
    <div class="status" id="statusBadge">—</div>
    <div style="margin-top:12px; color:var(--muted); font-size:0.9rem;" id="lastTime">No readings yet</div>
  </div>

  <div class="card">
    <input type="number" id="glucoseInput" placeholder="—" step="0.1" min="0" max="40" autofocus/>
    <div style="text-align:center; margin:12px 0; color:var(--muted);">mmol/L</div>

    <div class="context-buttons" id="contextButtons">
      <button class="context-btn active" data-ctx="Before meal">Before meal</button>
      <button class="context-btn" data-ctx="After meal">After meal</button>
      <button class="context-btn" data-ctx="Before bed">Before bed</button>
      <button class="context-btn" data-ctx="Random">Random</button>
    </div>

    <button onclick="saveReading()">Save Reading</button>
  </div>

  <!-- Import section -->
  <div class="card">
    <div style="font-weight:600; margin-bottom:12px;">Import from mySugr (CSV)</div>
    <input type="file" id="csvFile" accept=".csv"/>
    <button onclick="importMySugrCSV()">Import CSV</button>
    <div id="importStatus"></div>
  </div>

  <div class="card history">
    <div style="font-weight:600; margin-bottom:12px;">Recent Readings</div>
    <div id="historyList"></div>
  </div>
</main>

<script>
// ────────────────────────────────────────────────
let readings = JSON.parse(localStorage.getItem('glucotrack_readings') || '[]');
let selectedContext = 'Before meal';

const dateEl       = document.getElementById('date');
const currentEl    = document.getElementById('current');
const statusEl     = document.getElementById('statusBadge');
const lastTimeEl   = document.getElementById('lastTime');
const input        = document.getElementById('glucoseInput');
const historyEl    = document.getElementById('historyList');
const importStatus = document.getElementById('importStatus');

const ctxButtons = document.querySelectorAll('#contextButtons button');
ctxButtons.forEach(btn => {
  btn.onclick = () => {
    ctxButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedContext = btn.dataset.ctx;
  };
});

// Format date
function updateDate() {
  dateEl.textContent = new Date().toLocaleDateString('en-ZA', {
    weekday: 'short', day: 'numeric', month: 'short'
  });
}
updateDate();
setInterval(updateDate, 60000);

// Status color & text
function getStatus(v) {
  if (v < 3.9) return {cls:'low',  txt:'LOW'};
  if (v <= 10) return {cls:'ok',   txt:'OK'};
  return             {cls:'high', txt:'HIGH'};
}

// Show latest reading
function renderLatest() {
  if (!readings.length) {
    currentEl.textContent = '—';
    statusEl.textContent = 'No data';
    statusEl.className = 'status';
    lastTimeEl.textContent = 'No readings yet';
    return;
  }
  const latest = readings[readings.length-1];
  currentEl.textContent = latest.value.toFixed(1);
  const st = getStatus(latest.value);
  statusEl.textContent = st.txt;
  statusEl.className = 'status ' + st.cls;
  lastTimeEl.textContent = 'Last reading • ' + new Date(latest.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
}

// Render history (last 10)
function renderHistory() {
  if (!readings.length) {
    historyEl.innerHTML = '<div style="color:var(--muted); text-align:center; padding:16px 0;">No readings yet</div>';
    return;
  }
  const html = readings.slice(-10).reverse().map(r => {
    const st = getStatus(r.value);
    const time = new Date(r.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    return `
      <div class="entry">
        <div>
          <strong>${r.value.toFixed(1)}</strong> mmol/L
          <span style="color:var(--muted); font-size:0.9rem;"> • ${r.context}</span>
        </div>
        <div style="color:var(--muted); font-size:0.9rem;">${time}</div>
      </div>
    `;
  }).join('');
  historyEl.innerHTML = html;
}

// Save new reading
function saveReading() {
  const val = parseFloat(input.value);
  if (isNaN(val) || val <= 0) {
    alert('Please enter a valid glucose value');
    return;
  }
  readings.push({
    value: val,
    context: selectedContext,
    ts: Date.now()
  });
  localStorage.setItem('glucotrack_readings', JSON.stringify(readings));
  input.value = '';
  renderLatest();
  renderHistory();
  toast('Reading saved ✓');
}

// ── mySugr CSV Import with duplicate protection ────────────────────────
function importMySugrCSV() {
  const fileInput = document.getElementById('csvFile');
  const file = fileInput.files[0];
  if (!file) {
    alert('Please select a CSV file first');
    return;
  }

  importStatus.textContent = 'Reading file...';
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split(/\r?\n/);
    let added = 0;
    let skipped = 0;

    // We'll store a Set of (timestamp rounded to minute, value) for quick lookup
    const existing = new Set(
      readings.map(r => {
        const d = new Date(r.ts);
        const minuteKey = d.getFullYear() + '-' +
                          String(d.getMonth()+1).padStart(2,'0') + '-' +
                          String(d.getDate()).padStart(2,'0') + ' ' +
                          String(d.getHours()).padStart(2,'0') + ':' +
                          String(d.getMinutes()).padStart(2,'0');
        return minuteKey + '|' + r.value.toFixed(1);
      })
    );

    // Skip header row(s) — mySugr usually has 1–2 header lines
    let startRow = 0;
    while (startRow < lines.length && !lines[startRow].includes('Date') && !lines[startRow].includes('Time')) {
      startRow++;
    }
    startRow++; // skip the actual header

    for (let i = startRow; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const cols = line.split(',').map(c => c.trim().replace(/^"|"$/g,''));
      // Typical mySugr columns: Date, Time, Blood Glucose (mmol/L), ...
      if (cols.length < 3) continue;

      const dateStr = cols[0]; // e.g. 15/02/2025
      const timeStr = cols[1]; // e.g. 14:37
      const bgStr   = cols[2]; // e.g. 6.4

      if (!dateStr || !timeStr || !bgStr) continue;

      // Parse date/time
      const [day, month, year] = dateStr.split('/');
      const [hour, minute]     = timeStr.split(':');
      const dt = new Date(year, month-1, day, hour, minute);
      if (isNaN(dt.getTime())) continue;

      const bg = parseFloat(bgStr.replace(',', '.'));
      if (isNaN(bg) || bg <= 0) continue;

      // Create a key rounded to the minute
      const minuteKey = dt.getFullYear() + '-' +
                        String(dt.getMonth()+1).padStart(2,'0') + '-' +
                        String(dt.getDate()).padStart(2,'0') + ' ' +
                        String(dt.getHours()).padStart(2,'0') + ':' +
                        String(dt.getMinutes()).padStart(2,'0');

      const key = minuteKey + '|' + bg.toFixed(1);

      if (existing.has(key)) {
        skipped++;
        continue;
      }

      // New entry → add
      readings.push({
        value: bg,
        context: 'Imported', // you can change this
        ts: dt.getTime()
      });

      // Add to existing set so we don't add it again in the same import
      existing.add(key);
      added++;
    }

    // Save and refresh
    localStorage.setItem('glucotrack_readings', JSON.stringify(readings));
    renderLatest();
    renderHistory();

    importStatus.innerHTML = `
      Import finished:<br>
      <strong>${added}</strong> new readings added<br>
      <strong>${skipped}</strong> duplicates skipped
    `;
    if (added > 0) toast(`${added} readings imported successfully`);
    else toast('No new readings found (all duplicates)');
  };

  reader.onerror = () => {
    importStatus.textContent = 'Error reading file';
    alert('Could not read the CSV file');
  };

  reader.readAsText(file);
}

// Simple toast
function toast(msg) {
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 24px; border-radius:999px; font-size:0.95rem; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,0.3);';
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2200);
}

// Init
renderLatest();
renderHistory();

// Optional: clear data (uncomment to reset)
// localStorage.removeItem('glucotrack_readings'); readings = []; renderLatest(); renderHistory();
</script>

</body>
</html>
