<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>GlucoTrack Elite</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS INTEGRATION: Your high-end styling + lead-dev layout */
        :root {
            --bg: #F4F6F9; --white: #fff; --text: #0D1321; --acc: #1A56DB;
            --low: #E53E3E; --ok: #38A169; --hi: #D97706; --border: #E2E6ED;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }
        .topbar { background: var(--white); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 100; }
        .logo { font-weight: 800; color: var(--acc); font-size: 1.2rem; }
        .card { background: var(--white); margin: 15px; padding: 20px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 0 15px; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 2.2rem; font-weight: 800; display: block; }
        .stat-lbl { font-size: 0.75rem; font-weight: 700; color: #677088; text-transform: uppercase; }
        
        /* Lead-Dev Parser UI */
        .import-zone { text-align: center; padding: 10px; }
        .btn-main { background: var(--acc); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }
        
        /* Emergency Overlay */
        #hypo-alert { position: fixed; inset:0; background: var(--low); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .rule-15 { background: white; color: black; padding: 20px; border-radius: 15px; margin: 20px; max-width: 320px; }
    </style>
</head>
<body>

<div id="hypo-alert">
    <h1 style="font-size: 4rem;" id="hypo-val">--</h1>
    <h2 style="font-weight: 800;">HYPO ALERT</h2>
    <div class="rule-15">
        <h4 style="color: var(--low); margin-bottom: 10px;">RULE OF 15</h4>
        <p>15g fast carbs. Wait 15 mins. Re-test.</p>
    </div>
    <button onclick="document.getElementById('hypo-alert').style.display='none'" style="background:white; color:var(--low); border:none; padding:15px 30px; border-radius:12px; font-weight:800;">DISMISS</button>
</div>

<div class="topbar">
    <div class="logo">GLUCOTRACK<span>ELITE</span></div>
    <div class="import-zone">
        <input type="file" id="csvFile" hidden onchange="eliteParser.handleFile(this)">
        <button onclick="document.getElementById('csvFile').click()" style="background:none; border: 1px solid var(--acc); color: var(--acc); padding: 5px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; cursor: pointer;">IMPORT CSV</button>
    </div>
</div>

<div class="grid">
    <div class="card">
        <span class="stat-lbl">Predicted GMI</span>
        <span id="gmi-val" class="stat-val">--%</span>
    </div>
    <div class="card">
        <span class="stat-lbl">Last Entry</span>
        <span id="last-val" class="stat-val">--</span>
    </div>
</div>

<div class="card">
    <span class="stat-lbl">24-Hour Trend</span>
    <canvas id="mainChart" style="margin-top: 15px;"></canvas>
</div>

<div class="card">
    <h3 style="margin-bottom: 15px;">Elite Bolus Calculator</h3>
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="number" id="calc-bg" placeholder="Glucose" style="flex:1; padding: 12px; border-radius: 10px; border: 1px solid var(--border);">
        <input type="number" id="calc-carbs" placeholder="Carbs (g)" style="flex:1; padding: 12px; border-radius: 10px; border: 1px solid var(--border);">
    </div>
    <div id="dose-result" style="margin-bottom: 15px; font-weight: 800; color: var(--acc);">Dose Suggestion: 0.0 Units</div>
    <button class="btn-main" onclick="eliteEngine.calculateDose()">Calculate & Log</button>
</div>

<script>
/**
 * THE ELITE ENGINE: Lead Developer Logic
 */
const eliteEngine = {
    history: [],
    config: { hypo: 3.9, target: 6.0, icr: 10, isf: 2.0, conv: 18.018 },

    calculateGMI: () => {
        if (!eliteEngine.history.length) return "--";
        const avgMmol = eliteEngine.history.reduce((a, b) => a + b.val, 0) / eliteEngine.history.length;
        const avgMgdl = avgMmol * eliteEngine.config.conv;
        // Clinical GMI Formula
        return (3.31 + (0.02392 * avgMgdl)).toFixed(1);
    },

    calculateDose: () => {
        const bg = parseFloat(document.getElementById('calc-bg').value);
        const carbs = parseFloat(document.getElementById('calc-carbs').value) || 0;
        
        if (isNaN(bg)) return;
        if (bg < eliteEngine.config.hypo) {
            document.getElementById('hypo-val').innerText = bg;
            document.getElementById('hypo-alert').style.display = 'flex';
            return;
        }

        const mealDose = carbs / eliteEngine.config.icr;
        const corrDose = (bg > eliteEngine.config.target) ? (bg - eliteEngine.config.target) / eliteEngine.config.isf : 0;
        const total = (mealDose + corrDose).toFixed(1);

        document.getElementById('dose-result').innerText = `Dose Suggestion: ${total} Units`;
        eliteEngine.history.unshift({ val: bg, ts: Date.now() });
        uiManager.refresh();
    }
};

/**
 * THE PRECISION PARSER: Specifically for your mySugr CSV structure
 */
const eliteParser = {
    handleFile: (input) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/);
            const imported = [];
            
            lines.slice(1).forEach(line => {
                // Regex: Correctly handles commas inside quotes like "7,7"
                const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                if (cols && cols.length >= 4) {
                    const valStr = cols[3].replace(/"/g, '').replace(',', '.');
                    const val = parseFloat(valStr);
                    const ts = new Date(`${cols[0].replace(/"/g,'')} ${cols[1].replace(/"/g,'')}`).getTime();
                    
                    if (!isNaN(val) && !isNaN(ts)) {
                        imported.push({ val, ts });
                    }
                }
            });
            eliteEngine.history = imported.sort((a,b) => b.ts - a.ts);
            uiManager.refresh();
        };
        reader.readAsText(input.files[0]);
    }
};

const uiManager = {
    chart: null,
    refresh: () => {
        document.getElementById('gmi-val').innerText = eliteEngine.calculateGMI() + "%";
        if (eliteEngine.history.length) {
            document.getElementById('last-val').innerText = eliteEngine.history[0].val;
        }
        uiManager.renderChart();
    },
    renderChart: () => {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (uiManager.chart) uiManager.chart.destroy();
        const displayData = [...eliteEngine.history].reverse().slice(-15);
        
        uiManager.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: displayData.map(d => new Date(d.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})),
                datasets: [{
                    data: displayData.map(d => d.val),
                    borderColor: '#1A56DB',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(26, 86, 219, 0.05)'
                }]
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { min: 2, max: 20 } } }
        });
    }
};
</script>
</body>
</html>
