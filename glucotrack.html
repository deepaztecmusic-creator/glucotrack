<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>GlucoTrack Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        /* Base styles from your template with functional fixes */
        :root {
            --bg: #F4F6F9; --white: #fff; --text: #0D1321; --acc: #1A56DB;
            --low: #E53E3E; --ok: #38A169; --hi: #D97706; --border: #E2E6ED;
        }
        body.dark {
            --bg: #0D1321; --white: #1a2236; --text: #e8edf5; --border: #243049;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); max-width: 430px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        
        .topbar { background: var(--white); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; color: var(--acc); }
        
        .card { background: var(--white); margin: 12px; padding: 16px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .gc-num { font-size: 54px; font-weight: 800; font-family: 'JetBrains Mono'; letter-spacing: -2px; }
        .gc-num.low { color: var(--low); }
        .gc-num.ok { color: var(--ok); }
        .gc-num.hi { color: var(--hi); }

        .fab { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--acc); color: #fff; padding: 12px 24px; border-radius: 30px; border: none; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(26,86,219,0.3); }

        /* Modal Styles */
        .mbd { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-end; z-index: 1000; }
        .mbd.open { display: flex; }
        .msheet { width: 100%; background: var(--white); border-radius: 20px 20px 0 0; padding: 20px; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 16px; }
        
        .btn-block { width: 100%; padding: 14px; background: var(--acc); color: white; border: none; border-radius: 10px; font-weight: 700; margin-top: 10px; }
        .toast-wrap { position: fixed; top: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; pointer-events: none; z-index: 2000; }
        .toast { background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="topbar">
        <div class="logo">GLUCO<span>TRACK</span></div>
        <button onclick="toggleTheme()" id="theme-toggle">üåô</button>
    </div>

    <div class="card">
        <div style="font-size: 12px; font-weight: 700; color: #677088;">LATEST READING</div>
        <div class="gc-num ok" id="main-val">--</div>
        <div id="last-time" style="font-size: 11px; color: #677088;">No data yet</div>
    </div>

    <div class="card">
        <canvas id="glucoseChart" height="180"></canvas>
    </div>

    <div class="card" id="history-list">
        <div style="font-weight: 700; margin-bottom: 10px;">Recent Activity</div>
        <div id="entries-container"></div>
    </div>

    <div class="card">
        <div style="font-weight: 700; margin-bottom: 10px;">Import mySugr Data</div>
        <input type="file" id="csv-input" accept=".csv" style="display: none;">
        <button class="btn-block" style="background: #6366f1;" onclick="document.getElementById('csv-input').click()">Upload CSV</button>
    </div>

    <button class="fab" onclick="openModal()">+ Add Reading</button>

    <div class="mbd" id="log-modal" onclick="if(event.target === this) closeModal()">
        <div class="msheet">
            <h2 style="margin-bottom: 15px;">Log Entry</h2>
            <input type="number" id="in-glucose" placeholder="Glucose (mg/dL)">
            <input type="text" id="in-meal" placeholder="What did you eat? (e.g. 2 slices of pizza)">
            <div id="ai-calc" style="font-size: 13px; color: var(--acc); margin-top: 5px; font-weight: 600;"></div>
            <button class="btn-block" onclick="saveEntry()">Save Entry</button>
        </div>
    </div>

    <div class="toast-wrap" id="toast-wrap"></div>

    <script>
        // State Management
        let data = JSON.parse(localStorage.getItem('gluco_data')) || [];
        let chart = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
            initChart();
            setupImport();
            setupMealAI();
        });

        function renderUI() {
            const container = document.getElementById('entries-container');
            const mainVal = document.getElementById('main-val');
            const lastTime = document.getElementById('last-time');
            
            container.innerHTML = data.length ? '' : '<div style="color:#888; text-align:center; padding:20px;">No entries yet</div>';
            
            if (data.length > 0) {
                const latest = data[0];
                mainVal.innerText = latest.glucose || '--';
                mainVal.className = 'gc-num ' + getStatus(latest.glucose);
                lastTime.innerText = new Date(latest.ts).toLocaleString();

                data.slice(0, 5).forEach(entry => {
                    const div = document.createElement('div');
                    div.style.cssText = "display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border)";
                    div.innerHTML = `
                        <div>
                            <div style="font-weight:600">${entry.glucose} mg/dL</div>
                            <div style="font-size:11px; color:#666">${entry.meal || 'No meal notes'}</div>
                        </div>
                        <div style="font-size:11px; color:#999">${new Date(entry.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    `;
                    container.appendChild(div);
                });
            }
            updateChart();
        }

        // CSV IMPORT FUNCTIONALITY (Fixed for mySugr)
        function setupImport() {
            document.getElementById('csv-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const imported = results.data.map(row => {
                            // handles mySugr headers "Date", "Time", "Blood Glucose"
                            const bg = row['Blood Glucose'] || row['Value'] || row['Blutzucker'];
                            const date = row['Date'] || row['Datum'];
                            const time = row['Time'] || row['Zeit'];
                            if(!bg || !date) return null;
                            return {
                                glucose: parseInt(bg),
                                ts: new Date(`${date} ${time || '00:00'}`).getTime(),
                                meal: row['Carbs'] ? `${row['Carbs']}g Carbs` : 'Imported'
                            };
                        }).filter(x => x && !isNaN(x.glucose));

                        data = [...imported, ...data].sort((a,b) => b.ts - a.ts);
                        save();
                        showToast(`Imported ${imported.length} entries`);
                    }
                });
            });
        }

        // AI MEAL ANALYSIS (Simulated Logic)
        function setupMealAI() {
            const mealIn = document.getElementById('in-meal');
            const aiLabel = document.getElementById('ai-calc');
            
            mealIn.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                if(val.length < 3) { aiLabel.innerText = ''; return; }
                
                // Logic to simulate AI carb estimation
                let estCarbs = 0;
                if(val.includes('pizza')) estCarbs += 30;
                if(val.includes('apple')) estCarbs += 15;
                if(val.includes('bread')) estCarbs += 15;
                if(val.includes('soda')) estCarbs += 40;

                if(estCarbs > 0) {
                    aiLabel.innerText = `Estimate: ~${estCarbs}g carbs. Suggested Insulin: ${(estCarbs/15).toFixed(1)}u`;
                }
            });
        }

        function saveEntry() {
            const g = document.getElementById('in-glucose').value;
            const m = document.getElementById('in-meal').value;
            if(!g) return showToast("Enter glucose value", "error");

            data.unshift({
                glucose: parseInt(g),
                meal: m,
                ts: Date.now()
            });
            save();
            closeModal();
            showToast("Saved successfully");
            document.getElementById('in-glucose').value = '';
            document.getElementById('in-meal').value = '';
        }

        function getStatus(v) {
            if(v < 70) return 'low';
            if(v > 180) return 'hi';
            return 'ok';
        }

        function save() {
            localStorage.setItem('gluco_data', JSON.stringify(data));
            renderUI();
        }

        function initChart() {
            const ctx = document.getElementById('glucoseChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Glucose', data: [], borderColor: '#1A56DB', tension: 0.4, fill: true, backgroundColor: 'rgba(26, 86, 219, 0.1)' }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { min: 40, max: 300 } } }
            });
        }

        function updateChart() {
            if(!chart) return;
            const history = [...data].reverse().slice(-10);
            chart.data.labels = history.map(d => new Date(d.ts).toLocaleTimeString());
            chart.data.datasets[0].data = history.map(d => d.glucose);
            chart.update();
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            document.getElementById('toast-wrap').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function openModal() { document.getElementById('log-modal').classList.add('open'); }
        function closeModal() { document.getElementById('log-modal').classList.remove('open'); }
        function toggleTheme() { 
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.getElementById('theme-toggle').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }
    </script>
</body>
</html>
