<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>GlucoTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<style>
/* --- ALL YOUR ORIGINAL CSS REMAINS UNTOUCHED --- */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#F4F6F9;--white:#fff;--border:#E2E6ED;--border2:#C8CDD8;
  --text:#0D1321;--t2:#5A6478;--t3:#677088;
  --low:#E53E3E;--low-bg:#FFF5F5;--low-b:#FEB2B2;
  --ok:#38A169;--ok-bg:#F0FFF4;--ok-b:#9AE6B4;
  --hi:#D97706;--hi-bg:#FFFBEB;--hi-b:#FCD34D;
  --vhi:#E53E3E;--acc:#1A56DB;--acc-bg:#EBF5FF;--acc-b:#93C5FD;
  --pur:#7C3AED;--pur-bg:#F5F3FF;
  --sh:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --sh2:0 4px 16px rgba(0,0,0,.09);
  --r:14px;--rs:8px;
}
body.dark{
  --bg:#0D1321;--white:#1a2236;--border:#243049;--border2:#2d3d57;
  --text:#e8edf5;--t2:#a0b0cc;--t3:#7a8db5;--acc:#5b8dee;
  --low-bg:#2d1515;--low-b:#7f2020;--ok-bg:#0d2a1a;--ok-b:#1a5c30;
  --hi-bg:#2a1f08;--hi-b:#7a4f0a;--acc-bg:#0d1e3d;--acc-b:#1a3a6b;
}
html{height:100%;background:var(--bg);}
body{height:100%;overflow:hidden;font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;display:flex;flex-direction:column;}
.topbar{background:var(--white);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0;position:relative;z-index:210;}
.logo{font-size:16px;font-weight:800;color:var(--acc);letter-spacing:-.3px;}
.gc-num{font-size:60px;font-weight:800;line-height:1;letter-spacing:-2.5px;color:var(--ok);font-family:'JetBrains Mono',monospace;}
.gc-num.low{color:var(--low);}.gc-num.hi{color:var(--hi);}.gc-num.none{color:var(--t3);font-size:42px;}
.card{margin:12px 14px 0;background:#fff;border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);padding:16px;}
.scroll{flex:1;overflow-y:auto;}
.fab{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:100;background:var(--acc);color:#fff;border:none;border-radius:50px;padding:13px 24px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(26,86,219,.35);}
/* --- END OF YOUR ORIGINAL CSS --- */
</style>
</head>
<body class="dark"> <div class="topbar">
        <div class="logo">GLUCO<span>TRACK</span></div>
        <div class="topbar-right">
            <span class="topbar-date" id="current-date">--:--</span>
        </div>
    </div>

    <div class="scroll">
        <div class="card">
            <div class="gc-lbl">LATEST READING</div>
            <div class="gc-top">
                <div class="gc-row">
                    <div class="gc-num none" id="hero-val">--</div>
                    <div class="gc-ucol">
                        <span class="gc-unit">mg/dL</span>
                        <span class="gc-trend stable" id="hero-trend">â†’</span>
                    </div>
                </div>
            </div>
            <div class="gc-meta">
                <span class="gc-time" id="hero-time">Waiting for data...</span>
            </div>
        </div>

        <div class="card">
            <div class="sc-hd">
                <span class="sc-title">GLUCOSE HISTORY</span>
            </div>
            <div style="height:180px; width:100%;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="sc-title" style="margin-bottom:10px;">IMPORT MYSUGR</div>
            <input type="file" id="mysugr-file" accept=".csv" style="display:none">
            <button class="di" style="width:100%; border:1px solid var(--border); padding:10px; border-radius:8px; cursor:pointer;" onclick="document.getElementById('mysugr-file').click()">
                <span>Select mySugr CSV File</span>
            </button>
        </div>

        <div class="card card-last">
            <div class="sc-hd"><span class="sc-title">RECENT ENTRIES</span></div>
            <div id="history-list">
                <div class="empty">No logs found. Import a CSV to begin.</div>
            </div>
        </div>
    </div>

    <button class="fab" onclick="alert('Manual entry coming soon!')">
        <span>+ Add Reading</span>
    </button>

<script>
/** * BRAINS OF THE APP
 * Handles mySugr CSV mapping and Data Persistence
 */

let glucoseData = JSON.parse(localStorage.getItem('gluco_store')) || [];
let myChart = null;

// 1. INITIALIZE ON LOAD
document.addEventListener('DOMContentLoaded', () => {
    initChart();
    updateUI();
    
    // Set Clock
    setInterval(() => {
        document.getElementById('current-date').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }, 1000);

    // 2. CSV IMPORT LOGIC (The fix you requested)
    document.getElementById('mysugr-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const imported = results.data.map(row => {
                    // Mapping mySugr specific headers
                    const bg = row['Blood Glucose'] || row['Value'] || row['Blutzucker'];
                    const date = row['Date'] || row['Datum'];
                    const time = row['Time'] || row['Zeit'];
                    
                    if (!bg || !date) return null;

                    return {
                        val: parseInt(bg),
                        ts: new Date(`${date} ${time || '00:00'}`).getTime(),
                        note: row['Carbs'] ? `${row['Carbs']}g Carbs` : 'Import'
                    };
                }).filter(x => x && !isNaN(x.val));

                if (imported.length > 0) {
                    // Merge new data with old, sort by time, remove duplicates
                    const combined = [...imported, ...glucoseData];
                    glucoseData = Array.from(new Map(combined.map(item => [item.ts, item])).values())
                                       .sort((a,b) => b.ts - a.ts);
                    
                    localStorage.setItem('gluco_store', JSON.stringify(glucoseData));
                    updateUI();
                    alert(`Successfully imported ${imported.length} readings!`);
                }
            }
        });
    });
});

// 3. UI RENDERING
function updateUI() {
    const heroVal = document.getElementById('hero-val');
    const heroTime = document.getElementById('hero-time');
    const historyList = document.getElementById('history-list');

    if (glucoseData.length > 0) {
        const latest = glucoseData[0];
        heroVal.innerText = latest.val;
        heroVal.className = 'gc-num ' + (latest.val < 70 ? 'low' : latest.val > 180 ? 'hi' : '');
        heroTime.innerText = `Measured at ${new Date(latest.ts).toLocaleString()}`;

        // Update List
        historyList.innerHTML = glucoseData.slice(0, 10).map(item => `
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border)">
                <div>
                    <div style="font-weight:700">${item.val} mg/dL</div>
                    <div style="font-size:11px; color:var(--t3)">${item.note}</div>
                </div>
                <div style="text-align:right; font-size:11px; color:var(--t3)">
                    ${new Date(item.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                </div>
            </div>
        `).join('');

        updateChart();
    }
}

// 4. CHART.JS LOGIC
function initChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    myChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ 
            data: [], borderColor: '#1A56DB', backgroundColor: 'rgba(26,86,219,0.1)', 
            fill: true, tension: 0.4, pointRadius: 0 
        }]},
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { min: 40, max: 300 } }
        }
    });
}

function updateChart() {
    if (!myChart) return;
    const subset = [...glucoseData].reverse().slice(-20);
    myChart.data.labels = subset.map(d => '');
    myChart.data.datasets[0].data = subset.map(d => d.val);
    myChart.update();
}
</script>
</body>
</html>
