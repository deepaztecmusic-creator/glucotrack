<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GlucoTrack">
<meta name="theme-color" content="#0D1321">
<title>GlucoTrack | Enterprise Grade</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
<style>
/* ─── SYSTEM ARCHITECTURE ─── */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#F4F6F9;--white:#fff;--border:#E2E6ED;--text:#0D1321;--t3:#9AA3B5;
  --low:#E53E3E;--ok:#38A169;--hi:#D97706;--acc:#1A56DB;
  --r:14px;--rs:8px;--sh:0 1px 3px rgba(0,0,0,.06);
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* ─── UI COMPONENTS ─── */
.topbar{background:var(--white);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);z-index:10;}
.logo{font-size:16px;font-weight:800;color:var(--acc);}
.topbar-date{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;}

.wbar{background:#0D1321;padding:12px 16px;color:#fff;}
.wbar-inner{display:flex;align-items:center;justify-content:space-between;}
.wnum{font-size:28px;font-weight:700;color:#34d399;font-family:'JetBrains Mono',monospace;}
.wunit{font-size:12px;color:#64748b;margin-left:4px;}
.wtime{font-size:10px;color:#64748b;font-family:'JetBrains Mono',monospace;text-transform:uppercase;}

.scroll{flex:1;overflow-y:auto;padding-bottom:100px;}
.card{margin:12px;background:#fff;border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);}
.gc-lbl{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;margin-bottom:4px;}
.gc-num{font-size:56px;font-weight:800;color:var(--ok);font-family:'JetBrains Mono',monospace;line-height:1;}
.gc-u{font-size:16px;color:var(--t3);font-weight:700;margin-left:6px;}
.gc-time{font-size:11px;color:var(--t3);font-family:'JetBrains Mono',monospace;margin-top:8px;}

/* ─── ALERTS & STATS ─── */
#alert-banner{display:none;margin:12px 12px 0;padding:12px;border-radius:var(--rs);font-weight:800;font-size:12px;text-align:center;animation:pulse 2s infinite;}
.alert-hypo{display:block !important;background:var(--low);color:#fff;}
.alert-hyper{display:block !important;background:var(--hi);color:#fff;}
@keyframes pulse{0%{opacity:1}50%{opacity:0.8}100%{opacity:1}}

.stats-grid{display:flex;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.stat-val{font-size:18px;font-weight:800;color:var(--text);}
.stat-label{font-size:10px;color:var(--t3);font-weight:700;}

.chart-wrap{width:100%;height:140px;margin-top:15px;}
canvas#glucoseChart{width:100%;height:100%;}

.fab{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--acc);color:#fff;padding:14px 24px;border-radius:50px;font-weight:700;border:none;box-shadow:0 4px 15px rgba(26,86,219,0.4);cursor:pointer;z-index:100;}
</style>
</head>
<body>

<div id="alert-banner"></div>

<div class="topbar">
    <div class="logo">GLUCO<span>TRACK</span></div>
    <div class="topbar-date">--- -- --:--</div>
</div>

<div class="wbar">
    <div class="wbar-inner">
        <div>
            <span class="wnum" id="widget-val">5.8</span><span class="wunit">mmol/L</span>
            <div class="wtime" id="widget-time">Just now</div>
        </div>
        <div style="text-align:right">
            <div style="font-size:10px; opacity:0.6">TREND</div>
            <div id="trend-arrow" style="font-size:18px;">→</div>
        </div>
    </div>
</div>

<div class="scroll">
    <div class="card">
        <div class="gc-lbl">Glucose History (mmol/L)</div>
        <div style="display:flex; align-items:baseline;">
            <div class="gc-num" id="hero-val">5.8</div>
            <div class="gc-u">mmol/L</div>
        </div>
        <div class="gc-time" id="hero-time">Last Reading: Just now</div>
        <div class="chart-wrap"><canvas id="glucoseChart"></canvas></div>
    </div>

    <div class="card">
        <div class="gc-lbl">Clinical Indicators</div>
        <div class="stats-grid">
            <div><div class="stat-val" id="stat-tir">100%</div><div class="stat-label">IN RANGE</div></div>
            <div><div class="stat-val" id="stat-avg">5.8</div><div class="stat-label">AVG GLUCOSE</div></div>
            <div><div class="stat-val" id="stat-a1c">5.4</div><div class="stat-label">EST. A1C</div></div>
        </div>
    </div>
</div>

<button class="fab" onclick="initiateReading()">+ Log Reading</button>

<script>
/**
 * CLINICAL CORE ENGINE
 */
const AppState = {
    history: [5.4, 5.8, 6.1, 5.9, 5.7, 6.2, 5.8], 
    lastReadingTimestamp: Date.now(),
    timerRef: null,
    clockRef: null
};

function updateClock() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }).toUpperCase();
    const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
    document.querySelector('.topbar-date').textContent = `${dateStr} ${timeStr}`;
}

function updateRelativeTimers() {
    const diffMins = Math.floor((Date.now() - AppState.lastReadingTimestamp) / 60000);
    const label = diffMins < 1 ? "Just now" : `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
    document.getElementById('widget-time').textContent = label;
    document.getElementById('hero-time').textContent = `Last Reading: ${label}`;
}

function updateClinicalStats() {
    const data = AppState.history;
    const tir = Math.round((data.filter(v => v >= 3.9 && v <= 10.0).length / data.length) * 100);
    const avg = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(1);
    const a1c = ((parseFloat(avg) + 2.59) / 1.59).toFixed(1);

    document.getElementById('stat-tir').textContent = `${tir}%`;
    document.getElementById('stat-avg').textContent = avg;
    document.getElementById('stat-a1c').textContent = a1c;
}

function drawChart() {
    const canvas = document.getElementById('glucoseChart');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    const data = AppState.history;
    const w = rect.width;
    const h = rect.height;
    ctx.clearRect(0, 0, w, h);

    const getX = (i) => (i / (data.length - 1)) * w;
    const getY = (v) => h - ((v - 2.0) / (15.0 - 2.0)) * h;

    // Green Range (Target Zone: 3.9 - 10.0 mmol/L)
    ctx.fillStyle = 'rgba(56, 161, 105, 0.08)';
    ctx.fillRect(0, getY(10.0), w, getY(3.9) - getY(10.0));

    // Glucose Path
    ctx.beginPath();
    ctx.strokeStyle = '#1A56DB';
    ctx.lineWidth = 3;
    ctx.lineJoin = 'round';
    data.forEach((val, i) => i === 0 ? ctx.moveTo(getX(i), getY(val)) : ctx.lineTo(getX(i), getY(val)));
    ctx.stroke();
}

/**
 * ATOMIC READING INITIATION (Stops and Resets Timer)
 */
function initiateReading() {
    // 1. KILL the background timer interval immediately to prevent race conditions
    clearInterval(AppState.timerRef);

    // 2. Commit new data (Realistic mmol/L range)
    const newVal = parseFloat((Math.random() * (12.0 - 3.5) + 3.5).toFixed(1));
    const oldVal = AppState.history[AppState.history.length - 1];
    AppState.history.push(newVal);
    if(AppState.history.length > 25) AppState.history.shift();
    
    // 3. Reset the Global Timestamp to "now"
    AppState.lastReadingTimestamp = Date.now();

    // 4. Update UI Components
    document.getElementById('widget-val').textContent = newVal.toFixed(1);
    document.getElementById('hero-val').textContent = newVal.toFixed(1);
    
    const arrow = document.getElementById('trend-arrow');
    const diff = newVal - oldVal;
    arrow.textContent = diff > 0.4 ? "↑" : (diff < -0.4 ? "↓" : "→");
    
    // Clinical Threshold Handling
    const banner = document.getElementById('alert-banner');
    if (newVal < 3.9) {
        banner.textContent = "⚠ HYPOGLYCEMIA ALERT";
        banner.className = 'alert-hypo';
        document.getElementById('hero-val').style.color = 'var(--low)';
    } else if (newVal > 10.0) {
        banner.textContent = "⚠ HYPERGLYCEMIA ALERT";
        banner.className = 'alert-hyper';
        document.getElementById('hero-val').style.color = 'var(--hi)';
    } else {
        banner.style.display = 'none';
        document.getElementById('hero-val').style.color = 'var(--ok)';
    }

    // 5. Finalize State and RESTART background logic
    drawChart();
    updateClinicalStats();
    updateRelativeTimers(); // Immediate update to "Just now"
    AppState.timerRef = setInterval(updateRelativeTimers, 10000);
}

function boot() {
    updateClock();
    updateRelativeTimers();
    updateClinicalStats();
    drawChart();
    
    if(AppState.clockRef) clearInterval(AppState.clockRef);
    if(AppState.timerRef) clearInterval(AppState.timerRef);
    
    AppState.clockRef = setInterval(updateClock, 1000);
    AppState.timerRef = setInterval(updateRelativeTimers, 10000);
}

window.onload = boot;
window.onresize = drawChart;
</script>
</body>
</html>
